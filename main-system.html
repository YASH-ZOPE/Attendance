<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Attendance System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- AWS Cognito SDK -->
  <script
    src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>

  <!-- Cognito Config -->
  <script src="cognito-config.js"></script>

  <!-- Auth Functions -->
  <script src="auth.js"></script>

  <!-- Firebase SDK (Add AFTER AWS Cognito SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Firebase Config (reuse same file) -->
  <script src="firebase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>

  <style>
    :root {
      --primary-color: #E8C4D8;
      --success-color: #D4E8D4;
      --danger-color: #F5D6D6;
      --warning-color: #F9E8D9;
    }

    body {
      background: #F8F6F4;
      padding-top: 70px;
    }

    .navbar-brand {
      font-weight: 700;
      font-size: 1.4rem;
    }

    .nav-section {
      scroll-margin-top: 80px;
    }

    .section-card {
      background: #FFFEF9;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
      padding: 20px;
      margin-bottom: 20px;
    }

    .section-title {
      font-weight: 600;
      color: #7A7A7A;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #F0EDE8;
    }

    .present {
      background: #E8F4E8 !important;
    }

    .absent {
      background: #FDECED !important;
    }

    .table-container {
      max-height: 50vh;
      overflow: auto;
    }

    .file-drop {
      border: 2px dashed #E8C4D8;
      padding: 30px;
      text-align: center;
      border-radius: 10px;
      background: #FBF8FA;
      transition: all 0.3s;
      cursor: pointer;
    }

    .file-drop:hover,
    .file-drop.dragover {
      border-color: #D9A8C4;
      background: #F7F0F5;
    }

    .day-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 10px;
    }

    .day-btn {
      padding: 10px 5px;
      text-align: center;
      border: 1px solid #EFEAE5;
      border-radius: 6px;
      cursor: pointer;
      background: #FFFEF9;
      transition: all 0.2s;
      font-weight: 500;
      color: #7A7A7A;
    }

    .day-btn:hover {
      background: #F7F0F5;
      border-color: var(--primary-color);
      transform: scale(1.05);
    }

    .day-btn.active {
      background: #E8C4D8;
      color: #8B5A7A;
      border-color: #E8C4D8;
    }

    .day-btn.has-data {
      background: #E8F0E8;
      border-color: #C8DCC8;
    }

    .day-btn.has-data.active {
      background: #D4E8D4;
      color: #5A7A5A;
    }

    .day-btn.holiday {
      background: #FDF5F5 !important;
      border-color: #F5D6D6 !important;
      color: #B08080;
    }

    .day-btn.holiday.active {
      background: #F5D6D6 !important;
      color: #9A6A6A !important;
    }

    .day-header {
      font-weight: bold;
      text-align: center;
      padding: 8px;
      background: #F5F3F0;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #8A8A8A;
    }

    .subject-tag {
      display: inline-flex;
      align-items: center;
      background: #F7F0F5;
      border: 1px solid #E8C4D8;
      padding: 5px 12px;
      border-radius: 20px;
      margin: 3px;
      font-size: 0.9rem;
      color: #8B5A7A;
    }

    .subject-tag.active {
      background: #E8C4D8;
      color: #6A4A5A;
    }

    .subject-tag .delete-btn {
      cursor: pointer;
      margin-left: 8px;
      color: #D89AA8;
      font-weight: bold;
    }

    .subject-tag.active .delete-btn {
      color: #9A6A7A;
    }

    .stats-card {
      background: linear-gradient(135deg, #E8C4D8 0%, #DDB8CC 100%);
      color: #6A4A5A;
      border-radius: 10px;
      padding: 15px;
    }

    .stats-card.success {
      background: linear-gradient(135deg, #D4E8D4 0%, #C4DCC4 100%);
      color: #4A6A4A;
    }

    .stats-card.danger {
      background: linear-gradient(135deg, #F5D6D6 0%, #EDCACA 100%);
      color: #8A5A5A;
    }

    .stats-card.warning {
      background: linear-gradient(135deg, #F9E8D9 0%, #F0DCCD 100%);
      color: #8A6A4A;
    }

    .defaulter-badge {
      background: #F5D6D6;
      color: #9A6A6A;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .good-badge {
      background: #D4E8D4;
      color: #5A7A5A;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .btn-action {
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .holiday-badge {
      background: #FDF5EB;
      color: #A08060;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
    }

    .quick-nav {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
      background: #FFFEF9;
      border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
      padding: 10px;
    }

    .quick-nav a {
      display: block;
      padding: 8px 12px;
      color: #9A9A9A;
      text-decoration: none;
      border-radius: 6px;
      margin: 2px 0;
      font-size: 0.85rem;
    }

    .quick-nav a:hover,
    .quick-nav a.active {
      background: #E8C4D8;
      color: #6A4A5A;
    }

    /* Mobile responsiveness for stats cards */
    @media (max-width: 768px) {
      .stats-card h3 {
        font-size: 1.5rem;
      }

      .section-card {
        padding: 15px;
      }

      .section-title {
        font-size: 1.1rem;
      }

      .btn-action {
        font-size: 0.9rem;
        padding: 6px 12px;
      }

      .day-grid {
        gap: 3px;
      }

      .day-btn {
        padding: 8px 3px;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 576px) {
      body {
        padding-top: 60px;
      }

      .navbar-brand {
        font-size: 1.1rem;
      }

      .stats-card {
        padding: 12px;
      }

      .stats-card h3 {
        font-size: 1.3rem;
      }

      .stats-card h6 {
        font-size: 0.85rem;
      }

      .table-responsive {
        font-size: 0.85rem;
      }

      .go-btn {
        width: 100vw;
        height: auto;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 1rem;
      }
    }

    @media (max-width: 768px) {
      .quick-nav {
        display: none;
      }
    }

    /* Collapsible Info Box */
    .info-alert {
      background: linear-gradient(135deg, #E8E4F0 0%, #DDD8E8 100%);
      border: none;
      border-left: 4px solid #C8B8D8;
      color: #6A5A7A;
      transition: max-height 0.3s ease, padding 0.3s ease;
      overflow: hidden;
      cursor: pointer;
      max-height: 60px;
      /* Collapsed state */
      padding: 15px 20px;
    }

    .info-alert.collapsed {
      max-height: 60px;
    }

    .info-alert.collapsed .info-content {
      display: none;
    }

    .info-alert.collapsed h5::after {
      content: " (Click to expand)";
      font-size: 0.8rem;
      font-weight: normal;
      opacity: 0.7;
    }

    .info-alert:hover,
    .info-alert.expanded {
      max-height: 500px;
      /* Expanded state */
      padding: 20px;
    }

    .info-alert:hover .info-content,
    .info-alert.expanded .info-content {
      display: block;
    }

    .info-alert h5 {
      margin-bottom: 10px;
      transition: margin 0.3s ease;
    }

    .info-alert.collapsed h5 {
      margin-bottom: 0;
    }

    .modal-header-custom {
      background: linear-gradient(135deg, #F5D6D6 0%, #EDCACA 100%);
      color: #8A5A5A;
    }

    .go-btn {
      width: 84vw;
      height: 10vh;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      background: #4facfe;
      border: none;
      border-radius: 8px;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .go-btn:hover {
      background: #00c6ff;
    }

    /* Role-based visibility */
    .admin-only {
      display: block;
    }

    .teacher-only {
      display: block;
    }

    .student-only {
      display: none;
    }

    .hide-for-teacher {
      display: none;
    }

    .hide-for-student {
      display: none;
    }

    /* For buttons/inline elements */
    .admin-only-inline {
      display: inline-block;
    }

    .teacher-only-inline {
      display: inline-block;
    }

    .hide-for-teacher-inline {
      display: none;
    }

    .hide-for-student-inline {
      display: none;
    }



    /* Fix Academic Year section spacing */
    #month-section .row.g-2 {
      gap: 10px !important;
      margin-bottom: 15px;
    }

    /* Better dropdown sizing */
    #month-section .col-2 {
      min-width: 150px;
      /* Prevent squeezing */
    }

    /* Academic Year dropdowns - more space */
    #academicYearLevelSelect,
    #divisionSelect {
      min-width: 120px;
    }

    /* Apply button - better alignment */
    #applyMonthBtn {
      margin-top: 0;
      height: 38px;
      /* Match dropdown height */
    }

    /* Alert boxes - prevent text cutoff */
    #currentAcademicDisplay,
    #currentMonthDisplay {
      word-wrap: break-word;
      white-space: normal;
      line-height: 1.4;
    }

    .alert.mb-0.py-2 {
      padding: 10px 15px !important;
      min-height: 45px;
    }

    /* Better label spacing */
    #month-section .form-label.fw-bold.small {
      margin-bottom: 5px;
      font-size: 0.85rem;
    }

    /* ==================== ATTENDANCE SECTION BUTTON FIX ==================== */

    /* Fix camera/attendance section */
    #camera-section {
      margin: 30px 0;
      /* Space from navbar and other sections */
      padding: 0 15px;
      position: relative;
      z-index: 1;
      /* Below navbar */
    }

    /* Attendance button - cleaner design */
    .go-btn {
      width: 100%;
      /* Full width on mobile, container width on desktop */
      max-width: 1050px;
      /* Limit max width */
      height: auto;
      min-height: 80px;
      padding: 20px 30px;
      margin: 0 auto 30px;
      /* Center horizontally */
      display: block;
      font-size: 1.2rem;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #4facfe 0%, #00c6ff 100%);
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      line-height: 1.4;
    }

    .go-btn:hover {
      background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
    }

    .go-btn:active {
      transform: translateY(-1px);
    }

    /* ==================== RESPONSIVE FIXES ==================== */

    /* Desktop view */
    @media (min-width: 992px) {
      #month-section .row.g-2 {
        gap: 15px !important;
      }

      #month-section .col-2 {
        flex: 0 0 auto;
        width: auto;
      }

      .go-btn {
        width: 7000px;
        min-height: 100px;
        font-size: 1.3rem;
      }
    }

    /* Tablet view */
    @media (max-width: 991px) and (min-width: 577px) {
      #month-section .col-2 {
        width: 48%;
        margin-bottom: 10px;
      }

      .go-btn {
        width: 90%;
        min-height: 90px;
      }
    }

    /* Mobile view */
    @media (max-width: 576px) {

      /* Stack Academic Year dropdowns */
      #month-section .col-2 {
        width: 100%;
        margin-bottom: 10px;
      }

      #month-section .row.g-2 {
        gap: 0 !important;
      }

      /* Full width button on mobile */
      .go-btn {
        width: 100%;
        min-height: 70px;
        padding: 15px 20px;
        margin-bottom: 20px;
        font-size: 1.1rem;
        border-radius: 12px;
      }

      /* Smaller alert text on mobile */
      .alert.mb-0.py-2 {
        font-size: 0.85rem;
        padding: 8px 12px !important;
      }

      /* Fix navbar overlap */
      body {
        padding-top: 65px;
        /* Slightly more space */
      }

      #camera-section {
        margin-top: 15px;
      }
    }

    /* Extra small devices */
    @media (max-width: 400px) {
      .go-btn {
        font-size: 1rem;
        min-height: 60px;
        padding: 12px 15px;
      }

      .go-btn::before {
        font-size: 1.1rem;
      }
    }

    /* ==================== NAVBAR Z-INDEX FIX ==================== */

    /* Ensure navbar stays on top */
    .navbar.fixed-top {
      z-index: 1030;
      /* Bootstrap default, but explicitly set */
    }

    /* All content below navbar */
    .container.py-4 {
      position: relative;
      z-index: 1;
    }

    /* ==================== ALIGNMENT & SPACING IMPROVEMENTS ==================== */

    /* Better section spacing */
    .nav-section {
      margin-bottom: 25px;
      scroll-margin-top: 90px;
      /* Account for fixed navbar */
    }

    /* Section cards - consistent padding */
    .section-card {
      padding: 25px;
    }

    @media (max-width: 576px) {
      .section-card {
        padding: 15px;
      }
    }

    /* Calendar container spacing */
    #calendarContainer {
      margin-top: 25px !important;
      padding: 20px;
      background: #fafafa;
      border-radius: 10px;
    }

    /* Better form control heights */
    .form-select,
    .form-control {
      height: 38px;
      padding: 6px 12px;
    }

    .form-select-sm {
      height: 32px;
      padding: 4px 10px;
      font-size: 0.875rem;
    }

    /* ==================== LEAVE APPLICATION STYLES ==================== */

    /* Leave Header Hover Effect */
    .leave-header:hover {
      background: #f8f9fa;
    }

    .leave-header:active {
      background: #e9ecef;
    }

    /* Leave Status Badges */
    .leave-status-pending {
      background: #ffc107;
      color: #000;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .leave-status-approved {
      background: #28a745;
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .leave-status-rejected {
      background: #dc3545;
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* Leave Reason Text */
    .leave-reason-text {
      font-size: 0.9rem;
      color: #6c757d;
      font-style: italic;
    }

    /* On Leave Badge (for attendance table) */
    .on-leave-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    /* Leave Note in Defaulter List */
    .leave-note {
      background: #e7f3ff;
      border-left: 3px solid #667eea;
      padding: 8px 12px;
      margin-top: 5px;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .leave-note i {
      color: #667eea;
    }

    /* Leave Action Buttons */
    .leave-action-btn {
      padding: 4px 10px;
      font-size: 0.85rem;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .leave-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Leave Table Row Highlighting */
    .leave-row-pending {
      background-color: #fff9e6;
    }

    .leave-row-approved {
      background-color: #e8f5e9;
    }

    .leave-row-rejected {
      background-color: #ffebee;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #leaveContent .table {
        font-size: 0.85rem;
      }

      .leave-action-btn {
        font-size: 0.75rem;
        padding: 3px 8px;
      }
    }
  </style>
</head>

<body>

  <!-- Navigation Bar (Update links) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-calendar-check me-2"></i>Smart Attendance
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item teacher-only">
            <a class="nav-link" href="#department-section"><i class="bi bi-building me-1"></i>Departments</a>
          </li>
          <li class="nav-item teacher-only">
            <a class="nav-link" href="#course-section"><i class="bi bi-journal-bookmark me-1"></i>Courses</a>
          </li>
          <li class="nav-item teacher-only">
            <a class="nav-link" href="#subject-section"><i class="bi bi-book me-1"></i>Subjects</a>
          </li>
          <li class="nav-item teacher-only">
            <a class="nav-link" href="#selection-section"><i class="bi bi-check-square me-1"></i>Selection</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#month-section"><i class="bi bi-calendar3 me-1"></i>Academic Year</a>
          </li>
          <li class="nav-item teacher-only">
            <a class="nav-link" href="#upload-section"><i class="bi bi-upload me-1"></i>Upload</a>
          </li>
          <li class="nav-item teacher-only">
            <a class="nav-link" href="#leave-section"><i class="bi bi-calendar-x me-1"></i>Leave</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#attendance-section"><i class="bi bi-table me-1"></i>Attendance</a>
          </li>
          <li class="nav-item teacher-only">
            <a class="nav-link" href="#defaulter-section"><i class="bi bi-exclamation-triangle me-1"></i>Defaulters</a>
          </li>
        </ul>
        <div class="d-flex align-items-center">
          <span class="badge bg-light text-dark me-2" id="navSubjectBadge">No Subject</span>
          <span class="badge bg-warning text-dark" id="navMonthBadge">No Month</span>
        </div>
      </div>
    </div>
  </nav>


  <!-- Quick Navigation (Right Side) -->
  <div class="quick-nav d-none d-lg-block">
    <a href="#department-section" class="teacher-only"><i class="bi bi-building"></i></a>
    <a href="#course-section" class="teacher-only"><i class="bi bi-journal-bookmark"></i></a>
    <a href="#subject-section" class="teacher-only"><i class="bi bi-book"></i></a>
    <a href="#selection-section" class="teacher-only"><i class="bi bi-check-square"></i></a>
    <a href="#month-section"><i class="bi bi-calendar3"></i></a>
    <a href="#upload-section" class="teacher-only"><i class="bi bi-upload"></i></a>
    <a href="#leave-section" class="teacher-only"><i class="bi bi-calendar-x"></i></a>
    <a href="#attendance-section"><i class="bi bi-table"></i></a>
    <a href="#defaulter-section" class="teacher-only"><i class="bi bi-exclamation-triangle"></i></a>
  </div>

  <div class="container py-4">


    <!-- Info Box -->
    <div class="alert info-alert collapsed mb-4" id="infoBox">
      <h5><i class="bi bi-info-circle me-2"></i>How to Use</h5>
      <ol class="mb-0 info-content">
        <li><strong>Add Department</strong> - Create departments like Computer Science, Mechanical, etc.</li>
        <li><strong>Add Course</strong> - Select department and add courses like BTech, MTech, etc.</li>
        <li><strong>Add Subject</strong> - Select course and add subjects for that course</li>
        <li><strong>Select All</strong> - Choose Department, Course, Subject</li>
        <li><strong>Select Month & Academic Year</strong> - Choose academic year (FY/SY/TY), year, division, month</li>
        <li><strong>Upload CSV</strong> - Upload attendance file</li>
        <li><strong>Manage Attendance</strong> - View, edit, mark holidays, check defaulters</li>
      </ol>
    </div>


    <!-- SECTION 1: Department Management -->
    <section id="department-section" class="nav-section admin-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-building me-2"></i>Department Management</h4>

        <div class="admin-only">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Add New Department</label>
              <div class="input-group">
                <input type="text" id="newDepartmentInput" class="form-control" placeholder="Enter department name">
                <button id="addDepartmentBtn" class="btn btn-primary">
                  <i class="bi bi-plus-lg me-1"></i>Add
                </button>
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Select Department</label>
              <select id="departmentSelect" class="form-select">
                <option value="">-- Choose Department --</option>
              </select>
            </div>

            <div class="col-md-4 admin-only">
              <label class="form-label fw-bold">Actions</label>
              <div>
                <button id="deleteDepartmentBtn" class="btn btn-outline-danger">
                  <i class="bi bi-trash me-1"></i>Delete Selected
                </button>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-bold">Available Departments:</label>
            <div id="departmentTags">
              <span class="text-muted">No departments added yet. Add your first department above.</span>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3 mb-0" id="departmentStatus">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Current Department:</strong> <span id="currentDepartmentDisplay">None selected</span>
        </div>
      </div>
    </section>



    <!-- SECTION 2: Course Management -->
    <section id="course-section" class="nav-section admin-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-journal-bookmark me-2"></i>Course Management</h4>

        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Note:</strong> Please select a department first before adding courses.
        </div>

        <div class="admin-only">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Add New Course</label>
              <div class="input-group">
                <input type="text" id="newCourseInput" class="form-control" placeholder="Enter course name" disabled>
                <button id="addCourseBtn" class="btn btn-primary" disabled>
                  <i class="bi bi-plus-lg me-1"></i>Add
                </button>
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Select Course</label>
              <select id="courseSelect" class="form-select" disabled>
                <option value="">-- Choose Course --</option>
              </select>
            </div>

            <div class="col-md-4 admin-only">
              <label class="form-label fw-bold">Actions</label>
              <div>
                <button id="deleteCourseBtn" class="btn btn-outline-danger">
                  <i class="bi bi-trash me-1"></i>Delete Selected
                </button>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-bold">Available Courses for <span id="coursesDepartmentName">--</span>:</label>
            <div id="courseTags">
              <span class="text-muted">Select a department first.</span>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3 mb-0" id="courseStatus">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Current Course:</strong> <span id="currentCourseDisplay">None selected</span>
        </div>
      </div>
    </section>



    <!-- SECTION 3: Subject Management -->
    <section id="subject-section" class="nav-section admin-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-book me-2"></i>Subject Management</h4>

        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Note:</strong> Please select a course first before adding subjects.
        </div>

        <div class="admin-only">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Add New Subject</label>
              <div class="input-group">
                <input type="text" id="newSubjectInput" class="form-control" placeholder="Enter subject name" disabled>
                <button id="addSubjectBtn" class="btn btn-primary" disabled>
                  <i class="bi bi-plus-lg me-1"></i>Add
                </button>
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Select Subject</label>
              <select id="subjectSelect" class="form-select" disabled>
                <option value="">-- Choose Subject --</option>
              </select>
            </div>

            <div class="col-md-4 admin-only">
              <label class="form-label fw-bold">Actions</label>
              <div>
                <button id="deleteSubjectBtn" class="btn btn-outline-danger">
                  <i class="bi bi-trash me-1"></i>Delete Selected
                </button>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-bold">Available Subjects for <span id="subjectsCourseName">--</span>:</label>
            <div id="subjectTags">
              <span class="text-muted">Select a course first.</span>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3 mb-0" id="subjectStatus">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Current Subject:</strong> <span id="currentSubjectDisplay">None selected</span>
        </div>
      </div>
    </section>



    <!-- SECTION 4: Final Selection -->
    <section id="selection-section" class="nav-section teacher-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-check-square me-2"></i>Final Selection</h4>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">Department</label>
            <select id="finalDepartmentSelect" class="form-select">
              <option value="">-- Choose Department --</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Course</label>
            <select id="finalCourseSelect" class="form-select" disabled>
              <option value="">-- Choose Course --</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Subject</label>
            <select id="finalSubjectSelect" class="form-select" disabled>
              <option value="">-- Choose Subject --</option>
            </select>
          </div>
        </div>

        <div class="alert alert-success mt-3 mb-0">
          <strong><i class="bi bi-check-circle me-2"></i>Selected Path:</strong>
          <div class="mt-2">
            <span class="badge bg-primary me-2" id="selectedPathDept">No Department</span>
            <i class="bi bi-arrow-right me-2"></i>
            <span class="badge bg-primary me-2" id="selectedPathCourse">No Course</span>
            <i class="bi bi-arrow-right me-2"></i>
            <span class="badge bg-primary" id="selectedPathSubject">No Subject</span>
          </div>
        </div>
      </div>
    </section>



    <!-- SECTION 5: Month & Calendar (Modified) -->
    <section id="month-section" class="nav-section">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-calendar3 me-2"></i>Academic Year & Calendar</h4>

        <div>
          <div class="row g-2">
            <div class="col-2 teacher-only">
              <label class="form-label fw-bold small">Academic Year</label>
              <select id="academicYearLevelSelect" class="form-select form-select-sm">
                <option value="">-- Select --</option>
                <option value="FY">FY</option>
                <option value="SY">SY</option>
                <option value="TY">TY</option>
              </select>
            </div>


            <div class="col-2 teacher-only">
              <label class="form-label fw-bold small">Division</label>
              <select id="divisionSelect" class="form-select form-select-sm">
                <option value="">-- Select --</option>
                <option value="Division A">Div A</option>
                <option value="Division B">Div B</option>
                <option value="Division C">Div C</option>
              </select>
            </div>

            <div class="col-2">
              <label class="form-label fw-bold small">Month</label>
              <select id="monthSelect" class="form-select form-select-sm">
                <option value="0">Jan</option>
                <option value="1">Feb</option>
                <option value="2">Mar</option>
                <option value="3">Apr</option>
                <option value="4">May</option>
                <option value="5">Jun</option>
                <option value="6">Jul</option>
                <option value="7">Aug</option>
                <option value="8">Sep</option>
                <option value="9">Oct</option>
                <option value="10">Nov</option>
                <option value="11">Dec</option>
              </select>
            </div>

            <div class="col-2">
              <label class="form-label fw-bold small">Year Number</label>
              <select id="yearSelect" class="form-select form-select-sm"></select>
            </div>

            <div class="col-2">
              <label class="form-label fw-bold small">&nbsp;</label>
              <button id="applyMonthBtn" class="btn btn-success btn-sm w-100">
                <i class="bi bi-check-lg me-1"></i>Apply
              </button>
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-12">
            <div class="alert alert-success mb-0 py-2">
              <strong>Selected:</strong>
              <span id="currentAcademicDisplay">None</span>
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-12">
            <div class="alert alert-info mb-0 py-2">
              <strong>Month:</strong>
              <span id="currentMonthDisplay">None</span>
            </div>
          </div>
        </div>


        <!-- Calendar Grid (Same as before) -->
        <div id="calendarContainer" class="mt-4" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-calendar-week me-2"></i>Select Day</h5>
            <div class="teacher-only">
              <button id="toggleHolidayBtn" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-sun me-1"></i>Toggle Holiday
              </button>
              <button id="clearHolidaysBtn" class="btn btn-outline-secondary btn-sm ms-2">
                <i class="bi bi-x-circle me-1"></i>Clear All Holidays
              </button>
            </div>
          </div>

          <div class="day-grid mb-2">
            <div class="day-header">Sun</div>
            <div class="day-header">Mon</div>
            <div class="day-header">Tue</div>
            <div class="day-header">Wed</div>
            <div class="day-header">Thu</div>
            <div class="day-header">Fri</div>
            <div class="day-header">Sat</div>
          </div>
          <div id="dayGrid" class="day-grid"></div>

          <div class="row mt-3">
            <div class="col-md-6">
              <div class="alert alert-warning mb-0">
                <strong><i class="bi bi-sun me-1"></i>Holidays:</strong>
                <span id="holidayList">None</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="alert alert-info mb-0">
                <strong><i class="bi bi-calendar-check me-1"></i>Current Day:</strong>
                <span id="currentDayDisplay">None</span>
                <span id="holidayIndicator" class="badge bg-danger ms-2" style="display: none;">HOLIDAY</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>


    <!-- Statistics Section -->
    <section id="stats-section" class="nav-section">
      <div class="row g-3 mb-4">
        <div class="col-md-3 teacher-only">
          <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">Total Students</h6>
                <h3 class="mb-0" id="statsTotalStudents">0</h3>
              </div>
              <i class="bi bi-people fs-1 opacity-50"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3 teacher-only">
          <div class="stats-card success">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">Present Today</h6>
                <h3 class="mb-0" id="statsPresentToday">0</h3>
              </div>
              <i class="bi bi-check-circle fs-1 opacity-50"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3 teacher-only">
          <div class="stats-card danger">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">Absent Today</h6>
                <h3 class="mb-0" id="statsAbsentToday">0</h3>
              </div>
              <i class="bi bi-x-circle fs-1 opacity-50"></i>
            </div>
          </div>
        </div>

        <div class="col-md-3 teacher-only">
          <div class="stats-card warning">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">Working Days</h6>
                <h3 class="mb-0" id="statsWorkingDays">0</h3>
              </div>
              <i class="bi bi-calendar-date fs-1 opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Upload Section -->
    <section id="upload-section" class="nav-section teacher-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-upload me-2"></i>Upload Attendance</h4>

        <div class="row g-3">
          <div class="col-md-8">
            <div class="file-drop" id="fileDrop">
              <i class="bi bi-cloud-upload fs-1 text-primary"></i>
              <h5 class="mt-2">Drop CSV file here</h5>
              <p class="text-muted mb-2">or click to browse</p>
              <input type="file" id="fileInput" accept=".csv" style="display: none;">
              <button class="btn btn-primary" id="browseBtn">
                <i class="bi bi-folder2-open me-1"></i>Browse Files
              </button>
            </div>
            <div id="fileInfo" class="alert alert-info mt-2" style="display: none;"></div>
          </div>

          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header bg-light">
                <strong><i class="bi bi-file-earmark-text me-1"></i>CSV Format</strong>
              </div>
              <div class="card-body">
                <small>
                  <strong>Columns:</strong> ID, Name, Day1, Day2...Day31<br><br>
                  <strong>Example:</strong><br>
                  <code>1, YASH, Present, Absent, Present...</code><br>
                  <code>2, SHAM, Absent, Present, Present...</code>
                </small>
              </div>
              <div class="card-footer">
                <button id="downloadTemplateBtn" class="btn btn-outline-info btn-sm w-100">
                  <i class="bi bi-download me-1"></i>Download Template
                </button>
              </div>
            </div>
          </div>
        </div>


        <div class="mt-3">
          <div class="row g-2">
            <div class="col-12 col-md-3">
              <button id="downloadReportBtn" class="btn btn-success btn-action w-100 teacher-only-inline">
                <i class="bi bi-file-earmark-arrow-down me-1"></i>Download Report
              </button>
            </div>
            <div class="col-12 col-md-3">
              <button id="clearAllBtn" class="btn btn-outline-danger btn-action w-100 admin-only-inline">
                <i class="bi bi-trash me-1"></i>Clear All Data
              </button>
            </div>
            <div class="col-12 col-md-3">
              <button id="debugSaveBtn" class="btn btn-warning btn-action w-100 admin-only-inline">
                <i class="bi bi-bug me-1"></i>DEBUG: Check Saved Data
              </button>
            </div>
            <div class="col-12 col-md-3">
              <button id="generateQRBtn" class="btn btn-info btn-action w-100 teacher-only-inline">
                <i class="bi bi-qr-code me-1"></i>Generate QR
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SECTION: Leave Applications (Collapsible) -->
    <section id="leave-section" class="nav-section teacher-only">
      <div class="section-card">

        <!-- Collapsed Header (Clickable) -->
        <div class="d-flex justify-content-between align-items-center leave-header" id="leaveHeaderToggle"
          style="cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s;">
          <div>
            <h4 class="section-title mb-0" style="display: inline-block; border: none; padding: 0;">
              <i class="bi bi-calendar-x me-2"></i>Leave Applications
            </h4>
            <span class="badge bg-warning text-dark ms-2" id="leavePendingCount" style="display: none;">0</span>
            <span class="badge bg-success text-white ms-1" id="leaveApprovedCount" style="display: none;">0</span>
          </div>
          <i class="bi bi-chevron-down fs-4 text-muted" id="leaveToggleIcon"></i>
        </div>

        <!-- Expandable Content (Hidden by default) -->
        <div id="leaveContent" style="display: none; margin-top: 20px;">

          <!-- Submit Button & Filters -->
          <div class="row mb-3 align-items-end">
            <div class="col-md-3">
              <button class="btn btn-primary w-100" id="openLeaveFormBtn">
                <i class="bi bi-plus-circle me-1"></i>Submit New Leave
              </button>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold small">Filter by Status</label>
              <select id="leaveStatusFilter" class="form-select form-select-sm">
                <option value="all">All Applications</option>
                <option value="pending">Pending Only</option>
                <option value="approved">Approved Only</option>
                <option value="rejected">Rejected Only</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold small">Filter by Month</label>
              <select id="leaveMonthFilter" class="form-select form-select-sm">
                <option value="current">Current Month</option>
                <option value="all">All Months</option>
              </select>
            </div>
            <div class="col-md-3">
              <button class="btn btn-outline-secondary btn-sm w-100" id="refreshLeavesBtn">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
              </button>
            </div>
          </div>

          <!-- Leave Applications Table -->
          <div class="table-responsive">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th width="8%">ID</th>
                  <th width="15%">Student Name</th>
                  <th width="12%">From</th>
                  <th width="12%">To</th>
                  <th width="8%">Days</th>
                  <th width="20%">Reason</th>
                  <th width="10%">Status</th>
                  <th width="15%">Actions</th>
                </tr>
              </thead>
              <tbody id="leaveTableBody">
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-2"></i>
                    <p class="mt-2 mb-0">No leave applications yet</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </section>


    <section id="camera-section" class="nav-section">
      <button class="go-btn" onclick="window.location.href='face-recognition.html'">
        Attendance Section
      </button>
    </section>
    <!-- Attendance Section -->
    <section id="attendance-section" class="nav-section">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-table me-2"></i>Attendance Table</h4>

        <!-- Day Navigation -->
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">Select Day</label>
            <select id="dateSelect" class="form-select" disabled>
              <option value="">-- Select month first --</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">Navigation</label>
            <div class="btn-group w-100">
              <button id="prevDayBtn" class="btn btn-outline-primary" disabled>
                <i class="bi bi-chevron-left"></i> Previous
              </button>
              <button id="nextDayBtn" class="btn btn-outline-primary" disabled>
                Next <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
          <div class="col-md-4"> <!-- ✅ REMOVED teacher-only from div -->
            <label class="form-label fw-bold teacher-only">Quick Actions</label> <!-- ✅ MOVED to label -->
            <div class="btn-group w-100 teacher-only"> <!-- ✅ MOVED to buttons container -->
              <button id="markAllPresentBtn" class="btn btn-outline-success">All Present</button>
              <button id="markAllAbsentBtn" class="btn btn-outline-danger">All Absent</button>
            </div>
          </div>
        </div>
        <div class="teacher-only">
          <div class="row g-2 mb-3">
            <div class="col-12 col-sm-6 col-md-3">
              <div class="input-group input-group-sm">
                <input type="text" id="searchInput" class="form-control" placeholder="Search ID/Name">
                <button id="searchBtn" class="btn btn-outline-primary">
                  <i class="bi bi-search"></i>
                </button>
                <button id="resetSearchBtn" class="btn btn-outline-secondary">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <select id="sortSelect" class="form-select form-select-sm">
                <option value="">Sort by...</option>
                <option value="id-asc">ID (Low→High)</option>
                <option value="id-desc">ID (High→Low)</option>
                <option value="name-asc">Name (A→Z)</option>
                <option value="name-desc">Name (Z→A)</option>
                <option value="attendance-asc">Attend % (Low→High)</option>
                <option value="attendance-desc">Attend % (High→Low)</option>
              </select>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <select id="filterSelect" class="form-select form-select-sm">
                <option value="all">Show All</option>
                <option value="present">Present Only</option>
                <option value="absent">Absent Only</option>
                <option value="defaulter">Defaulters Only</option>
              </select>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <button id="refreshTableBtn" class="btn btn-outline-primary btn-sm w-100">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
              </button>
            </div>
          </div>
        </div>
        <!-- Table -->
        <div class="table-responsive table-container border rounded">
          <table id="attendanceTable" class="table table-hover mb-0">
            <thead class="table-light sticky-top">
              <tr>
                <th width="10%">ID</th>
                <th width="25%">Name</th>
                <th width="15%">Today</th>
                <th width="25%">Monthly Stats</th>
                <th width="25%" class="teacher-only">Actions</th>
              </tr>
            </thead>
            <tbody id="attendanceTableBody">
              <tr>
                <td colspan="5" class="text-center text-muted py-5">
                  <i class="bi bi-inbox fs-1"></i>
                  <p class="mt-2">No data loaded. Please select a subject, month, and upload a CSV file.</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Summary -->
        <div class="d-flex justify-content-between align-items-center mt-3 p-3 bg-light rounded teacher-only">
          <div>
            <strong>Total:</strong> <span id="summaryTotal" class="badge bg-primary">0</span>
            <strong class="ms-3">Present:</strong> <span id="summaryPresent" class="badge bg-success">0</span>
            <strong class="ms-3">Absent:</strong> <span id="summaryAbsent" class="badge bg-danger">0</span>
          </div>
          <div>
            <strong>Attendance Rate:</strong> <span id="summaryRate" class="badge bg-info">0%</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Defaulter Section -->
    <section id="defaulter-section" class="nav-section teacher-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-exclamation-triangle me-2"></i>Defaulter Management</h4>

        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label fw-bold">Minimum Attendance Threshold</label>
            <div class="input-group">
              <input type="number" id="thresholdInput" class="form-control" value="75" min="0" max="100">
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="col-md-3">
            <button id="showDefaultersBtn" class="btn btn-danger btn-action w-100">
              <i class="bi bi-list-ul me-1"></i>Show Defaulters
            </button>
          </div>
          <div class="col-md-3">
            <button id="exportDefaultersBtn" class="btn btn-outline-danger btn-action w-100">
              <i class="bi bi-download me-1"></i>Export Defaulters
            </button>
          </div>
          <div class="col-md-3">
            <div class="alert alert-danger mb-0 py-2 text-center">
              <strong>Defaulters:</strong> <span id="defaulterCount">0</span>
            </div>
          </div>
        </div>

        <!-- Defaulter Table -->
        <div id="defaulterTableContainer" class="mt-4" style="display: none;">
          <h5><i class="bi bi-people me-2"></i>Defaulter List</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-danger">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Present Days</th>
                  <th>Absent Days</th>
                  <th>Working Days</th>
                  <th>Attendance %</th>
                </tr>
              </thead>
              <tbody id="defaulterTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- Defaulter Modal -->
  <div class="modal fade" id="defaulterModal" tabindex="-1" aria-labelledby="defaulterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header modal-header-custom">
          <h5 class="modal-title" id="defaulterModalLabel">
            <i class="bi bi-exclamation-triangle me-2"></i>Defaulters Report
          </h5>
          <button type="button" class="btn-close btn-close-white" id="modalCloseBtn" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-4">
              <strong>Subject:</strong> <span id="modalSubject">-</span>
            </div>
            <div class="col-4">
              <strong>Month:</strong> <span id="modalMonth">-</span>
            </div>
            <div class="col-4">
              <strong>Threshold:</strong> <span id="modalThreshold">75%</span>
            </div>
          </div>

          <div id="modalDefaulterContent">
            <table class="table table-striped">
              <thead class="table-danger">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Present</th>
                  <th>Absent</th>
                  <th>Working Days</th>
                  <th>Attendance %</th>
                </tr>
              </thead>
              <tbody id="modalDefaulterTableBody"></tbody>
            </table>
          </div>

          <div id="noDefaultersAlert" class="alert alert-success" style="display: none;">
            <i class="bi bi-emoji-smile me-2"></i>
            Great! No defaulters found. All students have attendance above the threshold.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="modalCloseBtnFooter">Close</button>
          <button type="button" class="btn btn-danger" id="modalExportBtn">
            <i class="bi bi-download me-1"></i>Export to CSV
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
      <div class="modal-content">
        <div class="modal-header"
          style="background: linear-gradient(135deg, #D4E8F5 0%, #C4DFF0 100%); color: #3A6A8A;">
          <h5 class="modal-title" id="qrModalLabel"><i class="bi bi-qr-code me-2"></i>QR Code – Attendance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center p-4">
          <!-- QR Status Timer -->
          <div id="qrStatus" class="alert alert-success mb-3" style="display:none;">
            ✅ Active - Expires in: <span id="qrTimer">10:00</span>

          </div>
          <!-- Dynamic Security Code -->
          <div id="qrDynamicCodeDisplay" class="alert alert-warning mb-3" style="display:none;">
            🔐 Security Code: <span id="qrDynamicCode"
              style="font-family: monospace; font-size: 1.5rem; font-weight: bold;">----</span>
            <br>
            Refreshes in <span id="qrCountdown">8</span>s
          </div>
          <!-- Validation warning (shown when fields missing) -->
          <div id="qrValidationAlert" class="alert alert-warning mb-3" style="display:none; font-size:0.85rem;">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <span id="qrValidationMsg"></span>
          </div>

          <!-- QR image container -->
          <div id="qrCodeContainer" class="d-flex justify-content-center mb-3"></div>

          <!-- Path badges showing what's encoded -->
          <div id="qrPathBadges" class="mb-2">
            <span class="badge bg-primary me-1" id="qrBadgeDept">—</span>
            <i class="bi bi-chevron-right text-muted" style="font-size:0.7rem;"></i>
            <span class="badge bg-primary me-1" id="qrBadgeCourse">—</span>
            <i class="bi bi-chevron-right text-muted" style="font-size:0.7rem;"></i>
            <span class="badge bg-success me-1" id="qrBadgeSubject">—</span>
          </div>
          <div class="mb-3 d-none">
            <span class="badge bg-secondary me-1" id="qrBadgeAcYear">—</span>
            <span class="badge bg-secondary me-1" id="qrBadgeDiv">—</span>
            <span class="badge bg-warning text-dark me-1" id="qrBadgeMonth">—</span>
            <span class="badge bg-warning text-dark" id="qrBadgeDay">—</span>
          </div>

          <small class="text-muted">Scan this on the Face Recognition page to set the division and mark
            attendance.</small>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
            <i class="bi bi-x me-1"></i>Close
          </button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>

    // ==================== FIREBASE CLOUD STORAGE ====================
    let firebaseDB = null;
    let useCloud = false;

    // Initialize Firebase
    async function initFirebase() {
      try {
        if (typeof firebase === 'undefined') {
          console.warn('⚠️ Firebase not loaded, using IndexedDB only');
          return false;
        }

        firebaseDB = firebase.database();

        // Test connection
        await firebaseDB.ref('.info/connected').once('value');

        useCloud = true;
        console.log('✅ Firebase connected for main system');
        return true;
      } catch (error) {
        console.error('❌ Firebase connection failed:', error);
        useCloud = false;
        return false;
      }
    }
    function encodeFirebaseKey(key) {
      if (!key) return key;
      return String(key).replace(/\//g, '__');
    }

    function encodeNestedObject(obj) {
      if (!obj || typeof obj !== 'object') return obj;

      const encoded = {};
      for (const key in obj) {
        const encodedKey = encodeFirebaseKey(key);
        const value = obj[key];

        // If value is an object, encode it recursively
        if (value && typeof value === 'object' && !Array.isArray(value)) {
          encoded[encodedKey] = encodeNestedObject(value);
        } else {
          encoded[encodedKey] = value;
        }
      }
      return encoded;
    }

    function decodeNestedObject(obj) {
      if (!obj || typeof obj !== 'object') return obj;

      const decoded = {};
      for (const key in obj) {
        const decodedKey = decodeFirebaseKey(key);
        const value = obj[key];

        // If value is an object, decode it recursively
        if (value && typeof value === 'object' && !Array.isArray(value)) {
          decoded[decodedKey] = decodeNestedObject(value);
        } else {
          decoded[decodedKey] = value;
        }
      }
      return decoded;
    }
    function decodeFirebaseKey(key) {
      if (!key) return key;
      return String(key).replace(/__/g, '/');
    }
    // Save data (cloud + local hybrid)
    // Save data (FIREBASE FIRST, IndexedDB as backup)
    async function saveToStorage(key, data) {
      let firebaseSaved = false;
      let path;

      // ✅ GLOBAL KEYS (shared by all)
      const globalKeys = ['departments', 'courses', 'subjects', 'threshold'];

      // ✅ ENCODE DATA FOR FIREBASE (fix "/" in keys)
      let firebaseData = data;
      if (key === 'subjects' || key === 'courses') {
        firebaseData = encodeNestedObject(data);
      }

      // ✅ DIVISION-SPECIFIC KEYS (stored in division path)
      const divisionSpecificKeys = [
        'selectedDepartment',
        'selectedCourse',
        'selectedSubject',
        'selectedMonth',
        'selectedYear',
        'currentDay',
        'selectedAcademicYear',  // Store in division path
        'selectedDivision'       // Store in division path
      ];

      if (globalKeys.includes(key)) {
        // Save to global path
        path = `mainSystem/${key}`;
      }
      else if (divisionSpecificKeys.includes(key)) {
        // Save to division-specific path
        const year = appState.selectedYear || new Date().getFullYear();
        const dept = appState.selectedDepartment;
        const course = appState.selectedCourse;
        const academicYear = appState.selectedAcademicYear;
        const division = appState.selectedDivision;

        if (!dept || !course || !academicYear || !division) {
          console.warn(`⚠️ Cannot save ${key}: division path incomplete. Saving to IndexedDB only.`);
          // Save to IndexedDB as fallback
          try {
            await saveToDatabase(key, data);
          } catch (error) {
            console.warn(`⚠️ IndexedDB save failed for ${key}:`, error);
          }
          return;
        }

        path = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/${key}`;
      }
      else if (key === 'attendanceData') {
        // Full attendance data structure saves to root
        path = `mainSystem/attendanceData`;
      }
      else if (key === 'holidays') {
        // Holidays save to current month path (shared by all divisions)
        const year = appState.selectedYear || new Date().getFullYear();
        const dept = appState.selectedDepartment;
        const course = appState.selectedCourse;
        const academicYear = appState.selectedAcademicYear;
        const division = appState.selectedDivision;
        const monthKey = getMonthKey();

        if (!dept || !course || !academicYear || !division || !monthKey) {
          console.warn(`⚠️ Cannot save holidays: path incomplete`);
          await saveToDatabase(key, data);
          return;
        }

        path = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/holidays`;
      }
      else {
        // Default to global
        path = `mainSystem/${key}`;
      }

      // Try Firebase FIRST
      if (useCloud && firebaseDB) {
        try {
          await firebaseDB.ref(path).set(firebaseData);  // ✅ Use encoded data
          console.log(`✅ Saved to Firebase: ${path}`);
          firebaseSaved = true;
        } catch (error) {
          console.error(`❌ Firebase save failed for ${key}:`, error);
        }
      }

      // Backup to IndexedDB
      try {
        await saveToDatabase(key, data);
        console.log(`📂 Backup to IndexedDB: ${key}`);
      } catch (error) {
        console.warn(`⚠️ IndexedDB backup failed for ${key}:`, error);
      }

      if (!firebaseSaved && !useCloud) {
        console.warn(`⚠️ Firebase not connected, using IndexedDB only`);
      }
    }
    // After successful login, read user's division attributes
    async function initializeMainSystemForStudent() {
      try {
        const user = await getCurrentUser();
        const attributes = await getUserAttributes();

        // Extract custom attributes
        const department = attributes['custom:department'];
        const course = attributes['custom:course'];
        const academicYear = attributes['custom:academicYear'];
        const division = attributes['custom:division'];

        if (department && course && academicYear && division) {
          // Auto-populate and LOCK the dropdowns
          document.getElementById('departmentSelect').value = department;
          document.getElementById('departmentSelect').disabled = true;

          // Load courses for this department
          await loadCoursesForDepartment(department);
          document.getElementById('courseSelect').value = course;
          document.getElementById('courseSelect').disabled = true;

          document.getElementById('academicYearSelect').value = academicYear;
          document.getElementById('academicYearSelect').disabled = true;

          document.getElementById('divisionSelect').value = division;
          document.getElementById('divisionSelect').disabled = true;

          console.log('✅ Student division locked:', { department, course, academicYear, division });

          // Load their attendance data
          await loadAttendanceForDivision();
        } else {
          console.warn('⚠️ Student missing division attributes');
        }

      } catch (error) {
        console.error('Error initializing student:', error);
      }
    }
    // Load data (FIREBASE FIRST, fallback to IndexedDB)
    async function loadFromStorage(key) {
      let path;

      // ✅ GLOBAL KEYS
      const globalKeys = ['departments', 'courses', 'subjects', 'threshold'];

      // ✅ DIVISION-SPECIFIC KEYS
      const divisionSpecificKeys = [
        'selectedDepartment',
        'selectedCourse',
        'selectedSubject',
        'selectedMonth',
        'selectedYear',
        'currentDay',
        'selectedAcademicYear',
        'selectedDivision'
      ];

      if (globalKeys.includes(key)) {
        path = `mainSystem/${key}`;
      }
      else if (divisionSpecificKeys.includes(key)) {
        const year = appState.selectedYear || new Date().getFullYear();
        const dept = appState.selectedDepartment;
        const course = appState.selectedCourse;
        const academicYear = appState.selectedAcademicYear;
        const division = appState.selectedDivision;

        if (!dept || !course || !academicYear || !division) {
          console.warn(`⚠️ Cannot load ${key}: division path incomplete. Loading from IndexedDB.`);
          // Load from IndexedDB as fallback
          try {
            const localData = await loadFromDatabase(key);
            if (localData !== null) {
              console.log(`📂 Loaded from IndexedDB: ${key}`);
              return localData;
            }
          } catch (error) {
            console.error(`❌ IndexedDB load failed for ${key}:`, error);
          }
          return null;
        }

        path = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/${key}`;
      }
      else if (key === 'attendanceData') {
        path = `mainSystem/attendanceData`;
      }
      else if (key === 'holidays') {
        const year = appState.selectedYear || new Date().getFullYear();
        const dept = appState.selectedDepartment;
        const course = appState.selectedCourse;
        const academicYear = appState.selectedAcademicYear;
        const division = appState.selectedDivision;
        const monthKey = getMonthKey();

        if (!dept || !course || !academicYear || !division || !monthKey) {
          console.warn(`⚠️ Cannot load holidays: path incomplete`);
          const localData = await loadFromDatabase(key);
          return localData;
        }

        path = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/holidays`;
      }
      else {
        path = `mainSystem/${key}`;
      }

      // Try Firebase first
      if (useCloud && firebaseDB) {
        try {
          const snapshot = await firebaseDB.ref(path).once('value');
          let cloudData = snapshot.val();

          if (cloudData !== null) {
            // ✅ DECODE DATA FROM FIREBASE
            if (key === 'subjects' || key === 'courses') {
              cloudData = decodeNestedObject(cloudData);
            }
            console.log(`✅ Loaded from Firebase: ${path}`);
            return cloudData;
          } else {
            console.log(`📂 No Firebase data for ${path}, trying IndexedDB...`);
          }
        } catch (error) {
          console.error(`❌ Firebase load failed for ${key}:`, error);
        }
      }

      // Fallback to IndexedDB
      try {
        const localData = await loadFromDatabase(key);
        if (localData !== null) {
          console.log(`📂 Loaded from IndexedDB: ${key}`);
          return localData;
        }
      } catch (error) {
        console.error(`❌ IndexedDB load failed for ${key}:`, error);
      }

      console.log(`⚠️ No data found for ${key}`);
      return null;
    }
    // ==================== END FIREBASE FUNCTIONS ====================

    // ==================== AUTHENTICATION CHECK ====================
    // ... your existing authentication code ...


    // ==================== AUTHENTICATION CHECK ====================
    async function checkAuthAndInit() {
      try {
        // Check if logged in
        const user = await getCurrentUser();

        if (!user) {
          // Not logged in - redirect to login
          window.location.href = 'index.html';
          return;
        }

        // Get role
        const role = await getUserRole();

        // Show user info
        console.log(`Logged in as: ${user.attributes.email} (${role})`);

        // ✅ FOR STUDENTS: Auto-populate and lock division fields
        if (role === 'student') {
          const attributes = await getUserAttributes();

          const department = attributes['custom:department'];
          const course = attributes['custom:course'];
          const academicYear = attributes['custom:academicYear'];
          const division = attributes['custom:division'];

          if (department && course && academicYear && division) {
            // Set in appState
            appState.selectedDepartment = department;
            appState.selectedCourse = course;
            appState.selectedAcademicYear = academicYear;
            appState.selectedDivision = division;

            console.log('✅ Student division locked:', { department, course, academicYear, division });
          } else {
            console.warn('⚠️ Student missing division attributes');
            alert('Your account is missing division information. Please contact admin.');
          }
        }

        if (role === 'teacher') {
          console.log('🔄 Teacher login - Clearing session selections');

          // Clear from appState
          appState.selectedDepartment = null;
          appState.selectedCourse = null;
          appState.selectedSubject = null;
          appState.selectedAcademicYear = null;
          appState.selectedDivision = null;

          // Clear from storage
          await saveToStorage('selectedDepartment', null);
          await saveToStorage('selectedCourse', null);
          await saveToStorage('selectedSubject', null);
          await saveToStorage('selectedAcademicYear', null);
          await saveToStorage('selectedDivision', null);
        }

        // Continue with normal initialization
        initialize();

      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = 'index.html';
      }
    }

    // ==================== ROLE-BASED UI HIDING ====================
    async function applyRoleBasedUI() {
      try {
        const role = await getUserRole();
        console.log('Applying UI for role:', role);

        if (role === 'admin') {
          // Admin sees everything - no changes needed
          return;
        }

        if (role === 'teacher') {
          // Hide admin-only elements
          hideElements('.admin-only');
          hideElements('.admin-only-inline');

        } else if (role === 'student') {
          // Hide admin-only AND teacher-only elements
          hideElements('.admin-only');
          hideElements('.admin-only-inline');
          hideElements('.teacher-only');
          hideElements('.teacher-only-inline');
          hideElements('.hide-for-student');
          hideElements('.hide-for-student-inline');

          // Make table read-only
          makeTableReadOnly();
        }

      } catch (error) {
        console.error('Error applying role-based UI:', error);
      }
    }

    function hideElements(selector) {
      document.querySelectorAll(selector).forEach(el => {
        el.style.display = 'none';
      });
    }

    function makeTableReadOnly() {
      // ✅ Disable ONLY teacher-specific controls
      document.querySelectorAll('.teacher-only input, .teacher-only select, .teacher-only button').forEach(el => {
        el.disabled = true;
      });

      // ✅ Disable month/year/division/academic year selects for students
      elements.academicYearLevelSelect.disabled = false; // Keep academic year select enabled for students
      elements.divisionSelect.disabled = false;
      elements.monthSelect.disabled = false;
      elements.yearSelect.disabled = false;

      // ✅ EXPLICITLY ENABLE day navigation (force override)
      elements.prevDayBtn.disabled = false;
      elements.nextDayBtn.disabled = false;
      elements.dateSelect.disabled = false;

      // ✅ Make buttons visible and clickable for students
      elements.prevDayBtn.style.pointerEvents = 'auto';
      elements.nextDayBtn.style.pointerEvents = 'auto';
      elements.dateSelect.style.pointerEvents = 'auto';

      // ✅ Hide ONLY action buttons in table (NOT navigation)
      const style = document.createElement('style');
      style.id = 'student-readonly-styles';
      style.textContent = `
    /* Hide mark attendance buttons */
    .mark-present-btn, 
    .mark-absent-btn { 
      display: none !important; 
    }
    
    /* Hide teacher-only sections but NOT day navigation */
    .teacher-only:not(#prevDayBtn):not(#nextDayBtn):not(#dateSelect) { 
      display: none !important; 
    }
    
    /* Keep day navigation visible and clickable */
    #prevDayBtn, 
    #nextDayBtn, 
    #dateSelect {
      opacity: 1 !important;
      pointer-events: auto !important;
      display: inline-block !important;
    }
  `;

      // ✅ Only add if not already added
      if (!document.getElementById('student-readonly-styles')) {
        document.head.appendChild(style);
      }

      console.log('✅ Student read-only mode applied - day navigation enabled');
    }
    // Logout function (if you add logout button)
    async function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        await logout();
        window.location.href = 'index.html';
      }
    }

    // Call on page load
    window.addEventListener('DOMContentLoaded', checkAuthAndInit);

    // ==================== YOUR EXISTING CODE BELOW ====================
    async function initialize() {
      // Your existing initialization code...
      // Collapsible info box - click to toggle
      document.getElementById('infoBox').addEventListener('click', function () {
        this.classList.toggle('collapsed');
        this.classList.toggle('expanded');
      });
      await openDatabase();
      // ... rest of code
    }



    // ==================== INDEXEDDB SETUP ====================
    let db = null;
    let dbReady = false;

    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("SmartAttendanceDB", 1);

        request.onupgradeneeded = (event) => {
          db = event.target.result;
          if (!db.objectStoreNames.contains("appData")) {
            db.createObjectStore("appData", { keyPath: "key" });
          }
        };

        request.onsuccess = (event) => {
          db = event.target.result;
          dbReady = true;
          console.log("Database opened successfully");
          resolve(db);
        };

        request.onerror = (event) => {
          console.error("Database error:", event.target.error);
          reject(event.target.error);
        };
      });
    }

    function saveToDatabase(key, data) {
      return new Promise((resolve, reject) => {
        if (!dbReady) {
          console.warn("Database not ready");
          resolve();
          return;
        }

        try {
          const transaction = db.transaction(["appData"], "readwrite");
          const store = transaction.objectStore("appData");
          store.put({ key: key, value: data });

          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        } catch (error) {
          console.error("Save error:", error);
          reject(error);
        }
      });
    }

    function loadFromDatabase(key) {
      return new Promise((resolve, reject) => {
        if (!dbReady) {
          resolve(null);
          return;
        }

        try {
          const transaction = db.transaction(["appData"], "readonly");
          const store = transaction.objectStore("appData");
          const request = store.get(key);

          request.onsuccess = () => {
            resolve(request.result ? request.result.value : null);
          };
          request.onerror = () => reject(request.error);
        } catch (error) {
          console.error("Load error:", error);
          reject(error);
        }
      });
    }

    async function saveAllData() {
      try {
        if (appState.selectedYear === null && elements.yearSelect.value) {
          appState.selectedYear = parseInt(elements.yearSelect.value);
        }

        await saveToStorage("subjects", appState.subjects);
        await saveToStorage("selectedSubject", appState.selectedSubject);
        await saveToStorage("selectedMonth", appState.selectedMonth);
        await saveToStorage("selectedYear", appState.selectedYear);
        await saveToStorage("currentDay", appState.currentDay);
        await saveToStorage("attendanceData", appState.attendanceData);
        await saveToStorage("holidays", appState.holidays);
        await saveToStorage("threshold", appState.threshold);
        await saveToStorage("departments", appState.departments);
        await saveToStorage("selectedDepartment", appState.selectedDepartment);
        await saveToStorage("courses", appState.courses);
        await saveToStorage("selectedCourse", appState.selectedCourse);
        await saveToStorage("selectedAcademicYear", appState.selectedAcademicYear);
        await saveToStorage("selectedDivision", appState.selectedDivision);
        const currentDate = new Date().toDateString();
        await saveToStorage("currentDate", currentDate);
        console.log("All data saved (cloud + local)");
      } catch (error) {
        console.error("Failed to save data:", error);
      }
    }

    async function loadAllData() {
      try {
        // ✅ STEP 1: Load GLOBAL data first
        const departments = await loadFromStorage("departments");
        const courses = await loadFromStorage("courses");
        const subjects = await loadFromStorage("subjects");
        const threshold = await loadFromStorage("threshold");

        if (departments) appState.departments = departments;
        if (courses) appState.courses = courses;
        if (subjects) appState.subjects = subjects;
        if (threshold !== null) appState.threshold = threshold;

        // ✅ STEP 2: Load Academic Year & Division from IndexedDB (user's last choice)
        // These determine which division path to load from
        const selectedAcademicYear = await loadFromDatabase("selectedAcademicYear");
        const selectedDivision = await loadFromDatabase("selectedDivision");

        if (selectedAcademicYear) appState.selectedAcademicYear = selectedAcademicYear;
        if (selectedDivision) appState.selectedDivision = selectedDivision;

        // ✅ STEP 3: Now we can load division-specific data
        // (These will use the academic year & division set above)
        const selectedDepartment = await loadFromStorage("selectedDepartment");
        const selectedCourse = await loadFromStorage("selectedCourse");
        const selectedSubject = await loadFromStorage("selectedSubject");
        const selectedMonth = await loadFromStorage("selectedMonth");
        const selectedYear = await loadFromStorage("selectedYear");
        const currentDay = await loadFromStorage("currentDay");
        const attendanceData = await loadFromStorage("attendanceData");
        const holidays = await loadFromStorage("holidays");

        if (selectedDepartment) appState.selectedDepartment = selectedDepartment;
        if (selectedCourse) appState.selectedCourse = selectedCourse;
        if (selectedSubject) appState.selectedSubject = selectedSubject;
        if (selectedMonth !== null) appState.selectedMonth = selectedMonth;
        if (selectedYear !== null) appState.selectedYear = selectedYear;
        if (currentDay !== null) appState.currentDay = currentDay;
        if (attendanceData) appState.attendanceData = attendanceData;
        if (holidays) appState.holidays = holidays;

        console.log("All data loaded");
        return true;
      } catch (error) {
        console.error("Failed to load data:", error);
        return false;
      }
    }
    // ==================== APPLICATION STATE ====================
    const appState = {
      subjects: {},
      selectedSubject: null,
      selectedMonth: null,
      selectedYear: null,
      currentDay: 1,
      daysInMonth: 31,
      attendanceData: {},  // { "2025-01": { "Math": { "1": { _name: "YASH", 1: "Present", 2: "Absent" } } } }
      holidays: {},        // { "2025-01": [1, 15, 26] }
      threshold: 75,
      studentList: [],      // For current display
      departments: [],              // NEW
      selectedDepartment: null,     // NEW
      courses: {},                  // NEW: { "computer": ["bca", "btech"], "mechanical": [...] }
      selectedCourse: null,         // NEW
      selectedAcademicYear: null,   // NEW: "fy", "sy", or "ty"
      selectedDivision: null        // NEW: "A", "B", or "C"
    };


    function getCurrentSubjects() {
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;

      if (!dept || !course) return [];

      // ✅ Access nested structure: subjects[dept][course]
      if (!appState.subjects[dept]) return [];
      if (!appState.subjects[dept][course]) return [];

      return appState.subjects[dept][course];
    }
    let isUpdatingSubjectDropdown = false;
    let isUpdatingDayDropdown = false;

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];

    // ==================== DOM ELEMENTS ====================
    const elements = {
      // Department elements
      newDepartmentInput: document.getElementById('newDepartmentInput'),
      addDepartmentBtn: document.getElementById('addDepartmentBtn'),
      departmentSelect: document.getElementById('departmentSelect'),
      deleteDepartmentBtn: document.getElementById('deleteDepartmentBtn'),
      departmentTags: document.getElementById('departmentTags'),
      currentDepartmentDisplay: document.getElementById('currentDepartmentDisplay'),

      // Course elements
      newCourseInput: document.getElementById('newCourseInput'),
      addCourseBtn: document.getElementById('addCourseBtn'),
      courseSelect: document.getElementById('courseSelect'),
      deleteCourseBtn: document.getElementById('deleteCourseBtn'),
      courseTags: document.getElementById('courseTags'),
      coursesDepartmentName: document.getElementById('coursesDepartmentName'),
      currentCourseDisplay: document.getElementById('currentCourseDisplay'),

      // Final Selection elements
      finalDepartmentSelect: document.getElementById('finalDepartmentSelect'),
      finalCourseSelect: document.getElementById('finalCourseSelect'),
      finalSubjectSelect: document.getElementById('finalSubjectSelect'),
      selectedPathDept: document.getElementById('selectedPathDept'),
      selectedPathCourse: document.getElementById('selectedPathCourse'),
      selectedPathSubject: document.getElementById('selectedPathSubject'),

      // Academic Year & Division elements
      academicYearLevelSelect: document.getElementById('academicYearLevelSelect'),
      divisionSelect: document.getElementById('divisionSelect'),
      currentAcademicDisplay: document.getElementById('currentAcademicDisplay'),

      // Subject elements
      newSubjectInput: document.getElementById('newSubjectInput'),
      addSubjectBtn: document.getElementById('addSubjectBtn'),
      subjectSelect: document.getElementById('subjectSelect'),
      deleteSubjectBtn: document.getElementById('deleteSubjectBtn'),
      subjectTags: document.getElementById('subjectTags'),
      subjectsCourseName: document.getElementById('subjectsCourseName'),
      currentSubjectDisplay: document.getElementById('currentSubjectDisplay'),

      // Month elements
      monthSelect: document.getElementById('monthSelect'),
      yearSelect: document.getElementById('yearSelect'),
      applyMonthBtn: document.getElementById('applyMonthBtn'),
      currentMonthDisplay: document.getElementById('currentMonthDisplay'),
      calendarContainer: document.getElementById('calendarContainer'),
      dayGrid: document.getElementById('dayGrid'),

      // Holiday elements
      toggleHolidayBtn: document.getElementById('toggleHolidayBtn'),
      clearHolidaysBtn: document.getElementById('clearHolidaysBtn'),
      holidayList: document.getElementById('holidayList'),
      holidayIndicator: document.getElementById('holidayIndicator'),
      currentDayDisplay: document.getElementById('currentDayDisplay'),

      // Upload elements
      fileDrop: document.getElementById('fileDrop'),
      fileInput: document.getElementById('fileInput'),
      browseBtn: document.getElementById('browseBtn'),
      fileInfo: document.getElementById('fileInfo'),
      downloadTemplateBtn: document.getElementById('downloadTemplateBtn'),
      downloadReportBtn: document.getElementById('downloadReportBtn'),
      clearAllBtn: document.getElementById('clearAllBtn'),

      // Attendance table elements
      dateSelect: document.getElementById('dateSelect'),
      prevDayBtn: document.getElementById('prevDayBtn'),
      nextDayBtn: document.getElementById('nextDayBtn'),
      markAllPresentBtn: document.getElementById('markAllPresentBtn'),
      markAllAbsentBtn: document.getElementById('markAllAbsentBtn'),
      searchInput: document.getElementById('searchInput'),
      searchBtn: document.getElementById('searchBtn'),
      resetSearchBtn: document.getElementById('resetSearchBtn'),
      sortSelect: document.getElementById('sortSelect'),
      filterSelect: document.getElementById('filterSelect'),
      refreshTableBtn: document.getElementById('refreshTableBtn'),
      attendanceTableBody: document.getElementById('attendanceTableBody'),

      // Summary elements
      summaryTotal: document.getElementById('summaryTotal'),
      summaryPresent: document.getElementById('summaryPresent'),
      summaryAbsent: document.getElementById('summaryAbsent'),
      summaryRate: document.getElementById('summaryRate'),

      // Stats elements
      statsTotalStudents: document.getElementById('statsTotalStudents'),
      statsPresentToday: document.getElementById('statsPresentToday'),
      statsAbsentToday: document.getElementById('statsAbsentToday'),
      statsWorkingDays: document.getElementById('statsWorkingDays'),

      // Defaulter elements
      thresholdInput: document.getElementById('thresholdInput'),
      showDefaultersBtn: document.getElementById('showDefaultersBtn'),
      exportDefaultersBtn: document.getElementById('exportDefaultersBtn'),
      defaulterCount: document.getElementById('defaulterCount'),
      defaulterTableContainer: document.getElementById('defaulterTableContainer'),
      defaulterTableBody: document.getElementById('defaulterTableBody'),

      // Modal elements
      modalCloseBtn: document.getElementById('modalCloseBtn'),
      modalCloseBtnFooter: document.getElementById('modalCloseBtnFooter'),
      modalSubject: document.getElementById('modalSubject'),
      modalMonth: document.getElementById('modalMonth'),
      modalThreshold: document.getElementById('modalThreshold'),
      modalDefaulterTableBody: document.getElementById('modalDefaulterTableBody'),
      noDefaultersAlert: document.getElementById('noDefaultersAlert'),
      modalExportBtn: document.getElementById('modalExportBtn'),

      // Navbar badges
      navSubjectBadge: document.getElementById('navSubjectBadge'),
      navMonthBadge: document.getElementById('navMonthBadge')
    };

    // ==================== UTILITY FUNCTIONS ====================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getMonthKey() {
      if (appState.selectedMonth === null || appState.selectedYear === null) return null;
      return `${appState.selectedYear}-${String(appState.selectedMonth + 1).padStart(2, '0')}`;
      //Adds 1 for human format ✅
    }

    function getDaysInMonth(month, year) {
      return new Date(year, month + 1, 0).getDate();
    }

    function getFirstDayOfMonth(month, year) {
      return new Date(year, month, 1).getDay();
    }

    function formatDate(day) {
      if (appState.selectedMonth === null || appState.selectedYear === null) return 'None';
      return `${day} ${monthNames[appState.selectedMonth]} ${appState.selectedYear}`;
    }

    function normalizeStatus(status) {
      const s = String(status || '').trim().toLowerCase();
      if (s.startsWith('p') || s === '1' || s === 'yes' || s === 'y' || s === 'true') {
        return 'Present';
      }
      return 'Absent';
    }

    function showAlert(message, type = 'info') {
      alert(message);
    }

    // ==================== SUBJECT FUNCTIONS ====================
    function populateSubjectDropdown() {
      elements.subjectSelect.innerHTML = '<option value="">-- Choose Subject --</option>';
      elements.finalSubjectSelect.innerHTML = '<option value="">-- Choose Subject --</option>';

      elements.selectedPathDept.textContent = appState.selectedDepartment || 'No Department';
      elements.selectedPathCourse.textContent = appState.selectedCourse || 'No Course';
      elements.selectedPathSubject.textContent = appState.selectedSubject || 'No Subject';

      if (!appState.selectedCourse) {
        elements.subjectSelect.disabled = true;
        elements.finalSubjectSelect.disabled = true;
        return;
      }

      elements.subjectSelect.disabled = false;
      elements.finalSubjectSelect.disabled = false;

      // ✅ Get subjects for current course
      const subjectList = getCurrentSubjects();

      subjectList.forEach(subject => {
        const option1 = document.createElement('option');
        option1.value = subject;
        option1.textContent = subject;
        if (subject === appState.selectedSubject) {
          option1.selected = true;
        }
        elements.subjectSelect.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = subject;
        option2.textContent = subject;
        if (subject === appState.selectedSubject) {
          option2.selected = true;  // ✅ FIX: Set selected on BOTH dropdowns
        }
        elements.finalSubjectSelect.appendChild(option2);
      });
    }
    function renderSubjectTags() {
      if (!appState.selectedCourse) {
        elements.subjectTags.innerHTML = '<span class="text-muted">Select a course first.</span>';
        if (elements.subjectsCourseName) {
          elements.subjectsCourseName.textContent = '--';
        }
        return;
      }

      if (elements.subjectsCourseName) {
        elements.subjectsCourseName.textContent = appState.selectedCourse;
      }

      // ✅ Use helper function instead
      const subjectList = getCurrentSubjects();

      if (subjectList.length === 0) {
        elements.subjectTags.innerHTML = '<span class="text-muted">No subjects added yet. Add your first subject above.</span>';
        return;
      }

      elements.subjectTags.innerHTML = '';
      subjectList.forEach(subject => {
        const tag = document.createElement('span');
        tag.className = `subject-tag ${subject === appState.selectedSubject ? 'active' : ''}`;
        tag.innerHTML = `
      ${escapeHtml(subject)}
      <span class="delete-btn" data-subject="${escapeHtml(subject)}">&times;</span>
    `;

        tag.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-btn')) {
            selectSubject(subject);
          }
        });

        elements.subjectTags.appendChild(tag);
      });

      // Add delete event listeners
      document.querySelectorAll('.subject-tag .delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const subject = e.target.getAttribute('data-subject');
          deleteSubject(subject);
        });
      });
    }

    function addSubject(name) {
      name = String(name).trim();

      if (!name) {
        showAlert('Please enter a subject name!', 'warning');
        return false;
      }

      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;

      if (!dept || !course) {
        showAlert('Please select department and course first!', 'warning');
        return false;
      }

      // ✅ Create nested structure
      if (!appState.subjects[dept]) {
        appState.subjects[dept] = {};
      }
      if (!appState.subjects[dept][course]) {
        appState.subjects[dept][course] = [];
      }

      if (appState.subjects[dept][course].includes(name)) {
        showAlert('Subject already exists!', 'warning');
        return false;
      }

      appState.subjects[dept][course].push(name);

      populateSubjectDropdown();
      renderSubjectTags();
      saveAllData();

      showAlert(`Subject "${name}" added successfully!`, 'success');
      return true;
    }
    function selectSubject(name) {
      appState.selectedSubject = name;
      isUpdatingSubjectDropdown = true;
      elements.subjectSelect.value = name;
      elements.finalSubjectSelect.value = name;
      isUpdatingSubjectDropdown = false;

      updateSubjectDisplay();
      renderSubjectTags();
      updateFinalSelectionBadges();
      ensureSubjectStructureExists();
      // ✅ FIX: Force reload attendance data
      loadStudentList();  // Reload students first
      refreshAttendanceTable();  // Then refresh table
      updateStats();  // Update stats
      renderCalendarGrid();  // Update calendar

      saveAllData();

      // ✅ RELOAD leave applications when subject changes
      loadLeaveApplications();
    }

    function updateSubjectDisplay() {
      const subject = appState.selectedSubject || 'None selected';
      elements.currentSubjectDisplay.textContent = subject;
      elements.navSubjectBadge.textContent = appState.selectedSubject || 'No Subject';
    }

    // ==================== MONTH FUNCTIONS ====================
    function populateYearDropdown() {
      const currentYear = new Date().getFullYear();
      elements.yearSelect.innerHTML = '';

      for (let y = currentYear - 5; y <= currentYear + 5; y++) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        if (y === currentYear) option.selected = true;
        elements.yearSelect.appendChild(option);
      }
    }

    function applyMonth() {
      appState.selectedMonth = parseInt(elements.monthSelect.value);
      appState.selectedYear = parseInt(elements.yearSelect.value);
      appState.daysInMonth = getDaysInMonth(appState.selectedMonth, appState.selectedYear);
      appState.currentDay = 1;

      updateMonthDisplay();
      populateDayDropdown();
      renderCalendarGrid();
      updateHolidayDisplay();
      elements.calendarContainer.style.display = 'block';
      if (appState.selectedSubject) {
        ensureSubjectStructureExists();
      }

      refreshAttendanceTable();
      saveAllData();
      showAlert(`Month set to ${monthNames[appState.selectedMonth]} ${appState.selectedYear}`, 'success');

      loadLeaveApplications();
    }

    function updateMonthDisplay() {
      const display = appState.selectedMonth !== null
        ? `${monthNames[appState.selectedMonth]} ${appState.selectedYear} (${appState.daysInMonth} days)`
        : 'None';

      elements.currentMonthDisplay.textContent = display;
      elements.navMonthBadge.textContent = appState.selectedMonth !== null
        ? `${monthNames[appState.selectedMonth].substring(0, 3)} ${appState.selectedYear}`
        : 'No Month';
    }

    function populateDayDropdown() {
      elements.dateSelect.innerHTML = '';

      for (let day = 1; day <= appState.daysInMonth; day++) {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = formatDate(day);
        if (isHoliday(day)) {
          option.textContent += ' (Holiday)';
        }
        elements.dateSelect.appendChild(option);
      }

      elements.dateSelect.value = appState.currentDay;
      elements.dateSelect.disabled = false;
      updateDayNavigation();
    }

    function renderCalendarGrid() {
      elements.dayGrid.innerHTML = '';

      const firstDay = getFirstDayOfMonth(appState.selectedMonth, appState.selectedYear);
      const monthKey = getMonthKey();
      const subjectData = getSubjectData();

      // Empty cells before first day
      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.style.visibility = 'hidden';
        elements.dayGrid.appendChild(emptyCell);
      }

      // Day buttons
      for (let day = 1; day <= appState.daysInMonth; day++) {
        const dayBtn = document.createElement('div');
        dayBtn.className = 'day-btn';
        dayBtn.textContent = day;
        dayBtn.setAttribute('data-day', day);

        // Check if has data
        let hasData = false;
        if (subjectData) {
          for (const studentId in subjectData) {
            if (!studentId.startsWith('_') && subjectData[studentId][day]) {
              hasData = true;
              break;
            }
          }
        }

        if (isHoliday(day)) {
          dayBtn.classList.add('holiday');
        } else if (hasData) {
          dayBtn.classList.add('has-data');
        }

        if (day === appState.currentDay) {
          dayBtn.classList.add('active');
        }

        dayBtn.addEventListener('click', () => selectDay(day));
        elements.dayGrid.appendChild(dayBtn);
      }

      updateCurrentDayDisplay();
    }

    function selectDay(day) {
      // Validate input
      day = parseInt(day);

      if (isNaN(day) || day < 1 || day > appState.daysInMonth) {
        console.error('❌ Invalid day:', day);
        return;
      }

      // Prevent unnecessary updates
      if (appState.currentDay === day) {
        console.log('Already on day', day, '- skipping update');
        return;
      }

      console.log(`✅ selectDay: ${appState.currentDay} → ${day}`);

      appState.currentDay = day;
      isUpdatingDayDropdown = true;
      elements.dateSelect.value = day;
      isUpdatingDayDropdown = false;

      // Update calendar UI
      document.querySelectorAll('.day-btn').forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.getAttribute('data-day')) === day) {
          btn.classList.add('active');
        }
      });

      updateCurrentDayDisplay();
      updateDayNavigation();
      refreshAttendanceTable();
      saveAllData();
    }

    function updateCurrentDayDisplay() {
      elements.currentDayDisplay.textContent = formatDate(appState.currentDay);

      if (isHoliday(appState.currentDay)) {
        elements.holidayIndicator.style.display = 'inline';
      } else {
        elements.holidayIndicator.style.display = 'none';
      }
    }

    function updateDayNavigation() {
      elements.prevDayBtn.disabled = appState.currentDay <= 1;
      elements.nextDayBtn.disabled = appState.currentDay >= appState.daysInMonth;
    }

    // ==================== HOLIDAY FUNCTIONS ====================
    function getHolidaysForMonth() {
      const monthKey = getMonthKey();
      if (!monthKey) return [];
      return appState.holidays[monthKey] || [];
    }

    function isHoliday(day) {
      return getHolidaysForMonth().includes(day);
    }

    function toggleHoliday() {
      if (appState.selectedMonth === null) {
        showAlert('Please select a month first!', 'warning');
        return;
      }

      const monthKey = getMonthKey();
      if (!appState.holidays[monthKey]) {
        appState.holidays[monthKey] = [];
      }

      const day = appState.currentDay;
      const index = appState.holidays[monthKey].indexOf(day);

      if (index > -1) {
        appState.holidays[monthKey].splice(index, 1);
        showAlert(`Day ${day} unmarked as holiday`, 'info');
      } else {
        appState.holidays[monthKey].push(day);
        appState.holidays[monthKey].sort((a, b) => a - b);
        showAlert(`Day ${day} marked as holiday`, 'success');
      }

      updateHolidayDisplay();
      renderCalendarGrid();
      populateDayDropdown();
      refreshAttendanceTable();
      updateStats();
      saveAllData();
    }

    function clearAllHolidays() {
      if (!confirm('Clear all holidays for this month?')) return;

      const monthKey = getMonthKey();
      if (monthKey) {
        appState.holidays[monthKey] = [];
      }

      updateHolidayDisplay();
      renderCalendarGrid();
      populateDayDropdown();
      refreshAttendanceTable();
      updateStats();
      saveAllData();

      showAlert('All holidays cleared', 'info');
    }

    function updateHolidayDisplay() {
      const holidays = getHolidaysForMonth();
      if (holidays.length === 0) {
        elements.holidayList.textContent = 'None';
      } else {
        elements.holidayList.textContent = holidays.map(d => `Day ${d}`).join(', ');
      }
    }

    function getWorkingDays() {
      const subjectData = getSubjectData();

      if (!subjectData) return 0;

      const holidays = getHolidaysForMonth();
      const lectureDays = new Set();

      // ✅ CHECK ALL STUDENTS to find all lecture days
      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;

        const studentAttendance = subjectData[studentId];

        for (let day = 1; day <= appState.daysInMonth; day++) {
          // If ANY student has attendance data for this day, it's a lecture day
          if (studentAttendance[day] !== undefined) {
            lectureDays.add(day);
          }
        }
      }

      // Count lecture days that are NOT holidays
      let workingDays = 0;
      lectureDays.forEach(day => {
        if (!holidays.includes(day)) {
          workingDays++;
        }
      });

      return workingDays;
    }

    // ==================== FILE HANDLING ====================
    function parseCSV(text) {
      // Remove BOM
      text = text.replace(/^\ufeff/, '');

      const lines = text.split(/\r?\n/).filter(line => line.trim());
      const rows = [];

      for (const line of lines) {
        const cols = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            cols.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        cols.push(current.trim());
        rows.push(cols);
      }

      return rows;
    }

    function processCSVData(text) {
      if (!appState.selectedSubject) {
        throw new Error('Please select a subject first!');
      }

      if (appState.selectedMonth === null) {
        throw new Error('Please select a month first!');
      }

      // ✅ VALIDATE ALL REQUIRED FIELDS FOR 8-LEVEL STRUCTURE
      if (!appState.selectedDepartment) {
        throw new Error('Please select a department first!');
      }

      if (!appState.selectedCourse) {
        throw new Error('Please select a course first!');
      }

      if (!appState.selectedAcademicYear) {
        throw new Error('Please select an academic year (FY/SY/TY) first!');
      }

      if (!appState.selectedDivision) {
        throw new Error('Please select a division first!');
      }

      const rows = parseCSV(text);

      if (rows.length < 2) {
        throw new Error('CSV must have at least a header row and one data row');
      }

      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;
      const monthKey = getMonthKey();
      const subject = appState.selectedSubject;

      // ✅ CREATE 8-LEVEL NESTED STRUCTURE WITH PROPER NULL CHECKS
      if (!appState.attendanceData[year]) {
        appState.attendanceData[year] = {};
      }
      if (!appState.attendanceData[year][dept]) {
        appState.attendanceData[year][dept] = {};
      }
      if (!appState.attendanceData[year][dept][course]) {
        appState.attendanceData[year][dept][course] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear]) {
        appState.attendanceData[year][dept][course][academicYear] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear][division]) {
        appState.attendanceData[year][dept][course][academicYear][division] = {
          students: {},  // ✅ ADD THIS
          months: {}
        };
      }
      // ✅ Ensure students object exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].students) {
        appState.attendanceData[year][dept][course][academicYear][division].students = {};
      }
      // ✅ FIX: Check if months exists before accessing it
      if (!appState.attendanceData[year][dept][course][academicYear][division].months) {
        appState.attendanceData[year][dept][course][academicYear][division].months = {};
      }

      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey]) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey] = { subjects: {} };
      }

      // ✅ FIX: Check if subjects exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects = {};
      }

      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject]) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject] = { attendance: {} };
      }

      // ✅ FIX: Check if attendance exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance = {};
      }

      // ✅ NOW SAFE to get reference
      // ✅ NOW SAFE to get reference
      const attendanceRef = appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance;

      // ✅ GET OR CREATE MASTER STUDENT LIST at division level
      if (!appState.attendanceData[year][dept][course][academicYear][division].students) {
        appState.attendanceData[year][dept][course][academicYear][division].students = {};
      }
      const masterStudents = appState.attendanceData[year][dept][course][academicYear][division].students;

      let studentCount = 0;

      // Skip header row, process data rows
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (row.length < 2) continue;

        const id = String(row[0]).trim();
        const name = String(row[1]).trim();

        if (!id || !name) continue;

        // ✅ STORE IN MASTER STUDENT LIST (division level)
        if (!masterStudents[id]) {
          masterStudents[id] = { name: name };
        }

        attendanceRef[id] = { _name: name };

        // Parse daily attendance (columns 2 onwards)
        // ✅ ONLY store days that actually have data in CSV
        for (let day = 1; day <= appState.daysInMonth; day++) {
          const colIndex = day + 1;

          // ✅ Check if CSV has data for this day
          if (row[colIndex] !== undefined && row[colIndex].trim() !== '') {
            const status = normalizeStatus(row[colIndex]);
            attendanceRef[id][day] = status;
          }
          // ✅ Don't store anything if column is empty/missing
        }

        studentCount++;
      }

      console.log(`✅ Saved ${studentCount} students to division master list`);
      console.log(`✅ Saved attendance to: ${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/subjects/${subject}`);

      return studentCount;
    }
    function handleFileUpload(file) {
      if (!file) return;

      if (!file.name.endsWith('.csv')) {
        showAlert('Please upload a CSV file!', 'warning');
        return;
      }

      const reader = new FileReader();

      reader.onload = (event) => {
        try {
          const text = event.target.result;
          const studentCount = processCSVData(text);

          if (studentCount === 0) {
            showAlert('No valid student data found in CSV', 'warning');
            return;
          }

          elements.fileInfo.style.display = 'block';
          elements.fileInfo.innerHTML = `
            <i class="bi bi-check-circle text-success me-2"></i>
            <strong>Upload Successful!</strong><br>
            File: ${escapeHtml(file.name)}<br>
            Students: ${studentCount}<br>
            Subject: ${appState.selectedSubject}<br>
            Month: ${monthNames[appState.selectedMonth]} ${appState.selectedYear}
          `;

          renderCalendarGrid();
          refreshAttendanceTable();
          updateStats();
          saveAllData();

          // ✅ RESET FILE INPUT AFTER SUCCESSFUL UPLOAD
          elements.fileInput.value = '';
          console.log('✅ File input reset after successful upload');

          showAlert(`Successfully uploaded ${studentCount} students!`, 'success');
        } catch (error) {
          // ✅ ALSO RESET ON ERROR
          elements.fileInput.value = '';
          console.log('⚠️ File input reset after error');
          console.error('File processing error:', error);
          showAlert('Error: ' + error.message, 'danger');
        }
      };

      reader.onerror = () => {
        showAlert('Error reading file!', 'danger');
      };

      reader.readAsText(file);
    }
    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
    function downloadTemplate() {
      if (appState.selectedMonth === null) {
        showAlert('Please select a month first!', 'warning');
        return;
      }

      // ✅ ADD VALIDATION for context
      if (!appState.selectedDepartment || !appState.selectedCourse ||
        !appState.selectedAcademicYear || !appState.selectedDivision) {
        showAlert('Please select Department, Course, Academic Year, and Division first!', 'warning');
        return;
      }

      const headers = ['ID', 'Name'];
      for (let day = 1; day <= appState.daysInMonth; day++) {
        headers.push(`Day${day}`);
      }

      const sampleData = [
        headers,
        ['1', 'Student One', ...Array(appState.daysInMonth).fill('Present')],
        ['2', 'Student Two', ...Array(appState.daysInMonth).fill('Absent')],
        ['3', 'Student Three', ...Array(appState.daysInMonth).fill('Present')]
      ];

      const csv = sampleData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\r\n');

      // ✅ BETTER FILENAME with full context
      const filename = `template_${appState.selectedDepartment}_${appState.selectedCourse}_${appState.selectedAcademicYear}_${appState.selectedDivision}_${monthNames[appState.selectedMonth]}_${appState.selectedYear}.csv`;

      downloadFile(csv, filename);
    }

    function downloadReport() {
      if (!appState.selectedSubject) {
        showAlert('Please select a subject first!', 'warning');
        return;
      }

      if (appState.selectedMonth === null) {
        showAlert('Please select a month first!', 'warning');
        return;
      }

      if (!appState.selectedDepartment || !appState.selectedCourse ||
        !appState.selectedAcademicYear || !appState.selectedDivision) {
        showAlert('Please select Department, Course, Academic Year, and Division first!', 'warning');
        return;
      }

      const subjectData = getSubjectData();

      if (!subjectData || Object.keys(subjectData).filter(key => !key.startsWith('_')).length === 0) {
        showAlert('No attendance data found for this subject in this month! Please upload attendance data first.', 'warning');
        return;
      }

      const holidays = getHolidaysForMonth();

      const daysWithLectures = new Set();

      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;

        const studentAttendance = subjectData[studentId];

        for (let day = 1; day <= appState.daysInMonth; day++) {
          if (studentAttendance[day] !== undefined) {
            daysWithLectures.add(day);
          }
        }
      }

      const lectureDays = Array.from(daysWithLectures).sort((a, b) => a - b);

      if (lectureDays.length === 0) {
        showAlert('No lecture data found for this subject in this month!', 'warning');
        return;
      }

      // ✅ MODIFIED HEADERS - Add Leave Info Columns
      const headers = ['ID', 'Name'];

      lectureDays.forEach(day => {
        const isHoliday = holidays.includes(day);
        headers.push(`Day ${day}${isHoliday ? ' (H)' : ''}`);
      });

      headers.push('Present', 'Absent', 'Total Lectures', 'Percentage', 'Leave Applications', 'Leave Days Approved');

      const rows = [headers];

      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;

        const studentAttendance = subjectData[studentId];
        const studentName = studentAttendance._name || studentId;

        const row = [studentId, studentName];

        let present = 0;
        let absent = 0;

        lectureDays.forEach(day => {
          if (holidays.includes(day)) {
            row.push('Holiday');
          } else {
            const status = studentAttendance[day] || 'Absent';
            row.push(status);

            if (status === 'Present') {
              present++;
            } else {
              absent++;
            }
          }
        });

        const totalLectures = present + absent;
        const percentage = totalLectures > 0 ? Math.round((present / totalLectures) * 100) : 0;

        // ✅ ADD LEAVE INFO
        const leaveSummary = getStudentLeaveSummary(studentId);
        const leaveApps = leaveSummary ? leaveSummary.applications : 0;
        const leaveDays = leaveSummary ? leaveSummary.count : 0;

        row.push(present, absent, totalLectures, `${percentage}%`, leaveApps, leaveDays);
        rows.push(row);
      }

      const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\r\n');

      const filename = `report_${appState.selectedDepartment}_${appState.selectedCourse}_${appState.selectedAcademicYear}_${appState.selectedDivision}_${appState.selectedSubject}_${monthNames[appState.selectedMonth]}_${appState.selectedYear}.csv`;

      downloadFile(csv, filename);

      showAlert(`Report exported with ${lectureDays.length} lecture days and leave information`, 'success');
    }

    async function clearSelectedSubjectMonth() {
      if (!appState.selectedSubject) {
        showAlert('Please select a subject first!', 'warning');
        return;
      }

      if (appState.selectedMonth === null) {
        showAlert('Please select a month first!', 'warning');
        return;
      }

      if (!appState.selectedDepartment || !appState.selectedCourse ||
        !appState.selectedAcademicYear || !appState.selectedDivision) {
        showAlert('Please select Department, Course, Academic Year, and Division first!', 'warning');
        return;
      }

      const monthName = monthNames[appState.selectedMonth];
      const confirmMsg = `⚠️ DELETE ATTENDANCE DATA?\n\nThis will permanently remove attendance for:\n- Subject: ${appState.selectedSubject}\n- Month: ${monthName} ${appState.selectedYear}\n- Department: ${appState.selectedDepartment}\n- Course: ${appState.selectedCourse}\n- Academic Year: ${appState.selectedAcademicYear}\n- Division: ${appState.selectedDivision}\n\nThis action cannot be undone!`;

      if (!confirm(confirmMsg)) {
        return;
      }

      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;
      const monthKey = getMonthKey();
      const subject = appState.selectedSubject;

      // ✅ DELETE ONLY THE SELECTED SUBJECT'S ATTENDANCE FOR THIS MONTH
      try {
        if (appState.attendanceData?.[year]?.[dept]?.[course]?.[academicYear]?.[division]?.months?.[monthKey]?.subjects?.[subject]) {
          delete appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject];

          console.log(`🗑️ Deleted attendance data for: ${year}/${dept}/${course}/${academicYear}/${division}/${monthKey}/${subject}`);
        }

        // ✅ ALSO CLEAR HOLIDAYS FOR THIS MONTH (optional - only if you want to delete holidays too)
        if (appState.holidays[monthKey]) {
          appState.holidays[monthKey] = [];
          console.log(`🗑️ Cleared holidays for: ${monthKey}`);
        }

        // Refresh UI
        refreshAttendanceTable();
        updateStats();
        renderCalendarGrid();
        updateHolidayDisplay();

        await saveAllData();

        showAlert(`Attendance data cleared for ${appState.selectedSubject} in ${monthName} ${appState.selectedYear}!`, 'success');
      } catch (error) {
        console.error('Error clearing data:', error);
        showAlert('Error clearing data. Please try again.', 'danger');
      }
    }
    // ==================== ATTENDANCE TABLE FUNCTIONS ====================
    function getSubjectData() {
      const monthKey = getMonthKey();
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;

      // Validate all required fields
      if (!monthKey || !year || !dept || !course || !academicYear || !division || !appState.selectedSubject) {
        return null;
      }

      return appState.attendanceData
        ?.[year]
        ?.[dept]
        ?.[course]
        ?.[academicYear]
        ?.[division]
        ?.months
        ?.[monthKey]
        ?.subjects
        ?.[appState.selectedSubject]
        ?.attendance || null;
    }

    function ensureSubjectStructureExists() {
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;
      const monthKey = getMonthKey();
      const subject = appState.selectedSubject;

      // ❌ Exit if any required field is missing
      if (!year || !dept || !course || !academicYear || !division || !monthKey || !subject) {
        console.log('⚠️ Cannot create subject structure - context incomplete');
        return false;
      }

      // ✅ Build the full path step by step
      if (!appState.attendanceData[year]) {
        appState.attendanceData[year] = {};
      }
      if (!appState.attendanceData[year][dept]) {
        appState.attendanceData[year][dept] = {};
      }
      if (!appState.attendanceData[year][dept][course]) {
        appState.attendanceData[year][dept][course] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear]) {
        appState.attendanceData[year][dept][course][academicYear] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear][division]) {
        appState.attendanceData[year][dept][course][academicYear][division] = {
          students: {},  // ✅ Master student list
          months: {}
        };
      }

      // ✅ Ensure students object exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].students) {
        appState.attendanceData[year][dept][course][academicYear][division].students = {};
      }

      // ✅ Ensure months object exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].months) {
        appState.attendanceData[year][dept][course][academicYear][division].months = {};
      }

      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey]) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey] = {
          subjects: {}
        };
      }

      // ✅ Ensure subjects object exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects = {};
      }

      // ✅ Create THIS subject's structure if it doesn't exist
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject]) {
        console.log(`✅ Creating attendance structure for subject: ${subject}`);
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject] = {
          attendance: {}
        };
      }

      // ✅ Ensure attendance object exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance = {};
      }

      console.log(`✅ Subject structure exists: ${year}/${dept}/${course}/${academicYear}/${division}/${monthKey}/${subject}`);
      return true;
    }
    function getStudentStats(studentId) {
      const subjectData = getSubjectData();
      if (!subjectData || !subjectData[studentId]) {
        return { present: 0, absent: 0, workingDays: 0, percentage: 0 };
      }

      const student = subjectData[studentId];
      const holidays = getHolidaysForMonth();

      // ✅ FIND ALL LECTURE DAYS (from all students)
      const allLectureDays = new Set();
      for (const sid in subjectData) {
        if (sid.startsWith('_')) continue;
        const attendance = subjectData[sid];
        for (let day = 1; day <= appState.daysInMonth; day++) {
          if (attendance[day] !== undefined) {
            allLectureDays.add(day);
          }
        }
      }

      let present = 0;
      let absent = 0;

      // ✅ COUNT THIS STUDENT'S ATTENDANCE FOR ALL LECTURE DAYS
      allLectureDays.forEach(day => {
        // Skip holidays
        if (holidays.includes(day)) return;

        // Check this student's status
        if (student[day] === 'Present') {
          present++;
        } else if (student[day] === 'Absent') {
          absent++;
        } else {
          // ✅ Day has no data for this student → count as absent
          absent++;
        }
      });

      const workingDays = present + absent;
      const percentage = workingDays > 0 ? Math.round((present / workingDays) * 100) : 0;

      return { present, absent, workingDays, percentage };
    }

    function loadStudentList() {
      console.log('🔄 loadStudentList called (HYBRID version)');

      appState.studentList = [];

      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;

      // ✅ STEP 1: Try to load MASTER STUDENT LIST from division level (NEW WAY)
      let masterStudents = null;

      if (year && dept && course && academicYear && division) {
        masterStudents = appState.attendanceData
          ?.[year]
          ?.[dept]
          ?.[course]
          ?.[academicYear]
          ?.[division]
          ?.students || null;

        if (masterStudents && Object.keys(masterStudents).length > 0) {
          console.log(`✅ Found division master list: ${Object.keys(masterStudents).length} students`);
        }
      }

      // ✅ STEP 2: If master list exists, use it (NEW WAY)
      if (masterStudents && Object.keys(masterStudents).length > 0) {
        console.log('📊 Loading from DIVISION MASTER LIST');

        const subjectData = getSubjectData(); // Get current subject's attendance
        console.log('📊 Subject data:', subjectData ? 'EXISTS' : 'NULL');

        let count = 0;
        for (const studentId in masterStudents) {
          const masterStudent = masterStudents[studentId];

          // Get today's status from subject attendance (if available)
          let todayStatus = 'Absent'; // Default

          if (subjectData && subjectData[studentId]) {
            todayStatus = subjectData[studentId][appState.currentDay] || 'Absent';
          }

          appState.studentList.push({
            id: studentId,
            name: masterStudent.name || studentId,
            status: todayStatus
          });

          count++;
        }

        console.log(`✅ Loaded ${count} students from master list`);
        return;
      }

      // ✅ STEP 3: Fall back to old method (SUBJECT DATA) if master list doesn't exist
      console.log('📊 Master list not found - falling back to SUBJECT DATA (old method)');

      const subjectData = getSubjectData();
      console.log('📊 Subject data:', subjectData ? 'EXISTS' : 'NULL');

      if (!subjectData) {
        console.warn('⚠️ No subject data available - upload CSV first');
        return;
      }

      let count = 0;
      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;

        const student = subjectData[studentId];
        const todayStatus = student[appState.currentDay] || 'Absent';

        appState.studentList.push({
          id: studentId,
          name: student._name || studentId,
          status: todayStatus
        });
        count++;
      }

      console.log(`✅ Loaded ${count} students from subject data (old method)`);
    }

    function refreshAttendanceTable() {
      console.log('🔄 refreshAttendanceTable called');
      console.log('📌 Current subject:', appState.selectedSubject);
      console.log('📌 Current month:', appState.selectedMonth);
      console.log('📌 Current day:', appState.currentDay);

      loadStudentList();

      console.log('📊 Student list length:', appState.studentList.length);

      let displayList = [...appState.studentList];

      // Apply filter
      const filter = elements.filterSelect.value;
      if (filter === 'present') {
        displayList = displayList.filter(s => s.status === 'Present');
      } else if (filter === 'absent') {
        displayList = displayList.filter(s => s.status === 'Absent');
      } else if (filter === 'defaulter') {
        const threshold = appState.threshold;
        displayList = displayList.filter(s => {
          const stats = getStudentStats(s.id);
          return stats.percentage < threshold;
        });
      }

      // Apply search
      const searchTerm = elements.searchInput.value.trim().toLowerCase();
      if (searchTerm) {
        displayList = displayList.filter(s =>
          s.id.toLowerCase().includes(searchTerm) ||
          s.name.toLowerCase().includes(searchTerm)
        );
      }

      // Apply sort
      const sortValue = elements.sortSelect.value;
      if (sortValue) {
        const [key, direction] = sortValue.split('-');
        displayList.sort((a, b) => {
          let valA, valB;

          if (key === 'id') {
            valA = isNaN(a.id) ? a.id : Number(a.id);
            valB = isNaN(b.id) ? b.id : Number(b.id);
          } else if (key === 'name') {
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
          } else if (key === 'attendance') {
            valA = getStudentStats(a.id).percentage;
            valB = getStudentStats(b.id).percentage;
          }

          if (valA < valB) return direction === 'asc' ? -1 : 1;
          if (valA > valB) return direction === 'asc' ? 1 : -1;
          return 0;
        });
      }

      renderAttendanceTable(displayList);
      updateSummary(displayList);
      updateStats();
    }

    function renderAttendanceTable(students) {
      if (!students || students.length === 0) {
        elements.attendanceTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-5">
              <i class="bi bi-inbox fs-1"></i>
              <p class="mt-2">No students found. Upload a CSV file to get started.</p>
            </td>
          </tr>
        `;
        return;
      }

      const isHolidayToday = isHoliday(appState.currentDay);
      const threshold = appState.threshold;

      elements.attendanceTableBody.innerHTML = '';

      students.forEach(student => {
        const stats = getStudentStats(student.id);
        const isDefaulter = stats.percentage < threshold;

        const row = document.createElement('tr');
        row.className = student.status === 'Present' ? 'present' : 'absent';




        row.innerHTML = `
          <td><strong>${escapeHtml(student.id)}</strong></td>
            <td>${escapeHtml(student.name)}</td>
          <td>
            <span class="badge ${student.status === 'Present' ? 'bg-success' : 'bg-danger'}">
                ${student.status}
            </span>
                ${isHolidayToday ? '<span class="holiday-badge ms-1">Holiday</span>' : ''}
            </td>
            <td>
                ${stats.present}/${stats.workingDays} days
            <span class="${isDefaulter ? 'defaulter-badge' : 'good-badge'} ms-2">
                ${stats.percentage}%
             </span>
             </td>
            <td class="teacher-only">
             <button class="btn btn-sm btn-outline-success mark-present-btn" 
            data-id="${escapeHtml(student.id)}" 
            ${isHolidayToday ? 'disabled' : ''}>
            <i class="bi bi-check"></i>
            </button>
             <button class="btn btn-sm btn-outline-danger mark-absent-btn" 
            data-id="${escapeHtml(student.id)}" 
            ${isHolidayToday ? 'disabled' : ''}>
            <i class="bi bi-x"></i>
            </button>
            </td>
        `;

        elements.attendanceTableBody.appendChild(row);
      });

      // Add event listeners for mark buttons
      document.querySelectorAll('.mark-present-btn').forEach(btn => {
        btn.addEventListener('click', () => markAttendance(btn.dataset.id, 'Present'));
      });

      document.querySelectorAll('.mark-absent-btn').forEach(btn => {
        btn.addEventListener('click', () => markAttendance(btn.dataset.id, 'Absent'));
      });
    }

    function markAttendance(studentId, status) {
      const monthKey = getMonthKey();
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;
      const subject = appState.selectedSubject;

      if (!monthKey || !year || !dept || !course || !academicYear || !division || !subject) {
        console.error('❌ Missing required fields for marking attendance');
        return;
      }

      // ✅ CREATE PATH IF DOESN'T EXIST
      if (!appState.attendanceData[year]) {
        appState.attendanceData[year] = {};
      }
      if (!appState.attendanceData[year][dept]) {
        appState.attendanceData[year][dept] = {};
      }
      if (!appState.attendanceData[year][dept][course]) {
        appState.attendanceData[year][dept][course] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear]) {
        appState.attendanceData[year][dept][course][academicYear] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear][division]) {
        appState.attendanceData[year][dept][course][academicYear][division] = { months: {} };
      }
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey]) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey] = { subjects: {} };
      }
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject]) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject] = { attendance: {} };
      }

      const attendanceRef = appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance;

      if (!attendanceRef[studentId]) {
        console.error('❌ Student not found:', studentId);
        return;
      }

      attendanceRef[studentId][appState.currentDay] = status;

      refreshAttendanceTable();
      renderCalendarGrid();
      saveAllData();
    }
    function markAllAttendance(status) {
      if (isHoliday(appState.currentDay)) {
        showAlert('Cannot mark attendance on a holiday!', 'warning');
        return;
      }

      const subjectData = getSubjectData();
      if (!subjectData) return;

      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;
        subjectData[studentId][appState.currentDay] = status;
      }

      refreshAttendanceTable();
      renderCalendarGrid();
      saveAllData();

      showAlert(`All students marked as ${status}!`, 'success');
    }

    function updateSummary(students) {
      const total = students.length;
      const present = students.filter(s => s.status === 'Present').length;
      const absent = total - present;
      const rate = total > 0 ? Math.round((present / total) * 100) : 0;

      elements.summaryTotal.textContent = total;
      elements.summaryPresent.textContent = present;
      elements.summaryAbsent.textContent = absent;
      elements.summaryRate.textContent = `${rate}%`;
    }

    function updateStats() {
      const subjectData = getSubjectData();
      let totalStudents = 0;
      let presentToday = 0;
      let absentToday = 0;

      if (subjectData) {
        for (const studentId in subjectData) {
          if (studentId.startsWith('_')) continue;
          totalStudents++;

          if (subjectData[studentId][appState.currentDay] === 'Present') {
            presentToday++;
          } else {
            absentToday++;
          }
        }
      }

      elements.statsTotalStudents.textContent = totalStudents;
      elements.statsPresentToday.textContent = presentToday;
      elements.statsAbsentToday.textContent = absentToday;
      elements.statsWorkingDays.textContent = getWorkingDays();
    }

    // ==================== DEFAULTER FUNCTIONS ====================
    function getDefaultersList() {
      const defaulters = [];
      const subjectData = getSubjectData();
      const threshold = appState.threshold;

      if (!subjectData) return defaulters;

      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;

        const stats = getStudentStats(studentId);
        if (stats.percentage < threshold) {
          defaulters.push({
            id: studentId,
            name: subjectData[studentId]._name || studentId,
            ...stats
          });
        }
      }

      defaulters.sort((a, b) => a.percentage - b.percentage);
      return defaulters;
    }

    function updateDefaulterCount() {
      const defaulters = getDefaultersList();
      elements.defaulterCount.textContent = defaulters.length;
    }

    function showDefaulterTable() {
      const defaulters = getDefaultersList();

      if (defaulters.length === 0) {
        elements.defaulterTableContainer.style.display = 'none';
        showAlert('No defaulters found! All students are above the threshold.', 'success');
        return;
      }

      elements.defaulterTableBody.innerHTML = '';

      defaulters.forEach(d => {
        const row = document.createElement('tr');

        // ✅ GET LEAVE SUMMARY FOR THIS STUDENT
        const leaveSummary = getStudentLeaveSummary(d.id);

        row.innerHTML = `
      <td>${escapeHtml(d.id)}</td>
      <td>
        ${escapeHtml(d.name)}
        ${leaveSummary ? `<br><small class="text-info">📝 ${leaveSummary.applications} leave application(s)</small>` : ''}
      </td>
      <td>${d.present}</td>
      <td>${d.absent}</td>
      <td>${d.workingDays}</td>
      <td>
        <span class="defaulter-badge">${d.percentage}%</span>
        ${leaveSummary ? `<br><small class="badge bg-info mt-1">${leaveSummary.count} days leave approved</small>` : ''}
      </td>
    `;
        elements.defaulterTableBody.appendChild(row);
      });

      elements.defaulterTableContainer.style.display = 'block';
    }

    function showDefaulterModal() {
      if (!appState.selectedSubject) {
        showAlert('Please select a subject first!', 'warning');
        return;
      }

      if (appState.selectedMonth === null) {
        showAlert('Please select a month first!', 'warning');
        return;
      }

      const defaulters = getDefaultersList();

      elements.modalSubject.textContent = appState.selectedSubject;
      elements.modalMonth.textContent = `${monthNames[appState.selectedMonth]} ${appState.selectedYear}`;
      elements.modalThreshold.textContent = `${appState.threshold}%`;

      if (defaulters.length === 0) {
        elements.noDefaultersAlert.style.display = 'block';
        document.getElementById('modalDefaulterContent').style.display = 'none';
      } else {
        elements.noDefaultersAlert.style.display = 'none';
        document.getElementById('modalDefaulterContent').style.display = 'block';

        elements.modalDefaulterTableBody.innerHTML = '';
        defaulters.forEach(d => {
          // ✅ GET LEAVE SUMMARY
          const leaveSummary = getStudentLeaveSummary(d.id);

          const row = document.createElement('tr');
          row.innerHTML = `
        <td>${escapeHtml(d.id)}</td>
        <td>
          ${escapeHtml(d.name)}
          ${leaveSummary ? `<br><small class="text-info">📝 Leave: ${escapeHtml(leaveSummary.reasons)}</small>` : ''}
        </td>
        <td>${d.present}</td>
        <td>${d.absent}</td>
        <td>${d.workingDays}</td>
        <td>
          <span class="defaulter-badge">${d.percentage}%</span>
          ${leaveSummary ? `<br><small class="badge bg-info mt-1">${leaveSummary.count} day(s) approved</small>` : ''}
        </td>
      `;
          elements.modalDefaulterTableBody.appendChild(row);
        });
      }

      const modal = new bootstrap.Modal(document.getElementById('defaulterModal'));
      modal.show();
    }

    function exportDefaulters() {
      if (!appState.selectedSubject || appState.selectedMonth === null) {
        showAlert('Please select a subject and month first!', 'warning');
        return;
      }

      const defaulters = getDefaultersList();

      if (defaulters.length === 0) {
        showAlert('No defaulters to export!', 'info');
        return;
      }

      // ✅ MODIFIED HEADERS - Add Leave Info Column
      const headers = ['ID', 'Name', 'Present Days', 'Absent Days', 'Working Days', 'Attendance %', 'Leave Applications', 'Leave Days', 'Leave Reason'];
      const rows = [headers];

      defaulters.forEach(d => {
        // ✅ GET LEAVE INFO
        const leaveSummary = getStudentLeaveSummary(d.id);

        const leaveApps = leaveSummary ? leaveSummary.applications : 0;
        const leaveDays = leaveSummary ? leaveSummary.count : 0;
        const leaveReason = leaveSummary ? leaveSummary.reasons : 'N/A';

        rows.push([
          d.id,
          d.name,
          d.present,
          d.absent,
          d.workingDays,
          `${d.percentage}%`,
          leaveApps,
          leaveDays,
          leaveReason
        ]);
      });

      const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\r\n');
      downloadFile(csv, `defaulters_${appState.selectedSubject}_${monthNames[appState.selectedMonth]}_${appState.selectedYear}.csv`);
    }
    function addDepartment(name) {
      name = String(name).trim();

      if (!name) {
        showAlert('Please enter a department name!', 'warning');
        return false;
      }

      if (appState.departments.includes(name)) {
        showAlert('Department already exists!', 'warning');
        return false;
      }

      console.log(`🔧 Adding department: "${name}"`);

      appState.departments.push(name);
      appState.courses[name] = [];

      populateDepartmentDropdown();
      renderDepartmentTags();

      console.log(`🔧 Calling saveAllData()...`);
      saveAllData();

      showAlert(`Department "${name}" added successfully!`, 'success');
      return true;
    }
    function deleteDepartment(name) {
      if (!confirm(`⚠️ DELETE DEPARTMENT "${name}"?...`)) {
        return;
      }

      // ✅ DELETE ALL SUBJECTS for all courses in this department
      if (appState.subjects[name]) {
        delete appState.subjects[name];
      }

      // Remove from departments array
      appState.departments = appState.departments.filter(d => d !== name);

      // Delete all courses
      delete appState.courses[name];

      // Delete attendance data for ALL YEARS
      for (const year in appState.attendanceData) {
        if (appState.attendanceData[year]?.[name]) {
          delete appState.attendanceData[year][name];
        }
      }

      // Reset selection if needed
      if (appState.selectedDepartment === name) {
        appState.selectedDepartment = null;
        appState.selectedCourse = null;
        appState.selectedSubject = null;

        // Disable inputs
        elements.newCourseInput.disabled = true;
        elements.addCourseBtn.disabled = true;
        elements.courseSelect.disabled = true;
        elements.newSubjectInput.disabled = true;
        elements.addSubjectBtn.disabled = true;
        elements.subjectSelect.disabled = true;

        updateDepartmentDisplay();
        updateCourseDisplay();
        updateSubjectDisplay();
      }

      // Update UI
      populateDepartmentDropdown();
      renderDepartmentTags();
      populateCourseDropdown();
      renderCourseTags();
      populateSubjectDropdown();
      renderSubjectTags();
      updateFinalSelectionDropdowns();
      refreshAttendanceTable();

      saveAllData();
      showAlert(`Department "${name}" and all related data deleted!`, 'info');
    }

    function selectDepartment(name) {
      appState.selectedDepartment = name;
      appState.selectedCourse = null; // Reset course when department changes

      elements.departmentSelect.value = name;
      elements.finalDepartmentSelect.value = name;

      // Enable course input
      elements.newCourseInput.disabled = false;
      elements.addCourseBtn.disabled = false;
      elements.courseSelect.disabled = false;
      updateDepartmentDisplay();
      updateFinalSelectionBadges();
      populateCourseDropdown();
      renderCourseTags();
      updateFinalSelectionDropdowns();
      saveAllData();
      loadLeaveApplications();
    }

    function populateDepartmentDropdown() {
      // Update both dropdowns
      const dropdowns = [elements.departmentSelect, elements.finalDepartmentSelect];

      dropdowns.forEach(dropdown => {
        dropdown.innerHTML = '<option value="">-- Choose Department --</option>';

        appState.departments.forEach(dept => {
          const option = document.createElement('option');
          option.value = dept;
          option.textContent = dept;
          if (dept === appState.selectedDepartment) {
            option.selected = true;
          }
          dropdown.appendChild(option);
        });
      });
    }

    function renderDepartmentTags() {
      if (appState.departments.length === 0) {
        elements.departmentTags.innerHTML = '<span class="text-muted">No departments added yet.</span>';
        return;
      }

      elements.departmentTags.innerHTML = '';
      appState.departments.forEach(dept => {
        const tag = document.createElement('span');
        tag.className = `subject-tag ${dept === appState.selectedDepartment ? 'active' : ''}`;
        tag.innerHTML = `
      ${escapeHtml(dept)}
      <span class="delete-btn" data-dept="${escapeHtml(dept)}">&times;</span>
    `;

        tag.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-btn')) {
            selectDepartment(dept);
          }
        });

        elements.departmentTags.appendChild(tag);
      });

      // Add delete listeners
      document.querySelectorAll('#departmentTags .delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteDepartment(e.target.getAttribute('data-dept'));
        });
      });
    }

    function updateDepartmentDisplay() {
      const dept = appState.selectedDepartment || 'None selected';
      elements.currentDepartmentDisplay.textContent = dept;
      elements.selectedPathDept.textContent = appState.selectedDepartment || 'No Department';
    }

    // ==================== COURSE FUNCTIONS ====================
    function addCourse(name) {
      if (!appState.selectedDepartment) {
        showAlert('Please select a department first!', 'warning');
        return false;
      }

      name = String(name).trim();

      if (!name) {
        showAlert('Please enter a course name!', 'warning');
        return false;
      }

      if (appState.courses[appState.selectedDepartment].includes(name)) {
        showAlert('Course already exists in this department!', 'warning');
        return false;
      }

      appState.courses[appState.selectedDepartment].push(name);

      populateCourseDropdown();
      renderCourseTags();
      saveAllData();

      showAlert(`Course "${name}" added successfully!`, 'success');
      return true;
    }

    function deleteCourse(name) {
      if (!appState.selectedDepartment) {
        showAlert('Please select a department first!', 'warning');
        return;
      }

      if (!confirm(`⚠️ DELETE COURSE "${name}"?...`)) {
        return;
      }

      const dept = appState.selectedDepartment;

      // ✅ DELETE SUBJECTS for this course
      if (appState.subjects[dept] && appState.subjects[dept][name]) {
        delete appState.subjects[dept][name];
      }

      // Remove from courses array
      appState.courses[dept] = appState.courses[dept].filter(c => c !== name);

      // Delete attendance data for ALL YEARS
      for (const year in appState.attendanceData) {
        if (appState.attendanceData[year]?.[dept]?.[name]) {
          delete appState.attendanceData[year][dept][name];
        }
      }

      // Reset selection if needed
      if (appState.selectedCourse === name) {
        appState.selectedCourse = null;
        appState.selectedSubject = null;

        // Disable subject inputs
        elements.newSubjectInput.disabled = true;
        elements.addSubjectBtn.disabled = true;
        elements.subjectSelect.disabled = true;

        updateCourseDisplay();
        updateSubjectDisplay();
      }

      // Update UI
      populateCourseDropdown();
      renderCourseTags();
      populateSubjectDropdown();
      renderSubjectTags();
      updateFinalSelectionDropdowns();
      refreshAttendanceTable();

      saveAllData();
      showAlert(`Course "${name}" and all related data deleted!`, 'info');
    }

    function selectCourse(name) {
      appState.selectedCourse = name;
      appState.selectedSubject = null; // ✅ RESET subject when course changes

      elements.courseSelect.value = name;
      elements.finalCourseSelect.value = name;

      // Enable subject input
      elements.newSubjectInput.disabled = false;
      elements.addSubjectBtn.disabled = false;
      elements.subjectSelect.disabled = false;

      updateCourseDisplay();
      updateFinalSelectionBadges();
      populateSubjectDropdown(); // ✅ Repopulate with course-specific subjects
      renderSubjectTags(); // ✅ Show course-specific subjects
      updateFinalSelectionDropdowns();
      saveAllData();
      loadLeaveApplications();
    }

    function populateCourseDropdown() {
      const dropdowns = [elements.courseSelect, elements.finalCourseSelect];

      dropdowns.forEach(dropdown => {
        dropdown.innerHTML = '<option value="">-- Choose Course --</option>';

        if (!appState.selectedDepartment) {
          dropdown.disabled = true;
          return;
        }

        dropdown.disabled = false;

        const courses = appState.courses[appState.selectedDepartment] || [];
        courses.forEach(course => {
          const option = document.createElement('option');
          option.value = course;
          option.textContent = course;
          if (course === appState.selectedCourse) {
            option.selected = true;
          }
          dropdown.appendChild(option);
        });
      });
    }

    function renderCourseTags() {
      if (!appState.selectedDepartment) {
        elements.courseTags.innerHTML = '<span class="text-muted">Select a department first.</span>';
        elements.coursesDepartmentName.textContent = '--';
        return;
      }

      elements.coursesDepartmentName.textContent = appState.selectedDepartment;

      const courses = appState.courses[appState.selectedDepartment] || [];

      if (courses.length === 0) {
        elements.courseTags.innerHTML = '<span class="text-muted">No courses added yet.</span>';
        return;
      }

      elements.courseTags.innerHTML = '';
      courses.forEach(course => {
        const tag = document.createElement('span');
        tag.className = `subject-tag ${course === appState.selectedCourse ? 'active' : ''}`;
        tag.innerHTML = `
      ${escapeHtml(course)}
      <span class="delete-btn" data-course="${escapeHtml(course)}">&times;</span>
    `;

        tag.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-btn')) {
            selectCourse(course);
          }
        });

        elements.courseTags.appendChild(tag);
      });

      document.querySelectorAll('#courseTags .delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteCourse(e.target.getAttribute('data-course'));
        });
      });
    }

    function updateCourseDisplay() {
      const course = appState.selectedCourse || 'None selected';
      elements.currentCourseDisplay.textContent = course;
      elements.selectedPathCourse.textContent = appState.selectedCourse || 'No Course';
    }

    function deleteSubject(name) {
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;

      if (!dept || !course) {
        showAlert('Please select department and course first!', 'warning');
        return;
      }

      if (!confirm(`⚠️ DELETE SUBJECT "${name}"?\n\nThis will also delete all attendance data for this subject.\n\nThis action cannot be undone!`)) {
        return;
      }

      // Remove from subjects array
      if (appState.subjects[dept] && appState.subjects[dept][course]) {
        appState.subjects[dept][course] = appState.subjects[dept][course].filter(s => s !== name);
      }

      // Delete attendance data for ALL YEARS
      for (const year in appState.attendanceData) {
        if (appState.attendanceData[year]?.[dept]?.[course]) {
          for (const acYear in appState.attendanceData[year][dept][course]) {
            for (const div in appState.attendanceData[year][dept][course][acYear]) {
              if (appState.attendanceData[year][dept][course][acYear][div]?.months) {
                for (const month in appState.attendanceData[year][dept][course][acYear][div].months) {
                  if (appState.attendanceData[year][dept][course][acYear][div].months[month]?.subjects?.[name]) {
                    delete appState.attendanceData[year][dept][course][acYear][div].months[month].subjects[name];
                  }
                }
              }
            }
          }
        }
      }

      // Reset selection if needed
      if (appState.selectedSubject === name) {
        appState.selectedSubject = null;
        updateSubjectDisplay();
      }

      // Update UI
      populateSubjectDropdown();
      renderSubjectTags();
      updateFinalSelectionDropdowns();
      refreshAttendanceTable();

      saveAllData();
      showAlert(`Subject "${name}" and all related data deleted!`, 'info');
    }

    // ==================== FINAL SELECTION & ACADEMIC YEAR ====================
    function updateFinalSelectionDropdowns() {
      // ✅ Populate all three dropdowns (these handle their own null checks)
      populateDepartmentDropdown();
      populateCourseDropdown();
      populateSubjectDropdown();

      // ✅ Update path badges
      elements.selectedPathDept.textContent = appState.selectedDepartment || 'No Department';
      elements.selectedPathCourse.textContent = appState.selectedCourse || 'No Course';
      elements.selectedPathSubject.textContent = appState.selectedSubject || 'No Subject';
    }
    function updateFinalSelectionBadges() {
      elements.selectedPathDept.textContent = appState.selectedDepartment || 'No Department';
      elements.selectedPathCourse.textContent = appState.selectedCourse || 'No Course';
      elements.selectedPathSubject.textContent = appState.selectedSubject || 'No Subject';
    }
    function updateAcademicYearDisplay() {
      const parts = [];

      if (appState.selectedAcademicYear) {
        parts.push(`Academic Year: ${appState.selectedAcademicYear}`);
      }

      if (appState.selectedDivision) {
        parts.push(`Division: ${appState.selectedDivision}`);
      }

      if (parts.length === 0) {
        elements.currentAcademicDisplay.textContent = 'None';
      } else {
        elements.currentAcademicDisplay.textContent = parts.join(' | ');
      }
    }

    // ==================== EVENT LISTENERS ====================
    function initializeEventListeners() {
      if (window._eventListenersInitialized) {
        console.warn('⚠️ Event listeners already initialized! Skipping...');
        return;
      }
      window._eventListenersInitialized = true;
      console.log('✅ Initializing event listeners (first time only)');

      // ==================== DEPARTMENT EVENTS ====================
      // Add Department
      elements.addDepartmentBtn.addEventListener('click', () => {
        const name = elements.newDepartmentInput.value.trim();
        if (addDepartment(name)) {
          elements.newDepartmentInput.value = '';
        }
      });

      elements.newDepartmentInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const name = elements.newDepartmentInput.value.trim();
          if (addDepartment(name)) {
            elements.newDepartmentInput.value = '';
          }
        }
      });

      // Select Department
      elements.departmentSelect.addEventListener('change', () => {
        const dept = elements.departmentSelect.value;

        // ✅ FIX: Handle empty selection
        if (!dept || dept === '') {
          // Reset department and all dependent selections
          appState.selectedDepartment = null;
          appState.selectedCourse = null;
          appState.selectedSubject = null;

          // Disable dependent inputs
          elements.newCourseInput.disabled = true;
          elements.addCourseBtn.disabled = true;
          elements.courseSelect.disabled = true;
          elements.newSubjectInput.disabled = true;
          elements.addSubjectBtn.disabled = true;
          elements.subjectSelect.disabled = true;

          // Update displays
          updateDepartmentDisplay();
          updateCourseDisplay();
          updateSubjectDisplay();
          updateFinalSelectionBadges();

          // Clear dropdowns
          populateCourseDropdown();
          populateSubjectDropdown();
          renderCourseTags();
          renderSubjectTags();

          saveAllData();
          return;
        }

        selectDepartment(dept);
      });

      // Delete Department
      elements.deleteDepartmentBtn.addEventListener('click', () => {
        if (!appState.selectedDepartment) {
          showAlert('Please select a department first!', 'warning');
          return;
        }
        deleteDepartment(appState.selectedDepartment);
      });

      // ==================== COURSE EVENTS ====================
      // Add Course
      elements.addCourseBtn.addEventListener('click', () => {
        const name = elements.newCourseInput.value.trim();
        if (addCourse(name)) {
          elements.newCourseInput.value = '';
        }
      });

      elements.newCourseInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const name = elements.newCourseInput.value.trim();
          if (addCourse(name)) {
            elements.newCourseInput.value = '';
          }
        }
      });

      // Select Course
      elements.courseSelect.addEventListener('change', () => {
        const course = elements.courseSelect.value;

        if (!course || course === '') {
          appState.selectedCourse = null;
          appState.selectedSubject = null;

          elements.newSubjectInput.disabled = true;
          elements.addSubjectBtn.disabled = true;
          elements.subjectSelect.disabled = true;

          updateCourseDisplay();
          updateSubjectDisplay();
          updateFinalSelectionBadges();

          populateSubjectDropdown();
          renderSubjectTags();

          saveAllData();
          return;
        }

        selectCourse(course);
      });

      // Final Course Select
      elements.finalCourseSelect.addEventListener('change', () => {
        const course = elements.finalCourseSelect.value;

        if (!course || course === '') {
          appState.selectedCourse = null;
          appState.selectedSubject = null;

          elements.courseSelect.value = '';
          elements.finalSubjectSelect.value = '';

          updateCourseDisplay();
          updateSubjectDisplay();
          updateFinalSelectionBadges();

          populateSubjectDropdown();

          saveAllData();
          return;
        }

        selectCourse(course);
        updateFinalSelectionDropdowns();
      });

      // Delete Course
      elements.deleteCourseBtn.addEventListener('click', () => {
        if (!appState.selectedCourse) {
          showAlert('Please select a course first!', 'warning');
          return;
        }
        deleteCourse(appState.selectedCourse);
      });

      // ==================== FINAL SELECTION EVENTS ====================
      // Final Department Select
      elements.finalDepartmentSelect.addEventListener('change', () => {
        const dept = elements.finalDepartmentSelect.value;

        // ✅ FIX: Handle empty selection
        if (!dept || dept === '') {
          appState.selectedDepartment = null;
          appState.selectedCourse = null;
          appState.selectedSubject = null;

          elements.departmentSelect.value = '';
          elements.finalCourseSelect.value = '';
          elements.finalSubjectSelect.value = '';

          updateDepartmentDisplay();
          updateCourseDisplay();
          updateSubjectDisplay();
          updateFinalSelectionBadges();

          populateCourseDropdown();
          populateSubjectDropdown();

          saveAllData();
          return;
        }

        selectDepartment(dept);
        updateFinalSelectionDropdowns();
      });

      // Final Course Select
      elements.finalCourseSelect.addEventListener('change', () => {
        const course = elements.finalCourseSelect.value;
        if (course) {
          selectCourse(course);
          updateFinalSelectionDropdowns();
        }
      });

      // Final Subject Select
      elements.finalSubjectSelect.addEventListener('change', () => {
        const subject = elements.finalSubjectSelect.value;
        if (subject) {
          selectSubject(subject);
          updateFinalSelectionDropdowns();
        }
      });

      // ==================== ACADEMIC YEAR & DIVISION EVENTS ====================
      // Academic Year Select
      elements.academicYearLevelSelect.addEventListener('change', () => {
        appState.selectedAcademicYear = elements.academicYearLevelSelect.value;
        updateAcademicYearDisplay();
        saveAllData();
        loadLeaveApplications();
      });

      // Division Select
      elements.divisionSelect.addEventListener('change', () => {
        appState.selectedDivision = elements.divisionSelect.value;
        updateAcademicYearDisplay();
        saveAllData();
        loadLeaveApplications();
      });

      // Subject events
      elements.addSubjectBtn.addEventListener('click', () => {
        if (addSubject(elements.newSubjectInput.value)) {
          elements.newSubjectInput.value = '';
        }
      });

      elements.newSubjectInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          if (addSubject(elements.newSubjectInput.value)) {
            elements.newSubjectInput.value = '';
          }
        }
      });

      elements.subjectSelect.addEventListener('change', () => {
        if (isUpdatingSubjectDropdown) return;
        selectSubject(elements.subjectSelect.value);
      });

      elements.deleteSubjectBtn.addEventListener('click', () => {
        if (!appState.selectedSubject) {
          showAlert('Please select a subject first!', 'warning');
          return;
        }
        deleteSubject(appState.selectedSubject);
      });

      // Month events
      elements.applyMonthBtn.addEventListener('click', applyMonth);

      // Holiday events
      elements.toggleHolidayBtn.addEventListener('click', toggleHoliday);
      elements.clearHolidaysBtn.addEventListener('click', clearAllHolidays);

      // File upload events
      elements.browseBtn.addEventListener('click', () => {
        elements.fileInput.click();
      });

      elements.fileDrop.addEventListener('click', () => {
        elements.fileInput.click();
      });

      elements.fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          handleFileUpload(e.target.files[0]);
          // Don't reset here - will reset after successful upload
        }
      });

      elements.fileDrop.addEventListener('dragover', (e) => {
        e.preventDefault();
        elements.fileDrop.classList.add('dragover');
      });

      elements.fileDrop.addEventListener('dragleave', (e) => {
        e.preventDefault();
        elements.fileDrop.classList.remove('dragover');
      });

      elements.fileDrop.addEventListener('drop', (e) => {
        e.preventDefault();
        elements.fileDrop.classList.remove('dragover');

        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          handleFileUpload(e.dataTransfer.files[0]);
        }
      });

      elements.downloadTemplateBtn.addEventListener('click', downloadTemplate);
      elements.downloadReportBtn.addEventListener('click', downloadReport);
      elements.clearAllBtn.addEventListener('click', clearSelectedSubjectMonth);
      // DEBUG BUTTON - Check what's saved in database
      document.getElementById('debugSaveBtn').addEventListener('click', async () => {
        const data = {
          subjects: await loadFromDatabase('subjects'),
          selectedSubject: await loadFromDatabase('selectedSubject'),
          selectedMonth: await loadFromDatabase('selectedMonth'),
          selectedYear: await loadFromDatabase('selectedYear'),
          currentDay: await loadFromDatabase('currentDay'),
          attendanceData: await loadFromDatabase('attendanceData'),
          holidays: await loadFromDatabase('holidays')
        };

        console.log('=== DATABASE CONTENT ===');
        console.log('Subjects:', data.subjects);
        console.log('Selected Subject:', data.selectedSubject);
        console.log('Selected Month:', data.selectedMonth, '(0=Jan, 1=Feb, etc.)');
        console.log('Selected Year:', data.selectedYear);
        console.log('Current Day:', data.currentDay);
        console.log('Attendance Data Keys:', Object.keys(data.attendanceData || {}));
        console.log('Holidays:', data.holidays);
        console.log('========================');

        let message = '📊 DATABASE CONTENT:\n\n';
        message += `Subjects: ${data.subjects?.length || 0}\n`;
        message += `Selected Subject: ${data.selectedSubject || 'NONE'}\n`;
        message += `Selected Month: ${data.selectedMonth !== null ? data.selectedMonth + ' (0=Jan)' : 'NONE'}\n`;
        message += `Selected Year: ${data.selectedYear || 'NONE'}\n`;
        message += `Current Day: ${data.currentDay || 'NONE'}\n`;
        message += `\nAttendance Data Month Keys:\n`;
        if (data.attendanceData) {
          Object.keys(data.attendanceData).forEach(key => {
            message += `  - ${key}\n`;
          });
        } else {
          message += '  - NONE\n';
        }
        message += '\n✓ Check browser console for full details';

        alert(message);
      });

      // Generate QR button
      document.getElementById('generateQRBtn').addEventListener('click', async () => {
        const missing = [];
        if (!appState.selectedDepartment) missing.push('Department');
        if (!appState.selectedCourse) missing.push('Course');
        if (!appState.selectedSubject) missing.push('Subject');
        if (!appState.selectedAcademicYear) missing.push('Academic Year');
        if (!appState.selectedDivision) missing.push('Division');
        if (appState.selectedMonth === null) missing.push('Month');
        if (appState.selectedYear === null) missing.push('Year');

        const validationAlert = document.getElementById('qrValidationAlert');
        const qrContainer = document.getElementById('qrCodeContainer');

        if (missing.length > 0) {
          document.getElementById('qrValidationMsg').textContent = 'Missing: ' + missing.join(', ');
          validationAlert.style.display = 'block';
          qrContainer.innerHTML = '';
        } else {
          validationAlert.style.display = 'none';

          // ✅ CREATE DIVISION KEY FIRST
          const divisionKey = `${appState.selectedDepartment}_${appState.selectedCourse}_${appState.selectedAcademicYear}_${appState.selectedDivision}`;

          // ✅ STEP 1: DELETE OLD QR FROM FIREBASE (if exists)
          if (useCloud && firebaseDB) {
            try {
              console.log(`🔍 Checking for existing QR for: ${divisionKey}`);

              const snapshot = await firebaseDB.ref('mainSystem/activeQRs').once('value');
              const allQRs = snapshot.val() || {};

              // Find and delete any QR for this division
              for (const id in allQRs) {
                const qrData = allQRs[id];
                if (qrData.division === divisionKey) {
                  console.log(`🗑️ Deleting old QR: ${id}`);
                  await firebaseDB.ref(`mainSystem/activeQRs/${id}`).remove();
                }
              }

            } catch (error) {
              console.error('Error deleting old QR:', error);
            }
          }

          // ✅ STEP 2: CREATE NEW QR ID (always fresh)
          const qrId = Math.random().toString(36).substring(2, 10).toUpperCase();
          console.log(`🆕 Generated NEW QR ID: ${qrId}`);

          const payload = JSON.stringify({
            qrId: qrId,
            department: appState.selectedDepartment,
            course: appState.selectedCourse,
            academicYear: appState.selectedAcademicYear,
            division: appState.selectedDivision,
            subject: appState.selectedSubject,
            month: appState.selectedMonth,
            year: appState.selectedYear,
            day: appState.currentDay
          });

          // ✅ STEP 3: TRACK NEW QR LOCALLY
          if (!window.activeQRsByDivision) {
            window.activeQRsByDivision = {};
          }
          window.activeQRsByDivision[divisionKey] = qrId;

          // ✅ STEP 4: SAVE TO FIREBASE (new QR)
          if (useCloud && firebaseDB) {
            try {
              await firebaseDB.ref(`mainSystem/activeQRs/${qrId}`).set({
                createdAt: Date.now(),
                expiresAt: Date.now() + 600000,
                division: divisionKey,
                data: JSON.parse(payload)
              });
              console.log(`✅ Saved NEW QR to Firebase: ${qrId}`);
            } catch (error) {
              console.error('Error saving QR to Firebase:', error);
            }
          }

          // Start countdown timer
          startQRCountdown(600);

          // Generate QR using qrcode-generator
          const qr = qrcode(0, 'M');
          qr.addData(payload);
          qr.make();
          qrContainer.innerHTML = qr.createSvgTag(6, 0);

          // Show active status
          document.getElementById('qrStatus').style.display = 'block';
          document.getElementById('qrStatus').className = 'alert alert-success mb-3';
          document.getElementById('qrStatus').innerHTML = '✅ Active - Expires in: <span id="qrTimer">10:00</span>';
          document.getElementById('qrCodeContainer').style.opacity = '1';

          // Show and start dynamic code rotation
          document.getElementById('qrDynamicCodeDisplay').style.display = 'block';
          startDynamicCodeRotation();

          // Update path badges
          document.getElementById('qrBadgeDept').textContent = appState.selectedDepartment;
          document.getElementById('qrBadgeCourse').textContent = appState.selectedCourse;
          document.getElementById('qrBadgeSubject').textContent = appState.selectedSubject;
          document.getElementById('qrBadgeAcYear').textContent = appState.selectedAcademicYear;
          document.getElementById('qrBadgeDiv').textContent = appState.selectedDivision;
          document.getElementById('qrBadgeMonth').textContent = monthNames[appState.selectedMonth];
          document.getElementById('qrBadgeDay').textContent = 'Day ' + appState.currentDay;
        }

        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('qrModal'));
        modal.show();
      });
      // Day navigation events
      elements.dateSelect.addEventListener('change', () => {
        if (isUpdatingDayDropdown) return;
        selectDay(parseInt(elements.dateSelect.value));
      });

      let dayNavigationTimeout = null;

      elements.prevDayBtn.addEventListener('click', () => {
        // Clear any pending navigation
        if (dayNavigationTimeout) {
          clearTimeout(dayNavigationTimeout);
        }

        // Debounce to prevent double-clicks
        dayNavigationTimeout = setTimeout(() => {
          if (appState.currentDay > 1) {
            const newDay = appState.currentDay - 1;
            console.log(`📅 Prev Day: ${appState.currentDay} → ${newDay}`);
            selectDay(newDay);
          }
        }, 50); // 50ms debounce
      });

      elements.nextDayBtn.addEventListener('click', () => {
        // Clear any pending navigation
        if (dayNavigationTimeout) {
          clearTimeout(dayNavigationTimeout);
        }

        // Debounce to prevent double-clicks
        dayNavigationTimeout = setTimeout(() => {
          if (appState.currentDay < appState.daysInMonth) {
            const newDay = appState.currentDay + 1;
            console.log(`📅 Next Day: ${appState.currentDay} → ${newDay}`);
            selectDay(newDay);
          }
        }, 50); // 50ms debounce
      });

      // Attendance actions
      elements.markAllPresentBtn.addEventListener('click', () => markAllAttendance('Present'));
      elements.markAllAbsentBtn.addEventListener('click', () => markAllAttendance('Absent'));

      // Search and filter events
      elements.searchBtn.addEventListener('click', refreshAttendanceTable);
      elements.searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') refreshAttendanceTable();
      });
      elements.resetSearchBtn.addEventListener('click', () => {
        elements.searchInput.value = '';
        refreshAttendanceTable();
      });
      elements.sortSelect.addEventListener('change', refreshAttendanceTable);
      elements.filterSelect.addEventListener('change', refreshAttendanceTable);
      elements.refreshTableBtn.addEventListener('click', refreshAttendanceTable);

      // Threshold event
      elements.thresholdInput.addEventListener('change', () => {
        appState.threshold = parseInt(elements.thresholdInput.value) || 75;
        updateDefaulterCount();
        refreshAttendanceTable();
        saveAllData();
      });

      // Defaulter events
      elements.showDefaultersBtn.addEventListener('click', showDefaulterModal);
      elements.exportDefaultersBtn.addEventListener('click', exportDefaulters);
      elements.modalExportBtn.addEventListener('click', exportDefaulters);

      // Modal close events
      elements.modalCloseBtn.addEventListener('click', () => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('defaulterModal'));
        if (modal) modal.hide();
      });

      elements.modalCloseBtnFooter.addEventListener('click', () => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('defaulterModal'));
        if (modal) modal.hide();
      });
      // When QR modal closes, stop dynamic code rotation
      const qrModal = document.getElementById('qrModal');

      qrModal.addEventListener('hidden.bs.modal', () => {
        console.log('🔒 QR Modal closed - stopping code rotation');
        stopDynamicCodeRotation();
        // ✅ DON'T stop the countdown timer - QR is still valid in Firebase
        // Timer continues running in background to show accurate time remaining
      });

      // ✅ When modal opens, sync the timer display
      qrModal.addEventListener('shown.bs.modal', () => {
        console.log('🔓 QR Modal opened');
        // ✅ If we have an active QR, sync the timer display
        if (qrExpiryTimestamp) {
          updateQRTimer();
          console.log('✅ QR timer synced with actual expiry time');
        }
      });
      // Smooth scroll for navigation
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
          }
        });
      });

      // ==================== LEAVE APPLICATION EVENT LISTENERS ====================

      // Toggle Leave Section (Expand/Collapse)
      document.getElementById('leaveHeaderToggle').addEventListener('click', () => {
        const content = document.getElementById('leaveContent');
        const icon = document.getElementById('leaveToggleIcon');

        if (content.style.display === 'none') {
          content.style.display = 'block';
          icon.classList.remove('bi-chevron-down');
          icon.classList.add('bi-chevron-up');

          // Load leave applications when opening
          loadLeaveApplications();
        } else {
          content.style.display = 'none';
          icon.classList.remove('bi-chevron-up');
          icon.classList.add('bi-chevron-down');
        }
      });

      // Open Leave Form Modal
      document.getElementById('openLeaveFormBtn').addEventListener('click', () => {
        // Validate division context
        const validation = validateDivisionContext();

        if (!validation.valid) {
          showAlert(`Please select: ${validation.missing.join(', ')} before submitting leave applications!`, 'warning');
          return;
        }

        // Reset form
        resetLeaveForm();

        // Load students for dropdown
        loadStudentsForLeaveForm();

        // Set date range limits (current month)
        const year = appState.selectedYear;
        const month = appState.selectedMonth;

        if (month !== null && year !== null) {
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);

          const fromInput = document.getElementById('leaveFromDate');
          const toInput = document.getElementById('leaveToDate');

          fromInput.min = formatDateForInput(firstDay);
          fromInput.max = formatDateForInput(lastDay);
          toInput.min = formatDateForInput(firstDay);
          toInput.max = formatDateForInput(lastDay);

          // Set default values to current day
          if (appState.currentDay) {
            const currentDate = new Date(year, month, appState.currentDay);
            fromInput.value = formatDateForInput(currentDate);
            toInput.value = formatDateForInput(currentDate);
            updateLeaveDayCount();
          }
        }

        // Show modal
        if (!leaveModal) {
          leaveModal = new bootstrap.Modal(document.getElementById('leaveModal'));
        }
        leaveModal.show();
      });

      // Date change listeners (update day count)
      document.getElementById('leaveFromDate').addEventListener('change', updateLeaveDayCount);
      document.getElementById('leaveToDate').addEventListener('change', updateLeaveDayCount);

      // Submit Leave Button
      document.getElementById('submitLeaveBtn').addEventListener('click', submitLeaveApplication);

      // Leave Filter - Status
      document.getElementById('leaveStatusFilter').addEventListener('change', (e) => {
        leaveState.filters.status = e.target.value;
        renderLeaveTable();
      });

      // Leave Filter - Month
      document.getElementById('leaveMonthFilter').addEventListener('change', (e) => {
        leaveState.filters.month = e.target.value;
        renderLeaveTable();
      });

      // Refresh Leaves Button
      document.getElementById('refreshLeavesBtn').addEventListener('click', () => {
        loadLeaveApplications();
        showAlert('Leave applications refreshed', 'info');
      });
    }
    // ==================== LEAVE APPLICATION SYSTEM ====================

    // State for leave applications
    const leaveState = {
      applications: [],
      filters: {
        status: 'all',
        month: 'current'
      }
    };

    // Initialize leave modal
    let leaveModal = null;

    // ===== UTILITY FUNCTIONS =====

    /**
     * Get date in YYYY-MM-DD format
     */
    function formatDateForInput(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /**
     * Calculate all days between two dates
     */
    function getDaysBetweenDates(fromDate, toDate) {
      const days = [];
      const start = new Date(fromDate);
      const end = new Date(toDate);

      // Validate dates
      if (start > end) {
        return [];
      }

      const current = new Date(start);
      while (current <= end) {
        days.push(current.getDate());
        current.setDate(current.getDate() + 1);
      }

      return days;
    }

    /**
     * Get Firebase path for leave applications
     */
    function getLeaveApplicationsPath() {
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;

      if (!year || !dept || !course || !academicYear || !division) {
        return null;
      }

      return `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/leaveApplications`;
    }

    /**
     * Validate division context
     */
    function validateDivisionContext() {
      const missing = [];

      if (!appState.selectedDepartment) missing.push('Department');
      if (!appState.selectedCourse) missing.push('Course');
      if (!appState.selectedAcademicYear) missing.push('Academic Year');
      if (!appState.selectedDivision) missing.push('Division');
      if (appState.selectedMonth === null) missing.push('Month');
      if (appState.selectedYear === null) missing.push('Year');

      return {
        valid: missing.length === 0,
        missing: missing
      };
    }

    // ===== LOAD STUDENT LIST FOR DROPDOWN =====

    async function loadStudentsForLeaveForm() {
      const studentSelect = document.getElementById('leaveStudentSelect');
      studentSelect.innerHTML = '<option value="">-- Select Student --</option>';

      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;
      const monthKey = getMonthKey();
      const subject = appState.selectedSubject;

      if (!year || !dept || !course || !academicYear || !division || !monthKey || !subject) {
        console.warn('Cannot load students: context incomplete');
        studentSelect.innerHTML += '<option value="" disabled>Please select all required fields first</option>';
        return;
      }

      // ✅ FIX: Load from CURRENT SUBJECT'S attendance data
      const attendancePath = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/subjects/${subject}/attendance`;

      try {
        let students = {};

        if (useCloud && firebaseDB) {
          const snapshot = await firebaseDB.ref(attendancePath).once('value');
          students = snapshot.val() || {};
        } else {
          // Fallback to local data
          const subjectData = getSubjectData();
          students = subjectData || {};
        }

        if (Object.keys(students).length === 0) {
          console.warn('⚠️ No students found in current subject');
          studentSelect.innerHTML += '<option value="" disabled>No students found - please upload attendance first</option>';
          return;
        }

        // Convert to array and sort
        const studentArray = [];

        for (const studentId in students) {
          if (studentId.startsWith('_')) continue; // Skip metadata

          const studentName = students[studentId]._name || studentId;

          studentArray.push({
            id: studentId,
            name: studentName
          });
        }

        // Sort by ID (numerically if possible)
        studentArray.sort((a, b) => {
          const aNum = parseInt(a.id);
          const bNum = parseInt(b.id);

          if (!isNaN(aNum) && !isNaN(bNum)) {
            return aNum - bNum;
          }

          return a.name.localeCompare(b.name);
        });

        // Populate dropdown
        studentArray.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = `${student.id} - ${student.name}`;
          studentSelect.appendChild(option);
        });

        console.log(`✅ Loaded ${studentArray.length} students for leave form`);

      } catch (error) {
        console.error('Error loading students:', error);
        studentSelect.innerHTML += '<option value="" disabled>Error loading students</option>';
      }
    }

    // ===== DATE CHANGE HANDLER (Calculate Days) =====

    function updateLeaveDayCount() {
      const fromDate = document.getElementById('leaveFromDate').value;
      const toDate = document.getElementById('leaveToDate').value;
      const dayCountAlert = document.getElementById('leaveDayCountAlert');
      const totalLeaveDaysSpan = document.getElementById('totalLeaveDays');
      const leaveDaysListDiv = document.getElementById('leaveDaysList');

      if (!fromDate || !toDate) {
        dayCountAlert.style.display = 'none';
        return;
      }

      const days = getDaysBetweenDates(fromDate, toDate);

      if (days.length === 0) {
        dayCountAlert.style.display = 'none';
        return;
      }

      totalLeaveDaysSpan.textContent = days.length;
      leaveDaysListDiv.textContent = `Days: ${days.join(', ')}`;
      dayCountAlert.style.display = 'block';
    }

    // ===== SUBMIT LEAVE APPLICATION =====

    async function submitLeaveApplication() {
      // Get form values
      const studentId = document.getElementById('leaveStudentSelect').value;
      const fromDate = document.getElementById('leaveFromDate').value;
      const toDate = document.getElementById('leaveToDate').value;
      const reason = document.getElementById('leaveReason').value.trim();

      const validationAlert = document.getElementById('leaveValidationAlert');
      const validationMsg = document.getElementById('leaveValidationMsg');

      // Validate division context
      const contextValidation = validateDivisionContext();
      if (!contextValidation.valid) {
        validationMsg.textContent = `Please select: ${contextValidation.missing.join(', ')}`;
        validationAlert.style.display = 'block';
        return;
      }

      // Validate form fields
      if (!studentId) {
        validationMsg.textContent = 'Please select a student';
        validationAlert.style.display = 'block';
        return;
      }

      if (!fromDate || !toDate) {
        validationMsg.textContent = 'Please select both From and To dates';
        validationAlert.style.display = 'block';
        return;
      }

      if (new Date(fromDate) > new Date(toDate)) {
        validationMsg.textContent = 'From date cannot be after To date';
        validationAlert.style.display = 'block';
        return;
      }

      if (!reason) {
        validationMsg.textContent = 'Please provide a reason for leave';
        validationAlert.style.display = 'block';
        return;
      }

      // Calculate days
      const days = getDaysBetweenDates(fromDate, toDate);

      if (days.length === 0) {
        validationMsg.textContent = 'Invalid date range';
        validationAlert.style.display = 'block';
        return;
      }

      // Get student name
      const studentSelect = document.getElementById('leaveStudentSelect');
      const studentName = studentSelect.options[studentSelect.selectedIndex].text.split(' - ')[1] || studentId;

      // Get current user
      let submittedBy = 'unknown';
      try {
        const user = await getCurrentUser();
        submittedBy = user.attributes.email;
      } catch (error) {
        console.warn('Could not get current user:', error);
      }

      // Generate leave ID
      const leaveId = `leave_${Date.now()}`;

      // Create leave data
      const leaveData = {
        studentId: studentId,
        studentName: studentName,
        fromDate: fromDate,
        toDate: toDate,
        days: days,
        month: new Date(fromDate).getMonth(),
        year: new Date(fromDate).getFullYear(),
        reason: reason,
        status: 'pending',
        submittedBy: submittedBy,
        submittedAt: Date.now()
      };

      // Save to Firebase
      const leavePath = getLeaveApplicationsPath();

      if (!leavePath) {
        showAlert('Cannot save leave: division context incomplete', 'danger');
        return;
      }

      try {
        if (useCloud && firebaseDB) {
          await firebaseDB.ref(`${leavePath}/${leaveId}`).set(leaveData);
          console.log(`✅ Leave application submitted: ${leaveId}`);
        } else {
          // Fallback to IndexedDB
          const allLeaves = await loadFromDatabase('leaveApplications') || {};
          allLeaves[leaveId] = leaveData;
          await saveToDatabase('leaveApplications', allLeaves);
        }

        // Close modal
        if (leaveModal) {
          leaveModal.hide();
        }

        // Reset form
        resetLeaveForm();

        // Refresh leave list
        await loadLeaveApplications();

        showAlert(`Leave application submitted for ${studentName} (${days.length} days)`, 'success');

      } catch (error) {
        console.error('Error submitting leave:', error);
        showAlert('Failed to submit leave application. Please try again.', 'danger');
      }
    }

    // ===== RESET FORM =====

    function resetLeaveForm() {
      document.getElementById('leaveStudentSelect').value = '';
      document.getElementById('leaveFromDate').value = '';
      document.getElementById('leaveToDate').value = '';
      document.getElementById('leaveReason').value = '';
      document.getElementById('leaveDayCountAlert').style.display = 'none';
      document.getElementById('leaveValidationAlert').style.display = 'none';
    }

    // ===== LOAD LEAVE APPLICATIONS =====

    async function loadLeaveApplications() {
      const leavePath = getLeaveApplicationsPath();

      if (!leavePath) {
        console.warn('Cannot load leaves: division context incomplete');
        leaveState.applications = [];
        renderLeaveTable();
        return;
      }

      try {
        let leaves = {};

        if (useCloud && firebaseDB) {
          const snapshot = await firebaseDB.ref(leavePath).once('value');
          leaves = snapshot.val() || {};
        } else {
          leaves = await loadFromDatabase('leaveApplications') || {};
        }

        // Convert to array
        leaveState.applications = Object.keys(leaves).map(id => ({
          id: id,
          ...leaves[id]
        }));

        // Sort by submission date (newest first)
        leaveState.applications.sort((a, b) => b.submittedAt - a.submittedAt);

        console.log(`✅ Loaded ${leaveState.applications.length} leave applications`);

        renderLeaveTable();
        updateLeaveBadges();

      } catch (error) {
        console.error('Error loading leave applications:', error);
        leaveState.applications = [];
        renderLeaveTable();
      }
    }
    // ===== RENDER LEAVE TABLE =====

    function renderLeaveTable() {
      const tbody = document.getElementById('leaveTableBody');

      if (leaveState.applications.length === 0) {
        tbody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center text-muted py-4">
          <i class="bi bi-inbox fs-2"></i>
          <p class="mt-2 mb-0">No leave applications yet</p>
          <small>Click "Submit New Leave" to add one</small>
        </td>
      </tr>
    `;
        return;
      }

      // Apply filters
      let filteredLeaves = [...leaveState.applications];

      // Filter by status
      if (leaveState.filters.status !== 'all') {
        filteredLeaves = filteredLeaves.filter(leave => leave.status === leaveState.filters.status);
      }

      // Filter by month
      if (leaveState.filters.month === 'current') {
        filteredLeaves = filteredLeaves.filter(leave =>
          leave.month === appState.selectedMonth && leave.year === appState.selectedYear
        );
      }

      // Render filtered leaves
      tbody.innerHTML = '';

      if (filteredLeaves.length === 0) {
        tbody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center text-muted py-4">
          <i class="bi bi-funnel fs-2"></i>
          <p class="mt-2 mb-0">No applications match the selected filters</p>
        </td>
      </tr>
    `;
        return;
      }

      filteredLeaves.forEach(leave => {
        const row = document.createElement('tr');

        // Add row class based on status
        if (leave.status === 'pending') {
          row.classList.add('leave-row-pending');
        } else if (leave.status === 'approved') {
          row.classList.add('leave-row-approved');
        } else if (leave.status === 'rejected') {
          row.classList.add('leave-row-rejected');
        }

        // Format dates
        const fromDateObj = new Date(leave.fromDate);
        const toDateObj = new Date(leave.toDate);
        const fromFormatted = `${fromDateObj.getDate()} ${monthNames[fromDateObj.getMonth()]}`;
        const toFormatted = `${toDateObj.getDate()} ${monthNames[toDateObj.getMonth()]}`;

        // Status badge
        let statusBadge = '';
        if (leave.status === 'pending') {
          statusBadge = '<span class="leave-status-pending">Pending</span>';
        } else if (leave.status === 'approved') {
          statusBadge = '<span class="leave-status-approved">✓ Approved</span>';
        } else if (leave.status === 'rejected') {
          statusBadge = '<span class="leave-status-rejected">✗ Rejected</span>';
        }

        // Action buttons
        let actionButtons = '';
        if (leave.status === 'pending') {
          actionButtons = `
        <button class="btn btn-success btn-sm leave-action-btn me-1" 
                onclick="approveLeave('${leave.id}')" 
                title="Approve Leave">
          <i class="bi bi-check-circle"></i> Approve
        </button>
        <button class="btn btn-danger btn-sm leave-action-btn" 
                onclick="rejectLeave('${leave.id}')" 
                title="Reject Leave">
          <i class="bi bi-x-circle"></i> Reject
        </button>
      `;
        } else {
          actionButtons = `
        <button class="btn btn-outline-secondary btn-sm leave-action-btn" 
                onclick="deleteLeave('${leave.id}')" 
                title="Delete Leave">
          <i class="bi bi-trash"></i> Delete
        </button>
      `;
        }

        row.innerHTML = `
      <td><strong>${escapeHtml(leave.studentId)}</strong></td>
      <td>${escapeHtml(leave.studentName)}</td>
      <td>${fromFormatted}</td>
      <td>${toFormatted}</td>
      <td><span class="badge bg-secondary">${leave.days.length}</span></td>
      <td>
        <span class="leave-reason-text" title="${escapeHtml(leave.reason)}">
          ${escapeHtml(leave.reason.substring(0, 30))}${leave.reason.length > 30 ? '...' : ''}
        </span>
      </td>
      <td>${statusBadge}</td>
      <td>${actionButtons}</td>
    `;

        tbody.appendChild(row);
      });
    }

    // ===== UPDATE LEAVE BADGES (Pending/Approved Count) =====

    function updateLeaveBadges() {
      const pendingCount = leaveState.applications.filter(l => l.status === 'pending').length;
      const approvedCount = leaveState.applications.filter(l => l.status === 'approved').length;

      const pendingBadge = document.getElementById('leavePendingCount');
      const approvedBadge = document.getElementById('leaveApprovedCount');

      if (pendingCount > 0) {
        pendingBadge.textContent = pendingCount;
        pendingBadge.style.display = 'inline-block';
      } else {
        pendingBadge.style.display = 'none';
      }

      if (approvedCount > 0) {
        approvedBadge.textContent = approvedCount;
        approvedBadge.style.display = 'inline-block';
      } else {
        approvedBadge.style.display = 'none';
      }
    }

    // ===== APPROVE LEAVE =====

    async function approveLeave(leaveId) {
      const leave = leaveState.applications.find(l => l.id === leaveId);

      if (!leave) {
        showAlert('Leave application not found', 'danger');
        return;
      }

      const confirmMsg = `✅ APPROVE LEAVE?\n\nStudent: ${leave.studentName}\nDates: ${leave.fromDate} to ${leave.toDate}\nDays: ${leave.days.length}\nReason: ${leave.reason}\n\nThis will mark the student as "On Leave" for ALL subjects on these days.`;

      if (!confirm(confirmMsg)) {
        return;
      }

      try {
        // Get current user
        let approvedBy = 'unknown';
        try {
          const user = await getCurrentUser();
          approvedBy = user.attributes.email;
        } catch (error) {
          console.warn('Could not get current user:', error);
        }

        // Update status in Firebase
        const leavePath = getLeaveApplicationsPath();

        if (!leavePath) {
          showAlert('Cannot approve leave: division context incomplete', 'danger');
          return;
        }

        const updates = {
          status: 'approved',
          approvedBy: approvedBy,
          approvedAt: Date.now()
        };

        if (useCloud && firebaseDB) {
          await firebaseDB.ref(`${leavePath}/${leaveId}`).update(updates);
        } else {
          const allLeaves = await loadFromDatabase('leaveApplications') || {};
          if (allLeaves[leaveId]) {
            allLeaves[leaveId] = { ...allLeaves[leaveId], ...updates };
            await saveToDatabase('leaveApplications', allLeaves);
          }
        }

        console.log(`✅ Leave approved: ${leaveId}`);

        await loadLeaveApplications();

        // Reload leave applications
        await loadLeaveApplications();

        // Refresh attendance table and stats
        refreshAttendanceTable();
        updateStats();
        renderCalendarGrid();

        showAlert(`Leave approved for ${leave.studentName}. Attendance updated for ${leave.days.length} days.`, 'success');

      } catch (error) {
        console.error('Error approving leave:', error);
        showAlert('Failed to approve leave. Please try again.', 'danger');
      }
    }

    // ===== REJECT LEAVE =====

    async function rejectLeave(leaveId) {
      const leave = leaveState.applications.find(l => l.id === leaveId);

      if (!leave) {
        showAlert('Leave application not found', 'danger');
        return;
      }

      const confirmMsg = `⚠️ REJECT LEAVE?\n\nStudent: ${leave.studentName}\nDates: ${leave.fromDate} to ${leave.toDate}\nReason: ${leave.reason}\n\nThis action can be undone by deleting and resubmitting.`;

      if (!confirm(confirmMsg)) {
        return;
      }

      try {
        // Get current user
        let rejectedBy = 'unknown';
        try {
          const user = await getCurrentUser();
          rejectedBy = user.attributes.email;
        } catch (error) {
          console.warn('Could not get current user:', error);
        }

        // Update status in Firebase
        const leavePath = getLeaveApplicationsPath();

        if (!leavePath) {
          showAlert('Cannot reject leave: division context incomplete', 'danger');
          return;
        }

        const updates = {
          status: 'rejected',
          rejectedBy: rejectedBy,
          rejectedAt: Date.now()
        };

        if (useCloud && firebaseDB) {
          await firebaseDB.ref(`${leavePath}/${leaveId}`).update(updates);
        } else {
          const allLeaves = await loadFromDatabase('leaveApplications') || {};
          if (allLeaves[leaveId]) {
            allLeaves[leaveId] = { ...allLeaves[leaveId], ...updates };
            await saveToDatabase('leaveApplications', allLeaves);
          }
        }

        console.log(`❌ Leave rejected: ${leaveId}`);

        // Reload leave applications
        await loadLeaveApplications();

        showAlert(`Leave rejected for ${leave.studentName}.`, 'info');

      } catch (error) {
        console.error('Error rejecting leave:', error);
        showAlert('Failed to reject leave. Please try again.', 'danger');
      }
    }

    // ===== DELETE LEAVE =====

    async function deleteLeave(leaveId) {
      const leave = leaveState.applications.find(l => l.id === leaveId);

      if (!leave) {
        showAlert('Leave application not found', 'danger');
        return;
      }

      const confirmMsg = `🗑️ DELETE LEAVE APPLICATION?\n\nStudent: ${leave.studentName}\nDates: ${leave.fromDate} to ${leave.toDate}\n\nThis action cannot be undone.`;

      if (!confirm(confirmMsg)) {
        return;
      }

      try {
        const leavePath = getLeaveApplicationsPath();

        if (!leavePath) {
          showAlert('Cannot delete leave: division context incomplete', 'danger');
          return;
        }

        if (useCloud && firebaseDB) {
          await firebaseDB.ref(`${leavePath}/${leaveId}`).remove();
        } else {
          const allLeaves = await loadFromDatabase('leaveApplications') || {};
          delete allLeaves[leaveId];
          await saveToDatabase('leaveApplications', allLeaves);
        }

        console.log(`🗑️ Leave deleted: ${leaveId}`);

        // If leave was approved, optionally clear "On Leave" marks
        if (leave.status === 'approved') {
          const clearMarks = confirm(`This leave was approved. Do you want to remove "On Leave" marks from attendance?`);

          if (clearMarks) {
            await clearOnLeaveMarks(leave);
            refreshAttendanceTable();
            updateStats();
            renderCalendarGrid();
          }
        }

        // Reload leave applications
        await loadLeaveApplications();

        showAlert(`Leave application deleted.`, 'info');

      } catch (error) {
        console.error('Error deleting leave:', error);
        showAlert('Failed to delete leave. Please try again.', 'danger');
      }
    }

    // ===== AUTO-MARK ATTENDANCE AS "ON LEAVE" =====

    async function markDaysAsOnLeave(leave) {
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;

      if (!year || !dept || !course || !academicYear || !division) {
        console.error('Cannot mark attendance: division context incomplete');
        return;
      }

      // Get all subjects for this division
      const subjects = getCurrentSubjects();

      if (subjects.length === 0) {
        console.warn('No subjects found for division');
        return;
      }

      const monthKey = `${leave.year}-${String(leave.month + 1).padStart(2, '0')}`;

      console.log(`🔄 Marking ${leave.days.length} days as "On Leave" for ${subjects.length} subjects...`);

      for (const subject of subjects) {
        const attendancePath = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/subjects/${subject}/attendance/${leave.studentId}`;

        try {
          // Check if student exists in this subject
          if (useCloud && firebaseDB) {
            const studentSnapshot = await firebaseDB.ref(attendancePath).once('value');
            const studentData = studentSnapshot.val();

            if (!studentData) {
              console.warn(`Student ${leave.studentId} not found in subject ${subject} - skipping`);
              continue;
            }

            // Mark each day as "On Leave"
            const updates = {};
            leave.days.forEach(day => {
              updates[day] = 'On Leave';
            });

            await firebaseDB.ref(attendancePath).update(updates);
            console.log(`✅ Marked ${leave.days.length} days as "On Leave" in ${subject}`);

          } else {
            // Fallback: Update local attendance data
            if (appState.attendanceData?.[year]?.[dept]?.[course]?.[academicYear]?.[division]?.months?.[monthKey]?.subjects?.[subject]?.attendance?.[leave.studentId]) {
              const studentAttendance = appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance[leave.studentId];

              leave.days.forEach(day => {
                studentAttendance[day] = 'On Leave';
              });

              await saveAllData();
            }
          }

        } catch (error) {
          console.error(`Error marking attendance for subject ${subject}:`, error);
        }
      }

      console.log(`✅ Completed marking attendance as "On Leave"`);
    }

    // ===== CLEAR "ON LEAVE" MARKS (when deleting approved leave) =====

    async function clearOnLeaveMarks(leave) {
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;

      if (!year || !dept || !course || !academicYear || !division) {
        console.error('Cannot clear attendance: division context incomplete');
        return;
      }

      const subjects = getCurrentSubjects();
      const monthKey = `${leave.year}-${String(leave.month + 1).padStart(2, '0')}`;

      console.log(`🔄 Clearing "On Leave" marks for ${leave.days.length} days...`);

      for (const subject of subjects) {
        const attendancePath = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/subjects/${subject}/attendance/${leave.studentId}`;

        try {
          if (useCloud && firebaseDB) {
            const updates = {};
            leave.days.forEach(day => {
              updates[day] = 'Absent'; // Default to Absent when clearing
            });

            await firebaseDB.ref(attendancePath).update(updates);

          } else {
            if (appState.attendanceData?.[year]?.[dept]?.[course]?.[academicYear]?.[division]?.months?.[monthKey]?.subjects?.[subject]?.attendance?.[leave.studentId]) {
              const studentAttendance = appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance[leave.studentId];

              leave.days.forEach(day => {
                studentAttendance[day] = 'Absent';
              });

              await saveAllData();
            }
          }

        } catch (error) {
          console.error(`Error clearing attendance for subject ${subject}:`, error);
        }
      }

      console.log(`✅ Cleared "On Leave" marks`);
    }

    // ===== GET LEAVE INFO FOR STUDENT (for displaying in defaulter list) =====

    function getStudentLeaveInfo(studentId) {
      if (!appState.selectedMonth || !appState.selectedYear) {
        return null;
      }

      const approvedLeaves = leaveState.applications.filter(leave =>
        leave.status === 'approved' &&
        leave.studentId === studentId &&
        leave.month === appState.selectedMonth &&
        leave.year === appState.selectedYear
      );

      if (approvedLeaves.length === 0) {
        return null;
      }

      // Combine all approved leave days
      const totalLeaveDays = new Set();
      const reasons = [];

      approvedLeaves.forEach(leave => {
        leave.days.forEach(day => totalLeaveDays.add(day));
        if (!reasons.includes(leave.reason)) {
          reasons.push(leave.reason);
        }
      });

      return {
        count: totalLeaveDays.size,
        reasons: reasons,
        applications: approvedLeaves
      };
    }

    // ===== GET APPROVED LEAVES FOR STUDENT (Current Month) =====

    function getApprovedLeavesForStudent(studentId) {
      if (!appState.selectedMonth || !appState.selectedYear) {
        return [];
      }

      return leaveState.applications.filter(leave =>
        leave.status === 'approved' &&
        leave.studentId === studentId &&
        leave.month === appState.selectedMonth &&
        leave.year === appState.selectedYear
      );
    }

    // ===== GET LEAVE SUMMARY FOR STUDENT =====

    function getStudentLeaveSummary(studentId) {
      const approvedLeaves = getApprovedLeavesForStudent(studentId);

      if (approvedLeaves.length === 0) {
        return null;
      }

      // Calculate total leave days
      const totalLeaveDays = new Set();
      const reasons = [];

      approvedLeaves.forEach(leave => {
        leave.days.forEach(day => totalLeaveDays.add(day));

        // Get first 20 chars of reason
        const shortReason = leave.reason.substring(0, 20) + (leave.reason.length > 20 ? '...' : '');
        if (!reasons.includes(shortReason)) {
          reasons.push(shortReason);
        }
      });

      return {
        count: totalLeaveDays.size,
        days: Array.from(totalLeaveDays).sort((a, b) => a - b),
        reasons: reasons.join(', '),
        applications: approvedLeaves.length
      };
    }

    function renderAttendanceTable(students) {
      if (!students || students.length === 0) {
        elements.attendanceTableBody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted py-5">
          <i class="bi bi-inbox fs-1"></i>
          <p class="mt-2">No students found. Upload a CSV file to get started.</p>
        </td>
      </tr>
    `;
        return;
      }

      const isHolidayToday = isHoliday(appState.currentDay);
      const threshold = appState.threshold;

      elements.attendanceTableBody.innerHTML = '';

      students.forEach(student => {
        const stats = getStudentStats(student.id);
        const isDefaulter = stats.percentage < threshold;

        // ✅ CHECK IF STUDENT HAS APPROVED LEAVE
        const leaveSummary = getStudentLeaveSummary(student.id);
        const hasLeaveToday = leaveSummary && leaveSummary.days.includes(appState.currentDay);

        const row = document.createElement('tr');
        row.className = student.status === 'Present' ? 'present' : 'absent';

        row.innerHTML = `
      <td><strong>${escapeHtml(student.id)}</strong></td>
      <td>${escapeHtml(student.name)}</td>
      <td>
        <span class="badge ${student.status === 'Present' ? 'bg-success' : 'bg-danger'}">
          ${student.status}
        </span>
        ${isHolidayToday ? '<span class="holiday-badge ms-1">Holiday</span>' : ''}
        ${hasLeaveToday ? '<span class="badge bg-info ms-1" title="Approved leave application exists for today">📝 Leave App</span>' : ''}
      </td>
      <td>
        ${stats.present}/${stats.workingDays} days
        <span class="${isDefaulter ? 'defaulter-badge' : 'good-badge'} ms-2">
          ${stats.percentage}%
        </span>
        ${leaveSummary ? `<br><small class="text-muted">📝 ${leaveSummary.applications} leave app(s) - ${leaveSummary.count} days</small>` : ''}
      </td>
      <td class="teacher-only">
        <button class="btn btn-sm btn-outline-success mark-present-btn" 
          data-id="${escapeHtml(student.id)}" 
          ${isHolidayToday ? 'disabled' : ''}>
          <i class="bi bi-check"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger mark-absent-btn" 
          data-id="${escapeHtml(student.id)}" 
          ${isHolidayToday ? 'disabled' : ''}>
          <i class="bi bi-x"></i>
        </button>
      </td>
    `;

        elements.attendanceTableBody.appendChild(row);
      });

      // Add event listeners for mark buttons
      document.querySelectorAll('.mark-present-btn').forEach(btn => {
        btn.addEventListener('click', () => markAttendance(btn.dataset.id, 'Present'));
      });

      document.querySelectorAll('.mark-absent-btn').forEach(btn => {
        btn.addEventListener('click', () => markAttendance(btn.dataset.id, 'Absent'));
      });
    }


    // ==================== INITIALIZATION ====================
    async function initialize() {
      try {
        // Initialize Firebase
        await initFirebase();


        // Open database
        await openDatabase();

        // Load saved data
        await loadAllData();

        // ==================== INITIALIZE LEAVE SYSTEM ====================

        // Initialize leave modal reference
        leaveModal = null;

        // Load leave applications if division context is complete
        if (appState.selectedDepartment &&
          appState.selectedCourse &&
          appState.selectedAcademicYear &&
          appState.selectedDivision &&
          appState.selectedMonth !== null &&
          appState.selectedYear !== null) {

          console.log('✅ Loading leave applications on startup...');
          await loadLeaveApplications();
        } else {
          console.log('⚠️ Division context incomplete - leave applications will load when context is set');
        }

        // Populate year dropdown
        populateYearDropdown();

        populateDepartmentDropdown();
        renderDepartmentTags();
        if (appState.selectedDepartment) {
          populateCourseDropdown();
          renderCourseTags();
        }

        // ✅ Populate subjects BEFORE calling updateFinalSelectionDropdowns
        populateSubjectDropdown();
        renderSubjectTags();

        updateDepartmentDisplay();
        updateCourseDisplay();
        updateAcademicYearDisplay();
        updateSubjectDisplay();
        updateFinalSelectionDropdowns();

        // Set current month/year as default
        const now = new Date();
        if (appState.selectedMonth === null) {
          elements.monthSelect.value = now.getMonth();
        } else {
          elements.monthSelect.value = appState.selectedMonth;
        }

        if (appState.selectedYear === null) {
          elements.yearSelect.value = now.getFullYear();
        } else {
          elements.yearSelect.value = appState.selectedYear;
        }

        // Update threshold input
        elements.thresholdInput.value = appState.threshold;

        // Populate subject dropdown and tags
        populateSubjectDropdown();
        renderSubjectTags();
        updateSubjectDisplay();

        // If month was selected, restore calendar
        if (appState.selectedMonth !== null && appState.selectedYear !== null) {
          appState.daysInMonth = getDaysInMonth(appState.selectedMonth, appState.selectedYear);
          updateMonthDisplay();
          populateDayDropdown();
          renderCalendarGrid();
          updateHolidayDisplay();
          elements.calendarContainer.style.display = 'block';
          refreshAttendanceTable();
        }

        // Initialize event listeners
        initializeEventListeners();

        // Update stats
        updateStats();
        updateDefaulterCount();

        console.log('Application initialized successfully');


        // ✅ ADD REAL-TIME SYNC HERE
        if (useCloud && firebaseDB) {
          setupRealtimeSync();
        }

        // Apply role-based UI
        await applyRoleBasedUI();

      } catch (error) {
        console.error('Initialization error:', error);
        showAlert('Failed to initialize application. Please refresh the page.', 'danger');
      }
    }

    // ==================== REAL-TIME SYNC ====================
    function setupRealtimeSync() {
      firebaseDB.ref('mainSystem/attendanceData').on('value', (snapshot) => {
        const cloudData = snapshot.val();

        if (cloudData && JSON.stringify(cloudData) !== JSON.stringify(appState.attendanceData)) {
          console.log('📡 Attendance data updated from cloud');
          appState.attendanceData = cloudData;
          // refreshAttendanceTable();
          // updateStats();

          // Show notification
          const notification = document.createElement('div');
          notification.className = 'alert alert-info position-fixed top-0 end-0 m-3';
          notification.style.zIndex = '9999';
          notification.innerHTML = '<i class="bi bi-cloud-arrow-down me-2"></i>Attendance synced from cloud';
          document.body.appendChild(notification);

          setTimeout(() => notification.remove(), 3000);
        }
      });

      console.log('📡 Real-time sync enabled');
    }

    // Start the application
    initialize();
    //start>>>>>>>>>>
    let qrTimerInterval = null;
    let qrExpiryTimestamp = null; // ✅ Track actual expiry time instead of countdown

    function startQRCountdown(seconds) {
      // Clear previous timer
      if (qrTimerInterval) {
        clearInterval(qrTimerInterval);
        qrTimerInterval = null;
      }

      // ✅ Store the actual expiry timestamp (absolute time)
      qrExpiryTimestamp = Date.now() + (seconds * 1000);

      // Update immediately
      updateQRTimer();

      // ✅ Update every second based on actual time remaining
      qrTimerInterval = setInterval(() => {
        updateQRTimer();
      }, 1000);
    }

    function updateQRTimer() {
      // ✅ Calculate remaining time from actual expiry timestamp
      const remaining = Math.max(0, Math.floor((qrExpiryTimestamp - Date.now()) / 1000));

      const mins = Math.floor(remaining / 60);
      const secs = remaining % 60;

      const timerElement = document.getElementById('qrTimer');
      if (timerElement) {
        timerElement.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      const statusElement = document.getElementById('qrStatus');
      const qrContainer = document.getElementById('qrCodeContainer');

      if (remaining <= 0) {
        // ✅ Actually expired
        clearInterval(qrTimerInterval);
        qrTimerInterval = null;
        qrExpiryTimestamp = null;

        if (statusElement) {
          statusElement.className = 'alert alert-danger mb-3';
          statusElement.innerHTML = '⚠️ EXPIRED - Click Generate QR again';
        }

        if (qrContainer) {
          qrContainer.style.opacity = '0.3';
        }

        // ✅ Stop dynamic code rotation when expired
        stopDynamicCodeRotation();
      } else {
        // ✅ Still valid - ensure proper styling
        if (statusElement) {
          statusElement.className = 'alert alert-success mb-3';
        }

        if (qrContainer) {
          qrContainer.style.opacity = '1';
        }
      }
    }

    function stopQRCountdown() {
      if (qrTimerInterval) {
        clearInterval(qrTimerInterval);
        qrTimerInterval = null;
      }
      qrExpiryTimestamp = null;
    }
    //end>>>>>>>>>>

    let dynamicCodeInterval = null;

    function generateDynamicCode() {
      const array = new Uint32Array(1);
      window.crypto.getRandomValues(array);
      return (array[0] % 10000).toString().padStart(4, '0');
    }

    function getRemainingSeconds() {
      const currentTime = Date.now();
      const remaining = 8 - Math.floor((currentTime % 8000) / 1000);
      return remaining;
    }

    function startDynamicCodeRotation() {
      if (dynamicCodeInterval) {
        clearInterval(dynamicCodeInterval);
      }

      const codeElement = document.getElementById('qrDynamicCode');
      const countdownElement = document.getElementById('qrCountdown');

      function update() {
        const now = Date.now();

        // Update code every 8 sec
        if (codeElement) {
          const windowIndex = Math.floor(now / 8000);
          if (!codeElement.dataset.window || codeElement.dataset.window != windowIndex) {
            codeElement.dataset.window = windowIndex;
            const newCode = generateDynamicCode();
            codeElement.textContent = newCode;

            // Save to Firebase
            if (useCloud && firebaseDB) {
              firebaseDB.ref('mainSystem/dynamicCode').set({
                code: newCode,
                timestamp: Date.now(),
                expiresAt: Date.now() + 8000
              });
            }
          }
        }

        // Update countdown every second
        if (countdownElement) {
          const remaining = 8 - Math.floor((now % 8000) / 1000);
          countdownElement.textContent = remaining + "s";
        }
      }

      update();
      dynamicCodeInterval = setInterval(update, 1000);
    }

    function stopDynamicCodeRotation() {
      if (dynamicCodeInterval) {
        clearInterval(dynamicCodeInterval);
        dynamicCodeInterval = null;
      }
      if (useCloud && firebaseDB) {
        firebaseDB.ref('mainSystem/dynamicCode').remove()
          .then(() => {
            console.log('✅ Dynamic code cleared from Firebase');
          })
          .catch((error) => {
            console.error('❌ Failed to clear dynamic code:', error);
          });
      }
    }

    // Listen for refresh requests from face recognition system
    setupRefreshListener();

    function setupRefreshListener() {
      // Method 1: BroadcastChannel (modern browsers)
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('attendance-system');

        channel.onmessage = (event) => {
          if (event.data.type === 'REFRESH_REQUIRED' && event.data.source === 'face-recognition') {
            console.log('📢 Received refresh request from face recognition system');
            handleRefreshRequest();
          }
        };

        console.log('✅ BroadcastChannel listener active');
      }

      // Method 2: Storage event (fallback for cross-tab communication)
      window.addEventListener('storage', (event) => {
        if (event.key === '_refreshRequired' && event.newValue) {
          console.log('📢 Detected refresh flag in storage');
          handleRefreshRequest();
        }
      });

      // Method 3: Periodic polling (fallback)
      setInterval(async () => {
        try {
          const refreshFlag = await loadFromDatabase('_refreshRequired');
          if (refreshFlag && refreshFlag.timestamp) {
            const timeSinceRefresh = Date.now() - refreshFlag.timestamp;
            // If refresh flag is recent (within last 5 seconds)
            if (timeSinceRefresh < 5000) {
              console.log('📢 Found recent refresh flag via polling');
              handleRefreshRequest();
              // Clear the flag
              await saveToDatabase('_refreshRequired', null);
            }
          }
        } catch (error) {
          // Silently ignore errors in polling
        }
      }, 2000); // Check every 2 seconds
    }

    async function handleRefreshRequest() {
      console.log('🔄 Refreshing attendance data...');

      // Show notification to user
      const notification = document.createElement('div');
      notification.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
      notification.style.zIndex = '9999';
      notification.innerHTML = `
    <i class="bi bi-check-circle me-2"></i>
    <strong>Synced!</strong> Attendance updated from face recognition system.
  `;
      document.body.appendChild(notification);

      // Reload data from database
      await loadAllData();

      // Refresh the UI
      refreshAttendanceTable();
      updateStats();
      renderCalendarGrid();

      console.log('✅ Data refreshed successfully');

      // Remove notification after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
  </script>
  <!-- Leave Application Modal -->
  <div class="modal fade" id="leaveModal" tabindex="-1" aria-labelledby="leaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <!-- Header -->
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <h5 class="modal-title" id="leaveModalLabel">
            <i class="bi bi-calendar-x me-2"></i>Submit Leave Application
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <!-- Body -->
        <div class="modal-body">

          <!-- Validation Alert -->
          <div id="leaveValidationAlert" class="alert alert-warning" style="display: none;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="leaveValidationMsg"></span>
          </div>

          <!-- Student Selection -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              Student <span class="text-danger">*</span>
            </label>
            <select id="leaveStudentSelect" class="form-select" required>
              <option value="">-- Select Student --</option>
            </select>
            <small class="text-muted">Select from students in current division</small>
          </div>

          <!-- Date Range -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">
                From Date <span class="text-danger">*</span>
              </label>
              <input type="date" id="leaveFromDate" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">
                To Date <span class="text-danger">*</span>
              </label>
              <input type="date" id="leaveToDate" class="form-control" required>
            </div>
          </div>

          <!-- Day Count Display -->
          <div class="alert alert-info mb-3" id="leaveDayCountAlert" style="display: none;">
            <i class="bi bi-calendar-check me-2"></i>
            <strong>Total Leave Days:</strong> <span id="totalLeaveDays">0</span> day(s)
            <div id="leaveDaysList" class="mt-1 small"></div>
          </div>

          <!-- Reason -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              Reason <span class="text-danger">*</span>
            </label>
            <textarea id="leaveReason" class="form-control" rows="3"
              placeholder="e.g., Sick - High Fever, Family Emergency, Medical Appointment" required></textarea>
            <small class="text-muted">Please provide detailed reason for leave</small>
          </div>

        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Cancel
          </button>
          <button type="button" class="btn btn-primary" id="submitLeaveBtn">
            <i class="bi bi-check-circle me-1"></i>Submit Leave
          </button>
        </div>

      </div>
    </div>
  </div>
</body>

</html>