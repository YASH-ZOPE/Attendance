<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Attendance System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- AWS Cognito SDK -->
  <script
    src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>

  <!-- Cognito Config -->
  <script src="cognito-config.js"></script>

  <!-- Auth Functions -->
  <script src="auth.js"></script>

  <!-- Firebase SDK (Add AFTER AWS Cognito SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Firebase Config (reuse same file) -->
  <script src="firebase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>

  <style>
    :root {
      --primary-color: #E8C4D8;
      --success-color: #D4E8D4;
      --danger-color: #F5D6D6;
      --warning-color: #F9E8D9;
    }
    *::-webkit-scrollbar {
  display: none;
}

/* Hide scrollbar for IE, Edge and Firefox */
* {
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}
    body {
      background: #F8F6F4;
      padding-top: 70px;
    }

    .navbar-brand {
      font-weight: 700;
      font-size: 1.4rem;
    }

    .nav-section {
      scroll-margin-top: 80px;
    }

    .section-card {
      background: #FFFEF9;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
      padding: 20px;
      margin-bottom: 20px;
    }

    .section-title {
      font-weight: 600;
      color: #7A7A7A;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #F0EDE8;
    }

    .present {
      background: #E8F4E8 !important;
    }

    .absent {
      background: #FDECED !important;
    }

    .table-container {
      max-height: 50vh;
      overflow: auto;
    }

    .file-drop {
      border: 2px dashed #E8C4D8;
      padding: 30px;
      text-align: center;
      border-radius: 10px;
      background: #FBF8FA;
      transition: all 0.3s;
      cursor: pointer;
    }

    .file-drop:hover,
    .file-drop.dragover {
      border-color: #D9A8C4;
      background: #F7F0F5;
    }

    .day-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 10px;
    }

    .day-btn {
      padding: 10px 5px;
      text-align: center;
      border: 1px solid #EFEAE5;
      border-radius: 6px;
      cursor: pointer;
      background: #FFFEF9;
      transition: all 0.2s;
      font-weight: 500;
      color: #7A7A7A;
    }

    .day-btn:hover {
      background: #F7F0F5;
      border-color: var(--primary-color);
      transform: scale(1.05);
    }

    .day-btn.active {
      background: #E8C4D8;
      color: #8B5A7A;
      border-color: #E8C4D8;
    }

    .day-btn.has-data {
      background: #E8F0E8;
      border-color: #C8DCC8;
    }

    .day-btn.has-data.active {
      background: #D4E8D4;
      color: #5A7A5A;
    }

    .day-btn.holiday {
      background: #FDF5F5 !important;
      border-color: #F5D6D6 !important;
      color: #B08080;
    }

    .day-btn.holiday.active {
      background: #F5D6D6 !important;
      color: #9A6A6A !important;
    }

    .day-header {
      font-weight: bold;
      text-align: center;
      padding: 8px;
      background: #F5F3F0;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #8A8A8A;
    }

    .subject-tag {
      display: inline-flex;
      align-items: center;
      background: #F7F0F5;
      border: 1px solid #E8C4D8;
      padding: 5px 12px;
      border-radius: 20px;
      margin: 3px;
      font-size: 0.9rem;
      color: #8B5A7A;
    }

    .subject-tag.active {
      background: #E8C4D8;
      color: #6A4A5A;
    }

    .subject-tag .delete-btn {
      cursor: pointer;
      margin-left: 8px;
      color: #D89AA8;
      font-weight: bold;
    }

    .subject-tag.active .delete-btn {
      color: #9A6A7A;
    }

    .stats-card {
      background: linear-gradient(135deg, #E8C4D8 0%, #DDB8CC 100%);
      color: #6A4A5A;
      border-radius: 10px;
      padding: 15px;
    }

    .stats-card.success {
      background: linear-gradient(135deg, #D4E8D4 0%, #C4DCC4 100%);
      color: #4A6A4A;
    }

    .stats-card.danger {
      background: linear-gradient(135deg, #F5D6D6 0%, #EDCACA 100%);
      color: #8A5A5A;
    }

    .stats-card.warning {
      background: linear-gradient(135deg, #F9E8D9 0%, #F0DCCD 100%);
      color: #8A6A4A;
    }

    .defaulter-badge {
      background: #F5D6D6;
      color: #9A6A6A;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .good-badge {
      background: #D4E8D4;
      color: #5A7A5A;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .btn-action {
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .holiday-badge {
      background: #FDF5EB;
      color: #A08060;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.75rem;
    }

    .quick-nav {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
      background: #FFFEF9;
      border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
      padding: 10px;
    }

    .quick-nav a {
      display: block;
      padding: 8px 12px;
      color: #9A9A9A;
      text-decoration: none;
      border-radius: 6px;
      margin: 2px 0;
      font-size: 0.85rem;
    }

    .quick-nav a:hover,
    .quick-nav a.active {
      background: #E8C4D8;
      color: #6A4A5A;
    }

    /* Mobile responsiveness for stats cards */
    @media (max-width: 768px) {
      .stats-card h3 {
        font-size: 1.5rem;
      }

      .section-card {
        padding: 15px;
      }

      .section-title {
        font-size: 1.1rem;
      }

      .btn-action {
        font-size: 0.9rem;
        padding: 6px 12px;
      }

      .day-grid {
        gap: 3px;
      }

      .day-btn {
        padding: 8px 3px;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 576px) {
      body {
        padding-top: 60px;
      }

      .navbar-brand {
        font-size: 1.1rem;
      }

      .stats-card {
        padding: 12px;
      }

      .stats-card h3 {
        font-size: 1.3rem;
      }

      .stats-card h6 {
        font-size: 0.85rem;
      }

      .table-responsive {
        font-size: 0.85rem;
      }

      .go-btn {
        width: 100vw;
        height: auto;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 1rem;
      }
    }

    @media (max-width: 768px) {
      .quick-nav {
        display: none;
      }
    }

    /* Collapsible Info Box */
    .info-alert {
      background: linear-gradient(135deg, #E8E4F0 0%, #DDD8E8 100%);
      border: none;
      border-left: 4px solid #C8B8D8;
      color: #6A5A7A;
      transition: max-height 0.3s ease, padding 0.3s ease;
      overflow: hidden;
      cursor: pointer;
      max-height: 60px;
      /* Collapsed state */
      padding: 15px 20px;
    }

    .info-alert.collapsed {
      max-height: 60px;
    }

    .info-alert.collapsed .info-content {
      display: none;
    }

    .info-alert.collapsed h5::after {
      content: " (Click to expand)";
      font-size: 0.8rem;
      font-weight: normal;
      opacity: 0.7;
    }

    .info-alert:hover,
    .info-alert.expanded {
      max-height: 500px;
      /* Expanded state */
      padding: 20px;
    }

    .info-alert:hover .info-content,
    .info-alert.expanded .info-content {
      display: block;
    }

    .info-alert h5 {
      margin-bottom: 10px;
      transition: margin 0.3s ease;
    }

    .info-alert.collapsed h5 {
      margin-bottom: 0;
    }

    .modal-header-custom {
      background: linear-gradient(135deg, #F5D6D6 0%, #EDCACA 100%);
      color: #8A5A5A;
    }

    .go-btn {
      width: 84vw;
      height: 10vh;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      background: #4facfe;
      border: none;
      border-radius: 8px;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .go-btn:hover {
      background: #00c6ff;
    }

    /* Role-based visibility */
    .admin-only {
      display: block;
    }

    .teacher-only {
      display: block;
    }

    .student-only {
      display: none;
    }

    .hide-for-teacher {
      display: none;
    }

    .hide-for-student {
      display: none;
    }

    /* For buttons/inline elements */
    .admin-only-inline {
      display: inline-block;
    }

    .teacher-only-inline {
      display: inline-block;
    }

    .hide-for-teacher-inline {
      display: none;
    }

    .hide-for-student-inline {
      display: none;
    }

    /* Admin Two-Section Layout */
.admin-config-section {
  display: block;
}

.admin-attendance-section {
  display: block;
}

.admin-nav-button {
  position: fixed;
  bottom: 30px;
  right: 30px;
  z-index: 1000;
  padding: 15px 30px;
  font-size: 1.1rem;
  font-weight: 600;
  border-radius: 50px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  transition: all 0.3s ease;
}

.admin-nav-button:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

    /* Fix Academic Year section spacing */
    #month-section .row.g-2 {
      gap: 10px !important;
      margin-bottom: 15px;
    }

    /* Better dropdown sizing */
    #month-section .col-2 {
      min-width: 150px;
      /* Prevent squeezing */
    }

    /* Academic Year dropdowns - more space */
    #academicYearLevelSelect,
    #divisionSelect {
      min-width: 120px;
    }

    /* Apply button - better alignment */
    #applyMonthBtn {
      margin-top: 0;
      height: 38px;
      /* Match dropdown height */
    }

    /* Alert boxes - prevent text cutoff */
    #currentAcademicDisplay,
    #currentMonthDisplay {
      word-wrap: break-word;
      white-space: normal;
      line-height: 1.4;
    }

    .alert.mb-0.py-2 {
      padding: 10px 15px !important;
      min-height: 45px;
    }

    /* Better label spacing */
    #month-section .form-label.fw-bold.small {
      margin-bottom: 5px;
      font-size: 0.85rem;
    }

    /* ==================== ATTENDANCE SECTION BUTTON FIX ==================== */

    /* Fix camera/attendance section */
    #camera-section {
      margin: 30px 0;
      /* Space from navbar and other sections */
      padding: 0 15px;
      position: relative;
      z-index: 1;
      /* Below navbar */
    }

    /* Attendance button - cleaner design */
    .go-btn {
      width: 100%;
      /* Full width on mobile, container width on desktop */
      max-width: 1050px;
      /* Limit max width */
      height: auto;
      min-height: 80px;
      padding: 20px 30px;
      margin: 0 auto 30px;
      /* Center horizontally */
      display: block;
      font-size: 1.2rem;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #4facfe 0%, #00c6ff 100%);
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      line-height: 1.4;
    }

    .go-btn:hover {
      background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
    }

    .go-btn:active {
      transform: translateY(-1px);
    }

    /* ==================== RESPONSIVE FIXES ==================== */

    /* Desktop view */
    @media (min-width: 992px) {
      #month-section .row.g-2 {
        gap: 15px !important;
      }

      #month-section .col-2 {
        flex: 0 0 auto;
        width: auto;
      }

      .go-btn {
        width: 100vw;
        min-height: 100px;
        font-size: 1.3rem;
      }
    }

    /* Tablet view */
    @media (max-width: 991px) and (min-width: 577px) {
      #month-section .col-2 {
        width: 48%;
        margin-bottom: 10px;
      }

      .go-btn {
        width: 90%;
        min-height: 90px;
      }
    }

    /* Mobile view */
    @media (max-width: 576px) {

      /* Stack Academic Year dropdowns */
      #month-section .col-2 {
        width: 100%;
        margin-bottom: 10px;
      }

      #month-section .row.g-2 {
        gap: 0 !important;
      }

      /* Full width button on mobile */
      .go-btn {
        width: 100%;
        min-height: 70px;
        padding: 15px 20px;
        margin-bottom: 20px;
        font-size: 1.1rem;
        border-radius: 12px;
      }

      /* Smaller alert text on mobile */
      .alert.mb-0.py-2 {
        font-size: 0.85rem;
        padding: 8px 12px !important;
      }

      /* Fix navbar overlap */
      body {
        padding-top: 65px;
        /* Slightly more space */
      }

      #camera-section {
        margin-top: 15px;
      }
    }

    /* Extra small devices */
    @media (max-width: 400px) {
      .go-btn {
        font-size: 1rem;
        min-height: 60px;
        padding: 12px 15px;
      }

      .go-btn::before {
        font-size: 1.1rem;
      }
    }

    /* ==================== NAVBAR Z-INDEX FIX ==================== */

    /* Ensure navbar stays on top */
    .navbar.fixed-top {
      z-index: 1030;
      /* Bootstrap default, but explicitly set */
    }

    /* All content below navbar */
    .container.py-4 {
      position: relative;
      z-index: 1;
    }

    /* ==================== ALIGNMENT & SPACING IMPROVEMENTS ==================== */

    /* Better section spacing */
    .nav-section {
      margin-bottom: 25px;
      scroll-margin-top: 90px;
      /* Account for fixed navbar */
    }

    /* Section cards - consistent padding */
    .section-card {
      padding: 25px;
    }

    @media (max-width: 576px) {
      .section-card {
        padding: 15px;
      }
    }

    /* Calendar container spacing */
    #calendarContainer {
      margin-top: 25px !important;
      padding: 20px;
      background: #fafafa;
      border-radius: 10px;
    }

    /* Better form control heights */
    .form-select,
    .form-control {
      height: 38px;
      padding: 6px 12px;
    }

    .form-select-sm {
      height: 32px;
      padding: 4px 10px;
      font-size: 0.875rem;
    }

    /* ==================== LEAVE APPLICATION STYLES ==================== */

    /* Leave Header Hover Effect */
    .leave-header:hover {
      background: #f8f9fa;
    }

    .leave-header:active {
      background: #e9ecef;
    }

    /* Leave Status Badges */
    .leave-status-pending {
      background: #ffc107;
      color: #000;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .leave-status-approved {
      background: #28a745;
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .leave-status-rejected {
      background: #dc3545;
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* Leave Reason Text */
    .leave-reason-text {
      font-size: 0.9rem;
      color: #6c757d;
      font-style: italic;
    }

    /* On Leave Badge (for attendance table) */
    .on-leave-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    /* Leave Note in Defaulter List */
    .leave-note {
      background: #e7f3ff;
      border-left: 3px solid #667eea;
      padding: 8px 12px;
      margin-top: 5px;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .leave-note i {
      color: #667eea;
    }

    /* Leave Action Buttons */
    .leave-action-btn {
      padding: 4px 10px;
      font-size: 0.85rem;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .leave-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Leave Table Row Highlighting */
    .leave-row-pending {
      background-color: #fff9e6;
    }

    .leave-row-approved {
      background-color: #e8f5e9;
    }

    .leave-row-rejected {
      background-color: #ffebee;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #leaveContent .table {
        font-size: 0.85rem;
      }

      .leave-action-btn {
        font-size: 0.75rem;
        padding: 3px 8px;
      }
    }

    /* ==================== STUDENT ATTENDANCE CALENDAR STYLES ==================== */

    /* Student Present - Green */
    .day-btn.student-present {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
      border-color: #28a745 !important;
      color: #155724 !important;
      font-weight: 600;
    }

    .day-btn.student-present:hover {
      background: linear-gradient(135deg, #c3e6cb 0%, #b1dfbb 100%) !important;
      transform: scale(1.05);
    }

    .day-btn.student-present.active {
      background: #28a745 !important;
      color: white !important;
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
    }

    /* Student Absent - Red */
    .day-btn.student-absent {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%) !important;
      border-color: #dc3545 !important;
      color: #721c24 !important;
      font-weight: 600;
    }

    .day-btn.student-absent:hover {
      background: linear-gradient(135deg, #f5c6cb 0%, #f1b0b7 100%) !important;
      transform: scale(1.05);
    }

    .day-btn.student-absent.active {
      background: #dc3545 !important;
      color: white !important;
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
    }

    /* Student On Leave - Yellow/Amber */
    .day-btn.student-leave {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%) !important;
      border-color: #ffc107 !important;
      color: #856404 !important;
      font-weight: 600;
    }

    .day-btn.student-leave:hover {
      background: linear-gradient(135deg, #ffeaa7 0%, #ffe082 100%) !important;
      transform: scale(1.05);
    }

    .day-btn.student-leave.active {
      background: #ffc107 !important;
      color: #212529 !important;
      box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.3);
    }

    /* Add subtle animation for student days */
    .day-btn.student-present,
    .day-btn.student-absent,
    .day-btn.student-leave {
      transition: all 0.3s ease;
      position: relative;
    }

    /* Add icon indicators (optional) */
    .day-btn.student-present::before {
      content: '‚úì';
      position: absolute;
      top: 2px;
      right: 3px;
      font-size: 0.7rem;
      opacity: 0.6;
    }

    .day-btn.student-absent::before {
      content: '‚úó';
      position: absolute;
      top: 2px;
      right: 3px;
      font-size: 0.7rem;
      opacity: 0.6;
    }

    .day-btn.student-leave::before {
      content: 'üìù';
      position: absolute;
      top: 2px;
      right: 3px;
      font-size: 0.6rem;
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <div id="authLoadingOverlay" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #F8F6F4;
  z-index: 99999;
  overflow: auto;
">
  <!-- Enhanced Navbar Skeleton -->
  <nav class="navbar navbar-dark bg-primary shadow-sm" style="
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  ">
    <div class="container">
      <span class="navbar-brand" style="opacity: 0.7;">
        <i class="bi bi-calendar-check me-2"></i>Smart Attendance
      </span>
      <div class="skeleton-shimmer" style="
        width: 200px; 
        height: 30px; 
        background: rgba(255,255,255,0.2); 
        border-radius: 6px;
        position: relative;
        overflow: hidden;
      ">
        <div class="shimmer-wave"></div>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    
    <!-- Enhanced Skeleton Cards (Stats Section) -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card border-0 shadow-sm skeleton-card" style="
          height: 100px; 
          border-radius: 10px;
          background: white;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
          <div class="card-body">
            <div class="skeleton-line mb-2" style="width: 60%; height: 16px;"></div>
            <div class="skeleton-line" style="width: 40%; height: 24px;"></div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm skeleton-card" style="
          height: 100px; 
          border-radius: 10px;
          background: white;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
          <div class="card-body">
            <div class="skeleton-line mb-2" style="width: 60%; height: 16px;"></div>
            <div class="skeleton-line" style="width: 40%; height: 24px;"></div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm skeleton-card" style="
          height: 100px; 
          border-radius: 10px;
          background: white;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
          <div class="card-body">
            <div class="skeleton-line mb-2" style="width: 60%; height: 16px;"></div>
            <div class="skeleton-line" style="width: 40%; height: 24px;"></div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card border-0 shadow-sm skeleton-card" style="
          height: 100px; 
          border-radius: 10px;
          background: white;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
          <div class="card-body">
            <div class="skeleton-line mb-2" style="width: 60%; height: 16px;"></div>
            <div class="skeleton-line" style="width: 40%; height: 24px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Skeleton Table -->
    <div class="card border-0 shadow-sm" style="border-radius: 10px;">
      <div class="card-body">
        <!-- Table Header -->
        <div class="skeleton-shimmer mb-3" style="
          height: 30px; 
          width: 40%; 
          border-radius: 6px;
          background: #e8e8e8;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
        </div>

        <!-- Table Rows -->
        <div class="skeleton-shimmer mb-2" style="
          height: 50px; 
          border-radius: 8px;
          background: #f5f5f5;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
        </div>

        <div class="skeleton-shimmer mb-2" style="
          height: 50px; 
          border-radius: 8px;
          background: #f5f5f5;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
        </div>

        <div class="skeleton-shimmer mb-2" style="
          height: 50px; 
          border-radius: 8px;
          background: #f5f5f5;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
        </div>

        <div class="skeleton-shimmer mb-2" style="
          height: 50px; 
          border-radius: 8px;
          background: #f5f5f5;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
        </div>

        <div class="skeleton-shimmer" style="
          height: 50px; 
          border-radius: 8px;
          background: #f5f5f5;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Loading Message -->
  <div style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    animation: fadeInUp 0.5s ease;
  ">
    <div class="d-flex align-items-center">
      <div class="spinner-border spinner-border-sm text-primary me-2" style="
        width: 20px;
        height: 20px;
      "></div>
      <span style="color: #6A4A5A; font-weight: 500;">Authenticating...</span>
    </div>
  </div>
</div>

<style>
/* Shimmer Wave Effect */
.shimmer-wave {
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.6) 50%,
    transparent 100%
  );
  animation: shimmerMove 2s infinite;
}

@keyframes shimmerMove {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Skeleton Lines */
.skeleton-line {
  background: linear-gradient(
    90deg,
    #e0e0e0 25%,
    #f0f0f0 50%,
    #e0e0e0 75%
  );
  background-size: 200% 100%;
  border-radius: 4px;
  animation: skeletonPulse 1.5s ease-in-out infinite;
}

@keyframes skeletonPulse {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Skeleton Card Animation */
.skeleton-card {
  animation: fadeIn 0.6s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Loading Message Animation */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Remove old skeleton animation */
.skeleton-shimmer {
  background: #e8e8e8;
}

/* Improved spinner */
.spinner-border {
  border-width: 2px;
}
</style>
  <!-- Navigation Bar (Update links) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-calendar-check me-2"></i>Smart Attendance
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
  <!-- Admin Config Section Links -->
  <li class="nav-item teacher-only admin-config-nav">
    <a class="nav-link" href="#department-section"><i class="bi bi-building me-1"></i>Departments</a>
  </li>
  <li class="nav-item teacher-only admin-config-nav">
    <a class="nav-link" href="#course-section"><i class="bi bi-journal-bookmark me-1"></i>Courses</a>
  </li>
  <li class="nav-item teacher-only admin-config-nav">
    <a class="nav-link" href="#subject-section"><i class="bi bi-book me-1"></i>Subjects</a>
  </li>
  
  <!-- Admin Attendance Section Links -->
  <li class="nav-item teacher-only admin-attendance-nav">
    <a class="nav-link" href="#selection-section"><i class="bi bi-check-square me-1"></i>Selection</a>
  </li>
  <li class="nav-item admin-attendance-nav">
    <a class="nav-link" href="#month-section"><i class="bi bi-calendar3 me-1"></i>Academic Year</a>
  </li>
  <li class="nav-item teacher-only admin-attendance-nav">
    <a class="nav-link" href="#upload-section"><i class="bi bi-upload me-1"></i>Upload</a>
  </li>
  <li class="nav-item admin-attendance-nav">
    <a class="nav-link" href="#attendance-section"><i class="bi bi-table me-1"></i>Attendance</a>
  </li>
  <li class="nav-item teacher-only admin-attendance-nav">
    <a class="nav-link" href="#defaulter-section"><i class="bi bi-exclamation-triangle me-1"></i>Defaulters</a>
  </li>
</ul>
        <div class="d-flex align-items-center">
          <span class="badge bg-light text-dark me-2" id="navSubjectBadge">No Subject</span>
          <span class="badge bg-warning text-dark" id="navMonthBadge">No Month</span>
        </div>
      </div>
    </div>
  </nav>


  <!-- Quick Navigation (Right Side) -->
  <div class="quick-nav d-none d-lg-block">
  <!-- Admin Config Links -->
  <a href="#department-section" class="teacher-only admin-config-nav"><i class="bi bi-building"></i></a>
  <a href="#course-section" class="teacher-only admin-config-nav"><i class="bi bi-journal-bookmark"></i></a>
  <a href="#subject-section" class="teacher-only admin-config-nav"><i class="bi bi-book"></i></a>
  
  <!-- Admin Attendance Links -->
  <a href="#selection-section" class="teacher-only admin-attendance-nav"><i class="bi bi-check-square"></i></a>
  <a href="#month-section" class="admin-attendance-nav"><i class="bi bi-calendar3"></i></a>
  <a href="#upload-section" class="teacher-only admin-attendance-nav"><i class="bi bi-upload"></i></a>
  <a href="#attendance-section" class="admin-attendance-nav"><i class="bi bi-table"></i></a>
  <a href="#defaulter-section" class="teacher-only admin-attendance-nav"><i class="bi bi-exclamation-triangle"></i></a>
</div>

  <div class="container py-4">


    <!-- Info Box -->
<div class="alert info-alert collapsed mb-4 teacher-only" id="infoBox">
  <h5><i class="bi bi-info-circle me-2"></i>How to Use</h5>
  <div class="info-content">
    
    <!-- Admin Only Section 1 -->
    <div class="admin-only">
      <h6 class="mt-3 mb-2 text-primary"><i class="bi bi-shield-lock me-1"></i>Admin - Setup</h6>
      <ol class="mb-0">
        <li><strong>Add Department</strong> - Create departments like Computer Science, Mechanical, etc.</li>
        <li><strong>Add Course</strong> - Select department and add courses like BTech, MTech, etc.</li>
        <li><strong>Add Subject</strong> - Select course and add subjects for that course</li>
      </ol>
    </div>

    <!-- Admin & Teacher Section 2 -->
    <div class="teacher-only-block teacher-only">
      <h6 class="mt-3 mb-2 text-success"><i class="bi bi-person-check me-1"></i>Admin & Teacher - Operations</h6>
      <ol class="mb-0">
        <li><strong>Select All</strong> - Choose Department, Course, Subject</li>
        <li><strong>Select Month & Academic Year</strong> - Choose academic year (FY/SY/TY), year, division, month</li>
        <li><strong>Upload CSV</strong> - Upload attendance file</li>
        <li><strong>Manage Attendance</strong> - View, edit, mark holidays, check defaulters</li>
      </ol>
    </div>

    <!-- Student Section (if needed in future) -->
    <div class="student-only-block" style="display: none;">
      <h6 class="mt-3 mb-2 text-info"><i class="bi bi-mortarboard me-1"></i>Student</h6>
      <p class="mb-0 text-muted">View-only access to attendance records</p>
    </div>

  </div>
</div>

<!-- ========== ADMIN CONFIG SECTION (Department, Course, Subject, Final Selection) ========== -->
<div id="adminConfigSection" class="admin-config-section">
    <!-- SECTION 1: Department Management -->
    <section id="department-section" class="nav-section admin-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-building me-2"></i>Department Management</h4>

        <div class="admin-only">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Add New Department</label>
              <div class="input-group">
                <input type="text" id="newDepartmentInput" class="form-control" placeholder="Enter department name">
                <button id="addDepartmentBtn" class="btn btn-primary">
                  <i class="bi bi-plus-lg me-1"></i>Add
                </button>
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Select Department</label>
              <select id="departmentSelect" class="form-select">
                <option value="">-- Choose Department --</option>
              </select>
            </div>

            <div class="col-md-4 admin-only">
              <label class="form-label fw-bold">Actions</label>
              <div>
                <button id="deleteDepartmentBtn" class="btn btn-outline-danger">
                  <i class="bi bi-trash me-1"></i>Delete Selected
                </button>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-bold">Available Departments:</label>
            <div id="departmentTags">
              <span class="text-muted">No departments added yet. Add your first department above.</span>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3 mb-0" id="departmentStatus">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Current Department:</strong> <span id="currentDepartmentDisplay">None selected</span>
        </div>
      </div>
    </section>



    <!-- SECTION 2: Course Management -->
    <section id="course-section" class="nav-section admin-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-journal-bookmark me-2"></i>Course Management</h4>

        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Note:</strong> Please select a department first before adding courses.
        </div>

        <div class="admin-only">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Add New Course</label>
              <div class="input-group">
                <input type="text" id="newCourseInput" class="form-control" placeholder="Enter course name" disabled>
                <button id="addCourseBtn" class="btn btn-primary" disabled>
                  <i class="bi bi-plus-lg me-1"></i>Add
                </button>
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Select Course</label>
              <select id="courseSelect" class="form-select" disabled>
                <option value="">-- Choose Course --</option>
              </select>
            </div>

            <div class="col-md-4 admin-only">
              <label class="form-label fw-bold">Actions</label>
              <div>
                <button id="deleteCourseBtn" class="btn btn-outline-danger">
                  <i class="bi bi-trash me-1"></i>Delete Selected
                </button>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-bold">Available Courses for <span id="coursesDepartmentName">--</span>:</label>
            <div id="courseTags">
              <span class="text-muted">Select a department first.</span>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3 mb-0" id="courseStatus">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Current Course:</strong> <span id="currentCourseDisplay">None selected</span>
        </div>
      </div>
    </section>



    <!-- SECTION 3: Subject Management -->
    <section id="subject-section" class="nav-section admin-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-book me-2"></i>Subject Management</h4>

        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Note:</strong> Please select a course first before adding subjects.
        </div>

        <div class="admin-only">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Add New Subject</label>
              <div class="input-group">
                <input type="text" id="newSubjectInput" class="form-control" placeholder="Enter subject name" disabled>
                <button id="addSubjectBtn" class="btn btn-primary" disabled>
                  <i class="bi bi-plus-lg me-1"></i>Add
                </button>
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Select Subject</label>
              <select id="subjectSelect" class="form-select" disabled>
                <option value="">-- Choose Subject --</option>
              </select>
            </div>

            <div class="col-md-4 admin-only">
              <label class="form-label fw-bold">Actions</label>
              <div>
                <button id="deleteSubjectBtn" class="btn btn-outline-danger">
                  <i class="bi bi-trash me-1"></i>Delete Selected
                </button>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-bold">Available Subjects for <span id="subjectsCourseName">--</span>:</label>
            <div id="subjectTags">
              <span class="text-muted">Select a course first.</span>
            </div>
          </div>
        </div>

        <div class="alert alert-info mt-3 mb-0" id="subjectStatus">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Current Subject:</strong> <span id="currentSubjectDisplay">None selected</span>
        </div>
      </div>
    </section>

<!-- Admin Navigation Button - Continue to Attendance -->
    <button id="adminContinueBtn" class="btn btn-outline-secondary mb-4 admin-only" style="display: none;">
      Continue to Attendance Management <i class="bi bi-arrow-right ms-2"></i>
    </button>
  </div>
  <!-- End of Admin Config Section -->

  <!-- ========== ADMIN ATTENDANCE SECTION (Everything else) ========== -->
  <div id="adminAttendanceSection" class="admin-attendance-section">

    <!-- Back Button for Admins -->
    <button id="adminBackBtn" class="btn btn-outline-secondary mb-4 admin-only" style="display: none;">
      <i class="bi bi-arrow-left me-2"></i> Back to Setup
    </button>
    <!-- SECTION 4: Final Selection -->
    <section id="selection-section" class="nav-section teacher-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-check-square me-2"></i>Final Selection</h4>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">Department</label>
            <select id="finalDepartmentSelect" class="form-select">
              <option value="">-- Choose Department --</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Course</label>
            <select id="finalCourseSelect" class="form-select" disabled>
              <option value="">-- Choose Course --</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label fw-bold">Subject</label>
            <select id="finalSubjectSelect" class="form-select" disabled>
              <option value="">-- Choose Subject --</option>
            </select>
          </div>
        </div>

        <div class="alert alert-success mt-3 mb-0">
          <strong><i class="bi bi-check-circle me-2"></i>Selected Path:</strong>
          <div class="mt-2">
            <span class="badge bg-primary me-2" id="selectedPathDept">No Department</span>
            <i class="bi bi-arrow-right me-2"></i>
            <span class="badge bg-primary me-2" id="selectedPathCourse">No Course</span>
            <i class="bi bi-arrow-right me-2"></i>
            <span class="badge bg-primary" id="selectedPathSubject">No Subject</span>
          </div>
        </div>
      </div>
    </section>



    <!-- SECTION 5: Month & Calendar (Modified) -->
    <section id="month-section" class="nav-section">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-calendar3 me-2"></i>Academic Year & Calendar</h4>

        <div>
          <div class="row g-2">
            <div class="col-2 teacher-only">
              <label class="form-label fw-bold small">Academic Year</label>
              <select id="academicYearLevelSelect" class="form-select form-select-sm">
                <option value="">-- Select --</option>
                <option value="FY">FY</option>
                <option value="SY">SY</option>
                <option value="TY">TY</option>
              </select>
            </div>


            <div class="col-2 teacher-only">
              <label class="form-label fw-bold small">Division</label>
              <select id="divisionSelect" class="form-select form-select-sm">
                <option value="">-- Select --</option>
                <option value="Division A">Div A</option>
                <option value="Division B">Div B</option>
                <option value="Division C">Div C</option>
              </select>
            </div>

            <div class="col-2">
              <label class="form-label fw-bold small">Month</label>
              <select id="monthSelect" class="form-select form-select-sm">
                <option value="0">Jan</option>
                <option value="1">Feb</option>
                <option value="2">Mar</option>
                <option value="3">Apr</option>
                <option value="4">May</option>
                <option value="5">Jun</option>
                <option value="6">Jul</option>
                <option value="7">Aug</option>
                <option value="8">Sep</option>
                <option value="9">Oct</option>
                <option value="10">Nov</option>
                <option value="11">Dec</option>
              </select>
            </div>

            <div class="col-2">
              <label class="form-label fw-bold small">Year Number</label>
              <select id="yearSelect" class="form-select form-select-sm"></select>
            </div>

            <div class="col-2">
              <label class="form-label fw-bold small">&nbsp;</label>
              <button id="applyMonthBtn" class="btn btn-success btn-sm w-100">
                <i class="bi bi-check-lg me-1"></i>Apply
              </button>
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-12">
            <div class="alert alert-success mb-0 py-2">
              <strong>Selected:</strong>
              <span id="currentAcademicDisplay">None</span>
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-12">
            <div class="alert alert-info mb-0 py-2">
              <strong>Month:</strong>
              <span id="currentMonthDisplay">None</span>
            </div>
          </div>
        </div>


        <!-- Calendar Grid (Same as before) -->
        <div id="calendarContainer" class="mt-4" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-calendar-week me-2"></i>Select Day</h5>
            <div class="teacher-only">
              <button id="toggleHolidayBtn" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-sun me-1"></i>Toggle Holiday
              </button>
              <button id="clearHolidaysBtn" class="btn btn-outline-secondary btn-sm ms-2">
                <i class="bi bi-x-circle me-1"></i>Clear All Holidays
              </button>
            </div>
          </div>

          <div class="day-grid mb-2">
            <div class="day-header">Sun</div>
            <div class="day-header">Mon</div>
            <div class="day-header">Tue</div>
            <div class="day-header">Wed</div>
            <div class="day-header">Thu</div>
            <div class="day-header">Fri</div>
            <div class="day-header">Sat</div>
          </div>
          <div id="dayGrid" class="day-grid"></div>

          <div class="row mt-3">
            <div class="col-md-6">
              <div class="alert alert-warning mb-0">
                <strong><i class="bi bi-sun me-1"></i>Holidays:</strong>
                <span id="holidayList">None</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="alert alert-info mb-0">
                <strong><i class="bi bi-calendar-check me-1"></i>Current Day:</strong>
                <span id="currentDayDisplay">None</span>
                <span id="holidayIndicator" class="badge bg-danger ms-2" style="display: none;">HOLIDAY</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>


    <!-- Statistics Section -->
    <section id="stats-section" class="nav-section">
      <div class="row g-3 mb-4">
        <div class="col-md-3 teacher-only">
          <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">Total Students</h6>
                <h3 class="mb-0" id="statsTotalStudents">0</h3>
              </div>
              <i class="bi bi-people fs-1 opacity-50"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3 teacher-only">
          <div class="stats-card success">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">Present Today</h6>
                <h3 class="mb-0" id="statsPresentToday">0</h3>
              </div>
              <i class="bi bi-check-circle fs-1 opacity-50"></i>
            </div>
          </div>
        </div>
        <div class="col-md-3 teacher-only">
          <div class="stats-card danger">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">Absent Today</h6>
                <h3 class="mb-0" id="statsAbsentToday">0</h3>
              </div>
              <i class="bi bi-x-circle fs-1 opacity-50"></i>
            </div>
          </div>
        </div>

        <div class="col-md-3 teacher-only">
          <div class="stats-card warning">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">Working Days</h6>
                <h3 class="mb-0" id="statsWorkingDays">0</h3>
              </div>
              <i class="bi bi-calendar-date fs-1 opacity-50"></i>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Upload Section -->
    <section id="upload-section" class="nav-section teacher-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-upload me-2"></i>Upload Attendance</h4>

        <div class="row g-3">
          <div class="col-md-8">
            <div class="file-drop" id="fileDrop">
              <i class="bi bi-cloud-upload fs-1 text-primary"></i>
              <h5 class="mt-2">Drop CSV file here</h5>
              <p class="text-muted mb-2">or click to browse</p>
              <input type="file" id="fileInput" accept=".csv" style="display: none;">
              <button class="btn btn-primary" id="browseBtn">
                <i class="bi bi-folder2-open me-1"></i>Browse Files
              </button>
            </div>
            <div id="fileInfo" class="alert alert-info mt-2" style="display: none;"></div>
          </div>

          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header bg-light">
                <strong><i class="bi bi-file-earmark-text me-1"></i>CSV Format</strong>
              </div>
              <div class="card-body">
                <small>
                  <strong>Columns:</strong> ID, Name, Day1, Day2...Day31<br><br>
                  <strong>Example:</strong><br>
                  <code>1, YASH, Present, Absent, Present...</code><br>
                  <code>2, SHAM, Absent, Present, Present...</code>
                </small>
              </div>
              <div class="card-footer">
                <button id="downloadTemplateBtn" class="btn btn-outline-info btn-sm w-100">
                  <i class="bi bi-download me-1"></i>Download Template
                </button>
              </div>
            </div>
          </div>
        </div>


        <div class="mt-3">
  <div class="row g-2">
    <div class="col-12 col-md-3">
      <button id="downloadReportBtn" class="btn btn-outline-success btn-action w-100 teacher-only-inline">
        <i class="bi bi-file-earmark-arrow-down me-1"></i>Download Report
      </button>
    </div>
    <div class="col-12 col-md-3">
      <button id="clearAllBtn" class="btn btn-outline-danger btn-action w-100 admin-only-inline">
        <i class="bi bi-trash me-1"></i>Clear All Data
      </button>
    </div>
    <div class="col-12 col-md-3">
      <button id="debugSaveBtn" class="btn btn-outline-warning btn-action w-100 admin-only-inline">
        <i class="bi bi-bug me-1"></i>DEBUG: Check Saved Data
      </button>
    </div>
    <div class="col-12 col-md-3">
      <button id="generateQRBtn" class="btn btn-outline-info btn-action w-100 teacher-only-inline">
        <i class="bi bi-qr-code me-1"></i>Generate QR
      </button>
    </div>
  </div>
</div>
    </section>

    <div class="col-md-3" style="display: none;">
      <button class="btn btn-primary w-100" id="studentOpenLeaveFormBtn">
        <i class="bi bi-plus-circle me-1"></i>Submit New Leave
      </button>
    </div>

    <section id="camera-section" class="nav-section">
      <button class="go-btn" onclick="window.location.href='face-recognition.html'">
        Attendance Section
      </button>
    </section>

    <!-- Attendance Section -->
    <section id="attendance-section" class="nav-section teacher-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-table me-2"></i>Attendance Table</h4>

        <!-- Day Navigation -->
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">Select Day</label>
            <select id="dateSelect" class="form-select" disabled>
              <option value="">-- Select month first --</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">Navigation</label>
            <div class="btn-group w-100">
              <button id="prevDayBtn" class="btn btn-outline-primary" disabled>
                <i class="bi bi-chevron-left"></i> Previous
              </button>
              <button id="nextDayBtn" class="btn btn-outline-primary" disabled>
                Next <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
          <div class="col-md-4"> <!-- ‚úÖ REMOVED teacher-only from div -->
            <label class="form-label fw-bold teacher-only">Quick Actions</label> <!-- ‚úÖ MOVED to label -->
            <div class="btn-group w-100 teacher-only"> <!-- ‚úÖ MOVED to buttons container -->
              <button id="markAllPresentBtn" class="btn btn-outline-success">All Present</button>
              <button id="markAllAbsentBtn" class="btn btn-outline-danger">All Absent</button>
            </div>
          </div>
        </div>
        <div class="teacher-only">
          <div class="row g-2 mb-3">
            <div class="col-12 col-sm-6 col-md-3">
              <div class="input-group input-group-sm">
                <input type="text" id="searchInput" class="form-control" placeholder="Search ID/Name">
                <button id="searchBtn" class="btn btn-outline-primary">
                  <i class="bi bi-search"></i>
                </button>
                <button id="resetSearchBtn" class="btn btn-outline-secondary">
                  <i class="bi bi-x"></i>
                </button>
              </div>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <select id="sortSelect" class="form-select form-select-sm">
                <option value="">Sort by...</option>
                <option value="id-asc">ID (Low‚ÜíHigh)</option>
                <option value="id-desc">ID (High‚ÜíLow)</option>
                <option value="name-asc">Name (A‚ÜíZ)</option>
                <option value="name-desc">Name (Z‚ÜíA)</option>
                <option value="attendance-asc">Attend % (Low‚ÜíHigh)</option>
                <option value="attendance-desc">Attend % (High‚ÜíLow)</option>
              </select>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <select id="filterSelect" class="form-select form-select-sm">
                <option value="all">Show All</option>
                <option value="present">Present Only</option>
                <option value="absent">Absent Only</option>
                <option value="defaulter">Defaulters Only</option>
              </select>
            </div>
            <div class="col-12 col-sm-6 col-md-3">
              <button id="refreshTableBtn" class="btn btn-outline-primary btn-sm w-100">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
              </button>
            </div>
          </div>
        </div>
        <!-- Table -->
        <div class="table-responsive table-container border rounded">
          <table id="attendanceTable" class="table table-hover mb-0">
            <thead class="table-light sticky-top">
              <tr>
                <th width="10%">ID</th>
                <th width="25%">Name</th>
                <th width="15%">Today</th>
                <th width="25%">Monthly Stats</th>
                <th width="25%" class="teacher-only">Actions</th>
              </tr>
            </thead>
            <tbody id="attendanceTableBody">
              <tr>
                <td colspan="5" class="text-center text-muted py-5">
                  <i class="bi bi-inbox fs-1"></i>
                  <p class="mt-2">No data loaded. Please select a subject, month, and upload a CSV file.</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Summary -->
        <div class="d-flex justify-content-between align-items-center mt-3 p-3 bg-light rounded teacher-only">
          <div>
            <strong>Total:</strong> <span id="summaryTotal" class="badge bg-primary">0</span>
            <strong class="ms-3">Present:</strong> <span id="summaryPresent" class="badge bg-success">0</span>
            <strong class="ms-3">Absent:</strong> <span id="summaryAbsent" class="badge bg-danger">0</span>
          </div>
          <div>
            <strong>Attendance Rate:</strong> <span id="summaryRate" class="badge bg-info">0%</span>
          </div>
        </div>
      </div>
    </section>
    <div class="col-md-3 teacher-only">
      <div class="section-card">
        <li class="nav-item teacher-only">
          <a class="nav-link" href="leave-applications.html">
            <i class="bi bi-calendar-x me-1"></i>Leave Applications
          </a>
        </li>
      </div>
    </div>
    <!-- Defaulter Section -->
    <section id="defaulter-section" class="nav-section teacher-only">
      <div class="section-card">
        <h4 class="section-title"><i class="bi bi-exclamation-triangle me-2"></i>Defaulter Management</h4>

        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label fw-bold">Minimum Attendance Threshold</label>
            <div class="input-group">
              <input type="number" id="thresholdInput" class="form-control" value="75" min="0" max="100">
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="col-md-3">
            <button id="showDefaultersBtn" class="btn btn-danger btn-action w-100">
              <i class="bi bi-list-ul me-1"></i>Show Defaulters
            </button>
          </div>
          <div class="col-md-3">
            <button id="exportDefaultersBtn" class="btn btn-outline-danger btn-action w-100">
              <i class="bi bi-download me-1"></i>Export Defaulters
            </button>
          </div>
          <div class="col-md-3">
            <div class="alert alert-danger mb-0 py-2 text-center">
              <strong>Defaulters:</strong> <span id="defaulterCount">0</span>
            </div>
          </div>
        </div>

        <!-- Defaulter Table -->
        <div id="defaulterTableContainer" class="mt-4" style="display: none;">
          <h5><i class="bi bi-people me-2"></i>Defaulter List</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-danger">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Present Days</th>
                  <th>Absent Days</th>
                  <th>Working Days</th>
                  <th>Attendance %</th>
                </tr>
              </thead>
              <tbody id="defaulterTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
</div>
  <!-- End of Admin Attendance Section -->
  </div>

  <!-- Defaulter Modal -->
  <div class="modal fade" id="defaulterModal" tabindex="-1" aria-labelledby="defaulterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header modal-header-custom">
          <h5 class="modal-title" id="defaulterModalLabel">
            <i class="bi bi-exclamation-triangle me-2"></i>Defaulters Report
          </h5>
          <button type="button" class="btn-close btn-close-white" id="modalCloseBtn" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-4">
              <strong>Subject:</strong> <span id="modalSubject">-</span>
            </div>
            <div class="col-4">
              <strong>Month:</strong> <span id="modalMonth">-</span>
            </div>
            <div class="col-4">
              <strong>Threshold:</strong> <span id="modalThreshold">75%</span>
            </div>
          </div>

          <div id="modalDefaulterContent">
            <table class="table table-striped">
              <thead class="table-danger">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Present</th>
                  <th>Absent</th>
                  <th>Working Days</th>
                  <th>Attendance %</th>
                </tr>
              </thead>
              <tbody id="modalDefaulterTableBody"></tbody>
            </table>
          </div>

          <div id="noDefaultersAlert" class="alert alert-success" style="display: none;">
            <i class="bi bi-emoji-smile me-2"></i>
            Great! No defaulters found. All students have attendance above the threshold.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="modalCloseBtnFooter">Close</button>
          <button type="button" class="btn btn-danger" id="modalExportBtn">
            <i class="bi bi-download me-1"></i>Export to CSV
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- QR Code Modal -->
  <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
      <div class="modal-content">
        <div class="modal-header"
          style="background: linear-gradient(135deg, #D4E8F5 0%, #C4DFF0 100%); color: #3A6A8A;">
          <h5 class="modal-title" id="qrModalLabel"><i class="bi bi-qr-code me-2"></i>QR Code ‚Äì Attendance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center p-4">
          <!-- QR Status Timer -->
          <div id="qrStatus" class="alert alert-success mb-3" style="display:none;">
            ‚úÖ Active - Expires in: <span id="qrTimer">10:00</span>

          </div>
          <!-- Dynamic Security Code -->
          <div id="qrDynamicCodeDisplay" class="alert alert-warning mb-3" style="display:none;">
            üîê Security Code: <span id="qrDynamicCode"
              style="font-family: monospace; font-size: 1.5rem; font-weight: bold;">----</span>
            <br>
            Refreshes in <span id="qrCountdown">8</span>s
          </div>
          <!-- Validation warning (shown when fields missing) -->
          <div id="qrValidationAlert" class="alert alert-warning mb-3" style="display:none; font-size:0.85rem;">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <span id="qrValidationMsg"></span>
          </div>

          <!-- QR image container -->
          <div id="qrCodeContainer" class="d-flex justify-content-center mb-3"></div>

          <!-- Path badges showing what's encoded -->
          <div id="qrPathBadges" class="mb-2">
            <span class="badge bg-primary me-1" id="qrBadgeDept">‚Äî</span>
            <i class="bi bi-chevron-right text-muted" style="font-size:0.7rem;"></i>
            <span class="badge bg-primary me-1" id="qrBadgeCourse">‚Äî</span>
            <i class="bi bi-chevron-right text-muted" style="font-size:0.7rem;"></i>
            <span class="badge bg-success me-1" id="qrBadgeSubject">‚Äî</span>
          </div>
          <div class="mb-3 d-none">
            <span class="badge bg-secondary me-1" id="qrBadgeAcYear">‚Äî</span>
            <span class="badge bg-secondary me-1" id="qrBadgeDiv">‚Äî</span>
            <span class="badge bg-warning text-dark me-1" id="qrBadgeMonth">‚Äî</span>
            <span class="badge bg-warning text-dark" id="qrBadgeDay">‚Äî</span>
          </div>

          <small class="text-muted">Scan this on the Face Recognition page to set the division and mark
            attendance.</small>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
            <i class="bi bi-x me-1"></i>Close
          </button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>

    // ==================== FIREBASE CLOUD STORAGE ====================
    let firebaseDB = null;
    let useCloud = false;
    // Add after appState declaration
    let currentUserRole = null;
    let currentStudentId = null;
    // Initialize Firebase
    async function initFirebase() {
      try {
        if (typeof firebase === 'undefined') {
          console.warn('‚ö†Ô∏è Firebase not loaded, using IndexedDB only');
          return false;
        }

        firebaseDB = firebase.database();

        // Test connection
        await firebaseDB.ref('.info/connected').once('value');

        useCloud = true;
        console.log('‚úÖ Firebase connected for main system');
        return true;
      } catch (error) {
        console.error('‚ùå Firebase connection failed:', error);
        useCloud = false;
        return false;
      }
    }
    function encodeFirebaseKey(key) {
      if (!key) return key;
      return String(key).replace(/\//g, '__');
    }

    function encodeNestedObject(obj) {
      if (!obj || typeof obj !== 'object') return obj;

      const encoded = {};
      for (const key in obj) {
        const encodedKey = encodeFirebaseKey(key);
        const value = obj[key];

        // If value is an object, encode it recursively
        if (value && typeof value === 'object' && !Array.isArray(value)) {
          encoded[encodedKey] = encodeNestedObject(value);
        } else {
          encoded[encodedKey] = value;
        }
      }
      return encoded;
    }

    function decodeNestedObject(obj) {
      if (!obj || typeof obj !== 'object') return obj;

      const decoded = {};
      for (const key in obj) {
        const decodedKey = decodeFirebaseKey(key);
        const value = obj[key];

        // If value is an object, decode it recursively
        if (value && typeof value === 'object' && !Array.isArray(value)) {
          decoded[decodedKey] = decodeNestedObject(value);
        } else {
          decoded[decodedKey] = value;
        }
      }
      return decoded;
    }
    function decodeFirebaseKey(key) {
      if (!key) return key;
      return String(key).replace(/__/g, '/');
    }
    // Save data (cloud + local hybrid)
    // Save data (FIREBASE FIRST, IndexedDB as backup)
    async function saveToStorage(key, data) {
      let firebaseSaved = false;
      let path;

      // ‚úÖ GLOBAL KEYS (shared by all)
      const globalKeys = ['departments', 'courses', 'subjects', 'threshold'];

      // ‚úÖ ENCODE DATA FOR FIREBASE (fix "/" in keys)
      let firebaseData = data;
      if (key === 'subjects' || key === 'courses') {
        firebaseData = encodeNestedObject(data);
      }

      // ‚úÖ DIVISION-SPECIFIC KEYS (stored in division path)
      const divisionSpecificKeys = [
        'selectedDepartment',
        'selectedCourse',
        'selectedSubject',
        'selectedMonth',
        'selectedYear',
        'currentDay',
        'selectedAcademicYear',  // Store in division path
        'selectedDivision'       // Store in division path
      ];

      if (globalKeys.includes(key)) {
        // Save to global path
        path = `mainSystem/${key}`;
      }
      else if (divisionSpecificKeys.includes(key)) {
        // Save to division-specific path
        const year = appState.selectedYear || new Date().getFullYear();
        const dept = appState.selectedDepartment;
        const course = appState.selectedCourse;
        const academicYear = appState.selectedAcademicYear;
        const division = appState.selectedDivision;

        if (!dept || !course || !academicYear || !division) {
          console.warn(`‚ö†Ô∏è Cannot save ${key}: division path incomplete. Saving to IndexedDB only.`);
          // Save to IndexedDB as fallback
          try {
            await saveToDatabase(key, data);
          } catch (error) {
            console.warn(`‚ö†Ô∏è IndexedDB save failed for ${key}:`, error);
          }
          return;
        }

        path = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/${key}`;
      }
      else if (key === 'attendanceData') {
        // Full attendance data structure saves to root
        path = `mainSystem/attendanceData`;
      }
      else if (key === 'holidays') {
        // Holidays save to current month path (shared by all divisions)
        const year = appState.selectedYear || new Date().getFullYear();
        const dept = appState.selectedDepartment;
        const course = appState.selectedCourse;
        const academicYear = appState.selectedAcademicYear;
        const division = appState.selectedDivision;
        const monthKey = getMonthKey();

        if (!dept || !course || !academicYear || !division || !monthKey) {
          console.warn(`‚ö†Ô∏è Cannot save holidays: path incomplete`);
          await saveToDatabase(key, data);
          return;
        }

        path = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/holidays`;
      }
      else {
        // Default to global
        path = `mainSystem/${key}`;
      }

      // Try Firebase FIRST
      if (useCloud && firebaseDB) {
        try {
          await firebaseDB.ref(path).set(firebaseData);  // ‚úÖ Use encoded data
          console.log(`‚úÖ Saved to Firebase: ${path}`);
          firebaseSaved = true;
        } catch (error) {
          console.error(`‚ùå Firebase save failed for ${key}:`, error);
        }
      }

      // Backup to IndexedDB
      try {
        await saveToDatabase(key, data);
        console.log(`üìÇ Backup to IndexedDB: ${key}`);
      } catch (error) {
        console.warn(`‚ö†Ô∏è IndexedDB backup failed for ${key}:`, error);
      }

      if (!firebaseSaved && !useCloud) {
        console.warn(`‚ö†Ô∏è Firebase not connected, using IndexedDB only`);
      }
    }
    // After successful login, read user's division attributes
    async function initializeMainSystemForStudent() {
      try {
        const user = await getCurrentUser();
        const attributes = await getUserAttributes();

        // Extract custom attributes
        const department = attributes['custom:department'];
        const course = attributes['custom:course'];
        const academicYear = attributes['custom:academicYear'];
        const division = attributes['custom:division'];

        if (department && course && academicYear && division) {
          // Auto-populate and LOCK the dropdowns
          document.getElementById('departmentSelect').value = department;
          document.getElementById('departmentSelect').disabled = true;

          // Load courses for this department
          await loadCoursesForDepartment(department);
          document.getElementById('courseSelect').value = course;
          document.getElementById('courseSelect').disabled = true;

          document.getElementById('academicYearSelect').value = academicYear;
          document.getElementById('academicYearSelect').disabled = true;

          document.getElementById('divisionSelect').value = division;
          document.getElementById('divisionSelect').disabled = true;

          console.log('‚úÖ Student division locked:', { department, course, academicYear, division });

          // Load their attendance data
          await loadAttendanceForDivision();
        } else {
          console.warn('‚ö†Ô∏è Student missing division attributes');
        }

      } catch (error) {
        console.error('Error initializing student:', error);
      }
    }
    // Load data (FIREBASE FIRST, fallback to IndexedDB)
    async function loadFromStorage(key) {
      let path;

      // ‚úÖ GLOBAL KEYS
      const globalKeys = ['departments', 'courses', 'subjects', 'threshold'];

      // ‚úÖ DIVISION-SPECIFIC KEYS
      const divisionSpecificKeys = [
        'selectedDepartment',
        'selectedCourse',
        'selectedSubject',
        'selectedMonth',
        'selectedYear',
        'currentDay',
        'selectedAcademicYear',
        'selectedDivision'
      ];

      if (globalKeys.includes(key)) {
        path = `mainSystem/${key}`;
      }
      else if (divisionSpecificKeys.includes(key)) {
        const year = appState.selectedYear || new Date().getFullYear();
        const dept = appState.selectedDepartment;
        const course = appState.selectedCourse;
        const academicYear = appState.selectedAcademicYear;
        const division = appState.selectedDivision;

        if (!dept || !course || !academicYear || !division) {
          console.warn(`‚ö†Ô∏è Cannot load ${key}: division path incomplete. Loading from IndexedDB.`);
          // Load from IndexedDB as fallback
          try {
            const localData = await loadFromDatabase(key);
            if (localData !== null) {
              console.log(`üìÇ Loaded from IndexedDB: ${key}`);
              return localData;
            }
          } catch (error) {
            console.error(`‚ùå IndexedDB load failed for ${key}:`, error);
          }
          return null;
        }

        path = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/${key}`;
      }
      else if (key === 'attendanceData') {
        path = `mainSystem/attendanceData`;
      }
      else if (key === 'holidays') {
        const year = appState.selectedYear || new Date().getFullYear();
        const dept = appState.selectedDepartment;
        const course = appState.selectedCourse;
        const academicYear = appState.selectedAcademicYear;
        const division = appState.selectedDivision;
        const monthKey = getMonthKey();

        if (!dept || !course || !academicYear || !division || !monthKey) {
          console.warn(`‚ö†Ô∏è Cannot load holidays: path incomplete`);
          const localData = await loadFromDatabase(key);
          return localData;
        }

        path = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/holidays`;
      }
      else {
        path = `mainSystem/${key}`;
      }

      // Try Firebase first
      if (useCloud && firebaseDB) {
        try {
          const snapshot = await firebaseDB.ref(path).once('value');
          let cloudData = snapshot.val();

          if (cloudData !== null) {
            // ‚úÖ DECODE DATA FROM FIREBASE
            if (key === 'subjects' || key === 'courses') {
              cloudData = decodeNestedObject(cloudData);
            }
            console.log(`‚úÖ Loaded from Firebase: ${path}`);
            return cloudData;
          } else {
            console.log(`üìÇ No Firebase data for ${path}, trying IndexedDB...`);
          }
        } catch (error) {
          console.error(`‚ùå Firebase load failed for ${key}:`, error);
        }
      }

      // Fallback to IndexedDB
      try {
        const localData = await loadFromDatabase(key);
        if (localData !== null) {
          console.log(`üìÇ Loaded from IndexedDB: ${key}`);
          return localData;
        }
      } catch (error) {
        console.error(`‚ùå IndexedDB load failed for ${key}:`, error);
      }

      console.log(`‚ö†Ô∏è No data found for ${key}`);
      return null;
    }
    // ==================== END FIREBASE FUNCTIONS ====================

    // ==================== AUTHENTICATION CHECK ====================
    // ... your existing authentication code ...


    // ==================== AUTHENTICATION CHECK ====================
    async function checkAuthAndInit() {
      try {
        // Check if logged in
        const user = await getCurrentUser();

        if (!user) {
          // Not logged in - redirect to login
          window.location.href = 'index.html';
          return;
        }

        // Get role
        const role = await getUserRole();

        // Show user info
        console.log(`Logged in as: ${user.attributes.email} (${role})`);
        // ‚úÖ STORE ROLE GLOBALLY
        currentUserRole = role;

        if (role === 'student') {
          const attributes = await getUserAttributes();
          currentStudentId = attributes['custom:studentId'];
        }

        // ‚úÖ FOR STUDENTS: Auto-populate and lock division fields
        if (role === 'student') {
          const attributes = await getUserAttributes();

          const department = attributes['custom:department'];
          const course = attributes['custom:course'];
          const academicYear = attributes['custom:academicYear'];
          const division = attributes['custom:division'];

          if (department && course && academicYear && division) {
            // Set in appState
            appState.selectedDepartment = department;
            appState.selectedCourse = course;
            appState.selectedAcademicYear = academicYear;
            appState.selectedDivision = division;

            console.log('‚úÖ Student division locked:', { department, course, academicYear, division });
          } else {
            console.warn('‚ö†Ô∏è Student missing division attributes');
            alert('Your account is missing division information. Please contact admin.');
          }
        }

        if (role === 'teacher') {
          console.log('üîÑ Teacher login - Clearing session selections');

          // Clear from appState
          appState.selectedDepartment = null;
          appState.selectedCourse = null;
          appState.selectedSubject = null;
          appState.selectedAcademicYear = null;
          appState.selectedDivision = null;

          // Clear from storage
          await saveToStorage('selectedDepartment', null);
          await saveToStorage('selectedCourse', null);
          await saveToStorage('selectedSubject', null);
          await saveToStorage('selectedAcademicYear', null);
          await saveToStorage('selectedDivision', null);
        }

        // Continue with normal initialization
        initialize();

      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = 'index.html';
      }
    }

    async function applyRoleBasedUI() {
  try {
    const role = await getUserRole();
    console.log('üîµ Applying UI for role:', role);

    // Apply role-specific hiding
    if (role === 'admin') {
      console.log('‚úÖ Admin - Full access');
      
    } else if (role === 'teacher') {
      hideElements('.admin-only');
      hideElements('.admin-only-inline');
      console.log('‚úÖ Teacher - Hid admin elements');

    } else if (role === 'student') {
      hideElements('.admin-only');
      hideElements('.admin-only-inline');
      hideElements('.teacher-only');
      hideElements('.teacher-only-inline');
      hideElements('.hide-for-student');
      hideElements('.hide-for-student-inline');
      makeTableReadOnly();
      console.log('‚úÖ Student - Read-only mode');
    }

  } catch (error) {
    console.error('‚ùå Error applying role-based UI:', error);
  } finally {
    // ‚úÖ ALWAYS runs, even if there's an error
    console.log('üîÑ Removing loading overlay...');
    
    const overlay = document.getElementById('authLoadingOverlay');
    if (overlay) {
      // Smooth fade out
      overlay.style.transition = 'opacity 0.5s ease';
      overlay.style.opacity = '0';
      
      // Remove after fade
      setTimeout(() => {
        overlay.remove();
        console.log('‚úÖ Overlay removed successfully');
      }, 500);
    } else {
      console.warn('‚ö†Ô∏è Overlay element not found');
    }
  }
}
    function hideElements(selector) {
      document.querySelectorAll(selector).forEach(el => {
        el.style.display = 'none';
      });
    }

    function makeTableReadOnly() {
      // ‚úÖ Disable ONLY teacher-specific controls
      document.querySelectorAll('.teacher-only input, .teacher-only select, .teacher-only button').forEach(el => {
        el.disabled = true;
      });

      // ‚úÖ Disable month/year/division/academic year selects for students
      elements.academicYearLevelSelect.disabled = false; // Keep academic year select enabled for students
      elements.divisionSelect.disabled = false;
      elements.monthSelect.disabled = false;
      elements.yearSelect.disabled = false;

      // ‚úÖ EXPLICITLY ENABLE day navigation (force override)
      elements.prevDayBtn.disabled = false;
      elements.nextDayBtn.disabled = false;
      elements.dateSelect.disabled = false;

      // ‚úÖ Make buttons visible and clickable for students
      elements.prevDayBtn.style.pointerEvents = 'auto';
      elements.nextDayBtn.style.pointerEvents = 'auto';
      elements.dateSelect.style.pointerEvents = 'auto';

      // ‚úÖ Hide ONLY action buttons in table (NOT navigation)
      const style = document.createElement('style');
      style.id = 'student-readonly-styles';
      style.textContent = `
    /* Hide mark attendance buttons */
    .mark-present-btn, 
    .mark-absent-btn { 
      display: none !important; 
    }
    
    /* Hide teacher-only sections but NOT day navigation */
    .teacher-only:not(#prevDayBtn):not(#nextDayBtn):not(#dateSelect) { 
      display: none !important; 
    }
    
    /* Keep day navigation visible and clickable */
    #prevDayBtn, 
    #nextDayBtn, 
    #dateSelect {
      opacity: 1 !important;
      pointer-events: auto !important;
      display: inline-block !important;
    }
  `;

      // ‚úÖ Only add if not already added
      if (!document.getElementById('student-readonly-styles')) {
        document.head.appendChild(style);
      }

      console.log('‚úÖ Student read-only mode applied - day navigation enabled');
    }
    // Logout function (if you add logout button)
    async function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        await logout();
        window.location.href = 'index.html';
      }
    }

    // Call on page load
    window.addEventListener('DOMContentLoaded', checkAuthAndInit);

    // ==================== YOUR EXISTING CODE BELOW ====================
    async function initialize() {
      // Your existing initialization code...
      // Collapsible info box - click to toggle
      document.getElementById('infoBox').addEventListener('click', function () {
        this.classList.toggle('collapsed');
        this.classList.toggle('expanded');
      });
      await openDatabase();
      // ... rest of code
    }



    // ==================== INDEXEDDB SETUP ====================
    let db = null;
    let dbReady = false;

    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("SmartAttendanceDB", 1);

        request.onupgradeneeded = (event) => {
          db = event.target.result;
          if (!db.objectStoreNames.contains("appData")) {
            db.createObjectStore("appData", { keyPath: "key" });
          }
        };

        request.onsuccess = (event) => {
          db = event.target.result;
          dbReady = true;
          console.log("Database opened successfully");
          resolve(db);
        };

        request.onerror = (event) => {
          console.error("Database error:", event.target.error);
          reject(event.target.error);
        };
      });
    }

    function saveToDatabase(key, data) {
      return new Promise((resolve, reject) => {
        if (!dbReady) {
          console.warn("Database not ready");
          resolve();
          return;
        }

        try {
          const transaction = db.transaction(["appData"], "readwrite");
          const store = transaction.objectStore("appData");
          store.put({ key: key, value: data });

          transaction.oncomplete = () => resolve();
          transaction.onerror = () => reject(transaction.error);
        } catch (error) {
          console.error("Save error:", error);
          reject(error);
        }
      });
    }

    function loadFromDatabase(key) {
      return new Promise((resolve, reject) => {
        if (!dbReady) {
          resolve(null);
          return;
        }

        try {
          const transaction = db.transaction(["appData"], "readonly");
          const store = transaction.objectStore("appData");
          const request = store.get(key);

          request.onsuccess = () => {
            resolve(request.result ? request.result.value : null);
          };
          request.onerror = () => reject(request.error);
        } catch (error) {
          console.error("Load error:", error);
          reject(error);
        }
      });
    }

    async function saveAllData() {
      try {
        if (appState.selectedYear === null && elements.yearSelect.value) {
          appState.selectedYear = parseInt(elements.yearSelect.value);
        }

        await saveToStorage("subjects", appState.subjects);
        await saveToStorage("selectedSubject", appState.selectedSubject);
        await saveToStorage("selectedMonth", appState.selectedMonth);
        await saveToStorage("selectedYear", appState.selectedYear);
        await saveToStorage("currentDay", appState.currentDay);
        await saveToStorage("attendanceData", appState.attendanceData);
        await saveToStorage("holidays", appState.holidays);
        await saveToStorage("threshold", appState.threshold);
        await saveToStorage("departments", appState.departments);
        await saveToStorage("selectedDepartment", appState.selectedDepartment);
        await saveToStorage("courses", appState.courses);
        await saveToStorage("selectedCourse", appState.selectedCourse);
        await saveToStorage("selectedAcademicYear", appState.selectedAcademicYear);
        await saveToStorage("selectedDivision", appState.selectedDivision);
        const currentDate = new Date().toDateString();
        await saveToStorage("currentDate", currentDate);
        console.log("All data saved (cloud + local)");
      } catch (error) {
        console.error("Failed to save data:", error);
      }
    }

    async function loadAllData() {
      try {
        // ‚úÖ STEP 1: Load GLOBAL data first
        const departments = await loadFromStorage("departments");
        const courses = await loadFromStorage("courses");
        const subjects = await loadFromStorage("subjects");
        const threshold = await loadFromStorage("threshold");

        if (departments) appState.departments = departments;
        if (courses) appState.courses = courses;
        if (subjects) appState.subjects = subjects;
        if (threshold !== null) appState.threshold = threshold;

        // ‚úÖ STEP 2: Load Academic Year & Division from IndexedDB (user's last choice)
        // These determine which division path to load from
        const selectedAcademicYear = await loadFromDatabase("selectedAcademicYear");
        const selectedDivision = await loadFromDatabase("selectedDivision");

        if (selectedAcademicYear) appState.selectedAcademicYear = selectedAcademicYear;
        if (selectedDivision) appState.selectedDivision = selectedDivision;

        // ‚úÖ STEP 3: Now we can load division-specific data
        // (These will use the academic year & division set above)
        const selectedDepartment = await loadFromStorage("selectedDepartment");
        const selectedCourse = await loadFromStorage("selectedCourse");
        const selectedSubject = await loadFromStorage("selectedSubject");
        const selectedMonth = await loadFromStorage("selectedMonth");
        const selectedYear = await loadFromStorage("selectedYear");
        const currentDay = await loadFromStorage("currentDay");
        const attendanceData = await loadFromStorage("attendanceData");
        const holidays = await loadFromStorage("holidays");

        if (selectedDepartment) appState.selectedDepartment = selectedDepartment;
        if (selectedCourse) appState.selectedCourse = selectedCourse;
        if (selectedSubject) appState.selectedSubject = selectedSubject;
        if (selectedMonth !== null) appState.selectedMonth = selectedMonth;
        if (selectedYear !== null) appState.selectedYear = selectedYear;
        if (currentDay !== null) appState.currentDay = currentDay;
        if (attendanceData) appState.attendanceData = attendanceData;
        if (holidays) appState.holidays = holidays;

        console.log("All data loaded");
        return true;
      } catch (error) {
        console.error("Failed to load data:", error);
        return false;
      }
    }
    // ==================== APPLICATION STATE ====================
    const appState = {
      subjects: {},
      selectedSubject: null,
      selectedMonth: null,
      selectedYear: null,
      currentDay: 1,
      daysInMonth: 31,
      attendanceData: {},  // { "2025-01": { "Math": { "1": { _name: "YASH", 1: "Present", 2: "Absent" } } } }
      holidays: {},        // { "2025-01": [1, 15, 26] }
      threshold: 75,
      studentList: [],      // For current display
      departments: [],              // NEW
      selectedDepartment: null,     // NEW
      courses: {},                  // NEW: { "computer": ["bca", "btech"], "mechanical": [...] }
      selectedCourse: null,         // NEW
      selectedAcademicYear: null,   // NEW: "fy", "sy", or "ty"
      selectedDivision: null        // NEW: "A", "B", or "C"
    };


    function getCurrentSubjects() {
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;

      if (!dept || !course) return [];

      // ‚úÖ Access nested structure: subjects[dept][course]
      if (!appState.subjects[dept]) return [];
      if (!appState.subjects[dept][course]) return [];

      return appState.subjects[dept][course];
    }
    let isUpdatingSubjectDropdown = false;
    let isUpdatingDayDropdown = false;
    let isRenderingCalendar = false;
    let calendarRenderTimeout = null;

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];

    // ==================== DOM ELEMENTS ====================
    const elements = {
      // Department elements
      newDepartmentInput: document.getElementById('newDepartmentInput'),
      addDepartmentBtn: document.getElementById('addDepartmentBtn'),
      departmentSelect: document.getElementById('departmentSelect'),
      deleteDepartmentBtn: document.getElementById('deleteDepartmentBtn'),
      departmentTags: document.getElementById('departmentTags'),
      currentDepartmentDisplay: document.getElementById('currentDepartmentDisplay'),

      // Course elements
      newCourseInput: document.getElementById('newCourseInput'),
      addCourseBtn: document.getElementById('addCourseBtn'),
      courseSelect: document.getElementById('courseSelect'),
      deleteCourseBtn: document.getElementById('deleteCourseBtn'),
      courseTags: document.getElementById('courseTags'),
      coursesDepartmentName: document.getElementById('coursesDepartmentName'),
      currentCourseDisplay: document.getElementById('currentCourseDisplay'),

      // Final Selection elements
      finalDepartmentSelect: document.getElementById('finalDepartmentSelect'),
      finalCourseSelect: document.getElementById('finalCourseSelect'),
      finalSubjectSelect: document.getElementById('finalSubjectSelect'),
      selectedPathDept: document.getElementById('selectedPathDept'),
      selectedPathCourse: document.getElementById('selectedPathCourse'),
      selectedPathSubject: document.getElementById('selectedPathSubject'),

      // Academic Year & Division elements
      academicYearLevelSelect: document.getElementById('academicYearLevelSelect'),
      divisionSelect: document.getElementById('divisionSelect'),
      currentAcademicDisplay: document.getElementById('currentAcademicDisplay'),

      // Subject elements
      newSubjectInput: document.getElementById('newSubjectInput'),
      addSubjectBtn: document.getElementById('addSubjectBtn'),
      subjectSelect: document.getElementById('subjectSelect'),
      deleteSubjectBtn: document.getElementById('deleteSubjectBtn'),
      subjectTags: document.getElementById('subjectTags'),
      subjectsCourseName: document.getElementById('subjectsCourseName'),
      currentSubjectDisplay: document.getElementById('currentSubjectDisplay'),

      // Month elements
      monthSelect: document.getElementById('monthSelect'),
      yearSelect: document.getElementById('yearSelect'),
      applyMonthBtn: document.getElementById('applyMonthBtn'),
      currentMonthDisplay: document.getElementById('currentMonthDisplay'),
      calendarContainer: document.getElementById('calendarContainer'),
      dayGrid: document.getElementById('dayGrid'),

      // Holiday elements
      toggleHolidayBtn: document.getElementById('toggleHolidayBtn'),
      clearHolidaysBtn: document.getElementById('clearHolidaysBtn'),
      holidayList: document.getElementById('holidayList'),
      holidayIndicator: document.getElementById('holidayIndicator'),
      currentDayDisplay: document.getElementById('currentDayDisplay'),

      // Upload elements
      fileDrop: document.getElementById('fileDrop'),
      fileInput: document.getElementById('fileInput'),
      browseBtn: document.getElementById('browseBtn'),
      fileInfo: document.getElementById('fileInfo'),
      downloadTemplateBtn: document.getElementById('downloadTemplateBtn'),
      downloadReportBtn: document.getElementById('downloadReportBtn'),
      clearAllBtn: document.getElementById('clearAllBtn'),

      // Attendance table elements
      dateSelect: document.getElementById('dateSelect'),
      prevDayBtn: document.getElementById('prevDayBtn'),
      nextDayBtn: document.getElementById('nextDayBtn'),
      markAllPresentBtn: document.getElementById('markAllPresentBtn'),
      markAllAbsentBtn: document.getElementById('markAllAbsentBtn'),
      searchInput: document.getElementById('searchInput'),
      searchBtn: document.getElementById('searchBtn'),
      resetSearchBtn: document.getElementById('resetSearchBtn'),
      sortSelect: document.getElementById('sortSelect'),
      filterSelect: document.getElementById('filterSelect'),
      refreshTableBtn: document.getElementById('refreshTableBtn'),
      attendanceTableBody: document.getElementById('attendanceTableBody'),

      // Summary elements
      summaryTotal: document.getElementById('summaryTotal'),
      summaryPresent: document.getElementById('summaryPresent'),
      summaryAbsent: document.getElementById('summaryAbsent'),
      summaryRate: document.getElementById('summaryRate'),

      // Stats elements
      statsTotalStudents: document.getElementById('statsTotalStudents'),
      statsPresentToday: document.getElementById('statsPresentToday'),
      statsAbsentToday: document.getElementById('statsAbsentToday'),
      statsWorkingDays: document.getElementById('statsWorkingDays'),

      // Defaulter elements
      thresholdInput: document.getElementById('thresholdInput'),
      showDefaultersBtn: document.getElementById('showDefaultersBtn'),
      exportDefaultersBtn: document.getElementById('exportDefaultersBtn'),
      defaulterCount: document.getElementById('defaulterCount'),
      defaulterTableContainer: document.getElementById('defaulterTableContainer'),
      defaulterTableBody: document.getElementById('defaulterTableBody'),

      // Modal elements
      modalCloseBtn: document.getElementById('modalCloseBtn'),
      modalCloseBtnFooter: document.getElementById('modalCloseBtnFooter'),
      modalSubject: document.getElementById('modalSubject'),
      modalMonth: document.getElementById('modalMonth'),
      modalThreshold: document.getElementById('modalThreshold'),
      modalDefaulterTableBody: document.getElementById('modalDefaulterTableBody'),
      noDefaultersAlert: document.getElementById('noDefaultersAlert'),
      modalExportBtn: document.getElementById('modalExportBtn'),

      // Navbar badges
      navSubjectBadge: document.getElementById('navSubjectBadge'),
      navMonthBadge: document.getElementById('navMonthBadge')
    };

    // ==================== UTILITY FUNCTIONS ====================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getMonthKey() {
      if (appState.selectedMonth === null || appState.selectedYear === null) return null;
      return `${appState.selectedYear}-${String(appState.selectedMonth + 1).padStart(2, '0')}`;
      //Adds 1 for human format ‚úÖ
    }

    function getDaysInMonth(month, year) {
      return new Date(year, month + 1, 0).getDate();
    }

    function getFirstDayOfMonth(month, year) {
      return new Date(year, month, 1).getDay();
    }

    function formatDate(day) {
      if (appState.selectedMonth === null || appState.selectedYear === null) return 'None';
      return `${day} ${monthNames[appState.selectedMonth]} ${appState.selectedYear}`;
    }

    function normalizeStatus(status) {
      const s = String(status || '').trim().toLowerCase();
      if (s.startsWith('p') || s === '1' || s === 'yes' || s === 'y' || s === 'true') {
        return 'Present';
      }
      return 'Absent';
    }

    function showAlert(message, type = 'info') {
      alert(message);
    }

    // ==================== SUBJECT FUNCTIONS ====================
    function populateSubjectDropdown() {
      elements.subjectSelect.innerHTML = '<option value="">-- Choose Subject --</option>';
      elements.finalSubjectSelect.innerHTML = '<option value="">-- Choose Subject --</option>';

      elements.selectedPathDept.textContent = appState.selectedDepartment || 'No Department';
      elements.selectedPathCourse.textContent = appState.selectedCourse || 'No Course';
      elements.selectedPathSubject.textContent = appState.selectedSubject || 'No Subject';

      if (!appState.selectedCourse) {
        elements.subjectSelect.disabled = true;
        elements.finalSubjectSelect.disabled = true;
        return;
      }

      elements.subjectSelect.disabled = false;
      elements.finalSubjectSelect.disabled = false;

      // ‚úÖ Get subjects for current course
      const subjectList = getCurrentSubjects();

      subjectList.forEach(subject => {
        const option1 = document.createElement('option');
        option1.value = subject;
        option1.textContent = subject;
        if (subject === appState.selectedSubject) {
          option1.selected = true;
        }
        elements.subjectSelect.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = subject;
        option2.textContent = subject;
        if (subject === appState.selectedSubject) {
          option2.selected = true;  // ‚úÖ FIX: Set selected on BOTH dropdowns
        }
        elements.finalSubjectSelect.appendChild(option2);
      });
    }
    function renderSubjectTags() {
      if (!appState.selectedCourse) {
        elements.subjectTags.innerHTML = '<span class="text-muted">Select a course first.</span>';
        if (elements.subjectsCourseName) {
          elements.subjectsCourseName.textContent = '--';
        }
        return;
      }

      if (elements.subjectsCourseName) {
        elements.subjectsCourseName.textContent = appState.selectedCourse;
      }

      // ‚úÖ Use helper function instead
      const subjectList = getCurrentSubjects();

      if (subjectList.length === 0) {
        elements.subjectTags.innerHTML = '<span class="text-muted">No subjects added yet. Add your first subject above.</span>';
        return;
      }

      elements.subjectTags.innerHTML = '';
      subjectList.forEach(subject => {
        const tag = document.createElement('span');
        tag.className = `subject-tag ${subject === appState.selectedSubject ? 'active' : ''}`;
        tag.innerHTML = `
      ${escapeHtml(subject)}
      <span class="delete-btn" data-subject="${escapeHtml(subject)}">&times;</span>
    `;

        tag.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-btn')) {
            selectSubject(subject);
          }
        });

        elements.subjectTags.appendChild(tag);
      });

      // Add delete event listeners
      document.querySelectorAll('.subject-tag .delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const subject = e.target.getAttribute('data-subject');
          deleteSubject(subject);
        });
      });
    }

    function addSubject(name) {
      name = String(name).trim();

      if (!name) {
        showAlert('Please enter a subject name!', 'warning');
        return false;
      }

      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;

      if (!dept || !course) {
        showAlert('Please select department and course first!', 'warning');
        return false;
      }

      // ‚úÖ Create nested structure
      if (!appState.subjects[dept]) {
        appState.subjects[dept] = {};
      }
      if (!appState.subjects[dept][course]) {
        appState.subjects[dept][course] = [];
      }

      if (appState.subjects[dept][course].includes(name)) {
        showAlert('Subject already exists!', 'warning');
        return false;
      }

      appState.subjects[dept][course].push(name);

      populateSubjectDropdown();
      renderSubjectTags();
      saveAllData();

      showAlert(`Subject "${name}" added successfully!`, 'success');
      return true;
    }
    function selectSubject(name) {
      appState.selectedSubject = name;
      isUpdatingSubjectDropdown = true;
      elements.subjectSelect.value = name;
      elements.finalSubjectSelect.value = name;
      isUpdatingSubjectDropdown = false;

      updateSubjectDisplay();
      renderSubjectTags();
      updateFinalSelectionBadges();
      ensureSubjectStructureExists();
      // ‚úÖ FIX: Force reload attendance data
      loadStudentList();  // Reload students first
      refreshAttendanceTable();  // Then refresh table
      updateStats();  // Update stats
      renderCalendarGrid();  // Update calendar

      saveAllData();

      // ‚úÖ RELOAD leave applications when subject changes
      ;
    }

    function updateSubjectDisplay() {
      const subject = appState.selectedSubject || 'None selected';
      elements.currentSubjectDisplay.textContent = subject;
      elements.navSubjectBadge.textContent = appState.selectedSubject || 'No Subject';
    }

    // ==================== MONTH FUNCTIONS ====================
    function populateYearDropdown() {
      const currentYear = new Date().getFullYear();
      elements.yearSelect.innerHTML = '';

      for (let y = currentYear - 5; y <= currentYear + 5; y++) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        if (y === currentYear) option.selected = true;
        elements.yearSelect.appendChild(option);
      }
    }

    function applyMonth() {
      appState.selectedMonth = parseInt(elements.monthSelect.value);
      appState.selectedYear = parseInt(elements.yearSelect.value);
      appState.daysInMonth = getDaysInMonth(appState.selectedMonth, appState.selectedYear);
      appState.currentDay = 1;

      updateMonthDisplay();
      populateDayDropdown();
      renderCalendarGrid();
      updateHolidayDisplay();
      elements.calendarContainer.style.display = 'block';
      if (appState.selectedSubject) {
        ensureSubjectStructureExists();
      }

      refreshAttendanceTable();
      saveAllData();
      showAlert(`Month set to ${monthNames[appState.selectedMonth]} ${appState.selectedYear}`, 'success');

      ;
    }

    function updateMonthDisplay() {
      const display = appState.selectedMonth !== null
        ? `${monthNames[appState.selectedMonth]} ${appState.selectedYear} (${appState.daysInMonth} days)`
        : 'None';

      elements.currentMonthDisplay.textContent = display;
      elements.navMonthBadge.textContent = appState.selectedMonth !== null
        ? `${monthNames[appState.selectedMonth].substring(0, 3)} ${appState.selectedYear}`
        : 'No Month';
    }

    function populateDayDropdown() {
      elements.dateSelect.innerHTML = '';

      for (let day = 1; day <= appState.daysInMonth; day++) {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = formatDate(day);
        if (isHoliday(day)) {
          option.textContent += ' (Holiday)';
        }
        elements.dateSelect.appendChild(option);
      }

      elements.dateSelect.value = appState.currentDay;
      elements.dateSelect.disabled = false;
      updateDayNavigation();
    }

    async function renderCalendarGrid() {
      // ‚úÖ DEBOUNCE: Prevent multiple simultaneous renders
      if (isRenderingCalendar) {
        console.log('‚è∏Ô∏è Calendar render already in progress, skipping...');
        return;
      }

      // ‚úÖ Clear any pending render
      if (calendarRenderTimeout) {
        clearTimeout(calendarRenderTimeout);
      }

      // ‚úÖ Set lock
      isRenderingCalendar = true;

      try {
        elements.dayGrid.innerHTML = '';

        const firstDay = getFirstDayOfMonth(appState.selectedMonth, appState.selectedYear);
        const monthKey = getMonthKey();
        const subjectData = getSubjectData();

        // ‚úÖ GET USER ROLE AND STUDENT ID (cached to avoid multiple calls)
        let studentId = null;
        if (currentUserRole === 'student') {
          studentId = currentStudentId;
        }

        // ‚úÖ GET APPROVED LEAVE DAYS FOR THIS STUDENT
        let studentLeaveDays = new Set();
        if (studentId) {
          const approvedLeaves = leaveState.applications.filter(leave =>
            leave.status === 'approved' &&
            leave.studentId === studentId &&
            leave.month === appState.selectedMonth &&
            leave.year === appState.selectedYear
          );

          approvedLeaves.forEach(leave => {
            leave.days.forEach(day => studentLeaveDays.add(day));
          });

          if (studentLeaveDays.size > 0) {
            console.log(`üìÖ Student ${studentId} has ${studentLeaveDays.size} approved leave days:`, Array.from(studentLeaveDays));
          }
        }

        // Empty cells before first day
        for (let i = 0; i < firstDay; i++) {
          const emptyCell = document.createElement('div');
          emptyCell.style.visibility = 'hidden';
          elements.dayGrid.appendChild(emptyCell);
        }

        // Day buttons
        for (let day = 1; day <= appState.daysInMonth; day++) {
          const dayBtn = document.createElement('div');
          dayBtn.className = 'day-btn';
          dayBtn.textContent = day;
          dayBtn.setAttribute('data-day', day);

          // ‚úÖ FOR STUDENTS: Show their personal attendance status
          // ‚úÖ FOR STUDENTS: Show their personal attendance status
if (studentId && subjectData && subjectData[studentId]) {
  const status = subjectData[studentId][day];

  if (isHoliday(day)) {
    dayBtn.classList.add('holiday');
    dayBtn.title = 'Holiday';
  }
  // ‚úÖ NEW PRIORITY ORDER:
  // 1. Present (teacher marked) - HIGHEST PRIORITY
  // 2. Approved Leave (overrides Absent)
  // 3. "On Leave" status in attendance
  // 4. Absent (teacher marked)
  // 5. No data
  else if (status === 'Present') {
    dayBtn.classList.add('student-present');
    dayBtn.title = `Day ${day}: Present`;
    // ‚úÖ Show if leave was approved but teacher marked present
    if (studentLeaveDays.has(day)) {
      dayBtn.title += ' (Leave approved but marked present)';
    }
  }
  else if (status === 'On Leave' || studentLeaveDays.has(day)) {
    // ‚úÖ PRIORITY: Show leave even if marked absent (leave overrides absent)
    dayBtn.classList.add('student-leave');
    dayBtn.title = `Day ${day}: On Approved Leave`;
    if (status === 'Absent') {
      dayBtn.title += ' (Marked absent but leave was approved)';
    }
  }
  else if (status === 'Absent') {
    // ‚úÖ Only show absent if NO approved leave
    dayBtn.classList.add('student-absent');
    dayBtn.title = `Day ${day}: Absent`;
  }
  else if (status) {
    dayBtn.classList.add('has-data');
    dayBtn.title = `Day ${day}: ${status}`;
  }
}
          // ‚úÖ FOR TEACHERS/ADMINS: Show general data status
          else {
            let hasData = false;
            if (subjectData) {
              for (const sid in subjectData) {
                if (!sid.startsWith('_') && subjectData[sid][day]) {
                  hasData = true;
                  break;
                }
              }
            }

            if (isHoliday(day)) {
              dayBtn.classList.add('holiday');
              dayBtn.title = 'Holiday';
            } else if (hasData) {
              dayBtn.classList.add('has-data');
              dayBtn.title = `Day ${day}: Attendance recorded`;
            }
          }

          if (day === appState.currentDay) {
            dayBtn.classList.add('active');
          }

          dayBtn.addEventListener('click', () => selectDay(day));
          elements.dayGrid.appendChild(dayBtn);
        }

        updateCurrentDayDisplay();

      } finally {
        // ‚úÖ Release lock after a small delay
        calendarRenderTimeout = setTimeout(() => {
          isRenderingCalendar = false;
        }, 100);
      }
    }
    function selectDay(day) {
      // Validate input
      day = parseInt(day);

      if (isNaN(day) || day < 1 || day > appState.daysInMonth) {
        console.error('‚ùå Invalid day:', day);
        return;
      }

      // Prevent unnecessary updates
      if (appState.currentDay === day) {
        console.log('Already on day', day, '- skipping update');
        return;
      }

      console.log(`‚úÖ selectDay: ${appState.currentDay} ‚Üí ${day}`);

      appState.currentDay = day;
      isUpdatingDayDropdown = true;
      elements.dateSelect.value = day;
      isUpdatingDayDropdown = false;

      // Update calendar UI
      document.querySelectorAll('.day-btn').forEach(btn => {
        btn.classList.remove('active');
        if (parseInt(btn.getAttribute('data-day')) === day) {
          btn.classList.add('active');
        }
      });

      updateCurrentDayDisplay();
      updateDayNavigation();
      refreshAttendanceTable();
      saveAllData();
    }

    function updateCurrentDayDisplay() {
      elements.currentDayDisplay.textContent = formatDate(appState.currentDay);

      if (isHoliday(appState.currentDay)) {
        elements.holidayIndicator.style.display = 'inline';
      } else {
        elements.holidayIndicator.style.display = 'none';
      }
    }

    function updateDayNavigation() {
      elements.prevDayBtn.disabled = appState.currentDay <= 1;
      elements.nextDayBtn.disabled = appState.currentDay >= appState.daysInMonth;
    }

    // ==================== HOLIDAY FUNCTIONS ====================
    function getHolidaysForMonth() {
      const monthKey = getMonthKey();
      if (!monthKey) return [];
      return appState.holidays[monthKey] || [];
    }

    function isHoliday(day) {
      return getHolidaysForMonth().includes(day);
    }

    function toggleHoliday() {
      if (appState.selectedMonth === null) {
        showAlert('Please select a month first!', 'warning');
        return;
      }

      const monthKey = getMonthKey();
      if (!appState.holidays[monthKey]) {
        appState.holidays[monthKey] = [];
      }

      const day = appState.currentDay;
      const index = appState.holidays[monthKey].indexOf(day);

      if (index > -1) {
        appState.holidays[monthKey].splice(index, 1);
        showAlert(`Day ${day} unmarked as holiday`, 'info');
      } else {
        appState.holidays[monthKey].push(day);
        appState.holidays[monthKey].sort((a, b) => a - b);
        showAlert(`Day ${day} marked as holiday`, 'success');
      }

      updateHolidayDisplay();
      renderCalendarGrid();
      populateDayDropdown();
      refreshAttendanceTable();
      updateStats();
      saveAllData();
    }

    function clearAllHolidays() {
      if (!confirm('Clear all holidays for this month?')) return;

      const monthKey = getMonthKey();
      if (monthKey) {
        appState.holidays[monthKey] = [];
      }

      updateHolidayDisplay();
      renderCalendarGrid();
      populateDayDropdown();
      refreshAttendanceTable();
      updateStats();
      saveAllData();

      showAlert('All holidays cleared', 'info');
    }

    function updateHolidayDisplay() {
      const holidays = getHolidaysForMonth();
      if (holidays.length === 0) {
        elements.holidayList.textContent = 'None';
      } else {
        elements.holidayList.textContent = holidays.map(d => `Day ${d}`).join(', ');
      }
    }

    function getWorkingDays() {
      const subjectData = getSubjectData();

      if (!subjectData) return 0;

      const holidays = getHolidaysForMonth();
      const lectureDays = new Set();

      // ‚úÖ CHECK ALL STUDENTS to find all lecture days
      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;

        const studentAttendance = subjectData[studentId];

        for (let day = 1; day <= appState.daysInMonth; day++) {
          // If ANY student has attendance data for this day, it's a lecture day
          if (studentAttendance[day] !== undefined) {
            lectureDays.add(day);
          }
        }
      }

      // Count lecture days that are NOT holidays
      let workingDays = 0;
      lectureDays.forEach(day => {
        if (!holidays.includes(day)) {
          workingDays++;
        }
      });

      return workingDays;
    }

    // ==================== FILE HANDLING ====================
    function parseCSV(text) {
      // Remove BOM
      text = text.replace(/^\ufeff/, '');

      const lines = text.split(/\r?\n/).filter(line => line.trim());
      const rows = [];

      for (const line of lines) {
        const cols = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            cols.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        cols.push(current.trim());
        rows.push(cols);
      }

      return rows;
    }

    function processCSVData(text) {
      if (!appState.selectedSubject) {
        throw new Error('Please select a subject first!');
      }

      if (appState.selectedMonth === null) {
        throw new Error('Please select a month first!');
      }

      // ‚úÖ VALIDATE ALL REQUIRED FIELDS FOR 8-LEVEL STRUCTURE
      if (!appState.selectedDepartment) {
        throw new Error('Please select a department first!');
      }

      if (!appState.selectedCourse) {
        throw new Error('Please select a course first!');
      }

      if (!appState.selectedAcademicYear) {
        throw new Error('Please select an academic year (FY/SY/TY) first!');
      }

      if (!appState.selectedDivision) {
        throw new Error('Please select a division first!');
      }

      const rows = parseCSV(text);

      if (rows.length < 2) {
        throw new Error('CSV must have at least a header row and one data row');
      }

      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;
      const monthKey = getMonthKey();
      const subject = appState.selectedSubject;

      // ‚úÖ CREATE 8-LEVEL NESTED STRUCTURE WITH PROPER NULL CHECKS
      if (!appState.attendanceData[year]) {
        appState.attendanceData[year] = {};
      }
      if (!appState.attendanceData[year][dept]) {
        appState.attendanceData[year][dept] = {};
      }
      if (!appState.attendanceData[year][dept][course]) {
        appState.attendanceData[year][dept][course] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear]) {
        appState.attendanceData[year][dept][course][academicYear] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear][division]) {
        appState.attendanceData[year][dept][course][academicYear][division] = {
          students: {},  // ‚úÖ ADD THIS
          months: {}
        };
      }
      // ‚úÖ Ensure students object exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].students) {
        appState.attendanceData[year][dept][course][academicYear][division].students = {};
      }
      // ‚úÖ FIX: Check if months exists before accessing it
      if (!appState.attendanceData[year][dept][course][academicYear][division].months) {
        appState.attendanceData[year][dept][course][academicYear][division].months = {};
      }

      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey]) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey] = { subjects: {} };
      }

      // ‚úÖ FIX: Check if subjects exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects = {};
      }

      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject]) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject] = { attendance: {} };
      }

      // ‚úÖ FIX: Check if attendance exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance = {};
      }

      // ‚úÖ NOW SAFE to get reference
      // ‚úÖ NOW SAFE to get reference
      const attendanceRef = appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance;

      // ‚úÖ GET OR CREATE MASTER STUDENT LIST at division level
      if (!appState.attendanceData[year][dept][course][academicYear][division].students) {
        appState.attendanceData[year][dept][course][academicYear][division].students = {};
      }
      const masterStudents = appState.attendanceData[year][dept][course][academicYear][division].students;

      let studentCount = 0;

      // Skip header row, process data rows
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (row.length < 2) continue;

        const id = String(row[0]).trim();
        const name = String(row[1]).trim();

        if (!id || !name) continue;

        // ‚úÖ STORE IN MASTER STUDENT LIST (division level)
        if (!masterStudents[id]) {
          masterStudents[id] = { name: name };
        }

        attendanceRef[id] = { _name: name };

        // Parse daily attendance (columns 2 onwards)
        // ‚úÖ ONLY store days that actually have data in CSV
        for (let day = 1; day <= appState.daysInMonth; day++) {
          const colIndex = day + 1;

          // ‚úÖ Check if CSV has data for this day
          if (row[colIndex] !== undefined && row[colIndex].trim() !== '') {
            const status = normalizeStatus(row[colIndex]);
            attendanceRef[id][day] = status;
          }
          // ‚úÖ Don't store anything if column is empty/missing
        }

        studentCount++;
      }

      console.log(`‚úÖ Saved ${studentCount} students to division master list`);
      console.log(`‚úÖ Saved attendance to: ${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/subjects/${subject}`);

      return studentCount;
    }
    function handleFileUpload(file) {
      if (!file) return;

      if (!file.name.endsWith('.csv')) {
        showAlert('Please upload a CSV file!', 'warning');
        return;
      }

      const reader = new FileReader();

      reader.onload = (event) => {
        try {
          const text = event.target.result;
          const studentCount = processCSVData(text);

          if (studentCount === 0) {
            showAlert('No valid student data found in CSV', 'warning');
            return;
          }

          elements.fileInfo.style.display = 'block';
          elements.fileInfo.innerHTML = `
            <i class="bi bi-check-circle text-success me-2"></i>
            <strong>Upload Successful!</strong><br>
            File: ${escapeHtml(file.name)}<br>
            Students: ${studentCount}<br>
            Subject: ${appState.selectedSubject}<br>
            Month: ${monthNames[appState.selectedMonth]} ${appState.selectedYear}
          `;

          renderCalendarGrid();
          refreshAttendanceTable();
          updateStats();
          saveAllData();

          // ‚úÖ RESET FILE INPUT AFTER SUCCESSFUL UPLOAD
          elements.fileInput.value = '';
          console.log('‚úÖ File input reset after successful upload');

          showAlert(`Successfully uploaded ${studentCount} students!`, 'success');
        } catch (error) {
          // ‚úÖ ALSO RESET ON ERROR
          elements.fileInput.value = '';
          console.log('‚ö†Ô∏è File input reset after error');
          console.error('File processing error:', error);
          showAlert('Error: ' + error.message, 'danger');
        }
      };

      reader.onerror = () => {
        showAlert('Error reading file!', 'danger');
      };

      reader.readAsText(file);
    }
    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
    function downloadTemplate() {
      if (appState.selectedMonth === null) {
        showAlert('Please select a month first!', 'warning');
        return;
      }

      // ‚úÖ ADD VALIDATION for context
      if (!appState.selectedDepartment || !appState.selectedCourse ||
        !appState.selectedAcademicYear || !appState.selectedDivision) {
        showAlert('Please select Department, Course, Academic Year, and Division first!', 'warning');
        return;
      }

      const headers = ['ID', 'Name'];
      for (let day = 1; day <= appState.daysInMonth; day++) {
        headers.push(`Day${day}`);
      }

      const sampleData = [
        headers,
        ['1', 'Student One', ...Array(appState.daysInMonth).fill('Present')],
        ['2', 'Student Two', ...Array(appState.daysInMonth).fill('Absent')],
        ['3', 'Student Three', ...Array(appState.daysInMonth).fill('Present')]
      ];

      const csv = sampleData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\r\n');

      // ‚úÖ BETTER FILENAME with full context
      const filename = `template_${appState.selectedDepartment}_${appState.selectedCourse}_${appState.selectedAcademicYear}_${appState.selectedDivision}_${monthNames[appState.selectedMonth]}_${appState.selectedYear}.csv`;

      downloadFile(csv, filename);
    }

    function downloadReport() {
      if (!appState.selectedSubject) {
        showAlert('Please select a subject first!', 'warning');
        return;
      }

      if (appState.selectedMonth === null) {
        showAlert('Please select a month first!', 'warning');
        return;
      }

      if (!appState.selectedDepartment || !appState.selectedCourse ||
        !appState.selectedAcademicYear || !appState.selectedDivision) {
        showAlert('Please select Department, Course, Academic Year, and Division first!', 'warning');
        return;
      }

      const subjectData = getSubjectData();

      if (!subjectData || Object.keys(subjectData).filter(key => !key.startsWith('_')).length === 0) {
        showAlert('No attendance data found for this subject in this month! Please upload attendance data first.', 'warning');
        return;
      }

      const holidays = getHolidaysForMonth();

      const daysWithLectures = new Set();

      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;

        const studentAttendance = subjectData[studentId];

        for (let day = 1; day <= appState.daysInMonth; day++) {
          if (studentAttendance[day] !== undefined) {
            daysWithLectures.add(day);
          }
        }
      }

      const lectureDays = Array.from(daysWithLectures).sort((a, b) => a - b);

      if (lectureDays.length === 0) {
        showAlert('No lecture data found for this subject in this month!', 'warning');
        return;
      }

      // ‚úÖ MODIFIED HEADERS - Add Leave Info Columns
      const headers = ['ID', 'Name'];

      lectureDays.forEach(day => {
        const isHoliday = holidays.includes(day);
        headers.push(`Day ${day}${isHoliday ? ' (H)' : ''}`);
      });

      headers.push('Present', 'Absent', 'Total Lectures', 'Percentage', 'Leave Applications', 'Leave Days Approved');

      const rows = [headers];

      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;

        const studentAttendance = subjectData[studentId];
        const studentName = studentAttendance._name || studentId;

        const row = [studentId, studentName];

        let present = 0;
        let absent = 0;

        lectureDays.forEach(day => {
          if (holidays.includes(day)) {
            row.push('Holiday');
          } else {
            const status = studentAttendance[day] || 'Absent';
            row.push(status);

            if (status === 'Present') {
              present++;
            } else {
              absent++;
            }
          }
        });

        const totalLectures = present + absent;
        const percentage = totalLectures > 0 ? Math.round((present / totalLectures) * 100) : 0;

        // ‚úÖ ADD LEAVE INFO
        const leaveSummary = getStudentLeaveSummary(studentId);
        const leaveApps = leaveSummary ? leaveSummary.applications : 0;
        const leaveDays = leaveSummary ? leaveSummary.count : 0;

        row.push(present, absent, totalLectures, `${percentage}%`, leaveApps, leaveDays);
        rows.push(row);
      }

      const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\r\n');

      const filename = `report_${appState.selectedDepartment}_${appState.selectedCourse}_${appState.selectedAcademicYear}_${appState.selectedDivision}_${appState.selectedSubject}_${monthNames[appState.selectedMonth]}_${appState.selectedYear}.csv`;

      downloadFile(csv, filename);

      showAlert(`Report exported with ${lectureDays.length} lecture days and leave information`, 'success');
    }

    async function clearSelectedSubjectMonth() {
      if (!appState.selectedSubject) {
        showAlert('Please select a subject first!', 'warning');
        return;
      }

      if (appState.selectedMonth === null) {
        showAlert('Please select a month first!', 'warning');
        return;
      }

      if (!appState.selectedDepartment || !appState.selectedCourse ||
        !appState.selectedAcademicYear || !appState.selectedDivision) {
        showAlert('Please select Department, Course, Academic Year, and Division first!', 'warning');
        return;
      }

      const monthName = monthNames[appState.selectedMonth];
      const confirmMsg = `‚ö†Ô∏è DELETE ATTENDANCE DATA?\n\nThis will permanently remove attendance for:\n- Subject: ${appState.selectedSubject}\n- Month: ${monthName} ${appState.selectedYear}\n- Department: ${appState.selectedDepartment}\n- Course: ${appState.selectedCourse}\n- Academic Year: ${appState.selectedAcademicYear}\n- Division: ${appState.selectedDivision}\n\nThis action cannot be undone!`;

      if (!confirm(confirmMsg)) {
        return;
      }

      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;
      const monthKey = getMonthKey();
      const subject = appState.selectedSubject;

      // ‚úÖ DELETE ONLY THE SELECTED SUBJECT'S ATTENDANCE FOR THIS MONTH
      try {
        if (appState.attendanceData?.[year]?.[dept]?.[course]?.[academicYear]?.[division]?.months?.[monthKey]?.subjects?.[subject]) {
          delete appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject];

          console.log(`üóëÔ∏è Deleted attendance data for: ${year}/${dept}/${course}/${academicYear}/${division}/${monthKey}/${subject}`);
        }

        // ‚úÖ ALSO CLEAR HOLIDAYS FOR THIS MONTH (optional - only if you want to delete holidays too)
        if (appState.holidays[monthKey]) {
          appState.holidays[monthKey] = [];
          console.log(`üóëÔ∏è Cleared holidays for: ${monthKey}`);
        }

        // Refresh UI
        refreshAttendanceTable();
        updateStats();
        renderCalendarGrid();
        updateHolidayDisplay();

        await saveAllData();

        showAlert(`Attendance data cleared for ${appState.selectedSubject} in ${monthName} ${appState.selectedYear}!`, 'success');
      } catch (error) {
        console.error('Error clearing data:', error);
        showAlert('Error clearing data. Please try again.', 'danger');
      }
    }
    // ==================== ATTENDANCE TABLE FUNCTIONS ====================
    function getSubjectData() {
      const monthKey = getMonthKey();
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;

      // Validate all required fields
      if (!monthKey || !year || !dept || !course || !academicYear || !division || !appState.selectedSubject) {
        return null;
      }

      return appState.attendanceData
        ?.[year]
        ?.[dept]
        ?.[course]
        ?.[academicYear]
        ?.[division]
        ?.months
        ?.[monthKey]
        ?.subjects
        ?.[appState.selectedSubject]
        ?.attendance || null;
    }

    function ensureSubjectStructureExists() {
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;
      const monthKey = getMonthKey();
      const subject = appState.selectedSubject;

      // ‚ùå Exit if any required field is missing
      if (!year || !dept || !course || !academicYear || !division || !monthKey || !subject) {
        console.log('‚ö†Ô∏è Cannot create subject structure - context incomplete');
        return false;
      }

      // ‚úÖ Build the full path step by step
      if (!appState.attendanceData[year]) {
        appState.attendanceData[year] = {};
      }
      if (!appState.attendanceData[year][dept]) {
        appState.attendanceData[year][dept] = {};
      }
      if (!appState.attendanceData[year][dept][course]) {
        appState.attendanceData[year][dept][course] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear]) {
        appState.attendanceData[year][dept][course][academicYear] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear][division]) {
        appState.attendanceData[year][dept][course][academicYear][division] = {
          students: {},  // ‚úÖ Master student list
          months: {}
        };
      }

      // ‚úÖ Ensure students object exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].students) {
        appState.attendanceData[year][dept][course][academicYear][division].students = {};
      }

      // ‚úÖ Ensure months object exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].months) {
        appState.attendanceData[year][dept][course][academicYear][division].months = {};
      }

      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey]) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey] = {
          subjects: {}
        };
      }

      // ‚úÖ Ensure subjects object exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects = {};
      }

      // ‚úÖ Create THIS subject's structure if it doesn't exist
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject]) {
        console.log(`‚úÖ Creating attendance structure for subject: ${subject}`);
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject] = {
          attendance: {}
        };
      }

      // ‚úÖ Ensure attendance object exists
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance = {};
      }

      console.log(`‚úÖ Subject structure exists: ${year}/${dept}/${course}/${academicYear}/${division}/${monthKey}/${subject}`);
      return true;
    }
    function getStudentStats(studentId) {
      const subjectData = getSubjectData();
      if (!subjectData || !subjectData[studentId]) {
        return { present: 0, absent: 0, workingDays: 0, percentage: 0 };
      }

      const student = subjectData[studentId];
      const holidays = getHolidaysForMonth();

      // ‚úÖ FIND ALL LECTURE DAYS (from all students)
      const allLectureDays = new Set();
      for (const sid in subjectData) {
        if (sid.startsWith('_')) continue;
        const attendance = subjectData[sid];
        for (let day = 1; day <= appState.daysInMonth; day++) {
          if (attendance[day] !== undefined) {
            allLectureDays.add(day);
          }
        }
      }

      let present = 0;
      let absent = 0;

      // ‚úÖ COUNT THIS STUDENT'S ATTENDANCE FOR ALL LECTURE DAYS
      allLectureDays.forEach(day => {
        // Skip holidays
        if (holidays.includes(day)) return;

        // Check this student's status
        if (student[day] === 'Present') {
          present++;
        } else if (student[day] === 'Absent') {
          absent++;
        } else {
          // ‚úÖ Day has no data for this student ‚Üí count as absent
          absent++;
        }
      });

      const workingDays = present + absent;
      const percentage = workingDays > 0 ? Math.round((present / workingDays) * 100) : 0;

      return { present, absent, workingDays, percentage };
    }

    function loadStudentList() {
      console.log('üîÑ loadStudentList called (HYBRID version)');

      appState.studentList = [];

      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;

      // ‚úÖ STEP 1: Try to load MASTER STUDENT LIST from division level (NEW WAY)
      let masterStudents = null;

      if (year && dept && course && academicYear && division) {
        masterStudents = appState.attendanceData
          ?.[year]
          ?.[dept]
          ?.[course]
          ?.[academicYear]
          ?.[division]
          ?.students || null;

        if (masterStudents && Object.keys(masterStudents).length > 0) {
          console.log(`‚úÖ Found division master list: ${Object.keys(masterStudents).length} students`);
        }
      }

      // ‚úÖ STEP 2: If master list exists, use it (NEW WAY)
      if (masterStudents && Object.keys(masterStudents).length > 0) {
        console.log('üìä Loading from DIVISION MASTER LIST');

        const subjectData = getSubjectData(); // Get current subject's attendance
        console.log('üìä Subject data:', subjectData ? 'EXISTS' : 'NULL');

        let count = 0;
        for (const studentId in masterStudents) {
          const masterStudent = masterStudents[studentId];

          // Get today's status from subject attendance (if available)
          let todayStatus = 'Absent'; // Default

          if (subjectData && subjectData[studentId]) {
            todayStatus = subjectData[studentId][appState.currentDay] || 'Absent';
          }

          appState.studentList.push({
            id: studentId,
            name: masterStudent.name || studentId,
            status: todayStatus
          });

          count++;
        }

        console.log(`‚úÖ Loaded ${count} students from master list`);
        return;
      }

      // ‚úÖ STEP 3: Fall back to old method (SUBJECT DATA) if master list doesn't exist
      console.log('üìä Master list not found - falling back to SUBJECT DATA (old method)');

      const subjectData = getSubjectData();
      console.log('üìä Subject data:', subjectData ? 'EXISTS' : 'NULL');

      if (!subjectData) {
        console.warn('‚ö†Ô∏è No subject data available - upload CSV first');
        return;
      }

      let count = 0;
      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;

        const student = subjectData[studentId];
        const todayStatus = student[appState.currentDay] || 'Absent';

        appState.studentList.push({
          id: studentId,
          name: student._name || studentId,
          status: todayStatus
        });
        count++;
      }

      console.log(`‚úÖ Loaded ${count} students from subject data (old method)`);
    }

    function refreshAttendanceTable() {
      console.log('üîÑ refreshAttendanceTable called');
      console.log('üìå Current subject:', appState.selectedSubject);
      console.log('üìå Current month:', appState.selectedMonth);
      console.log('üìå Current day:', appState.currentDay);

      loadStudentList();

      console.log('üìä Student list length:', appState.studentList.length);

      let displayList = [...appState.studentList];

      // Apply filter
      const filter = elements.filterSelect.value;
      if (filter === 'present') {
        displayList = displayList.filter(s => s.status === 'Present');
      } else if (filter === 'absent') {
        displayList = displayList.filter(s => s.status === 'Absent');
      } else if (filter === 'defaulter') {
        const threshold = appState.threshold;
        displayList = displayList.filter(s => {
          const stats = getStudentStats(s.id);
          return stats.percentage < threshold;
        });
      }

      // Apply search
      const searchTerm = elements.searchInput.value.trim().toLowerCase();
      if (searchTerm) {
        displayList = displayList.filter(s =>
          s.id.toLowerCase().includes(searchTerm) ||
          s.name.toLowerCase().includes(searchTerm)
        );
      }

      // Apply sort
      const sortValue = elements.sortSelect.value;
      if (sortValue) {
        const [key, direction] = sortValue.split('-');
        displayList.sort((a, b) => {
          let valA, valB;

          if (key === 'id') {
            valA = isNaN(a.id) ? a.id : Number(a.id);
            valB = isNaN(b.id) ? b.id : Number(b.id);
          } else if (key === 'name') {
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
          } else if (key === 'attendance') {
            valA = getStudentStats(a.id).percentage;
            valB = getStudentStats(b.id).percentage;
          }

          if (valA < valB) return direction === 'asc' ? -1 : 1;
          if (valA > valB) return direction === 'asc' ? 1 : -1;
          return 0;
        });
      }

      renderAttendanceTable(displayList);
      updateSummary(displayList);
      updateStats();
    }

    function renderAttendanceTable(students) {
      if (!students || students.length === 0) {
        elements.attendanceTableBody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-5">
              <i class="bi bi-inbox fs-1"></i>
              <p class="mt-2">No students found. Upload a CSV file to get started.</p>
            </td>
          </tr>
        `;
        return;
      }

      const isHolidayToday = isHoliday(appState.currentDay);
      const threshold = appState.threshold;

      elements.attendanceTableBody.innerHTML = '';

      students.forEach(student => {
        const stats = getStudentStats(student.id);
        const isDefaulter = stats.percentage < threshold;

        const row = document.createElement('tr');
        row.className = student.status === 'Present' ? 'present' : 'absent';




        row.innerHTML = `
          <td><strong>${escapeHtml(student.id)}</strong></td>
            <td>${escapeHtml(student.name)}</td>
          <td>
            <span class="badge ${student.status === 'Present' ? 'bg-success' : 'bg-danger'}">
                ${student.status}
            </span>
                ${isHolidayToday ? '<span class="holiday-badge ms-1">Holiday</span>' : ''}
            </td>
            <td>
                ${stats.present}/${stats.workingDays} days
            <span class="${isDefaulter ? 'defaulter-badge' : 'good-badge'} ms-2">
                ${stats.percentage}%
             </span>
             </td>
            <td class="teacher-only">
             <button class="btn btn-sm btn-outline-success mark-present-btn" 
            data-id="${escapeHtml(student.id)}" 
            ${isHolidayToday ? 'disabled' : ''}>
            <i class="bi bi-check"></i>
            </button>
             <button class="btn btn-sm btn-outline-danger mark-absent-btn" 
            data-id="${escapeHtml(student.id)}" 
            ${isHolidayToday ? 'disabled' : ''}>
            <i class="bi bi-x"></i>
            </button>
            </td>
        `;

        elements.attendanceTableBody.appendChild(row);
      });

      // Add event listeners for mark buttons
      document.querySelectorAll('.mark-present-btn').forEach(btn => {
        btn.addEventListener('click', () => markAttendance(btn.dataset.id, 'Present'));
      });

      document.querySelectorAll('.mark-absent-btn').forEach(btn => {
        btn.addEventListener('click', () => markAttendance(btn.dataset.id, 'Absent'));
      });
    }

    function markAttendance(studentId, status) {
      const monthKey = getMonthKey();
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;
      const subject = appState.selectedSubject;

      if (!monthKey || !year || !dept || !course || !academicYear || !division || !subject) {
        console.error('‚ùå Missing required fields for marking attendance');
        return;
      }

      // ‚úÖ CREATE PATH IF DOESN'T EXIST
      if (!appState.attendanceData[year]) {
        appState.attendanceData[year] = {};
      }
      if (!appState.attendanceData[year][dept]) {
        appState.attendanceData[year][dept] = {};
      }
      if (!appState.attendanceData[year][dept][course]) {
        appState.attendanceData[year][dept][course] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear]) {
        appState.attendanceData[year][dept][course][academicYear] = {};
      }
      if (!appState.attendanceData[year][dept][course][academicYear][division]) {
        appState.attendanceData[year][dept][course][academicYear][division] = { months: {} };
      }
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey]) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey] = { subjects: {} };
      }
      if (!appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject]) {
        appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject] = { attendance: {} };
      }

      const attendanceRef = appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance;

      if (!attendanceRef[studentId]) {
        console.error('‚ùå Student not found:', studentId);
        return;
      }

      attendanceRef[studentId][appState.currentDay] = status;

      refreshAttendanceTable();
      renderCalendarGrid();
      saveAllData();
    }
    function markAllAttendance(status) {
      if (isHoliday(appState.currentDay)) {
        showAlert('Cannot mark attendance on a holiday!', 'warning');
        return;
      }

      const subjectData = getSubjectData();
      if (!subjectData) return;

      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;
        subjectData[studentId][appState.currentDay] = status;
      }

      refreshAttendanceTable();
      renderCalendarGrid();
      saveAllData();

      showAlert(`All students marked as ${status}!`, 'success');
    }

    function updateSummary(students) {
      const total = students.length;
      const present = students.filter(s => s.status === 'Present').length;
      const absent = total - present;
      const rate = total > 0 ? Math.round((present / total) * 100) : 0;

      elements.summaryTotal.textContent = total;
      elements.summaryPresent.textContent = present;
      elements.summaryAbsent.textContent = absent;
      elements.summaryRate.textContent = `${rate}%`;
    }

    function updateStats() {
      const subjectData = getSubjectData();
      let totalStudents = 0;
      let presentToday = 0;
      let absentToday = 0;

      if (subjectData) {
        for (const studentId in subjectData) {
          if (studentId.startsWith('_')) continue;
          totalStudents++;

          if (subjectData[studentId][appState.currentDay] === 'Present') {
            presentToday++;
          } else {
            absentToday++;
          }
        }
      }

      elements.statsTotalStudents.textContent = totalStudents;
      elements.statsPresentToday.textContent = presentToday;
      elements.statsAbsentToday.textContent = absentToday;
      elements.statsWorkingDays.textContent = getWorkingDays();
    }

    // ==================== DEFAULTER FUNCTIONS ====================
    function getDefaultersList() {
      const defaulters = [];
      const subjectData = getSubjectData();
      const threshold = appState.threshold;

      if (!subjectData) return defaulters;

      for (const studentId in subjectData) {
        if (studentId.startsWith('_')) continue;

        const stats = getStudentStats(studentId);
        if (stats.percentage < threshold) {
          defaulters.push({
            id: studentId,
            name: subjectData[studentId]._name || studentId,
            ...stats
          });
        }
      }

      defaulters.sort((a, b) => a.percentage - b.percentage);
      return defaulters;
    }

    function updateDefaulterCount() {
      const defaulters = getDefaultersList();
      elements.defaulterCount.textContent = defaulters.length;
    }

    function showDefaulterTable() {
      const defaulters = getDefaultersList();

      if (defaulters.length === 0) {
        elements.defaulterTableContainer.style.display = 'none';
        showAlert('No defaulters found! All students are above the threshold.', 'success');
        return;
      }

      elements.defaulterTableBody.innerHTML = '';

      defaulters.forEach(d => {
        const row = document.createElement('tr');

        // ‚úÖ GET LEAVE SUMMARY FOR THIS STUDENT
        const leaveSummary = getStudentLeaveSummary(d.id);

        row.innerHTML = `
      <td>${escapeHtml(d.id)}</td>
      <td>
        ${escapeHtml(d.name)}
        ${leaveSummary ? `<br><small class="text-info">üìù ${leaveSummary.applications} leave application(s)</small>` : ''}
      </td>
      <td>${d.present}</td>
      <td>${d.absent}</td>
      <td>${d.workingDays}</td>
      <td>
        <span class="defaulter-badge">${d.percentage}%</span>
        ${leaveSummary ? `<br><small class="badge bg-info mt-1">${leaveSummary.count} days leave approved</small>` : ''}
      </td>
    `;
        elements.defaulterTableBody.appendChild(row);
      });

      elements.defaulterTableContainer.style.display = 'block';
    }

    function showDefaulterModal() {
      if (!appState.selectedSubject) {
        showAlert('Please select a subject first!', 'warning');
        return;
      }

      if (appState.selectedMonth === null) {
        showAlert('Please select a month first!', 'warning');
        return;
      }

      const defaulters = getDefaultersList();

      elements.modalSubject.textContent = appState.selectedSubject;
      elements.modalMonth.textContent = `${monthNames[appState.selectedMonth]} ${appState.selectedYear}`;
      elements.modalThreshold.textContent = `${appState.threshold}%`;

      if (defaulters.length === 0) {
        elements.noDefaultersAlert.style.display = 'block';
        document.getElementById('modalDefaulterContent').style.display = 'none';
      } else {
        elements.noDefaultersAlert.style.display = 'none';
        document.getElementById('modalDefaulterContent').style.display = 'block';

        elements.modalDefaulterTableBody.innerHTML = '';
        defaulters.forEach(d => {
          // ‚úÖ GET LEAVE SUMMARY
          const leaveSummary = getStudentLeaveSummary(d.id);

          const row = document.createElement('tr');
          row.innerHTML = `
        <td>${escapeHtml(d.id)}</td>
        <td>
          ${escapeHtml(d.name)}
          ${leaveSummary ? `<br><small class="text-info">üìù Leave: ${escapeHtml(leaveSummary.reasons)}</small>` : ''}
        </td>
        <td>${d.present}</td>
        <td>${d.absent}</td>
        <td>${d.workingDays}</td>
        <td>
          <span class="defaulter-badge">${d.percentage}%</span>
          ${leaveSummary ? `<br><small class="badge bg-info mt-1">${leaveSummary.count} day(s) approved</small>` : ''}
        </td>
      `;
          elements.modalDefaulterTableBody.appendChild(row);
        });
      }

      const modal = new bootstrap.Modal(document.getElementById('defaulterModal'));
      modal.show();
    }

    function exportDefaulters() {
      if (!appState.selectedSubject || appState.selectedMonth === null) {
        showAlert('Please select a subject and month first!', 'warning');
        return;
      }

      const defaulters = getDefaultersList();

      if (defaulters.length === 0) {
        showAlert('No defaulters to export!', 'info');
        return;
      }

      // ‚úÖ MODIFIED HEADERS - Add Leave Info Column
      const headers = ['ID', 'Name', 'Present Days', 'Absent Days', 'Working Days', 'Attendance %', 'Leave Applications', 'Leave Days', 'Leave Reason'];
      const rows = [headers];

      defaulters.forEach(d => {
        // ‚úÖ GET LEAVE INFO
        const leaveSummary = getStudentLeaveSummary(d.id);

        const leaveApps = leaveSummary ? leaveSummary.applications : 0;
        const leaveDays = leaveSummary ? leaveSummary.count : 0;
        const leaveReason = leaveSummary ? leaveSummary.reasons : 'N/A';

        rows.push([
          d.id,
          d.name,
          d.present,
          d.absent,
          d.workingDays,
          `${d.percentage}%`,
          leaveApps,
          leaveDays,
          leaveReason
        ]);
      });

      const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\r\n');
      downloadFile(csv, `defaulters_${appState.selectedSubject}_${monthNames[appState.selectedMonth]}_${appState.selectedYear}.csv`);
    }
    function addDepartment(name) {
      name = String(name).trim();

      if (!name) {
        showAlert('Please enter a department name!', 'warning');
        return false;
      }

      if (appState.departments.includes(name)) {
        showAlert('Department already exists!', 'warning');
        return false;
      }

      console.log(`üîß Adding department: "${name}"`);

      appState.departments.push(name);
      appState.courses[name] = [];

      populateDepartmentDropdown();
      renderDepartmentTags();

      console.log(`üîß Calling saveAllData()...`);
      saveAllData();

      showAlert(`Department "${name}" added successfully!`, 'success');
      return true;
    }
    function deleteDepartment(name) {
      if (!confirm(`‚ö†Ô∏è DELETE DEPARTMENT "${name}"?...`)) {
        return;
      }

      // ‚úÖ DELETE ALL SUBJECTS for all courses in this department
      if (appState.subjects[name]) {
        delete appState.subjects[name];
      }

      // Remove from departments array
      appState.departments = appState.departments.filter(d => d !== name);

      // Delete all courses
      delete appState.courses[name];

      // Delete attendance data for ALL YEARS
      for (const year in appState.attendanceData) {
        if (appState.attendanceData[year]?.[name]) {
          delete appState.attendanceData[year][name];
        }
      }

      // Reset selection if needed
      if (appState.selectedDepartment === name) {
        appState.selectedDepartment = null;
        appState.selectedCourse = null;
        appState.selectedSubject = null;

        // Disable inputs
        elements.newCourseInput.disabled = true;
        elements.addCourseBtn.disabled = true;
        elements.courseSelect.disabled = true;
        elements.newSubjectInput.disabled = true;
        elements.addSubjectBtn.disabled = true;
        elements.subjectSelect.disabled = true;

        updateDepartmentDisplay();
        updateCourseDisplay();
        updateSubjectDisplay();
      }

      // Update UI
      populateDepartmentDropdown();
      renderDepartmentTags();
      populateCourseDropdown();
      renderCourseTags();
      populateSubjectDropdown();
      renderSubjectTags();
      updateFinalSelectionDropdowns();
      refreshAttendanceTable();

      saveAllData();
      showAlert(`Department "${name}" and all related data deleted!`, 'info');
    }

    function selectDepartment(name) {
      appState.selectedDepartment = name;
      appState.selectedCourse = null; // Reset course when department changes

      elements.departmentSelect.value = name;
      elements.finalDepartmentSelect.value = name;

      // Enable course input
      elements.newCourseInput.disabled = false;
      elements.addCourseBtn.disabled = false;
      elements.courseSelect.disabled = false;
      updateDepartmentDisplay();
      updateFinalSelectionBadges();
      populateCourseDropdown();
      renderCourseTags();
      updateFinalSelectionDropdowns();
      saveAllData();
      ;
    }

    function populateDepartmentDropdown() {
      // Update both dropdowns
      const dropdowns = [elements.departmentSelect, elements.finalDepartmentSelect];

      dropdowns.forEach(dropdown => {
        dropdown.innerHTML = '<option value="">-- Choose Department --</option>';

        appState.departments.forEach(dept => {
          const option = document.createElement('option');
          option.value = dept;
          option.textContent = dept;
          if (dept === appState.selectedDepartment) {
            option.selected = true;
          }
          dropdown.appendChild(option);
        });
      });
    }

    function renderDepartmentTags() {
      if (appState.departments.length === 0) {
        elements.departmentTags.innerHTML = '<span class="text-muted">No departments added yet.</span>';
        return;
      }

      elements.departmentTags.innerHTML = '';
      appState.departments.forEach(dept => {
        const tag = document.createElement('span');
        tag.className = `subject-tag ${dept === appState.selectedDepartment ? 'active' : ''}`;
        tag.innerHTML = `
      ${escapeHtml(dept)}
      <span class="delete-btn" data-dept="${escapeHtml(dept)}">&times;</span>
    `;

        tag.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-btn')) {
            selectDepartment(dept);
          }
        });

        elements.departmentTags.appendChild(tag);
      });

      // Add delete listeners
      document.querySelectorAll('#departmentTags .delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteDepartment(e.target.getAttribute('data-dept'));
        });
      });
    }

    function updateDepartmentDisplay() {
      const dept = appState.selectedDepartment || 'None selected';
      elements.currentDepartmentDisplay.textContent = dept;
      elements.selectedPathDept.textContent = appState.selectedDepartment || 'No Department';
    }

    // ==================== COURSE FUNCTIONS ====================
    function addCourse(name) {
      if (!appState.selectedDepartment) {
        showAlert('Please select a department first!', 'warning');
        return false;
      }

      name = String(name).trim();

      if (!name) {
        showAlert('Please enter a course name!', 'warning');
        return false;
      }

      if (appState.courses[appState.selectedDepartment].includes(name)) {
        showAlert('Course already exists in this department!', 'warning');
        return false;
      }

      appState.courses[appState.selectedDepartment].push(name);

      populateCourseDropdown();
      renderCourseTags();
      saveAllData();

      showAlert(`Course "${name}" added successfully!`, 'success');
      return true;
    }

    function deleteCourse(name) {
      if (!appState.selectedDepartment) {
        showAlert('Please select a department first!', 'warning');
        return;
      }

      if (!confirm(`‚ö†Ô∏è DELETE COURSE "${name}"?...`)) {
        return;
      }

      const dept = appState.selectedDepartment;

      // ‚úÖ DELETE SUBJECTS for this course
      if (appState.subjects[dept] && appState.subjects[dept][name]) {
        delete appState.subjects[dept][name];
      }

      // Remove from courses array
      appState.courses[dept] = appState.courses[dept].filter(c => c !== name);

      // Delete attendance data for ALL YEARS
      for (const year in appState.attendanceData) {
        if (appState.attendanceData[year]?.[dept]?.[name]) {
          delete appState.attendanceData[year][dept][name];
        }
      }

      // Reset selection if needed
      if (appState.selectedCourse === name) {
        appState.selectedCourse = null;
        appState.selectedSubject = null;

        // Disable subject inputs
        elements.newSubjectInput.disabled = true;
        elements.addSubjectBtn.disabled = true;
        elements.subjectSelect.disabled = true;

        updateCourseDisplay();
        updateSubjectDisplay();
      }

      // Update UI
      populateCourseDropdown();
      renderCourseTags();
      populateSubjectDropdown();
      renderSubjectTags();
      updateFinalSelectionDropdowns();
      refreshAttendanceTable();

      saveAllData();
      showAlert(`Course "${name}" and all related data deleted!`, 'info');
    }

    function selectCourse(name) {
      appState.selectedCourse = name;
      appState.selectedSubject = null; // ‚úÖ RESET subject when course changes

      elements.courseSelect.value = name;
      elements.finalCourseSelect.value = name;

      // Enable subject input
      elements.newSubjectInput.disabled = false;
      elements.addSubjectBtn.disabled = false;
      elements.subjectSelect.disabled = false;

      updateCourseDisplay();
      updateFinalSelectionBadges();
      populateSubjectDropdown(); // ‚úÖ Repopulate with course-specific subjects
      renderSubjectTags(); // ‚úÖ Show course-specific subjects
      updateFinalSelectionDropdowns();
      saveAllData();
      ;
    }

    function populateCourseDropdown() {
      const dropdowns = [elements.courseSelect, elements.finalCourseSelect];

      dropdowns.forEach(dropdown => {
        dropdown.innerHTML = '<option value="">-- Choose Course --</option>';

        if (!appState.selectedDepartment) {
          dropdown.disabled = true;
          return;
        }

        dropdown.disabled = false;

        const courses = appState.courses[appState.selectedDepartment] || [];
        courses.forEach(course => {
          const option = document.createElement('option');
          option.value = course;
          option.textContent = course;
          if (course === appState.selectedCourse) {
            option.selected = true;
          }
          dropdown.appendChild(option);
        });
      });
    }

    function renderCourseTags() {
      if (!appState.selectedDepartment) {
        elements.courseTags.innerHTML = '<span class="text-muted">Select a department first.</span>';
        elements.coursesDepartmentName.textContent = '--';
        return;
      }

      elements.coursesDepartmentName.textContent = appState.selectedDepartment;

      const courses = appState.courses[appState.selectedDepartment] || [];

      if (courses.length === 0) {
        elements.courseTags.innerHTML = '<span class="text-muted">No courses added yet.</span>';
        return;
      }

      elements.courseTags.innerHTML = '';
      courses.forEach(course => {
        const tag = document.createElement('span');
        tag.className = `subject-tag ${course === appState.selectedCourse ? 'active' : ''}`;
        tag.innerHTML = `
      ${escapeHtml(course)}
      <span class="delete-btn" data-course="${escapeHtml(course)}">&times;</span>
    `;

        tag.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-btn')) {
            selectCourse(course);
          }
        });

        elements.courseTags.appendChild(tag);
      });

      document.querySelectorAll('#courseTags .delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteCourse(e.target.getAttribute('data-course'));
        });
      });
    }

    function updateCourseDisplay() {
      const course = appState.selectedCourse || 'None selected';
      elements.currentCourseDisplay.textContent = course;
      elements.selectedPathCourse.textContent = appState.selectedCourse || 'No Course';
    }

    function deleteSubject(name) {
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;

      if (!dept || !course) {
        showAlert('Please select department and course first!', 'warning');
        return;
      }

      if (!confirm(`‚ö†Ô∏è DELETE SUBJECT "${name}"?\n\nThis will also delete all attendance data for this subject.\n\nThis action cannot be undone!`)) {
        return;
      }

      // Remove from subjects array
      if (appState.subjects[dept] && appState.subjects[dept][course]) {
        appState.subjects[dept][course] = appState.subjects[dept][course].filter(s => s !== name);
      }

      // Delete attendance data for ALL YEARS
      for (const year in appState.attendanceData) {
        if (appState.attendanceData[year]?.[dept]?.[course]) {
          for (const acYear in appState.attendanceData[year][dept][course]) {
            for (const div in appState.attendanceData[year][dept][course][acYear]) {
              if (appState.attendanceData[year][dept][course][acYear][div]?.months) {
                for (const month in appState.attendanceData[year][dept][course][acYear][div].months) {
                  if (appState.attendanceData[year][dept][course][acYear][div].months[month]?.subjects?.[name]) {
                    delete appState.attendanceData[year][dept][course][acYear][div].months[month].subjects[name];
                  }
                }
              }
            }
          }
        }
      }

      // Reset selection if needed
      if (appState.selectedSubject === name) {
        appState.selectedSubject = null;
        updateSubjectDisplay();
      }

      // Update UI
      populateSubjectDropdown();
      renderSubjectTags();
      updateFinalSelectionDropdowns();
      refreshAttendanceTable();

      saveAllData();
      showAlert(`Subject "${name}" and all related data deleted!`, 'info');
    }

    // ==================== FINAL SELECTION & ACADEMIC YEAR ====================
    function updateFinalSelectionDropdowns() {
      // ‚úÖ Populate all three dropdowns (these handle their own null checks)
      populateDepartmentDropdown();
      populateCourseDropdown();
      populateSubjectDropdown();

      // ‚úÖ Update path badges
      elements.selectedPathDept.textContent = appState.selectedDepartment || 'No Department';
      elements.selectedPathCourse.textContent = appState.selectedCourse || 'No Course';
      elements.selectedPathSubject.textContent = appState.selectedSubject || 'No Subject';
    }
    function updateFinalSelectionBadges() {
      elements.selectedPathDept.textContent = appState.selectedDepartment || 'No Department';
      elements.selectedPathCourse.textContent = appState.selectedCourse || 'No Course';
      elements.selectedPathSubject.textContent = appState.selectedSubject || 'No Subject';
    }
    function updateAcademicYearDisplay() {
      const parts = [];

      if (appState.selectedAcademicYear) {
        parts.push(`Academic Year: ${appState.selectedAcademicYear}`);
      }

      if (appState.selectedDivision) {
        parts.push(`Division: ${appState.selectedDivision}`);
      }

      if (parts.length === 0) {
        elements.currentAcademicDisplay.textContent = 'None';
      } else {
        elements.currentAcademicDisplay.textContent = parts.join(' | ');
      }
    }

    // ==================== EVENT LISTENERS ====================
    function initializeEventListeners() {
      if (window._eventListenersInitialized) {
        console.warn('‚ö†Ô∏è Event listeners already initialized! Skipping...');
        return;
      }
      window._eventListenersInitialized = true;
      console.log('‚úÖ Initializing event listeners (first time only)');

      // ==================== DEPARTMENT EVENTS ====================
      // Add Department
      elements.addDepartmentBtn.addEventListener('click', () => {
        const name = elements.newDepartmentInput.value.trim();
        if (addDepartment(name)) {
          elements.newDepartmentInput.value = '';
        }
      });

      elements.newDepartmentInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const name = elements.newDepartmentInput.value.trim();
          if (addDepartment(name)) {
            elements.newDepartmentInput.value = '';
          }
        }
      });

      // Select Department
      elements.departmentSelect.addEventListener('change', () => {
        const dept = elements.departmentSelect.value;

        // ‚úÖ FIX: Handle empty selection
        if (!dept || dept === '') {
          // Reset department and all dependent selections
          appState.selectedDepartment = null;
          appState.selectedCourse = null;
          appState.selectedSubject = null;

          // Disable dependent inputs
          elements.newCourseInput.disabled = true;
          elements.addCourseBtn.disabled = true;
          elements.courseSelect.disabled = true;
          elements.newSubjectInput.disabled = true;
          elements.addSubjectBtn.disabled = true;
          elements.subjectSelect.disabled = true;

          // Update displays
          updateDepartmentDisplay();
          updateCourseDisplay();
          updateSubjectDisplay();
          updateFinalSelectionBadges();

          // Clear dropdowns
          populateCourseDropdown();
          populateSubjectDropdown();
          renderCourseTags();
          renderSubjectTags();

          saveAllData();
          return;
        }

        selectDepartment(dept);
      });

      // Delete Department
      elements.deleteDepartmentBtn.addEventListener('click', () => {
        if (!appState.selectedDepartment) {
          showAlert('Please select a department first!', 'warning');
          return;
        }
        deleteDepartment(appState.selectedDepartment);
      });

      // ==================== COURSE EVENTS ====================
      // Add Course
      elements.addCourseBtn.addEventListener('click', () => {
        const name = elements.newCourseInput.value.trim();
        if (addCourse(name)) {
          elements.newCourseInput.value = '';
        }
      });

      elements.newCourseInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const name = elements.newCourseInput.value.trim();
          if (addCourse(name)) {
            elements.newCourseInput.value = '';
          }
        }
      });

      // Select Course
      elements.courseSelect.addEventListener('change', () => {
        const course = elements.courseSelect.value;

        if (!course || course === '') {
          appState.selectedCourse = null;
          appState.selectedSubject = null;

          elements.newSubjectInput.disabled = true;
          elements.addSubjectBtn.disabled = true;
          elements.subjectSelect.disabled = true;

          updateCourseDisplay();
          updateSubjectDisplay();
          updateFinalSelectionBadges();

          populateSubjectDropdown();
          renderSubjectTags();

          saveAllData();
          return;
        }

        selectCourse(course);
      });

      // Final Course Select
      elements.finalCourseSelect.addEventListener('change', () => {
        const course = elements.finalCourseSelect.value;

        if (!course || course === '') {
          appState.selectedCourse = null;
          appState.selectedSubject = null;

          elements.courseSelect.value = '';
          elements.finalSubjectSelect.value = '';

          updateCourseDisplay();
          updateSubjectDisplay();
          updateFinalSelectionBadges();

          populateSubjectDropdown();

          saveAllData();
          setupLeaveStatusListener();
          return;
        }

        selectCourse(course);
        updateFinalSelectionDropdowns();
      });

      // Delete Course
      elements.deleteCourseBtn.addEventListener('click', () => {
        if (!appState.selectedCourse) {
          showAlert('Please select a course first!', 'warning');
          return;
        }
        deleteCourse(appState.selectedCourse);
      });

      // ==================== FINAL SELECTION EVENTS ====================
      // Final Department Select
      elements.finalDepartmentSelect.addEventListener('change', () => {
        const dept = elements.finalDepartmentSelect.value;

        // ‚úÖ FIX: Handle empty selection
        if (!dept || dept === '') {
          appState.selectedDepartment = null;
          appState.selectedCourse = null;
          appState.selectedSubject = null;

          elements.departmentSelect.value = '';
          elements.finalCourseSelect.value = '';
          elements.finalSubjectSelect.value = '';

          updateDepartmentDisplay();
          updateCourseDisplay();
          updateSubjectDisplay();
          updateFinalSelectionBadges();

          populateCourseDropdown();
          populateSubjectDropdown();

          saveAllData();
          setupLeaveStatusListener();
          return;
        }

        selectDepartment(dept);
        updateFinalSelectionDropdowns();
      });

      // Final Course Select
      elements.finalCourseSelect.addEventListener('change', () => {
        const course = elements.finalCourseSelect.value;
        if (course) {
          selectCourse(course);
          updateFinalSelectionDropdowns();
        }
      });

      // Final Subject Select
      elements.finalSubjectSelect.addEventListener('change', () => {
        const subject = elements.finalSubjectSelect.value;
        if (subject) {
          selectSubject(subject);
          updateFinalSelectionDropdowns();
        }
      });

      // ==================== ACADEMIC YEAR & DIVISION EVENTS ====================
      // Academic Year Select
      elements.academicYearLevelSelect.addEventListener('change', () => {
        appState.selectedAcademicYear = elements.academicYearLevelSelect.value;
        updateAcademicYearDisplay();
        saveAllData();
        setupLeaveStatusListener();
      });

      // Division Select
      elements.divisionSelect.addEventListener('change', () => {
        appState.selectedDivision = elements.divisionSelect.value;
        updateAcademicYearDisplay();
        saveAllData();
        setupLeaveStatusListener();
      });

      // Subject events
      elements.addSubjectBtn.addEventListener('click', () => {
        if (addSubject(elements.newSubjectInput.value)) {
          elements.newSubjectInput.value = '';
        }
      });

      elements.newSubjectInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          if (addSubject(elements.newSubjectInput.value)) {
            elements.newSubjectInput.value = '';
          }
        }
      });

      elements.subjectSelect.addEventListener('change', () => {
        if (isUpdatingSubjectDropdown) return;
        selectSubject(elements.subjectSelect.value);
      });

      elements.deleteSubjectBtn.addEventListener('click', () => {
        if (!appState.selectedSubject) {
          showAlert('Please select a subject first!', 'warning');
          return;
        }
        deleteSubject(appState.selectedSubject);
      });

      // Month events
      elements.applyMonthBtn.addEventListener('click', applyMonth);

      // Holiday events
      elements.toggleHolidayBtn.addEventListener('click', toggleHoliday);
      elements.clearHolidaysBtn.addEventListener('click', clearAllHolidays);

      // File upload events
      elements.browseBtn.addEventListener('click', () => {
        elements.fileInput.click();
      });

      elements.fileDrop.addEventListener('click', () => {
        elements.fileInput.click();
      });

      elements.fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          handleFileUpload(e.target.files[0]);
          // Don't reset here - will reset after successful upload
        }
      });

      elements.fileDrop.addEventListener('dragover', (e) => {
        e.preventDefault();
        elements.fileDrop.classList.add('dragover');
      });

      elements.fileDrop.addEventListener('dragleave', (e) => {
        e.preventDefault();
        elements.fileDrop.classList.remove('dragover');
      });

      elements.fileDrop.addEventListener('drop', (e) => {
        e.preventDefault();
        elements.fileDrop.classList.remove('dragover');

        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          handleFileUpload(e.dataTransfer.files[0]);
        }
      });

      elements.downloadTemplateBtn.addEventListener('click', downloadTemplate);
      elements.downloadReportBtn.addEventListener('click', downloadReport);
      elements.clearAllBtn.addEventListener('click', clearSelectedSubjectMonth);
      // DEBUG BUTTON - Check what's saved in database
      document.getElementById('debugSaveBtn').addEventListener('click', async () => {
        const data = {
          subjects: await loadFromDatabase('subjects'),
          selectedSubject: await loadFromDatabase('selectedSubject'),
          selectedMonth: await loadFromDatabase('selectedMonth'),
          selectedYear: await loadFromDatabase('selectedYear'),
          currentDay: await loadFromDatabase('currentDay'),
          attendanceData: await loadFromDatabase('attendanceData'),
          holidays: await loadFromDatabase('holidays')
        };

        console.log('=== DATABASE CONTENT ===');
        console.log('Subjects:', data.subjects);
        console.log('Selected Subject:', data.selectedSubject);
        console.log('Selected Month:', data.selectedMonth, '(0=Jan, 1=Feb, etc.)');
        console.log('Selected Year:', data.selectedYear);
        console.log('Current Day:', data.currentDay);
        console.log('Attendance Data Keys:', Object.keys(data.attendanceData || {}));
        console.log('Holidays:', data.holidays);
        console.log('========================');

        let message = 'üìä DATABASE CONTENT:\n\n';
        message += `Subjects: ${data.subjects?.length || 0}\n`;
        message += `Selected Subject: ${data.selectedSubject || 'NONE'}\n`;
        message += `Selected Month: ${data.selectedMonth !== null ? data.selectedMonth + ' (0=Jan)' : 'NONE'}\n`;
        message += `Selected Year: ${data.selectedYear || 'NONE'}\n`;
        message += `Current Day: ${data.currentDay || 'NONE'}\n`;
        message += `\nAttendance Data Month Keys:\n`;
        if (data.attendanceData) {
          Object.keys(data.attendanceData).forEach(key => {
            message += `  - ${key}\n`;
          });
        } else {
          message += '  - NONE\n';
        }
        message += '\n‚úì Check browser console for full details';

        alert(message);
      });

      // Generate QR button
      document.getElementById('generateQRBtn').addEventListener('click', async () => {
        const missing = [];
        if (!appState.selectedDepartment) missing.push('Department');
        if (!appState.selectedCourse) missing.push('Course');
        if (!appState.selectedSubject) missing.push('Subject');
        if (!appState.selectedAcademicYear) missing.push('Academic Year');
        if (!appState.selectedDivision) missing.push('Division');
        if (appState.selectedMonth === null) missing.push('Month');
        if (appState.selectedYear === null) missing.push('Year');

        const validationAlert = document.getElementById('qrValidationAlert');
        const qrContainer = document.getElementById('qrCodeContainer');

        if (missing.length > 0) {
          document.getElementById('qrValidationMsg').textContent = 'Missing: ' + missing.join(', ');
          validationAlert.style.display = 'block';
          qrContainer.innerHTML = '';
        } else {
          validationAlert.style.display = 'none';

          // ‚úÖ CREATE DIVISION KEY FIRST
          const divisionKey = `${appState.selectedDepartment}_${appState.selectedCourse}_${appState.selectedAcademicYear}_${appState.selectedDivision}`;

          // ‚úÖ STEP 1: DELETE OLD QR FROM FIREBASE (if exists)
          if (useCloud && firebaseDB) {
            try {
              console.log(`üîç Checking for existing QR for: ${divisionKey}`);

              const snapshot = await firebaseDB.ref('mainSystem/activeQRs').once('value');
              const allQRs = snapshot.val() || {};

              // Find and delete any QR for this division
              for (const id in allQRs) {
                const qrData = allQRs[id];
                if (qrData.division === divisionKey) {
                  console.log(`üóëÔ∏è Deleting old QR: ${id}`);
                  await firebaseDB.ref(`mainSystem/activeQRs/${id}`).remove();
                }
              }

            } catch (error) {
              console.error('Error deleting old QR:', error);
            }
          }

          // ‚úÖ STEP 2: CREATE NEW QR ID (always fresh)
          const qrId = Math.random().toString(36).substring(2, 10).toUpperCase();
          console.log(`üÜï Generated NEW QR ID: ${qrId}`);

          const payload = JSON.stringify({
            qrId: qrId,
            department: appState.selectedDepartment,
            course: appState.selectedCourse,
            academicYear: appState.selectedAcademicYear,
            division: appState.selectedDivision,
            subject: appState.selectedSubject,
            month: appState.selectedMonth,
            year: appState.selectedYear,
            day: appState.currentDay
          });

          // ‚úÖ STEP 3: TRACK NEW QR LOCALLY
          if (!window.activeQRsByDivision) {
            window.activeQRsByDivision = {};
          }
          window.activeQRsByDivision[divisionKey] = qrId;

          // ‚úÖ STEP 4: SAVE TO FIREBASE (new QR)
          if (useCloud && firebaseDB) {
            try {
              await firebaseDB.ref(`mainSystem/activeQRs/${qrId}`).set({
                createdAt: Date.now(),
                expiresAt: Date.now() + 600000,
                division: divisionKey,
                data: JSON.parse(payload)
              });
              console.log(`‚úÖ Saved NEW QR to Firebase: ${qrId}`);
            } catch (error) {
              console.error('Error saving QR to Firebase:', error);
            }
          }

          // Start countdown timer
          startQRCountdown(600);

          // Generate QR using qrcode-generator
          const qr = qrcode(0, 'M');
          qr.addData(payload);
          qr.make();
          qrContainer.innerHTML = qr.createSvgTag(6, 0);

          // Show active status
          document.getElementById('qrStatus').style.display = 'block';
          document.getElementById('qrStatus').className = 'alert alert-success mb-3';
          document.getElementById('qrStatus').innerHTML = '‚úÖ Active - Expires in: <span id="qrTimer">10:00</span>';
          document.getElementById('qrCodeContainer').style.opacity = '1';

          // Show and start dynamic code rotation
          document.getElementById('qrDynamicCodeDisplay').style.display = 'block';
          startDynamicCodeRotation();

          // Update path badges
          document.getElementById('qrBadgeDept').textContent = appState.selectedDepartment;
          document.getElementById('qrBadgeCourse').textContent = appState.selectedCourse;
          document.getElementById('qrBadgeSubject').textContent = appState.selectedSubject;
          document.getElementById('qrBadgeAcYear').textContent = appState.selectedAcademicYear;
          document.getElementById('qrBadgeDiv').textContent = appState.selectedDivision;
          document.getElementById('qrBadgeMonth').textContent = monthNames[appState.selectedMonth];
          document.getElementById('qrBadgeDay').textContent = 'Day ' + appState.currentDay;
        }

        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('qrModal'));
        modal.show();
      });
      // Day navigation events
      elements.dateSelect.addEventListener('change', () => {
        if (isUpdatingDayDropdown) return;
        selectDay(parseInt(elements.dateSelect.value));
      });

      let dayNavigationTimeout = null;

      elements.prevDayBtn.addEventListener('click', () => {
        // Clear any pending navigation
        if (dayNavigationTimeout) {
          clearTimeout(dayNavigationTimeout);
        }

        // Debounce to prevent double-clicks
        dayNavigationTimeout = setTimeout(() => {
          if (appState.currentDay > 1) {
            const newDay = appState.currentDay - 1;
            console.log(`üìÖ Prev Day: ${appState.currentDay} ‚Üí ${newDay}`);
            selectDay(newDay);
          }
        }, 50); // 50ms debounce
      });

      elements.nextDayBtn.addEventListener('click', () => {
        // Clear any pending navigation
        if (dayNavigationTimeout) {
          clearTimeout(dayNavigationTimeout);
        }

        // Debounce to prevent double-clicks
        dayNavigationTimeout = setTimeout(() => {
          if (appState.currentDay < appState.daysInMonth) {
            const newDay = appState.currentDay + 1;
            console.log(`üìÖ Next Day: ${appState.currentDay} ‚Üí ${newDay}`);
            selectDay(newDay);
          }
        }, 50); // 50ms debounce
      });

      // Attendance actions
      elements.markAllPresentBtn.addEventListener('click', () => markAllAttendance('Present'));
      elements.markAllAbsentBtn.addEventListener('click', () => markAllAttendance('Absent'));

      // Search and filter events
      elements.searchBtn.addEventListener('click', refreshAttendanceTable);
      elements.searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') refreshAttendanceTable();
      });
      elements.resetSearchBtn.addEventListener('click', () => {
        elements.searchInput.value = '';
        refreshAttendanceTable();
      });
      elements.sortSelect.addEventListener('change', refreshAttendanceTable);
      elements.filterSelect.addEventListener('change', refreshAttendanceTable);
      elements.refreshTableBtn.addEventListener('click', refreshAttendanceTable);

      // Threshold event
      elements.thresholdInput.addEventListener('change', () => {
        appState.threshold = parseInt(elements.thresholdInput.value) || 75;
        updateDefaulterCount();
        refreshAttendanceTable();
        saveAllData();
      });

      // Defaulter events
      elements.showDefaultersBtn.addEventListener('click', showDefaulterModal);
      elements.exportDefaultersBtn.addEventListener('click', exportDefaulters);
      elements.modalExportBtn.addEventListener('click', exportDefaulters);

      // Modal close events
      elements.modalCloseBtn.addEventListener('click', () => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('defaulterModal'));
        if (modal) modal.hide();
      });

      elements.modalCloseBtnFooter.addEventListener('click', () => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('defaulterModal'));
        if (modal) modal.hide();
      });
      // When QR modal closes, stop dynamic code rotation
      const qrModal = document.getElementById('qrModal');

      qrModal.addEventListener('hidden.bs.modal', () => {
        console.log('üîí QR Modal closed - stopping code rotation');
        stopDynamicCodeRotation();
        // ‚úÖ DON'T stop the countdown timer - QR is still valid in Firebase
        // Timer continues running in background to show accurate time remaining
      });

      // ‚úÖ When modal opens, sync the timer display
      qrModal.addEventListener('shown.bs.modal', () => {
        console.log('üîì QR Modal opened');
        // ‚úÖ If we have an active QR, sync the timer display
        if (qrExpiryTimestamp) {
          updateQRTimer();
          console.log('‚úÖ QR timer synced with actual expiry time');
        }
      });
      // Smooth scroll for navigation
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
          }
        });
      });


      // Open Leave Form Modal
      const openLeaveFormBtn = document.getElementById('openLeaveFormBtn');
if (openLeaveFormBtn) {
  openLeaveFormBtn.addEventListener('click', async () => {
        // Validate division context
        const validation = validateDivisionContext();

        if (!validation.valid) {
          showAlert(`Please select: ${validation.missing.join(', ')} before submitting leave applications!`, 'warning');
          return;
        }

        // Reset form
        resetLeaveForm();

        // ‚úÖ CHECK USER ROLE FIRST (before loading students)
        const role = await getUserRole();
        const attributes = await getUserAttributes();

        if (role === 'student') {
          // ‚úÖ FOR STUDENTS: Only load THEIR student data
          const studentId = attributes['custom:studentId'];

          if (!studentId) {
            showAlert('Your student ID is not configured. Please contact admin.', 'danger');
            return;
          }

          // ‚úÖ MANUALLY POPULATE DROPDOWN WITH ONLY THEIR ID
          const studentSelect = document.getElementById('leaveStudentSelect');
          studentSelect.innerHTML = ''; // Clear dropdown

          // Get student name from current student list
          const currentStudent = appState.studentList.find(s => s.id === studentId);
          const studentName = currentStudent ? currentStudent.name : 'You';

          // Add ONLY their option
          const option = document.createElement('option');
          option.value = studentId;
          option.textContent = `${studentId} - ${studentName}`;
          option.selected = true;
          studentSelect.appendChild(option);

          // ‚úÖ DISABLE THE DROPDOWN
          studentSelect.disabled = true;

          // Add visual indicator
          const selectContainer = studentSelect.parentElement;
          const lockedMsg = document.createElement('small');
          lockedMsg.className = 'text-info d-block mt-1';
          lockedMsg.id = 'leaveStudentLocked';
          lockedMsg.innerHTML = '<i class="bi bi-lock me-1"></i>You can only submit leave for yourself';
          selectContainer.appendChild(lockedMsg);

          console.log(`‚úÖ Student dropdown restricted to: ${studentId}`);

        } else {
          // ‚úÖ FOR TEACHERS/ADMINS: Load full student list
          await loadStudentsForLeaveForm();
        }

        // Set date range limits (current month)
        const year = appState.selectedYear;
        const month = appState.selectedMonth;

        if (month !== null && year !== null) {
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);

          const fromInput = document.getElementById('leaveFromDate');
          const toInput = document.getElementById('leaveToDate');

          fromInput.min = formatDateForInput(firstDay);
          fromInput.max = formatDateForInput(lastDay);
          toInput.min = formatDateForInput(firstDay);
          toInput.max = formatDateForInput(lastDay);

          // Set default values to current day
          if (appState.currentDay) {
            const currentDate = new Date(year, month, appState.currentDay);
            fromInput.value = formatDateForInput(currentDate);
            toInput.value = formatDateForInput(currentDate);
            updateLeaveDayCount();
          }
        }

        // Show modal
        if (!leaveModal) {
          leaveModal = new bootstrap.Modal(document.getElementById('leaveModal'));
        }
        leaveModal.show();
      });
    }

      // Date change listeners (update day count)
      document.getElementById('leaveFromDate').addEventListener('change', updateLeaveDayCount);
      document.getElementById('leaveToDate').addEventListener('change', updateLeaveDayCount);

      // Submit Leave Button
      document.getElementById('submitLeaveBtn').addEventListener('click', submitLeaveApplication);

    }
    // ==================== LEAVE APPLICATION SYSTEM ====================

    // State for leave applications
    const leaveState = {
      applications: [],
      filters: {
        status: 'all',
        month: 'current'
      }
    };

    // Initialize leave modal
    let leaveModal = null;

    // ===== UTILITY FUNCTIONS =====

    /**
     * Get date in YYYY-MM-DD format
     */
    function formatDateForInput(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    /**
     * Calculate all days between two dates
     */
    function getDaysBetweenDates(fromDate, toDate) {
      const days = [];
      const start = new Date(fromDate);
      const end = new Date(toDate);

      // Validate dates
      if (start > end) {
        return [];
      }

      const current = new Date(start);
      while (current <= end) {
        days.push(current.getDate());
        current.setDate(current.getDate() + 1);
      }

      return days;
    }

    /**
     * Get Firebase path for leave applications
     */
    function getLeaveApplicationsPath() {
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;

      if (!year || !dept || !course || !academicYear || !division) {
        return null;
      }

      return `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/leaveApplications`;
    }

    /**
     * Validate division context
     */
    function validateDivisionContext() {
      const missing = [];

      if (!appState.selectedDepartment) missing.push('Department');
      if (!appState.selectedCourse) missing.push('Course');
      if (!appState.selectedAcademicYear) missing.push('Academic Year');
      if (!appState.selectedDivision) missing.push('Division');
      if (appState.selectedMonth === null) missing.push('Month');
      if (appState.selectedYear === null) missing.push('Year');

      return {
        valid: missing.length === 0,
        missing: missing
      };
    }

    // ===== LOAD STUDENT LIST FOR DROPDOWN =====

    async function loadStudentsForLeaveForm() {
      const studentSelect = document.getElementById('leaveStudentSelect');
      studentSelect.innerHTML = '<option value="">-- Select Student --</option>';

      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;
      const monthKey = getMonthKey();
      const subject = appState.selectedSubject;

      if (!year || !dept || !course || !academicYear || !division || !monthKey || !subject) {
        console.warn('Cannot load students: context incomplete');
        studentSelect.innerHTML += '<option value="" disabled>Please select all required fields first</option>';
        return;
      }

      // ‚úÖ FIX: Load from CURRENT SUBJECT'S attendance data
      const attendancePath = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/subjects/${subject}/attendance`;

      try {
        let students = {};

        if (useCloud && firebaseDB) {
          const snapshot = await firebaseDB.ref(attendancePath).once('value');
          students = snapshot.val() || {};
        } else {
          // Fallback to local data
          const subjectData = getSubjectData();
          students = subjectData || {};
        }

        if (Object.keys(students).length === 0) {
          console.warn('‚ö†Ô∏è No students found in current subject');
          studentSelect.innerHTML += '<option value="" disabled>No students found - please upload attendance first</option>';
          return;
        }

        // Convert to array and sort
        const studentArray = [];

        for (const studentId in students) {
          if (studentId.startsWith('_')) continue; // Skip metadata

          const studentName = students[studentId]._name || studentId;

          studentArray.push({
            id: studentId,
            name: studentName
          });
        }

        // Sort by ID (numerically if possible)
        studentArray.sort((a, b) => {
          const aNum = parseInt(a.id);
          const bNum = parseInt(b.id);

          if (!isNaN(aNum) && !isNaN(bNum)) {
            return aNum - bNum;
          }

          return a.name.localeCompare(b.name);
        });

        // Populate dropdown
        studentArray.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = `${student.id} - ${student.name}`;
          studentSelect.appendChild(option);
        });

        console.log(`‚úÖ Loaded ${studentArray.length} students for leave form`);

      } catch (error) {
        console.error('Error loading students:', error);
        studentSelect.innerHTML += '<option value="" disabled>Error loading students</option>';
      }
    }

    // ===== DATE CHANGE HANDLER (Calculate Days) =====

    function updateLeaveDayCount() {
      const fromDate = document.getElementById('leaveFromDate').value;
      const toDate = document.getElementById('leaveToDate').value;
      const dayCountAlert = document.getElementById('leaveDayCountAlert');
      const totalLeaveDaysSpan = document.getElementById('totalLeaveDays');
      const leaveDaysListDiv = document.getElementById('leaveDaysList');

      if (!fromDate || !toDate) {
        dayCountAlert.style.display = 'none';
        return;
      }

      const days = getDaysBetweenDates(fromDate, toDate);

      if (days.length === 0) {
        dayCountAlert.style.display = 'none';
        return;
      }

      totalLeaveDaysSpan.textContent = days.length;
      leaveDaysListDiv.textContent = `Days: ${days.join(', ')}`;
      dayCountAlert.style.display = 'block';
    }

    // ===== SUBMIT LEAVE APPLICATION =====

    async function submitLeaveApplication() {
      // Get form values
      const studentId = document.getElementById('leaveStudentSelect').value;
      const fromDate = document.getElementById('leaveFromDate').value;
      const toDate = document.getElementById('leaveToDate').value;
      const reason = document.getElementById('leaveReason').value.trim();

      const validationAlert = document.getElementById('leaveValidationAlert');
      const validationMsg = document.getElementById('leaveValidationMsg');
      const role = await getUserRole();
      const attributes = await getUserAttributes();

      if (role === 'student') {
        const authenticatedStudentId = attributes['custom:studentId'];

        if (studentId !== authenticatedStudentId) {
          validationMsg.textContent = '‚ö†Ô∏è Security Error: You can only submit leave for yourself!';
          validationAlert.style.display = 'block';
          console.error('‚ùå Student tried to submit leave for different ID');
          return;
        }
      }

      // Validate division context
      const contextValidation = validateDivisionContext();
      if (!contextValidation.valid) {
        validationMsg.textContent = `Please select: ${contextValidation.missing.join(', ')}`;
        validationAlert.style.display = 'block';
        return;
      }

      // Validate form fields
      if (!studentId) {
        validationMsg.textContent = 'Please select a student';
        validationAlert.style.display = 'block';
        return;
      }

      if (!fromDate || !toDate) {
        validationMsg.textContent = 'Please select both From and To dates';
        validationAlert.style.display = 'block';
        return;
      }

      if (new Date(fromDate) > new Date(toDate)) {
        validationMsg.textContent = 'From date cannot be after To date';
        validationAlert.style.display = 'block';
        return;
      }

      if (!reason) {
        validationMsg.textContent = 'Please provide a reason for leave';
        validationAlert.style.display = 'block';
        return;
      }

      // Calculate days
      const days = getDaysBetweenDates(fromDate, toDate);

      if (days.length === 0) {
        validationMsg.textContent = 'Invalid date range';
        validationAlert.style.display = 'block';
        return;
      }

      // Get student name
      const studentSelect = document.getElementById('leaveStudentSelect');
      const studentName = studentSelect.options[studentSelect.selectedIndex].text.split(' - ')[1] || studentId;

      // Get current user
      let submittedBy = 'unknown';
      try {
        const user = await getCurrentUser();
        submittedBy = user.attributes.email;
      } catch (error) {
        console.warn('Could not get current user:', error);
      }

      // Generate leave ID
      const leaveId = `leave_${Date.now()}`;

      // Create leave data
      const leaveData = {
        studentId: studentId,
        studentName: studentName,
        fromDate: fromDate,
        toDate: toDate,
        days: days,
        month: new Date(fromDate).getMonth(),
        year: new Date(fromDate).getFullYear(),
        reason: reason,
        status: 'pending',
        submittedBy: submittedBy,
        submittedAt: Date.now()
      };

      // Save to Firebase
      const leavePath = getLeaveApplicationsPath();

      if (!leavePath) {
        showAlert('Cannot save leave: division context incomplete', 'danger');
        return;
      }

      try {
        if (useCloud && firebaseDB) {
          await firebaseDB.ref(`${leavePath}/${leaveId}`).set(leaveData);
          console.log(`‚úÖ Leave application submitted: ${leaveId}`);
        } else {
          // Fallback to IndexedDB
          const allLeaves = await loadFromDatabase('leaveApplications') || {};
          allLeaves[leaveId] = leaveData;
          await saveToDatabase('leaveApplications', allLeaves);
        }

        // Close modal
        if (leaveModal) {
          leaveModal.hide();
        }

        // Reset form
        resetLeaveForm();



        showAlert(`Leave application submitted for ${studentName} (${days.length} days)`, 'success');

      } catch (error) {
        console.error('Error submitting leave:', error);
        showAlert('Failed to submit leave application. Please try again.', 'danger');
      }
    }

    // ===== RESET FORM =====

    function resetLeaveForm() {
      document.getElementById('leaveStudentSelect').value = '';
      document.getElementById('leaveStudentSelect').disabled = false;
      document.getElementById('leaveFromDate').value = '';
      document.getElementById('leaveToDate').value = '';
      document.getElementById('leaveReason').value = '';
      document.getElementById('leaveDayCountAlert').style.display = 'none';
      document.getElementById('leaveValidationAlert').style.display = 'none';
      const lockedMsg = document.getElementById('leaveStudentLocked');
      if (lockedMsg) {
        lockedMsg.remove();
      }
    }
    // ===== AUTO-MARK ATTENDANCE AS "ON LEAVE" =====

    async function markDaysAsOnLeave(leave) {
      const year = appState.selectedYear;
      const dept = appState.selectedDepartment;
      const course = appState.selectedCourse;
      const academicYear = appState.selectedAcademicYear;
      const division = appState.selectedDivision;

      if (!year || !dept || !course || !academicYear || !division) {
        console.error('Cannot mark attendance: division context incomplete');
        return;
      }

      // Get all subjects for this division
      const subjects = getCurrentSubjects();

      if (subjects.length === 0) {
        console.warn('No subjects found for division');
        return;
      }

      const monthKey = `${leave.year}-${String(leave.month + 1).padStart(2, '0')}`;

      console.log(`üîÑ Marking ${leave.days.length} days as "On Leave" for ${subjects.length} subjects...`);

      for (const subject of subjects) {
        const attendancePath = `mainSystem/attendanceData/${year}/${dept}/${course}/${academicYear}/${division}/months/${monthKey}/subjects/${subject}/attendance/${leave.studentId}`;

        try {
          // Check if student exists in this subject
          if (useCloud && firebaseDB) {
            const studentSnapshot = await firebaseDB.ref(attendancePath).once('value');
            const studentData = studentSnapshot.val();

            if (!studentData) {
              console.warn(`Student ${leave.studentId} not found in subject ${subject} - skipping`);
              continue;
            }

            // Mark each day as "On Leave"
            const updates = {};
            leave.days.forEach(day => {
              updates[day] = 'On Leave';
            });

            await firebaseDB.ref(attendancePath).update(updates);
            console.log(`‚úÖ Marked ${leave.days.length} days as "On Leave" in ${subject}`);

          } else {
            // Fallback: Update local attendance data
            if (appState.attendanceData?.[year]?.[dept]?.[course]?.[academicYear]?.[division]?.months?.[monthKey]?.subjects?.[subject]?.attendance?.[leave.studentId]) {
              const studentAttendance = appState.attendanceData[year][dept][course][academicYear][division].months[monthKey].subjects[subject].attendance[leave.studentId];

              leave.days.forEach(day => {
                studentAttendance[day] = 'On Leave';
              });

              await saveAllData();
            }
          }

        } catch (error) {
          console.error(`Error marking attendance for subject ${subject}:`, error);
        }
      }

      console.log(`‚úÖ Completed marking attendance as "On Leave"`);
    }


    // ===== GET LEAVE INFO FOR STUDENT (for displaying in defaulter list) =====

    function getStudentLeaveInfo(studentId) {
      if (!appState.selectedMonth || !appState.selectedYear) {
        return null;
      }

      const approvedLeaves = leaveState.applications.filter(leave =>
        leave.status === 'approved' &&
        leave.studentId === studentId &&
        leave.month === appState.selectedMonth &&
        leave.year === appState.selectedYear
      );

      if (approvedLeaves.length === 0) {
        return null;
      }

      // Combine all approved leave days
      const totalLeaveDays = new Set();
      const reasons = [];

      approvedLeaves.forEach(leave => {
        leave.days.forEach(day => totalLeaveDays.add(day));
        if (!reasons.includes(leave.reason)) {
          reasons.push(leave.reason);
        }
      });

      return {
        count: totalLeaveDays.size,
        reasons: reasons,
        applications: approvedLeaves
      };
    }

    // ===== GET APPROVED LEAVES FOR STUDENT (Current Month) =====

    function getApprovedLeavesForStudent(studentId) {
      if (!appState.selectedMonth || !appState.selectedYear) {
        return [];
      }

      return leaveState.applications.filter(leave =>
        leave.status === 'approved' &&
        leave.studentId === studentId &&
        leave.month === appState.selectedMonth &&
        leave.year === appState.selectedYear
      );
    }

    // ===== GET LEAVE SUMMARY FOR STUDENT =====

    function getStudentLeaveSummary(studentId) {
      if (!appState.selectedMonth || !appState.selectedYear) {
        return null;
      }

      // ‚úÖ CHANGED: Filter from leaveState.applications (array) instead of object
      const approvedLeaves = leaveState.applications.filter(leave =>
        leave.status === 'approved' &&
        leave.studentId === studentId &&
        leave.month === appState.selectedMonth &&
        leave.year === appState.selectedYear
      );

      if (approvedLeaves.length === 0) {
        return null;
      }

      // Combine all approved leave days
      const totalLeaveDays = new Set();
      const reasons = [];

      approvedLeaves.forEach(leave => {
        leave.days.forEach(day => totalLeaveDays.add(day));

        // Get first 20 chars of reason
        const shortReason = leave.reason.substring(0, 20) + (leave.reason.length > 20 ? '...' : '');
        if (!reasons.includes(shortReason)) {
          reasons.push(shortReason);
        }
      });

      return {
        count: totalLeaveDays.size,
        days: Array.from(totalLeaveDays).sort((a, b) => a - b),
        reasons: reasons.join(', '),
        applications: approvedLeaves.length
      };
    }

    // ==================== ADD THESE FUNCTIONS TO YOUR MAIN HTML FILE ====================
    // Add after line 1380 (after getStudentLeaveSummary function)

    /**
     * Load leave applications from Firebase/IndexedDB
     */
    async function loadLeaveApplications() {
      const leavePath = getLeaveApplicationsPath();

      if (!leavePath) {
        console.warn('Cannot load leaves: division context incomplete');
        leaveState.applications = {};
        return;
      }

      try {
        if (useCloud && firebaseDB) {
          // Load from Firebase
          const snapshot = await firebaseDB.ref(leavePath).once('value');
          const cloudLeaves = snapshot.val() || {};

          // Convert to array format
          leaveState.applications = Object.keys(cloudLeaves).map(key => ({
            id: key,
            ...cloudLeaves[key]
          }));

          console.log(`‚úÖ Loaded ${leaveState.applications.length} leave applications from Firebase`);

        } else {
          // Fallback to IndexedDB
          const localLeaves = await loadFromDatabase('leaveApplications') || {};

          leaveState.applications = Object.keys(localLeaves).map(key => ({
            id: key,
            ...localLeaves[key]
          }));

          console.log(`‚úÖ Loaded ${leaveState.applications.length} leave applications from IndexedDB`);
        }

      } catch (error) {
        console.error('Error loading leave applications:', error);
        leaveState.applications = [];
      }
    }

    /**
     * Get leave applications for current student (for student view)
     */
    async function getMyLeaveApplications() {
      try {
        const role = await getUserRole();

        if (role !== 'student') {
          return [];
        }

        const attributes = await getUserAttributes();
        const studentId = attributes['custom:studentId'];

        if (!studentId) {
          console.warn('Student ID not found in attributes');
          return [];
        }

        // Filter leaves for current student
        return leaveState.applications.filter(leave =>
          leave.studentId === studentId
        );

      } catch (error) {
        console.error('Error getting student leaves:', error);
        return [];
      }
    }
    /**
     * Display leave status in UI (for students)
     */
    async function displayMyLeaveStatus() {
      try {
        const role = await getUserRole();

        if (role !== 'student') {
          return;
        }

        // ‚úÖ FORCE FRESH RELOAD FROM FIREBASE (not from leaveState cache)
        const leavePath = getLeaveApplicationsPath();
        if (!leavePath) {
          console.warn('Cannot load leaves: division context incomplete');
          return;
        }

        let myLeaves = [];

        if (useCloud && firebaseDB) {
          const snapshot = await firebaseDB.ref(leavePath).once('value');
          const allLeaves = snapshot.val() || {};

          const attributes = await getUserAttributes();
          const studentId = attributes['custom:studentId'];

          // Filter for this student
          myLeaves = Object.keys(allLeaves)
            .map(key => ({ id: key, ...allLeaves[key] }))
            .filter(leave => leave.studentId === studentId);

        } else {
          // Fallback to getMyLeaveApplications
          myLeaves = await getMyLeaveApplications();
        }

        // ‚úÖ CREATE/UPDATE SECTION REGARDLESS OF WHETHER THERE ARE LEAVES
        let leaveStatusSection = document.getElementById('studentLeaveStatus');

        if (!leaveStatusSection) {
          const statsSection = document.getElementById('stats-section');

          if (statsSection) {
            leaveStatusSection = document.createElement('div');
            leaveStatusSection.id = 'studentLeaveStatus';
            leaveStatusSection.className = 'section-card mb-4';
            statsSection.insertAdjacentElement('afterend', leaveStatusSection);
          }
        }

        if (!leaveStatusSection) return;

        // ‚úÖ BUILD HTML - SHOW EMPTY STATE IF NO LEAVES
        let html = `
      <h4 class="section-title">
        <i class="bi bi-calendar-x me-2"></i>My Leave Applications
      </h4>
    `;

        if (myLeaves.length === 0) {
          // ‚úÖ SHOW EMPTY STATE INSTEAD OF REMOVING SECTION
          html += `
        <div class="alert alert-info mb-0">
          <i class="bi bi-info-circle me-2"></i>
          <strong>No leave applications yet.</strong>
          <p class="mb-0 mt-2">You haven't submitted any leave applications for this division. Click "Submit New Leave" button above to create one.</p>
        </div>
      `;
        } else {
          // ‚úÖ SHOW TABLE WITH LEAVE APPLICATIONS
          html += `
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Date Range</th>
                <th>Days</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Submitted</th>
              </tr>
            </thead>
            <tbody>
      `;

          // Sort by submission date (newest first)
          myLeaves.sort((a, b) => b.submittedAt - a.submittedAt);

          myLeaves.forEach(leave => {
            const fromDate = new Date(leave.fromDate).toLocaleDateString();
            const toDate = new Date(leave.toDate).toLocaleDateString();
            const submittedDate = new Date(leave.submittedAt).toLocaleDateString();

            let statusBadge = '';
            if (leave.status === 'pending') {
              statusBadge = '<span class="badge bg-warning text-dark">‚è≥ Pending</span>';
            } else if (leave.status === 'approved') {
              statusBadge = '<span class="badge bg-success">‚úÖ Approved</span>';
            } else if (leave.status === 'rejected') {
              statusBadge = '<span class="badge bg-danger">‚ùå Rejected</span>';
            }

            html += `
          <tr class="leave-row-${leave.status}">
            <td>${fromDate} - ${toDate}</td>
            <td>${leave.days.length} day(s)</td>
            <td>${escapeHtml(leave.reason)}</td>
            <td>${statusBadge}</td>
            <td>${submittedDate}</td>
          </tr>
        `;
          });

          html += `
            </tbody>
          </table>
        </div>
        <div class="alert alert-info mb-0">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Total Applications:</strong> ${myLeaves.length} |
          <strong>Pending:</strong> ${myLeaves.filter(l => l.status === 'pending').length} |
          <strong>Approved:</strong> ${myLeaves.filter(l => l.status === 'approved').length} |
          <strong>Rejected:</strong> ${myLeaves.filter(l => l.status === 'rejected').length}
        </div>
        <br> 
      `;
        }
         html += `
         <br>
      <div class="row">
        <div class="col-md-6 col-lg-4">
          <button class="btn btn-primary w-100" id="studentOpenLeaveFormBtn">
        <i class="bi bi-plus-circle me-1"></i>Submit New Leave
      </button>
        </div>
      </div>
    `;

        leaveStatusSection.innerHTML = html;

        // ‚úÖ ATTACH EVENT LISTENER AFTER RENDERING
        const studentLeaveBtn = document.getElementById('studentOpenLeaveFormBtn');
        if (studentLeaveBtn) {
          studentLeaveBtn.addEventListener('click', async () => {
            const validation = validateDivisionContext();
            if (!validation.valid) {
              showAlert(`Please select: ${validation.missing.join(', ')} before submitting leave applications!`, 'warning');
              return;
            }
            resetLeaveForm();
            const role = await getUserRole();
            const attributes = await getUserAttributes();
            if (role === 'student') {
              const studentId = attributes['custom:studentId'];
              if (!studentId) {
                showAlert('Your student ID is not configured. Please contact admin.', 'danger');
                return;
              }
              const studentSelect = document.getElementById('leaveStudentSelect');
              studentSelect.innerHTML = '';
              const currentStudent = appState.studentList.find(s => s.id === studentId);
              const studentName = currentStudent ? currentStudent.name : 'You';
              const option = document.createElement('option');
              option.value = studentId;
              option.textContent = `${studentId} - ${studentName}`;
              option.selected = true;
              studentSelect.appendChild(option);
              studentSelect.disabled = true;
              const selectContainer = studentSelect.parentElement;
              const lockedMsg = document.createElement('small');
              lockedMsg.className = 'text-info d-block mt-1';
              lockedMsg.id = 'leaveStudentLocked';
              lockedMsg.innerHTML = '<i class="bi bi-lock me-1"></i>You can only submit leave for yourself';
              selectContainer.appendChild(lockedMsg);
            } else {
              await loadStudentsForLeaveForm();
            }
            const year = appState.selectedYear;
            const month = appState.selectedMonth;
            if (month !== null && year !== null) {
              const firstDay = new Date(year, month, 1);
              const lastDay = new Date(year, month + 1, 0);
              const fromInput = document.getElementById('leaveFromDate');
              const toInput = document.getElementById('leaveToDate');
              fromInput.min = formatDateForInput(firstDay);
              fromInput.max = formatDateForInput(lastDay);
              toInput.min = formatDateForInput(firstDay);
              toInput.max = formatDateForInput(lastDay);
              if (appState.currentDay) {
                const currentDate = new Date(year, month, appState.currentDay);
                fromInput.value = formatDateForInput(currentDate);
                toInput.value = formatDateForInput(currentDate);
                updateLeaveDayCount();
              }
            }
            if (!leaveModal) {
              leaveModal = new bootstrap.Modal(document.getElementById('leaveModal'));
            }
            leaveModal.show();
          });
        }

        console.log(`‚úÖ Displayed leave status for student (${myLeaves.length} applications)`);

      } catch (error) {
        console.error('Error displaying leave status:', error);
      }
      
    }
    /**
     * Real-time listener for leave updates (for students)
     */
    let leaveListenerRefs = []; // ‚úÖ Track listener references

    function setupLeaveStatusListener() {
      // ‚úÖ FIRST: Remove old listeners
      if (leaveListenerRefs.length > 0) {
        leaveListenerRefs.forEach(ref => {
          firebaseDB.ref(ref.path).off(ref.event);
        });
        leaveListenerRefs = [];
        console.log('üîå Disconnected old leave listeners');
      }

      if (!useCloud || !firebaseDB) {
        return;
      }

      const leavePath = getLeaveApplicationsPath();
      if (!leavePath) {
        return;
      }

      console.log('üì° Setting up NEW listener on:', leavePath);

      // ‚úÖ Listen for deletions
      const onRemove = async (snapshot) => {
        console.log('üî• DELETED:', snapshot.key);
        await loadLeaveApplications();

        const role = await getUserRole();
        if (role === 'student') {
          await displayMyLeaveStatus();
        }
      };
      firebaseDB.ref(leavePath).on('child_removed', onRemove);
      leaveListenerRefs.push({ path: leavePath, event: 'child_removed' });

      // ‚úÖ Listen for additions
      const onAdd = async (snapshot) => {
        console.log('üî• ADDED:', snapshot.key);
        await loadLeaveApplications();

        const role = await getUserRole();
        if (role === 'student') {
          await displayMyLeaveStatus();
        }
      };
      firebaseDB.ref(leavePath).on('child_added', onAdd);
      leaveListenerRefs.push({ path: leavePath, event: 'child_added' });

      // ‚úÖ Listen for changes
      const onChange = async (snapshot) => {
        console.log('üî• CHANGED:', snapshot.key);
        await loadLeaveApplications();

        const role = await getUserRole();
        if (role === 'student') {
          await displayMyLeaveStatus();
        }
      };
      firebaseDB.ref(leavePath).on('child_changed', onChange);
      leaveListenerRefs.push({ path: leavePath, event: 'child_changed' });

      console.log('‚úÖ Leave listeners ACTIVE on:', leavePath);
    }
    // ==================== MODIFICATIONS TO EXISTING FUNCTIONS ====================

    // MODIFY the initialize() function - ADD THESE LINES after loadAllData():
    /*
    async function initialize() {
      try {
        await initFirebase();
        await openDatabase();
        await loadAllData();
        
        // ‚úÖ ADD THESE 3 LINES:
        await loadLeaveApplications();
        await displayMyLeaveStatus();
        setupLeaveStatusListener();
        
        populateYearDropdown();
        // ... rest of existing code
    */

    // MODIFY getStudentLeaveSummary() - REPLACE ENTIRE FUNCTION:
    /*
    function getStudentLeaveSummary(studentId) {
      if (!appState.selectedMonth || !appState.selectedYear) {
        return null;
      }
    
      // ‚úÖ CHANGED: Filter from leaveState.applications (array) instead of object
      const approvedLeaves = leaveState.applications.filter(leave =>
        leave.status === 'approved' &&
        leave.studentId === studentId &&
        leave.month === appState.selectedMonth &&
        leave.year === appState.selectedYear
      );
    
      if (approvedLeaves.length === 0) {
        return null;
      }
    
      // Combine all approved leave days
      const totalLeaveDays = new Set();
      const reasons = [];
    
      approvedLeaves.forEach(leave => {
        leave.days.forEach(day => totalLeaveDays.add(day));
        
        // Get first 20 chars of reason
        const shortReason = leave.reason.substring(0, 20) + (leave.reason.length > 20 ? '...' : '');
        if (!reasons.includes(shortReason)) {
          reasons.push(shortReason);
        }
      });
    
      return {
        count: totalLeaveDays.size,
        days: Array.from(totalLeaveDays).sort((a, b) => a - b),
        reasons: reasons.join(', '),
        applications: approvedLeaves.length
      };
    }
    */

    // MODIFY getApprovedLeavesForStudent() - REPLACE ENTIRE FUNCTION:
    /*
    function getApprovedLeavesForStudent(studentId) {
      if (!appState.selectedMonth || !appState.selectedYear) {
        return [];
      }
    
      // ‚úÖ CHANGED: Filter from array instead of object
      return leaveState.applications.filter(leave =>
        leave.status === 'approved' &&
        leave.studentId === studentId &&
        leave.month === appState.selectedMonth &&
        leave.year === appState.selectedYear
      );
    }
    */
    function renderAttendanceTable(students) {
      if (!students || students.length === 0) {
        elements.attendanceTableBody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted py-5">
          <i class="bi bi-inbox fs-1"></i>
          <p class="mt-2">No students found. Upload a CSV file to get started.</p>
        </td>
      </tr>
    `;
        return;
      }

      const isHolidayToday = isHoliday(appState.currentDay);
      const threshold = appState.threshold;

      elements.attendanceTableBody.innerHTML = '';

      students.forEach(student => {
        const stats = getStudentStats(student.id);
        const isDefaulter = stats.percentage < threshold;

        // ‚úÖ CHECK IF STUDENT HAS APPROVED LEAVE
        const leaveSummary = getStudentLeaveSummary(student.id);
        const hasLeaveToday = leaveSummary && leaveSummary.days.includes(appState.currentDay);

        const row = document.createElement('tr');
        row.className = student.status === 'Present' ? 'present' : 'absent';

        row.innerHTML = `
      <td><strong>${escapeHtml(student.id)}</strong></td>
      <td>${escapeHtml(student.name)}</td>
      <td>
        <span class="badge ${student.status === 'Present' ? 'bg-success' : 'bg-danger'}">
          ${student.status}
        </span>
        ${isHolidayToday ? '<span class="holiday-badge ms-1">Holiday</span>' : ''}
        ${hasLeaveToday ? '<span class="badge bg-info ms-1" title="Approved leave application exists for today">üìù Leave App</span>' : ''}
      </td>
      <td>
        ${stats.present}/${stats.workingDays} days
        <span class="${isDefaulter ? 'defaulter-badge' : 'good-badge'} ms-2">
          ${stats.percentage}%
        </span>
        ${leaveSummary ? `<br><small class="text-muted">üìù ${leaveSummary.applications} leave app(s) - ${leaveSummary.count} days</small>` : ''}
      </td>
      <td class="teacher-only">
        <button class="btn btn-sm btn-outline-success mark-present-btn" 
          data-id="${escapeHtml(student.id)}" 
          ${isHolidayToday ? 'disabled' : ''}>
          <i class="bi bi-check"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger mark-absent-btn" 
          data-id="${escapeHtml(student.id)}" 
          ${isHolidayToday ? 'disabled' : ''}>
          <i class="bi bi-x"></i>
        </button>
      </td>
    `;

        elements.attendanceTableBody.appendChild(row);
      });

      // Add event listeners for mark buttons
      document.querySelectorAll('.mark-present-btn').forEach(btn => {
        btn.addEventListener('click', () => markAttendance(btn.dataset.id, 'Present'));
      });

      document.querySelectorAll('.mark-absent-btn').forEach(btn => {
        btn.addEventListener('click', () => markAttendance(btn.dataset.id, 'Absent'));
      });
    }


    // ==================== INITIALIZATION ====================
    async function initialize() {
      try {
        // Initialize Firebase
        await initFirebase();


        // Open database
        await openDatabase();

        // Load saved data
        await loadAllData();
        await loadLeaveApplications();
        await displayMyLeaveStatus();
        setupLeaveStatusListener();
        if (appState.selectedAcademicYear) {
          elements.academicYearLevelSelect.value = appState.selectedAcademicYear;
        }
        if (appState.selectedDivision) {
          elements.divisionSelect.value = appState.selectedDivision;
        }
        // Populate year dropdown
        populateYearDropdown();

        populateDepartmentDropdown();
        renderDepartmentTags();
        if (appState.selectedDepartment) {
          populateCourseDropdown();
          renderCourseTags();
        }

        // ‚úÖ Populate subjects BEFORE calling updateFinalSelectionDropdowns
        populateSubjectDropdown();
        renderSubjectTags();

        updateDepartmentDisplay();
        updateCourseDisplay();
        updateAcademicYearDisplay();
        updateSubjectDisplay();
        updateFinalSelectionDropdowns();

        // Set current month/year as default
        const now = new Date();
        if (appState.selectedMonth === null) {
          elements.monthSelect.value = now.getMonth();
        } else {
          elements.monthSelect.value = appState.selectedMonth;
        }

        if (appState.selectedYear === null) {
          elements.yearSelect.value = now.getFullYear();
        } else {
          elements.yearSelect.value = appState.selectedYear;
        }

        // Update threshold input
        elements.thresholdInput.value = appState.threshold;

        // Populate subject dropdown and tags
        populateSubjectDropdown();
        renderSubjectTags();
        updateSubjectDisplay();

        // If month was selected, restore calendar
        if (appState.selectedMonth !== null && appState.selectedYear !== null) {
          appState.daysInMonth = getDaysInMonth(appState.selectedMonth, appState.selectedYear);
          updateMonthDisplay();
          populateDayDropdown();
          renderCalendarGrid();
          updateHolidayDisplay();
          elements.calendarContainer.style.display = 'block';
          refreshAttendanceTable();
        }

        // Initialize event listeners
        initializeEventListeners();

        // Update stats
        updateStats();
        updateDefaulterCount();

        console.log('Application initialized successfully');


        // ‚úÖ ADD REAL-TIME SYNC HERE
        if (useCloud && firebaseDB) {
          setupRealtimeSync();
        }

        // Apply role-based UI
        await applyRoleBasedUI();
        await setupAdminSectionNavigation();
      } catch (error) {
        console.error('Initialization error:', error);
        showAlert('Failed to initialize application. Please refresh the page.', 'danger');
      }
    }

    // ==================== REAL-TIME SYNC ====================
    function setupRealtimeSync() {
      firebaseDB.ref('mainSystem/attendanceData').on('value', (snapshot) => {
        const cloudData = snapshot.val();

        if (cloudData && JSON.stringify(cloudData) !== JSON.stringify(appState.attendanceData)) {
          console.log('üì° Attendance data updated from cloud');
          appState.attendanceData = cloudData;
          // refreshAttendanceTable();
          // updateStats();

          // Show notification
          const notification = document.createElement('div');
          notification.className = 'alert alert-info position-fixed top-0 end-0 m-3';
          notification.style.zIndex = '9999';
          notification.innerHTML = '<i class="bi bi-cloud-arrow-down me-2"></i>Attendance synced from cloud';
          document.body.appendChild(notification);

          setTimeout(() => notification.remove(), 3000);
        }
      });

      console.log('üì° Real-time sync enabled');
    }

    // ==================== ADMIN TWO-SECTION NAVIGATION ====================

async function setupAdminSectionNavigation() {
  try {
    const role = await getUserRole();

    const configSection = document.getElementById('adminConfigSection');
    const attendanceSection = document.getElementById('adminAttendanceSection');
    const continueBtn = document.getElementById('adminContinueBtn');
    const backBtn = document.getElementById('adminBackBtn');

    if (role === 'admin') {
      // Show continue button for admins
      continueBtn.style.display = 'block';
      backBtn.style.display = 'block';

      // Initially show only config section
      showAdminConfigSection();

      // Continue button click
      continueBtn.addEventListener('click', () => {
        showAdminAttendanceSection();
        
        // Scroll to top of attendance section
        attendanceSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });

      // Back button click
      backBtn.addEventListener('click', () => {
        showAdminConfigSection();
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

    } else if (role === 'teacher') {
      // Teachers see everything normally
      configSection.style.display = 'block';
      attendanceSection.style.display = 'block';
      continueBtn.style.display = 'none';
      backBtn.style.display = 'none';
    }

  } catch (error) {
    console.error('Error setting up admin navigation:', error);
  }
}

function showAdminConfigSection() {
  const configSection = document.getElementById('adminConfigSection');
  const attendanceSection = document.getElementById('adminAttendanceSection');

  configSection.style.display = 'block';
  attendanceSection.style.display = 'none';

  // ‚úÖ Show/Hide navbar links
  document.querySelectorAll('.admin-config-nav').forEach(el => {
    el.style.display = 'block';
  });
  document.querySelectorAll('.admin-attendance-nav').forEach(el => {
    el.style.display = 'none';
  });

  console.log('üìã Showing Admin Config Section (with config navbar)');
}

function showAdminAttendanceSection() {
  const configSection = document.getElementById('adminConfigSection');
  const attendanceSection = document.getElementById('adminAttendanceSection');

  configSection.style.display = 'none';
  attendanceSection.style.display = 'block';

  // ‚úÖ Show/Hide navbar links
  document.querySelectorAll('.admin-config-nav').forEach(el => {
    el.style.display = 'none';
  });
  document.querySelectorAll('.admin-attendance-nav').forEach(el => {
    el.style.display = 'block';
  });

  console.log('üìä Showing Admin Attendance Section (with attendance navbar)');
}

// Start the application
    initialize();
    //start>>>>>>>>>>
    let qrTimerInterval = null;
    let qrExpiryTimestamp = null; // ‚úÖ Track actual expiry time instead of countdown

    function startQRCountdown(seconds) {
      // Clear previous timer
      if (qrTimerInterval) {
        clearInterval(qrTimerInterval);
        qrTimerInterval = null;
      }

      // ‚úÖ Store the actual expiry timestamp (absolute time)
      qrExpiryTimestamp = Date.now() + (seconds * 1000);

      // Update immediately
      updateQRTimer();

      // ‚úÖ Update every second based on actual time remaining
      qrTimerInterval = setInterval(() => {
        updateQRTimer();
      }, 1000);
    }

    function updateQRTimer() {
      // ‚úÖ Calculate remaining time from actual expiry timestamp
      const remaining = Math.max(0, Math.floor((qrExpiryTimestamp - Date.now()) / 1000));

      const mins = Math.floor(remaining / 60);
      const secs = remaining % 60;

      const timerElement = document.getElementById('qrTimer');
      if (timerElement) {
        timerElement.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      const statusElement = document.getElementById('qrStatus');
      const qrContainer = document.getElementById('qrCodeContainer');

      if (remaining <= 0) {
        // ‚úÖ Actually expired
        clearInterval(qrTimerInterval);
        qrTimerInterval = null;
        qrExpiryTimestamp = null;

        if (statusElement) {
          statusElement.className = 'alert alert-danger mb-3';
          statusElement.innerHTML = '‚ö†Ô∏è EXPIRED - Click Generate QR again';
        }

        if (qrContainer) {
          qrContainer.style.opacity = '0.3';
        }

        // ‚úÖ Stop dynamic code rotation when expired
        stopDynamicCodeRotation();
      } else {
        // ‚úÖ Still valid - ensure proper styling
        if (statusElement) {
          statusElement.className = 'alert alert-success mb-3';
        }

        if (qrContainer) {
          qrContainer.style.opacity = '1';
        }
      }
    }

    function stopQRCountdown() {
      if (qrTimerInterval) {
        clearInterval(qrTimerInterval);
        qrTimerInterval = null;
      }
      qrExpiryTimestamp = null;
    }
    //end>>>>>>>>>>

    let dynamicCodeInterval = null;

    function generateDynamicCode() {
      const array = new Uint32Array(1);
      window.crypto.getRandomValues(array);
      return (array[0] % 10000).toString().padStart(4, '0');
    }

    function getRemainingSeconds() {
      const currentTime = Date.now();
      const remaining = 8 - Math.floor((currentTime % 8000) / 1000);
      return remaining;
    }

    function startDynamicCodeRotation() {
      if (dynamicCodeInterval) {
        clearInterval(dynamicCodeInterval);
      }

      const codeElement = document.getElementById('qrDynamicCode');
      const countdownElement = document.getElementById('qrCountdown');

      function update() {
        const now = Date.now();

        // Update code every 8 sec
        if (codeElement) {
          const windowIndex = Math.floor(now / 8000);
          if (!codeElement.dataset.window || codeElement.dataset.window != windowIndex) {
            codeElement.dataset.window = windowIndex;
            const newCode = generateDynamicCode();
            codeElement.textContent = newCode;

            // Save to Firebase
            if (useCloud && firebaseDB) {
              firebaseDB.ref('mainSystem/dynamicCode').set({
                code: newCode,
                timestamp: Date.now(),
                expiresAt: Date.now() + 8000
              });
            }
          }
        }

        // Update countdown every second
        if (countdownElement) {
          const remaining = 8 - Math.floor((now % 8000) / 1000);
          countdownElement.textContent = remaining + "s";
        }
      }

      update();
      dynamicCodeInterval = setInterval(update, 1000);
    }

    function stopDynamicCodeRotation() {
      if (dynamicCodeInterval) {
        clearInterval(dynamicCodeInterval);
        dynamicCodeInterval = null;
      }
      if (useCloud && firebaseDB) {
        firebaseDB.ref('mainSystem/dynamicCode').remove()
          .then(() => {
            console.log('‚úÖ Dynamic code cleared from Firebase');
          })
          .catch((error) => {
            console.error('‚ùå Failed to clear dynamic code:', error);
          });
      }
    }

    // Listen for refresh requests from face recognition system
    setupRefreshListener();

    function setupRefreshListener() {
      // Method 1: BroadcastChannel (modern browsers)
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('attendance-system');

        channel.onmessage = (event) => {
          if (event.data.type === 'REFRESH_REQUIRED' && event.data.source === 'face-recognition') {
            console.log('üì¢ Received refresh request from face recognition system');
            handleRefreshRequest();
          }
        };

        console.log('‚úÖ BroadcastChannel listener active');
      }

      // Method 2: Storage event (fallback for cross-tab communication)
      window.addEventListener('storage', (event) => {
        if (event.key === '_refreshRequired' && event.newValue) {
          console.log('üì¢ Detected refresh flag in storage');
          handleRefreshRequest();
        }
      });

      // Method 3: Periodic polling (fallback)
      setInterval(async () => {
        try {
          const refreshFlag = await loadFromDatabase('_refreshRequired');
          if (refreshFlag && refreshFlag.timestamp) {
            const timeSinceRefresh = Date.now() - refreshFlag.timestamp;
            // If refresh flag is recent (within last 5 seconds)
            if (timeSinceRefresh < 5000) {
              console.log('üì¢ Found recent refresh flag via polling');
              handleRefreshRequest();
              // Clear the flag
              await saveToDatabase('_refreshRequired', null);
            }
          }
        } catch (error) {
          // Silently ignore errors in polling
        }
      }, 2000); // Check every 2 seconds
    }

    async function handleRefreshRequest() {
      console.log('üîÑ Refreshing attendance data...');

      // Show notification to user
      const notification = document.createElement('div');
      notification.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
      notification.style.zIndex = '9999';
      notification.innerHTML = `
    <i class="bi bi-check-circle me-2"></i>
    <strong>Synced!</strong> Attendance updated from face recognition system.
  `;
      document.body.appendChild(notification);

      // Reload data from database
      await loadAllData();

      // Refresh the UI
      refreshAttendanceTable();
      updateStats();
      renderCalendarGrid();

      console.log('‚úÖ Data refreshed successfully');

      // Remove notification after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
  </script>
  <!-- Leave Application Modal -->
  <div class="modal fade" id="leaveModal" tabindex="-1" aria-labelledby="leaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <!-- Header -->
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <h5 class="modal-title" id="leaveModalLabel">
            <i class="bi bi-calendar-x me-2"></i>Submit Leave Application
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <!-- Body -->
        <div class="modal-body">

          <!-- Validation Alert -->
          <div id="leaveValidationAlert" class="alert alert-warning" style="display: none;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="leaveValidationMsg"></span>
          </div>

          <!-- Student Selection -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              Student <span class="text-danger">*</span>
            </label>
            <select id="leaveStudentSelect" class="form-select" required>
              <option value="">-- Select Student --</option>
            </select>
            <small class="text-muted">Select from students in current division</small>
          </div>

          <!-- Date Range -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">
                From Date <span class="text-danger">*</span>
              </label>
              <input type="date" id="leaveFromDate" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">
                To Date <span class="text-danger">*</span>
              </label>
              <input type="date" id="leaveToDate" class="form-control" required>
            </div>
          </div>

          <!-- Day Count Display -->
          <div class="alert alert-info mb-3" id="leaveDayCountAlert" style="display: none;">
            <i class="bi bi-calendar-check me-2"></i>
            <strong>Total Leave Days:</strong> <span id="totalLeaveDays">0</span> day(s)
            <div id="leaveDaysList" class="mt-1 small"></div>
          </div>

          <!-- Reason -->
          <div class="mb-3">
            <label class="form-label fw-bold">
              Reason <span class="text-danger">*</span>
            </label>
            <textarea id="leaveReason" class="form-control" rows="3"
              placeholder="e.g., Sick - High Fever, Family Emergency, Medical Appointment" required></textarea>
            <small class="text-muted">Please provide detailed reason for leave</small>
          </div>

        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Cancel
          </button>
          <button type="button" class="btn btn-primary" id="submitLeaveBtn">
            <i class="bi bi-check-circle me-1"></i>Submit Leave
          </button>
        </div>

      </div>
    </div>
  </div>
</body>

</html>