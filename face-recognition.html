<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face Recognition - Smart Attendance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">


  <!-- AWS Cognito SDK -->
  <script
    src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>
  <script src="cognito-config.js"></script>
  <script src="auth.js"></script>

  <!-- Firebase SDK (Add AFTER AWS Cognito, BEFORE face-api) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- Firebase Config -->
  <script src="firebase-config.js"></script>
  <!-- Cloud Storage -->
  <script src="cloud-storage.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    *::-webkit-scrollbar {
  display: none;
}

/* Hide scrollbar for IE, Edge and Firefox */
* {
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}
    .main-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
  background: linear-gradient(135deg, #E8C4D8 0%, #DDB8CC 100%);
  padding: 25px 30px;
  text-align: center;
  color: #6A4A5A;
}

.header h1 {
  font-weight: 700;
  margin: 0;
  letter-spacing: -0.5px;
}

    .content-area {
      padding: 30px;
    }

    .video-container {
      position: relative;
      background: #1a1a1a;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    #video {
      width: 100%;
      display: block;
      transform: scaleX(-1);
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      transform: scaleX(-1);
    }

    .mode-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
      border: 3px solid transparent;
      cursor: pointer;
    }

    .mode-card:hover {
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }

    .mode-card.active {
      background: linear-gradient(135deg, #FBF8FA 0%, #F7F0F5 100%);
    }

    .btn-face {
      border-radius: 25px;
      padding: 8px 20px;
      font-weight: 600;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .btn-face:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .status-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }

    .student-list {
      max-height: 400px;
      max-width: 100%;
      overflow-y: auto;
    }

    .student-card {
      max-width: 98%;
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s;
    }

    .student-card:hover {
      border-color: #E8C4D8;
      transform: translateX(5px);
    }

    .face-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #E8C4D8;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-content {
      text-align: center;
      color: white;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #E8C4D8;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .detection-box {
      position: absolute;
      border: 3px solid #00ff00;
      border-radius: 5px;
    }

    .detection-label {
      position: absolute;
      background: rgba(0, 255, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 3px;
      font-weight: 600;
      font-size: 14px;
    }

    .button-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .button-grid button {
      width: 100%;
      min-height: 40px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 15px;
      font-size: 0.85rem;
    }

    /* ✅ FIXED: Role-based visibility with proper specificity */
    .admin-only,
    .teacher-only {
      display: block;
    }

    .student-only {
      display: none;
    }

    /* For inline elements */
    .admin-only-inline,
    .teacher-only-inline {
      display: inline-block;
    }

    /* Responsive fixes */
    @media (max-width: 768px) {
      .main-card {
        margin: 10px;
      }

      .header h1 {
        font-size: 1.3rem;
      }

      .mode-card {
        padding: 15px;
      }

      .button-grid {
        grid-template-columns: 1fr;
      }

      .student-card {
        flex-direction: column;
        text-align: center;
      }

      .face-preview {
        margin: 0 auto;
      }
    }

    @media (max-width: 576px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 15px;
      }

      .header h1 {
        font-size: 1.1rem;
      }

      .content-area {
        padding: 15px;
      }

      .btn-face {
        font-size: 0.9rem;
        padding: 10px 20px;
      }

      .child-container {
        flex: 1 1 100% !important;
        min-width: 100%;
      }
    }

    /* ✅ FIXED: Proper flexbox layout with role support */
    .parent-container {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* Default layout (Admin/Teacher) - 60/40 split */
    .child-container {
      min-width: 280px;
      flex: 1 1 calc(40% - 7.5px);
      /* Default to smaller size */
    }

    /* First container (video) - 60% width */
    .child-container:nth-child(1) {
      flex: 1 1 calc(60% - 7.5px);
    }

    /* Third container (attendance) - 40% width */
    .child-container:nth-child(3) {
      flex: 1 1 calc(40% - 7.5px);
    }

    /* ✅ FIXED: Student role - proper layout with higher specificity */
    body.student-role .parent-container {
      /* Force 60/40 layout for only 2 containers */
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    /* Hide teacher-only containers completely */
    body.student-role .child-container:nth-child(2),
    body.student-role .child-container:nth-child(4) {
      display: none !important;
    }

    /* Make remaining containers fill properly */
    body.student-role .child-container:nth-child(1) {
      flex: 1 1 calc(60% - 7.5px) !important;
      max-width: calc(60% - 7.5px);
    }

    body.student-role .child-container:nth-child(3) {
      flex: 1 1 calc(40% - 7.5px) !important;
      max-width: calc(40% - 7.5px);
    }

    /* ✅ FIXED: Hide teacher/admin elements in student role */
    body.student-role .admin-only,
    body.student-role .teacher-only {
      display: none !important;
    }

    body.student-role .admin-only-inline,
    body.student-role .teacher-only-inline {
      display: none !important;
    }

    /* Bootstrap column width fix */
    .parent-container .child-container .col-11 {
      width: 100% !important;
      max-width: 100% !important;
      flex: none !important;
    }

    /* Adjust student list height for side-by-side */
    .parent-container .student-list {
      max-height: 400px;
    }

    /* Quick Stats height reduction */
    .row.mt-4 {
      margin-top: 1rem !important;
      margin-bottom: 0rem !important;
    }

    .row.mt-4 .text-center {
      padding: 10px !important;
    }

    .row.mt-4 h3 {
      font-size: 1.5rem !important;
      margin-bottom: 0.25rem !important;
    }

    .row.mt-4 small {
      font-size: 0.7rem;
    }

    /* Spacing above Main Dashboard button */
    .d-flex.justify-content-center {
      margin-top: 1.5rem;
    }

    /* Attendance blocks styling */
    .attendance-blocks {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 8px;
      margin-bottom: 10px;
    }

    .attendance-block {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
      min-height: 45px;
    }

    .attendance-block.present {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .attendance-block.absent {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .attendance-block:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Tooltip */
    .attendance-block .tooltip-text {
      visibility: hidden;
      background-color: rgba(0, 0, 0, 0.9);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px 12px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 12px;
      font-weight: normal;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .attendance-block .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
    }

    .attendance-block:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .attendance-blocks {
        grid-template-columns: repeat(8, 1fr);
      }
    }

    @media (max-width: 768px) {
      .attendance-blocks {
        grid-template-columns: repeat(5, 1fr);
      }

      .attendance-block {
        font-size: 14px;
        min-height: 40px;
      }

      /* ✅ FIXED: Student role stacks vertically on mobile */
      body.student-role .child-container:nth-child(1),
      body.student-role .child-container:nth-child(3) {
        flex: 1 1 100% !important;
        max-width: 100% !important;
      }
    }

    /* QR Scanner Overlay */
    .qr-scanner-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 10000;
      justify-content: center;
      align-items: center;
    }

    .qr-scanner-overlay.active {
      display: flex;
    }

    .qr-scanner-box {
      background: white;
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 450px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .qr-scanner-box h5 {
      color: #6A4A5A;
      margin-bottom: 15px;
    }

    #qr-video-container {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: #1a1a1a;
      margin-bottom: 15px;
    }

    #qr-video-container video {
      width: 100%;
      display: block;
    }

    #qrStatus {
      font-size: 0.85rem;
      color: #6A4A5A;
      margin-bottom: 15px;
      min-height: 20px;
    }

    .btn-close-qr {
      border-radius: 25px;
      padding: 8px 30px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* ===============================
   CONFIG DISPLAY CONTAINER
   =============================== */

    .config-display-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 15px 30px;
      border-bottom: 2px solid #dee2e6;
    }

    /* ===============================
   CONFIG CARD (FULL CLICKABLE)
   =============================== */

    .config-card {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    /* Hover Effect */
    .config-card:hover {
      box-shadow: 0 6px 25px rgba(102, 126, 234, 0.25);
      transform: translateY(-2px);
      border: 2px solid #667eea;
    }

    /* Click Ripple Effect */
    @keyframes ripple {
      0% {
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
      }

      100% {
        box-shadow: 0 0 0 20px rgba(102, 126, 234, 0);
      }
    }

    .config-card:active {
      animation: ripple 0.5s ease-out;
    }

    /* ===============================
   TITLE
   =============================== */

    .config-title {
      color: #6A4A5A;
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ===============================
   GRID LAYOUT
   =============================== */

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    /* ===============================
   GRID ITEMS
   =============================== */

    .config-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 0.85rem;
      transition: 0.2s ease;
    }

    .config-item:hover {
      background: #eef1ff;
    }

    .config-item i {
      color: #667eea;
      font-size: 1rem;
      margin-right: 6px;
    }

    .config-label {
      color: #6c757d;
      font-weight: 500;
      margin-right: 5px;
    }

    .config-value {
      color: #212529;
      font-weight: 600;
      margin-left: auto;
    }

    .config-value.not-set {
      color: #dc3545;
      font-style: italic;
    }

    /* ===============================
   TABLET RESPONSIVE
   =============================== */

    @media (max-width: 992px) {
      .config-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* ===============================
   MOBILE RESPONSIVE (COMPACT)
   =============================== */

    @media (max-width: 576px) {

      .config-display-container {
        padding: 10px 15px;
      }

      .config-card {
        padding: 14px;
        border-radius: 12px;
      }

      .config-title {
        font-size: 0.9rem;
      }

      .config-grid {
        grid-template-columns: repeat(1, 1fr);
        gap: 8px;
      }

      .config-item {
        font-size: 0.75rem;
        padding: 6px 8px;
      }

      .config-item i {
        font-size: 0.9rem;
      }

      /* ADD TO YOUR <style> SECTION */
      .section-card {
        background: #FFFEF9;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        padding: 20px;
        margin-bottom: 20px;
      }
    }

    /* ===============================
   SECURITY VERIFICATION SECTION - MINIMAL
   (Matches Current Configuration Style)
   =============================== */

/* Section Card Container */
#securityCodeSection.section-card {
  background: #ffffff;
  border-radius: 16px;
  padding: 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(0, 0, 0, 0.06);
  overflow: hidden;
}

/* Card Wrapper */
#securityCodeSection .card {
  border: none;
  background: transparent;
  box-shadow: none;
}

/* Card Header */
#securityCodeSection .card-header {
  background: #f8f9fa !important;
  border-bottom: 1px solid #e1e4e8;
  padding: 12px 20px;
}

#securityCodeSection .card-header h6 {
  color: #333333;
  font-weight: 600;
  font-size: 0.95rem;
  margin: 0;
}

#securityCodeSection .card-header i {
  color: #667eea;
}

/* Card Body */
#securityCodeSection .card-body {
  padding: 20px;
}

#securityCodeSection .card-body .text-muted {
  color: #666666 !important;
  font-size: 0.85rem;
  margin-bottom: 16px;
}

/* Security Code Input */
#securityCodeInput {
  height: 50px;
  background: #f8f9fa;
  border: 2px solid #e1e4e8 !important;
  border-radius: 10px;
  font-size: 1.5rem !important;
  font-weight: 600;
  letter-spacing: 0.8rem !important;
  text-align: center;
  color: #333333;
  transition: all 0.2s ease;
  padding-right: 50px !important;
}

#securityCodeInput::placeholder {
  color: #c8ccd0;
  letter-spacing: 0.6rem;
  font-size: 1.2rem;
}

#securityCodeInput:focus {
  outline: none;
  border-color: #667eea !important;
  background: #ffffff;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
}

/* Status Icons */
#codeLoadingSpinner,
#codeSuccessIcon {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
}

#codeSuccessIcon {
  font-size: 1.5rem;
}

/* Helper Text */
#securityCodeSection small.text-muted {
  color: #666666 !important;
  font-size: 0.75rem;
}

#securityCodeSection small i {
  font-size: 0.8rem;
  color: #667eea;
}

/* Validation Message */
#codeValidationMsg {
  padding: 10px 16px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 500;
  animation: slideDown 0.2s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#codeValidationMsg.alert-success {
  background: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
}

#codeValidationMsg.alert-danger {
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  color: #721c24;
}

/* Responsive */
@media (max-width: 768px) {
  #securityCodeSection.section-card {
    border-radius: 12px;
  }

  #securityCodeSection .card-header {
    padding: 10px 16px;
  }

  #securityCodeSection .card-header h6 {
    font-size: 0.9rem;
  }

  #securityCodeSection .card-body {
    padding: 16px;
  }

  #securityCodeInput {
    height: 45px;
    font-size: 1.3rem !important;
    letter-spacing: 0.6rem !important;
  }

  #securityCodeInput::placeholder {
    font-size: 1rem;
    letter-spacing: 0.5rem;
  }

  #securityCodeSection small.text-muted {
    font-size: 0.7rem;
  }
}

@media (max-width: 576px) {
  #securityCodeSection .card-body .row {
    margin: 0;
  }

  #securityCodeSection .card-body .col-md-6 {
    padding: 0;
  }

  #securityCodeInput {
    font-size: 1.2rem !important;
  }
}
  </style>
</head>

<body>

  <!-- ✅ Minimal Glass-Themed Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(248, 246, 244, 0.95);
    backdrop-filter: blur(10px);
    z-index: 99999;
    overflow: auto;
  ">
    <!-- Enhanced Navbar Skeleton -->
    <nav class="navbar navbar-dark bg-primary shadow-sm" style="
      background: linear-gradient(135deg, rgba(232, 196, 216, 0.8) 0%, rgba(221, 184, 204, 0.8) 100%) !important;
      backdrop-filter: blur(10px);
    ">
      <div class="container">
        <span class="navbar-brand" style="opacity: 0.5; color: #6A4A5A;">
          <i class="bi bi-camera-video me-2"></i>Face Recognition
        </span>
        <div class="skeleton-shimmer" style="
          width: 200px; 
          height: 30px; 
          background: rgba(106, 74, 90, 0.15); 
          border-radius: 6px;
          position: relative;
          overflow: hidden;
        ">
          <div class="shimmer-wave"></div>
        </div>
      </div>
    </nav>

    <!-- Config Section Skeleton -->
    <div style="
      background: rgba(248, 249, 250, 0.6);
      padding: 15px 30px;
      border-bottom: 1px solid rgba(222, 226, 230, 0.5);
      backdrop-filter: blur(5px);
    ">
      <div style="
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.5);
      ">
        <div class="skeleton-line mb-3" style="width: 200px; height: 20px;"></div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div class="skeleton-shimmer" style="
            height: 40px;
            border-radius: 8px;
            background: rgba(245, 245, 245, 0.6);
            position: relative;
            overflow: hidden;
          ">
            <div class="shimmer-wave"></div>
          </div>
          <div class="skeleton-shimmer" style="
            height: 40px;
            border-radius: 8px;
            background: rgba(245, 245, 245, 0.6);
            position: relative;
            overflow: hidden;
          ">
            <div class="shimmer-wave"></div>
          </div>
          <div class="skeleton-shimmer" style="
            height: 40px;
            border-radius: 8px;
            background: rgba(245, 245, 245, 0.6);
            position: relative;
            overflow: hidden;
          ">
            <div class="shimmer-wave"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="container py-4">
      <!-- Main Content Layout -->
      <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        
        <!-- Video Container Skeleton (60%) -->
        <div style="flex: 1 1 calc(60% - 7.5px); min-width: 280px;">
          <div class="card border-0" style="
            border-radius: 10px; 
            overflow: hidden;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.5);
          ">
            <!-- Video Area -->
            <div style="
              background: rgba(26, 26, 26, 0.8);
              backdrop-filter: blur(5px);
              height: 400px;
              position: relative;
              display: flex;
              align-items: center;
              justify-content: center;
            ">
              <div style="text-align: center; color: rgba(108, 117, 125, 0.5);">
                <i class="bi bi-camera-video" style="font-size: 4rem; opacity: 0.3;"></i>
                <div class="skeleton-line mt-3" style="width: 120px; height: 20px; margin: 0 auto;"></div>
              </div>
            </div>

            <div class="card-body">
              <!-- Button Skeleton -->
              <div class="skeleton-shimmer mb-3" style="
                height: 45px;
                border-radius: 25px;
                background: rgba(232, 232, 232, 0.6);
                position: relative;
                overflow: hidden;
              ">
                <div class="shimmer-wave"></div>
              </div>

              <!-- Stats Cards -->
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px;">
                <div class="card border-0 skeleton-card" style="
                  height: 80px;
                  border-radius: 10px;
                  background: rgba(255, 255, 255, 0.6);
                  backdrop-filter: blur(8px);
                  position: relative;
                  overflow: hidden;
                  border: 1px solid rgba(255, 255, 255, 0.4);
                ">
                  <div class="shimmer-wave"></div>
                  <div class="card-body text-center">
                    <div class="skeleton-line mb-2" style="width: 40px; height: 24px; margin: 0 auto;"></div>
                    <div class="skeleton-line" style="width: 60px; height: 14px; margin: 0 auto;"></div>
                  </div>
                </div>

                <div class="card border-0 skeleton-card" style="
                  height: 80px;
                  border-radius: 10px;
                  background: rgba(255, 255, 255, 0.6);
                  backdrop-filter: blur(8px);
                  position: relative;
                  overflow: hidden;
                  border: 1px solid rgba(255, 255, 255, 0.4);
                ">
                  <div class="shimmer-wave"></div>
                  <div class="card-body text-center">
                    <div class="skeleton-line mb-2" style="width: 40px; height: 24px; margin: 0 auto;"></div>
                    <div class="skeleton-line" style="width: 60px; height: 14px; margin: 0 auto;"></div>
                  </div>
                </div>

                <div class="card border-0 skeleton-card" style="
                  height: 80px;
                  border-radius: 10px;
                  background: rgba(255, 255, 255, 0.6);
                  backdrop-filter: blur(8px);
                  position: relative;
                  overflow: hidden;
                  border: 1px solid rgba(255, 255, 255, 0.4);
                ">
                  <div class="shimmer-wave"></div>
                  <div class="card-body text-center">
                    <div class="skeleton-line mb-2" style="width: 40px; height: 24px; margin: 0 auto;"></div>
                    <div class="skeleton-line" style="width: 60px; height: 14px; margin: 0 auto;"></div>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <div class="skeleton-shimmer" style="
                  height: 40px;
                  border-radius: 8px;
                  background: rgba(245, 245, 245, 0.6);
                  position: relative;
                  overflow: hidden;
                ">
                  <div class="shimmer-wave"></div>
                </div>
                <div class="skeleton-shimmer" style="
                  height: 40px;
                  border-radius: 8px;
                  background: rgba(245, 245, 245, 0.6);
                  position: relative;
                  overflow: hidden;
                ">
                  <div class="shimmer-wave"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Attendance Container Skeleton (40%) -->
        <div style="flex: 1 1 calc(40% - 7.5px); min-width: 280px;">
          <div class="card border-0" style="
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.5);
          ">
            <div class="card-body">
              <!-- Title -->
              <div class="skeleton-line mb-3" style="width: 180px; height: 20px;"></div>

              <!-- Present Blocks -->
              <div style="margin-bottom: 30px;">
                <div class="skeleton-line mb-2" style="width: 100px; height: 18px; background: rgba(16, 185, 129, 0.2);"></div>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                  <div class="skeleton-shimmer" style="
                    aspect-ratio: 1;
                    border-radius: 8px;
                    background: rgba(16, 185, 129, 0.15);
                    position: relative;
                    overflow: hidden;
                    min-height: 45px;
                  ">
                    <div class="shimmer-wave" style="background: linear-gradient(90deg, transparent 0%, rgba(16, 185, 129, 0.3) 50%, transparent 100%);"></div>
                  </div>
                  <div class="skeleton-shimmer" style="
                    aspect-ratio: 1;
                    border-radius: 8px;
                    background: rgba(16, 185, 129, 0.15);
                    position: relative;
                    overflow: hidden;
                    min-height: 45px;
                  ">
                    <div class="shimmer-wave" style="background: linear-gradient(90deg, transparent 0%, rgba(16, 185, 129, 0.3) 50%, transparent 100%);"></div>
                  </div>
                  <div class="skeleton-shimmer" style="
                    aspect-ratio: 1;
                    border-radius: 8px;
                    background: rgba(16, 185, 129, 0.15);
                    position: relative;
                    overflow: hidden;
                    min-height: 45px;
                  ">
                    <div class="shimmer-wave" style="background: linear-gradient(90deg, transparent 0%, rgba(16, 185, 129, 0.3) 50%, transparent 100%);"></div>
                  </div>
                </div>
              </div>

              <!-- Absent Blocks -->
              <div>
                <div class="skeleton-line mb-2" style="width: 100px; height: 18px; background: rgba(239, 68, 68, 0.2);"></div>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                  <div class="skeleton-shimmer" style="
                    aspect-ratio: 1;
                    border-radius: 8px;
                    background: rgba(239, 68, 68, 0.15);
                    position: relative;
                    overflow: hidden;
                    min-height: 45px;
                  ">
                    <div class="shimmer-wave" style="background: linear-gradient(90deg, transparent 0%, rgba(239, 68, 68, 0.3) 50%, transparent 100%);"></div>
                  </div>
                  <div class="skeleton-shimmer" style="
                    aspect-ratio: 1;
                    border-radius: 8px;
                    background: rgba(239, 68, 68, 0.15);
                    position: relative;
                    overflow: hidden;
                    min-height: 45px;
                  ">
                    <div class="shimmer-wave" style="background: linear-gradient(90deg, transparent 0%, rgba(239, 68, 68, 0.3) 50%, transparent 100%);"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Minimal Loading Message (No Progress Bar) -->
    <div style="
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(15px);
      padding: 18px 28px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.6);
      animation: fadeInUp 0.5s ease;
    ">
      <div class="d-flex align-items-center gap-3">
        <div style="
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: linear-gradient(135deg, rgba(232, 196, 216, 0.8) 0%, rgba(221, 184, 204, 0.8) 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          animation: rotate 2s linear infinite;
        ">
          <i class="bi bi-arrow-repeat" style="color: #6A4A5A;"></i>
        </div>
        <div>
          <div style="font-weight: 600; color: #2d3748; font-size: 0.9rem;">Loading AI Models</div>
          <div id="loadingStageText" style="color: #718096; font-size: 0.75rem;">Initializing...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Minimal Styles -->
<style>
/* Shimmer Wave Effect */
.shimmer-wave {
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.4) 50%,
    transparent 100%
  );
  animation: shimmerMove 2s infinite;
}

@keyframes shimmerMove {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Skeleton Lines */
.skeleton-line {
  background: rgba(224, 224, 224, 0.5);
  border-radius: 4px;
  animation: skeletonPulse 1.5s ease-in-out infinite;
}

@keyframes skeletonPulse {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 0.8; }
}

/* Skeleton Card Animation */
.skeleton-card {
  animation: fadeIn 0.6s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Loading Message Animation */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Rotate Animation */
@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Skeleton Shimmer */
.skeleton-shimmer {
  background: rgba(232, 232, 232, 0.5);
}
</style>

<!-- ✅ Simplified JavaScript (No Progress Bar) -->
<script>
// Update loading stage text only
function updateLoadingStage() {
  const stages = [
    'Loading face detection...',
    'Loading landmarks...',
    'Loading recognition...',
    'Processing neural networks...',
    'Almost ready...'
  ];
  
  let currentStage = 0;
  
  const interval = setInterval(() => {
    const stageText = document.getElementById('loadingStageText');
    
    if (stageText && currentStage < stages.length) {
      stageText.textContent = stages[currentStage];
      currentStage++;
    } else {
      clearInterval(interval);
    }
  }, 1200);
}

// Start when page loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', updateLoadingStage);
} else {
  updateLoadingStage();
}
</script>
  <div class="main-card">
    <!-- Header -->
    <div class="header">
  <div style="max-width: 600px; margin: 0 auto;">
    <div style="display: inline-flex; align-items: center; gap: 12px; background: rgba(255, 255, 255, 0.2); padding: 8px 20px; border-radius: 50px; margin-bottom: 10px;">
      <i class="bi bi-camera-video-fill" style="font-size: 1.5rem;"></i>
      <h1 style="margin: 0; font-size: 1.5rem;">Face Recognition</h1>
    </div>
    <p class="mb-0" style="font-size: 0.85rem; opacity: 0.9;">
      Automated attendance tracking
    </p>
  </div>
</div>

    <div class="main-card">
      <div class="config-display-container">
  <div class="config-card" id="configCard">
    <h6 class="config-title">
      <span>
        <i class="bi bi-gear-fill me-2"></i>Current Configuration
      </span>
      <span style="font-size: 0.75rem; color: #667eea; font-weight: 400;">
        <i class="bi bi-qr-code-scan me-1"></i>Click to Scan QR
      </span>
    </h6>
    <div class="config-grid">
      <!-- Field 1: Department - Academic year - Course - Div. -->
      <div class="config-item">
        <i class="bi bi-building me-1"></i>
        <span class="config-value" id="displayClassInfo">Not Set</span>
      </div>
      
      <!-- Field 2: Date: day - month - year -->
      <div class="config-item">
        <i class="bi bi-calendar-event me-1"></i>
        <span class="config-label">Date:</span>
        <span class="config-value" id="displayDate">Not Set</span>
      </div>
      
      <!-- Field 3: Subject -->
      <div class="config-item">
        <i class="bi bi-book me-1"></i>
        <span class="config-label">Subject:</span>
        <span class="config-value" id="displaySubject">Not Set</span>
      </div>
    </div>
  </div>
</div>

      <div class="content-area">
       <div id="securityCodeSection" class="section-card mb-4" style="display: none;">
  <div class="card">
    <div class="card-header bg-warning text-dark">
      <h6 class="mb-0">
        <i class="bi bi-shield-lock me-2"></i>Security Verification Required
      </h6>
    </div>
    <div class="card-body">
      <p class="text-muted mb-3">
        Enter the 4-digit security code displayed on the teacher's screen to unlock the camera.
      </p>
      <div class="row">
        <div class="col-md-6">
          <div class="position-relative">
            <input type="text" 
                   id="securityCodeInput" 
                   class="form-control form-control-lg text-center" 
                   placeholder="Enter 4-digit code" 
                   maxlength="4"
                   pattern="[0-9]{4}"
                   autocomplete="off"
                   style="font-size: 1.5rem; letter-spacing: 0.5rem; padding-right: 50px;">
            
            <!-- Loading spinner -->
            <div id="codeLoadingSpinner" style="display: none; position: absolute; right: 15px; top: 50%; transform: translateY(-50%);">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Verifying...</span>
              </div>
            </div>
            
            <!-- Success checkmark -->
            <div id="codeSuccessIcon" style="display: none; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #28a745; font-size: 1.5rem;">
              <i class="bi bi-check-circle-fill"></i>
            </div>
            
            <!-- Hidden button (functional but invisible) -->
            <button id="verifyCodeBtn" style="display: none;">Verify</button>
          </div>
          <small class="text-muted d-block mt-2">
            <i class="bi bi-info-circle me-1"></i>Code auto-verifies when you enter 4 digits
          </small>
          <div id="codeValidationMsg" class="mt-2" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>
</div>
        <div class="parent-container">
          <!-- Container 1: Video Feed (60% - Always visible) -->
          <div class="child-container">
            <div class="row">
              <div class="mode-card col-11">
                <div class="row">
                  <!-- Video Feed -->
                  <div class="video-container">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="canvas"></canvas>
                    <div id="statusBadge" class="status-badge bg-secondary">
                      <i class="bi bi-camera-video-off me-2"></i>Camera Off
                    </div>
                  </div>

                  <!-- Controls -->
                  <div class="d-grid gap-2">
                    <button id="startCameraBtn" class="btn btn-primary btn-face" disabled>
                      <i class="bi bi-camera-video me-2"></i>Start Camera
                    </button>
                    <button id="stopCameraBtn" class="btn btn-danger btn-face" style="display: none;">
                      <i class="bi bi-camera-video-off me-2"></i>Stop Camera
                    </button>
                  </div>

                  <!-- Quick Stats -->
                  <div class="row mt-4">
                    <div class="col-4">
                      <div class="text-center p-3 bg-light rounded">
                        <h3 class="text-primary mb-0" id="statRegistered">0</h3>
                        <small class="text-muted">Registered</small>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="text-center p-3 bg-light rounded">
                        <h3 class="text-success mb-0" id="statRecognized">0</h3>
                        <small class="text-muted">Recognized</small>
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="text-center p-3 bg-light rounded">
                        <h3 class="text-warning mb-0" id="statUnknown">0</h3>
                        <small class="text-muted">Unknown</small>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-center">
                    <button class="btn btn-primary w-100 mb-2" onclick="window.location.href='main-system.html'">
                      Main Dashboard
                    </button>
                    <br><br>

                  </div>

                  <div class="button-grid">
                    <button id="testConnectionBtn" class="btn btn-outline-info w-100 mb-2 admin-only-inline">
                      <i class="bi bi-plug me-2"></i>Test Main System Connection
                    </button>
                    <button id="refreshStatusBtn" class="btn btn-outline-secondary w-100 mb-2 admin-only-inline">
                      <i class="bi bi-arrow-clockwise me-2"></i>Refresh Status
                    </button>
                    <button id="syncToMainBtn" class="btn btn-success w-100 mb-2 teacher-only-inline">
                      <i class="bi bi-arrow-right-circle me-2"></i>Sync to Main System
                    </button>
                    <button id="clearAllFacesBtn" class="btn btn-outline-danger w-100 admin-only-inline">
                      <i class="bi bi-trash me-2"></i>Clear All Faces
                    </button>
                    <button id="forceReadBtn" class="btn btn-outline-info w-100 mb-2">
                      <i class="bi bi-arrow-clockwise me-2"></i>Force Read Firebase Now
                    </button>

                  </div>
                  <div><button id="scanQRBtn" class="btn btn-outline-primary w-100 mb-2">
                      <i class="bi bi-qr-code-scanning me-2"></i>Scan QR Code
                    </button></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Container 2: Mode Selection (40% - Teacher/Admin only) -->
          <div class="child-container teacher-only">
            <div class="mode-card">
              <!-- Mode Selection -->
              <h5 class="mb-3"><i class="bi bi-gear me-2"></i>Operation Mode</h5>
              <div class="mode-card" id="registerMode">
                <div class="d-flex align-items-center">
                  <i class="bi bi-person-plus-fill fs-1 text-primary me-3"></i>
                  <div>
                    <h5 class="mb-1">Register Face</h5>
                    <small class="text-muted">Capture and register student faces</small>
                  </div>
                </div>
                <div id="registerControls" style="display: none;" class="mt-3">
                  <div class="input-group mb-2">
                    <input type="text" id="studentIdInput" class="form-control" placeholder="Student ID">
                  </div>
                  <div class="input-group mb-2">
                    <input type="text" id="studentNameInput" class="form-control" placeholder="Student Name">
                  </div>
                  <button id="captureBtn" class="btn btn-success w-100" disabled>
                    <i class="bi bi-camera me-2"></i>Capture Face
                  </button>
                </div>
              </div>

              <div class="mode-card" id="recognitionMode">
                <div class="d-flex align-items-center">
                  <i class="bi bi-person-check-fill fs-1 text-success me-3"></i>
                  <div>
                    <h5 class="mb-1">Mark Attendance</h5>
                    <small class="text-muted">Recognize faces and mark attendance</small>
                  </div>
                </div>
                <div id="recognitionControls" style="display: none;" class="mt-3">
                  <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Face detection running. Stand in front of camera to mark attendance.
                  </div>
                  <button id="clearTodayBtn" class="btn btn-outline-warning btn-sm w-100">
                    <i class="bi bi-arrow-clockwise me-2"></i>Clear Today's Attendance
                  </button>
                </div>
              </div>
              <div>
                <div class="mode-card" id="bulkImportMode">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-folder-plus fs-1 text-info me-3"></i>
                    <div>
                      <h5 class="mb-1">Bulk Import</h5>
                      <small class="text-muted">Import multiple faces from folder</small>
                    </div>
                  </div>
                  <div id="bulkImportControls" style="display: none;" class="mt-3">
                    <div class="alert alert-warning">
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      <strong>Folder Structure Required:</strong><br>
                      Dataset/StudentID/image1.jpg<br>
                      Dataset/StudentID/image2.jpg
                    </div>
                    <input type="file" id="folderInput" webkitdirectory directory multiple class="form-control mb-3">
                    <div id="importPreview" style="display: none;" class="mb-3">
                      <div id="previewContent"></div>
                    </div>
                    <div class="d-grid gap-2">
                      <button id="startImportBtn" class="btn btn-primary" disabled>
                        <i class="bi bi-upload me-2"></i>Start Import
                      </button>
                      <button id="cancelImportBtn" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Container 3: Today's Attendance (40% - Always visible) -->
          <div class="child-container">
            <div class="mode-card">
              <h5 class="mb-3 mt-4">
                <i class="bi bi-grid-3x3 me-2"></i>Today's Attendance
                <span id="attendanceCount" class="badge bg-primary ms-2">0/0</span>
              </h5>

              <!-- Present Students Blocks -->
              <div class="mb-4">
                <h6 class="text-success mb-2">
                  <i class="bi bi-check-circle me-1"></i>PRESENT
                  <span id="presentCount" class="badge bg-success ms-1">0</span>
                </h6>
                <div id="presentBlocks" class="attendance-blocks">
                  <div class="text-center text-muted py-3">
                    <small>No students marked present</small>
                  </div>
                </div>
              </div>

              <!-- Absent Students Blocks -->
              <div>
                <h6 class="text-danger mb-2">
                  <i class="bi bi-x-circle me-1"></i>ABSENT
                  <span id="absentCount" class="badge bg-danger ms-1">0</span>
                </h6>
                <div id="absentBlocks" class="attendance-blocks">
                  <div class="text-center text-muted py-3">
                    <small>All students present</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Container 4: Registered Students (60% - Teacher/Admin only) -->
          <div class="child-container teacher-only">
            <div class="mode-card">
              <!-- Registered Students List -->
              <h5 class="mb-3 mt-4"><i class="bi bi-people me-2"></i>Registered Students</h5>
              <div class="student-list" id="studentList">
                <div class="text-center text-muted py-5">
                  <i class="bi bi-person-x fs-1"></i>
                  <p class="mt-2">No students registered yet</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Toast Notification -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
          <div id="toastNotification" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body"></div>
              <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        </div>

        <!-- Import Progress Modal -->
        <div id="importProgressModal"
          style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
          <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%;">
            <h4 class="text-center mb-4">Importing Faces...</h4>
            <div class="progress mb-3" style="height: 30px;">
              <div id="importProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                role="progressbar" style="width: 0%"></div>
            </div>
            <p id="importProgressText" class="text-center mb-2">Processing...</p>
            <p id="importProgressDetail" class="text-center text-muted"></p>
          </div>
        </div>

        <!-- Import Results Modal -->
        <div id="importResultsModal"
          style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
          <div
            style="background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h4 class="text-center mb-4">Import Results</h4>
            <div id="importResultsContent"></div>
            <button id="closeResultsBtn" class="btn btn-primary w-100 mt-3">Close</button>
          </div>
        </div>

        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
        <script src="face-storage.js"></script>
        <script src="face-recognition.js"></script>

        <script>
          // ==================== ROLE-BASED UI HIDING ====================
          async function applyRoleBasedUIForFaceRecognition() {
            try {
              const role = await getUserRole();
              console.log('Applying Face Recognition UI for role:', role);

              if (role === 'admin') {
                // Admin sees everything - no changes needed
                return;
              }

              if (role === 'teacher') {
                // Hide admin-only elements
                hideElements('.admin-only');
                hideElements('.admin-only-inline');

              } else if (role === 'student') {
                // ✅ FIXED: Add student-role class to body FIRST
                document.body.classList.add('student-role');

                // Then hide elements (CSS will handle the layout)
                hideElements('.admin-only');
                hideElements('.admin-only-inline');
                hideElements('.teacher-only');
                hideElements('.teacher-only-inline');

                // Hide delete buttons in student list
                hideDeleteButtonsForStudents();
              }

            } catch (error) {
              console.error('Error applying role-based UI:', error);
            }
          }

          function hideElements(selector) {
            document.querySelectorAll(selector).forEach(el => {
              el.style.display = 'none';
            });
          }

          function hideDeleteButtonsForStudents() {
            // Add CSS to hide delete buttons
            const style = document.createElement('style');
            style.id = 'student-role-style';
            style.textContent = `
            .student-card .btn-danger { display: none !important; }
          `;
            document.head.appendChild(style);

            // Also observe for dynamically added delete buttons
            const observer = new MutationObserver(() => {
              document.querySelectorAll('.student-card .btn-danger').forEach(btn => {
                btn.style.display = 'none';
              });
            });

            const studentList = document.getElementById('studentList');
            if (studentList) {
              observer.observe(studentList, { childList: true, subtree: true });
            }
          }

          // Add this function to update the simplified display
function updateConfigDisplay() {
  const config = JSON.parse(localStorage.getItem('attendanceConfig') || '{}');
  
  // Field 1: Department - Academic year - Course - Div.
  const classInfo = [
    config.department,
    config.academicYear,
    config.course,
    config.division
  ].filter(Boolean).join(' - ') || 'Not Set';
  
  document.getElementById('displayClassInfo').textContent = classInfo;
  document.getElementById('displayClassInfo').classList.toggle('not-set', classInfo === 'Not Set');
  
  // Field 2: Date (day - month - year)
  let dateStr = 'Not Set';
  if (config.day && config.month && config.year) {
    const shortYear = config.year.toString().slice(-2);
    dateStr = `${config.day} - ${config.month} - ${shortYear}`;
  }
  
  document.getElementById('displayDate').textContent = dateStr;
  document.getElementById('displayDate').classList.toggle('not-set', dateStr === 'Not Set');
  
  // Field 3: Subject (keeping original behavior)
  const subject = config.subject || 'Not Set';
  document.getElementById('displaySubject').textContent = subject;
  document.getElementById('displaySubject').classList.toggle('not-set', subject === 'Not Set');
}

          // ==================== AUTHENTICATION CHECK ====================
          async function checkAuthAndInitFaceRecognition() {
            try {
              // Check if logged in
              const user = await getCurrentUser();

              if (!user) {
                // Not logged in - redirect to login
                window.location.href = 'index.html';
                return;
              }

              // Get role
              const role = await getUserRole();
              console.log(`Face Recognition - Logged in as: ${user.attributes.email} (${role})`);
              await signIntoFirebase();
              // Apply role-based UI
              await applyRoleBasedUIForFaceRecognition();

              console.log('Face Recognition UI initialized for role:', role);

            } catch (error) {
              console.error('Auth check failed:', error);
              window.location.href = 'index.html';
            }
          }

          // Sync button handler
          document.getElementById('syncToMainBtn').addEventListener('click', async () => {
            try {
              const btn = document.getElementById('syncToMainBtn');
              btn.disabled = true;
              btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Syncing...';

              await faceSystem.syncToMainSystem();

              btn.disabled = false;
              btn.innerHTML = '<i class="bi bi-arrow-right-circle me-2"></i>Force Sync All Students';

            } catch (error) {
              faceSystem.showToast(`❌ ${error.message}`, 'danger');

              const btn = document.getElementById('syncToMainBtn');
              btn.disabled = false;
              btn.innerHTML = '<i class="bi bi-arrow-right-circle me-2"></i>Force Sync All Students';
            }
          });

          // Call on page load (after models are loaded)
          window.addEventListener('DOMContentLoaded', () => {
            // Wait a bit for face-api models to start loading
            setTimeout(checkAuthAndInitFaceRecognition, 500);
          });
          
          
          // ==================== QR SCANNER ====================
          let qrVideo = null;
          let qrStream = null;
          let qrAnimationFrame = null;
          let qrCanvas = null;
          let qrCtx = null;

          document.getElementById('scanQRBtn').addEventListener('click', async () => {
            if (!document.getElementById('qrScannerOverlay')) {
              const overlay = document.createElement('div');
              overlay.id = 'qrScannerOverlay';
              overlay.className = 'qr-scanner-overlay';
              overlay.innerHTML = `
              <div class="qr-scanner-box">
                <h5><i class="bi bi-qr-code-scanning me-2"></i>Scan QR Code</h5>
                <p class="text-muted" style="font-size: 0.85rem;">Point camera at the QR code generated from the Main Dashboard</p>
                <div id="qr-video-container">
                  <video id="qrVideo" autoplay muted playsinline></video>
                </div>
                <div id="qrStatus">Initializing camera...</div>
                <button id="closeQRBtn" class="btn btn-outline-danger btn-close-qr w-100">
                  <i class="bi bi-x-circle me-2"></i>Close
                </button>
              </div>
            `;
              document.body.appendChild(overlay);

              document.getElementById('closeQRBtn').addEventListener('click', () => {
                closeQRScanner();
              });
            }
            openQRScanner();
          });

          async function openQRScanner() {
            const overlay = document.getElementById('qrScannerOverlay');
            overlay.classList.add('active');

            qrVideo = document.getElementById('qrVideo');
            setQRStatus('Starting camera...');

            qrCanvas = document.createElement('canvas');
            qrCtx = qrCanvas.getContext('2d', { willReadFrequently: true });

            try {
              qrStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
              });
              qrVideo.srcObject = qrStream;
              qrVideo.setAttribute('playsinline', true);
              await qrVideo.play();

              setQRStatus('Scanning for QR code...');
              scanLoop();
            } catch (error) {
              try {
                qrStream = await navigator.mediaDevices.getUserMedia({ video: true });
                qrVideo.srcObject = qrStream;
                qrVideo.setAttribute('playsinline', true);
                await qrVideo.play();

                setQRStatus('Scanning for QR code...');
                scanLoop();
              } catch (err) {
                setQRStatus('❌ Camera access denied. Please allow camera.');
                console.error('QR camera error:', err);
              }
            }
          }

          function closeQRScanner() {
            if (qrStream) {
              qrStream.getTracks().forEach(track => track.stop());
              qrStream = null;
            }

            if (qrAnimationFrame) {
              cancelAnimationFrame(qrAnimationFrame);
              qrAnimationFrame = null;
            }

            const overlay = document.getElementById('qrScannerOverlay');
            overlay.classList.remove('active');

            if (qrVideo) {
              qrVideo.srcObject = null;
            }

            setQRStatus('Initializing camera...');
          }

          async function scanLoop() {
            if (!qrVideo || qrVideo.readyState < 3) {
              qrAnimationFrame = requestAnimationFrame(scanLoop);
              return;
            }

            qrCanvas.width = qrVideo.videoWidth;
            qrCanvas.height = qrVideo.videoHeight;
            qrCtx.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);

            try {
              const imageData = qrCtx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
              const code = jsQR(imageData.data, imageData.width, imageData.height);

              if (code) {
                // Stop scanning immediately
                if (qrAnimationFrame) {
                  cancelAnimationFrame(qrAnimationFrame);
                  qrAnimationFrame = null;
                }

                // Close scanner first
                closeQRScanner();

                // Then process the QR code
                if (window.faceSystem) {
                  await window.faceSystem.handleQRScan(code.data);
                } else {
                  console.error('❌ Face system not initialized yet');
                  alert('System not ready. Please refresh and try again.');
                }

                return;
              }
            } catch (e) {
              console.error('jsQR scan error:', e);
            }

            qrAnimationFrame = requestAnimationFrame(scanLoop);
          }

          function setQRStatus(message) {
            document.getElementById('qrStatus').textContent = message;
          }

          document.addEventListener('DOMContentLoaded', () => {
            const configCard = document.getElementById('configCard');

            if (configCard) {
              configCard.addEventListener('click', () => {
                console.log('Config card clicked - opening QR scanner');
                document.getElementById('scanQRBtn').click();
              });

              console.log('✅ Config card click handler attached');
            } else {
              console.warn('⚠️ Config card not found');
            }
          });
        </script>

</body>

</html>